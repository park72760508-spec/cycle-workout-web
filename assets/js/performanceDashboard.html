<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="STELVIO AI - Performance Dashboard">
  <title>STELVIO AI - Performance Dashboard</title>
  
  <!-- Tailwind CSS CDN (í”„ë¡œë•ì…˜ì—ì„œëŠ” ë¹Œë“œëœ CSS ì‚¬ìš© ê¶Œì¥) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind CDN ê²½ê³  ìˆ¨ê¸°ê¸° (ê°œë°œ í™˜ê²½)
    if (typeof console !== 'undefined' && console.warn) {
      const originalWarn = console.warn;
      console.warn = function(...args) {
        if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
          return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
        }
        originalWarn.apply(console, args);
      };
    }
  </script>
  
  <!-- React & ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone (JSX ë³€í™˜ìš©) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Chart.js (ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="assets/js/firebaseConfig.js"></script>
  
  <!-- í”„ë¡œì íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (assets/js/ ë””ë ‰í† ë¦¬) -->
  <script src="assets/js/geminiCoachPrompt.js"></script>
  <script src="assets/js/dashboardCoach.js"></script>
  <script src="assets/js/stravaManager.js"></script>
  <script src="assets/js/userManager.js"></script>
  
  <style>
    /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    
    /* Circular Progress Bar ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes progress {
      from {
        stroke-dashoffset: 283;
      }
    }
    
    .circular-progress {
      animation: progress 1s ease-out;
    }
    
    /* Skeleton UI ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }
    
    .skeleton {
      background: linear-gradient(
        90deg,
        #f0f0f0 0px,
        #e0e0e0 40px,
        #f0f0f0 80px
      );
      background-size: 1000px;
      animation: shimmer 2s infinite;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="dashboard-root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // DashboardCard ì»´í¬ë„ŒíŠ¸
    function DashboardCard({ title, children, className = "" }) {
      return (
        <div className={`bg-white rounded-2xl p-4 shadow-sm border border-gray-100 ${className}`}>
          {title && (
            <h3 className="text-sm font-semibold text-gray-600 mb-3">{title}</h3>
          )}
          {children}
        </div>
      );
    }
    
    // Training Trend Chart ì»´í¬ë„ŒíŠ¸ (Chart.js ì‚¬ìš©)
    function TrainingTrendChart({ data }) {
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);
      
      useEffect(() => {
        if (!data || data.length === 0) return;
        
        const ctx = chartRef.current?.getContext('2d');
        if (!ctx) return;
        
        // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
        if (chartInstanceRef.current) {
          chartInstanceRef.current.destroy();
        }
        
        // Chart.jsë¡œ ì°¨íŠ¸ ìƒì„±
        chartInstanceRef.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => d.date),
            datasets: [
              {
                label: 'Fitness',
                data: data.map(d => d.fitness),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointBackgroundColor: '#3b82f6'
              },
              {
                label: 'Fatigue',
                data: data.map(d => d.fatigue),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointBackgroundColor: '#ef4444'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  usePointStyle: true,
                  padding: 15,
                  font: {
                    size: 12
                  }
                }
              },
              tooltip: {
                backgroundColor: 'white',
                borderColor: '#e5e7eb',
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                titleFont: {
                  size: 13,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 12
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: true,
                  color: '#e5e7eb',
                  drawBorder: false
                },
                ticks: {
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                }
              },
              y: {
                grid: {
                  display: true,
                  color: '#e5e7eb',
                  drawBorder: false
                },
                ticks: {
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                },
                beginAtZero: true
              }
            }
          }
        });
        
        // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì°¨íŠ¸ ì •ë¦¬
        return () => {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
            chartInstanceRef.current = null;
          }
        };
      }, [data]);
      
      if (!data || data.length === 0) {
        return (
          <DashboardCard title="í›ˆë ¨ íŠ¸ë Œë“œ (ìµœê·¼ 7ì¼)">
            <div className="h-[200px] flex items-center justify-center text-gray-400 text-sm">
              ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
            </div>
          </DashboardCard>
        );
      }
      
      return (
        <DashboardCard title="í›ˆë ¨ íŠ¸ë Œë“œ (ìµœê·¼ 7ì¼)">
          <div className="h-[200px]">
            <canvas ref={chartRef}></canvas>
          </div>
        </DashboardCard>
      );
    }
    
    // Circular Progress ì»´í¬ë„ŒíŠ¸
    function CircularProgress({ value, max = 100, size = 120, strokeWidth = 8 }) {
      const percentage = Math.min((value / max) * 100, 100);
      const radius = (size - strokeWidth) / 2;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (percentage / 100) * circumference;
      
      const getColor = () => {
        if (percentage >= 80) return '#10b981'; // green
        if (percentage >= 60) return '#3b82f6'; // blue
        if (percentage >= 40) return '#f59e0b'; // amber
        return '#ef4444'; // red
      };
      
      return (
        <div className="relative inline-flex items-center justify-center" style={{ width: size, height: size }}>
          <svg width={size} height={size} className="transform -rotate-90">
            {/* ë°°ê²½ ì› */}
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              stroke="#e5e7eb"
              strokeWidth={strokeWidth}
              fill="none"
            />
            {/* ì§„í–‰ ì› */}
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              stroke={getColor()}
              strokeWidth={strokeWidth}
              fill="none"
              strokeDasharray={circumference}
              strokeDashoffset={offset}
              strokeLinecap="round"
              className="circular-progress transition-all duration-500"
            />
          </svg>
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="text-center">
              <div className="text-3xl font-bold" style={{ color: getColor() }}>
                {Math.round(value)}
              </div>
              <div className="text-xs text-gray-500">ì </div>
            </div>
          </div>
        </div>
      );
    }
    
    // ë©”ì¸ Dashboard ì»´í¬ë„ŒíŠ¸
    function PerformanceDashboard() {
      const [userProfile, setUserProfile] = useState(null);
      const [coachData, setCoachData] = useState(null);
      const [recentLogs, setRecentLogs] = useState([]);
      const [loading, setLoading] = useState(true);
      const [stats, setStats] = useState({
        ftp: 0,
        wkg: 0,
        weight: 0,
        totalPoints: 0,
        currentPoints: 0,
        weeklyGoal: 0,
        weeklyProgress: 0
      });
      const [aiPairingStatus, setAiPairingStatus] = useState(false);
      const [stravaStatus, setStravaStatus] = useState({ connected: false, lastSync: null });
      const [fitnessData, setFitnessData] = useState([]);
      
      // ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ
      useEffect(() => {
        async function loadUserProfile() {
          try {
            // ë¶€ëª¨ ì°½ì—ì„œ ì¸ì¦ ìƒíƒœ ê°€ì ¸ì˜¤ê¸° (iframeì¸ ê²½ìš°)
            let auth = window.auth;
            let currentUser = null;
            
            // iframeì¸ ê²½ìš° ë¶€ëª¨ ì°½ì˜ auth ì‚¬ìš©
            if (window.parent && window.parent !== window) {
              try {
                auth = window.parent.auth || window.parent.window?.auth;
                currentUser = auth?.currentUser || window.parent.window?.currentUser;
              } catch (e) {
                console.warn('ë¶€ëª¨ ì°½ ì ‘ê·¼ ì‹¤íŒ¨, í˜„ì¬ ì°½ ì‚¬ìš©:', e);
              }
            }
            
            // í˜„ì¬ ì°½ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            if (!currentUser && auth) {
              currentUser = auth.currentUser;
            }
            
            // localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (fallback)
            let userId = null;
            if (!currentUser) {
              try {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                  const userData = JSON.parse(storedUser);
                  if (userData && userData.id) {
                    userId = userData.id;
                  }
                }
              } catch (e) {
                console.warn('localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', e);
              }
            } else {
              userId = currentUser.uid;
            }
            
            if (!userId) {
              console.error('ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.');
              setLoading(false);
              return;
            }
            
            // Firestore ì°¸ì¡° ê°€ì ¸ì˜¤ê¸° (ë¶€ëª¨ ì°½ ë˜ëŠ” í˜„ì¬ ì°½)
            let firestore = window.firestore;
            
            // iframeì¸ ê²½ìš° ë¶€ëª¨ ì°½ì˜ firestore ì‚¬ìš©
            if (window.parent && window.parent !== window) {
              try {
                firestore = window.parent.firestore || window.parent.window?.firestore;
              } catch (e) {
                console.warn('ë¶€ëª¨ ì°½ Firestore ì ‘ê·¼ ì‹¤íŒ¨, í˜„ì¬ ì°½ ì‚¬ìš©:', e);
              }
            }
            
            if (!firestore) {
              console.error('Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              setLoading(false);
              return;
            }
            
            const userDoc = await firestore.collection('users').doc(userId).get();
            
            if (!userDoc.exists) {
              console.error('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              setLoading(false);
              return;
            }
            
            const userData = userDoc.data();
            setUserProfile({
              id: userId,
              name: userData.name || (currentUser ? (currentUser.displayName || currentUser.name) : null) || 'ì‚¬ìš©ì',
              ftp: userData.ftp || 0,
              weight: userData.weight || 0,
              grade: userData.grade || '2',
              acc_points: userData.acc_points || 0,
              rem_points: userData.rem_points || 0,
              ...userData
            });
            
            // í†µê³„ ê³„ì‚°
            const ftp = Number(userData.ftp) || 0;
            const weight = Number(userData.weight) || 0;
            const wkg = weight > 0 ? (ftp / weight).toFixed(2) : 0;
            
            setStats({
              ftp: ftp,
              wkg: parseFloat(wkg),
              weight: weight,
              totalPoints: Number(userData.acc_points || 0),
              currentPoints: Number(userData.rem_points || 0)
            });
            
            // Strava ì—°ê²° ìƒíƒœ í™•ì¸
            setStravaStatus({
              connected: !!(userData.strava_refresh_token),
              lastSync: userData.strava_last_sync || null
            });
            
          } catch (error) {
            console.error('ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:', error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë¡œë”© ìƒíƒœ í•´ì œ
            setLoading(false);
          }
        }
        
        // ì•½ê°„ì˜ ì§€ì—° í›„ ë¡œë“œ (Firebase ì´ˆê¸°í™” ëŒ€ê¸°)
        const timer = setTimeout(() => {
          loadUserProfile();
        }, 500);
        
        return () => clearTimeout(timer);
      }, []);
      
      // ìµœê·¼ í›ˆë ¨ ë¡œê·¸ ë¡œë“œ
      useEffect(() => {
        async function loadRecentLogs() {
          if (!userProfile) return;
          
          try {
            // Firestore ì°¸ì¡° ê°€ì ¸ì˜¤ê¸°
            let firestore = window.firestore;
            if (window.parent && window.parent !== window) {
              try {
                firestore = window.parent.firestore || window.parent.window?.firestore;
              } catch (e) {
                console.warn('ë¶€ëª¨ ì°½ Firestore ì ‘ê·¼ ì‹¤íŒ¨:', e);
              }
            }
            
            if (!firestore) {
              console.error('Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              return;
            }
            
            // ìµœê·¼ 30ì¼ê°„ì˜ training_log ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            // users/{userId}/logs ì„œë¸Œì»¬ë ‰ì…˜ ì‚¬ìš©
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const dateStr = thirtyDaysAgo.toISOString().split('T')[0];
            
            try {
              const userLogsRef = firestore.collection('users').doc(userProfile.id).collection('logs');
              const logsSnapshot = await userLogsRef
                .where('source', '==', 'strava')
                .where('date', '>=', dateStr)
                .orderBy('date', 'desc')
                .limit(30)
                .get();
            
              const logs = [];
              logsSnapshot.forEach(doc => {
                logs.push({ id: doc.id, ...doc.data() });
              });
              
              setRecentLogs(logs);
            } catch (queryError) {
              console.warn('í›ˆë ¨ ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨ (ì¸ë±ìŠ¤ í•„ìš”í•  ìˆ˜ ìˆìŒ):', queryError);
              // ì¸ë±ìŠ¤ ì˜¤ë¥˜ì¸ ê²½ìš° ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
              setRecentLogs([]);
            }
            
            // TSS ê¸°ë°˜ í¬ì¸íŠ¸ ê³„ì‚° â€” ì½”ë©˜íŠ¸ì™€ ë™ì¼: ìµœê·¼ 7ì¼(ì˜¤ëŠ˜ ê¸°ì¤€ -6ì¼~ì˜¤ëŠ˜) TSSë§Œ ì‚¬ìš©
            const toLocalDateStr = (val) => {
              if (!val) return '';
              const d = typeof val === 'string' ? new Date(val) : (val?.toDate ? val.toDate() : val);
              if (!d || !d.getFullYear) return '';
              return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            };
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            const start7 = new Date(today);
            start7.setDate(start7.getDate() - 6);
            const start7Str = start7.getFullYear() + '-' + String(start7.getMonth() + 1).padStart(2, '0') + '-' + String(start7.getDate()).padStart(2, '0');
            const byDate = {};
            logs.forEach(log => {
              const d = toLocalDateStr(log.date);
              if (!d) return;
              if (!byDate[d]) byDate[d] = 0;
              byDate[d] += Number(log.tss) || 0;
            });
            let last7DaysTSS = 0;
            Object.keys(byDate).forEach(d => {
              if (d >= start7Str && d <= todayStr) last7DaysTSS += byDate[d];
            });
            last7DaysTSS = Math.round(last7DaysTSS);
            const totalTss = logs.reduce((sum, log) => sum + (Number(log.tss) || 0), 0);
            setStats(prev => ({
              ...prev,
              weeklyProgress: last7DaysTSS,
              weeklyProgressLabel: last7DaysTSS,
              totalTss30: totalTss
            }));
            
            // Fitness ë°ì´í„° ìƒì„± (ìµœê·¼ 7ì¼)
            const last7Days = logs.slice(0, 7).reverse();
            const fitnessChartData = last7Days.map((log, index) => ({
              date: new Date(log.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }),
              fitness: Number(log.tss) || 0,
              fatigue: Number(log.tss) * 0.7 || 0 // ê°„ë‹¨í•œ ê³„ì‚° (ì‹¤ì œë¡œëŠ” CTL/ATL ê³„ì‚° í•„ìš”)
            }));
            setFitnessData(fitnessChartData);
            
          } catch (error) {
            console.error('í›ˆë ¨ ë¡œê·¸ ë¡œë“œ ì˜¤ë¥˜:', error);
          }
        }
        
        if (userProfile) {
          loadRecentLogs();
        }
      }, [userProfile]);
      
      // Gemini AI ì½”ì¹˜ ë¶„ì„ í˜¸ì¶œ
      useEffect(() => {
        async function fetchCoachAnalysis() {
          if (!userProfile || recentLogs.length === 0) {
            setLoading(false);
            return;
          }
          
          try {
            // ìºì‹œ í™•ì¸ (1ì‹œê°„)
            const cacheKey = `coach_analysis_${userProfile.id}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
              const { data, timestamp } = JSON.parse(cached);
              const oneHour = 60 * 60 * 1000;
              if (Date.now() - timestamp < oneHour) {
                setCoachData(data);
                setLoading(false);
                return;
              }
            }
            
            // Gemini API í˜¸ì¶œ
            if (typeof window.callGeminiCoach === 'function') {
              const analysis = await window.callGeminiCoach(userProfile, recentLogs);
              setCoachData(analysis);
              
              // ìºì‹œ ì €ì¥
              localStorage.setItem(cacheKey, JSON.stringify({
                data: analysis,
                timestamp: Date.now()
              }));
            }
          } catch (error) {
            console.error('AI ì½”ì¹˜ ë¶„ì„ ì˜¤ë¥˜:', error);
            // ê¸°ë³¸ê°’ ì„¤ì •
            setCoachData({
              condition_score: 50,
              training_status: 'Building Base',
              vo2max_estimate: 40,
              coach_comment: `${userProfile?.name || 'ì‚¬ìš©ì'}ë‹˜, ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.`,
              recommended_workout: 'Active Recovery (Z1)'
            });
          } finally {
            setLoading(false);
          }
        }
        
        if (userProfile && recentLogs.length > 0) {
          fetchCoachAnalysis();
        } else if (userProfile) {
          setLoading(false);
        }
      }, [userProfile, recentLogs]);
      
      // ë“±ê¸‰ ë±ƒì§€ í…ìŠ¤íŠ¸
      const getGradeBadge = (grade) => {
        const badges = {
          '1': 'ğŸ’ Diamond',
          '2': 'â­ Member',
          '3': 'ğŸ‘‘ Admin'
        };
        return badges[grade] || 'â­ Member';
      };
      
      if (loading) {
        return (
          <div className="max-w-[480px] mx-auto min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="skeleton w-32 h-32 rounded-full mx-auto mb-4"></div>
              <div className="skeleton w-48 h-6 mx-auto mb-2"></div>
              <div className="skeleton w-64 h-4 mx-auto"></div>
            </div>
          </div>
        );
      }
      
      return (
        <div className="max-w-[480px] mx-auto min-h-screen bg-gray-50 scrollbar-hide">
          {/* Header */}
          <header className="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-gray-200 px-4 py-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold">
                  {userProfile?.name?.charAt(0) || 'U'}
                </div>
                <div>
                  <div className="font-semibold text-gray-900">{userProfile?.name || 'ì‚¬ìš©ì'}</div>
                  <div className="text-xs text-gray-500">{getGradeBadge(userProfile?.grade)}</div>
                </div>
              </div>
              <button
                className="p-2 rounded-lg hover:bg-gray-100 active:opacity-80 transition-all"
                onClick={() => {
                  // í”„ë¡œí•„ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸° (ì¶”í›„ êµ¬í˜„)
                  alert('í”„ë¡œí•„ í¸ì§‘ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
                }}
              >
                <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
            </div>
          </header>
          
          <div className="px-4 py-6 space-y-6 pb-24">
            {/* Status Control Center */}
            <div className="flex gap-3 overflow-x-auto scrollbar-hide pb-2">
              <DashboardCard className="min-w-[140px]">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${aiPairingStatus ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                  <span className="text-sm text-gray-700">AI í˜ì–´ë§</span>
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  {aiPairingStatus ? 'ì—°ê²°ë¨' : 'ì—°ê²° ëŒ€ê¸°'}
                </div>
              </DashboardCard>
              
              <DashboardCard className="min-w-[140px]">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${stravaStatus.connected ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                  <span className="text-sm text-gray-700">Strava</span>
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  {stravaStatus.connected 
                    ? stravaStatus.lastSync 
                      ? `ë™ê¸°í™”: ${new Date(stravaStatus.lastSync).toLocaleDateString('ko-KR')}`
                      : 'ì—°ê²°ë¨'
                    : 'ì—°ê²° ëŒ€ê¸°'}
                </div>
              </DashboardCard>
            </div>
            
            {/* Gemini Coach Insight */}
            <DashboardCard className="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200">
              {coachData ? (
                <>
                  <div className="flex items-center justify-center mb-4">
                    <CircularProgress value={coachData.condition_score} />
                  </div>
                  <div className="text-center mb-3">
                    <div className="text-lg font-bold text-gray-900 mb-1">
                      {coachData.training_status}
                    </div>
                    <div className="text-sm text-gray-600">
                      VOâ‚‚max ì¶”ì •: {coachData.vo2max_estimate} ml/kg/min
                    </div>
                  </div>
                  <div className="bg-white/80 rounded-xl p-4 mb-3">
                    <p className="text-sm text-gray-800 leading-relaxed">
                      {coachData.coach_comment}
                    </p>
                  </div>
                  <div className="text-center">
                    <span className="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full">
                      ì¶”ì²œ: {coachData.recommended_workout}
                    </span>
                  </div>
                </>
              ) : (
                <div className="text-center py-8">
                  <div className="skeleton w-24 h-24 rounded-full mx-auto mb-4"></div>
                  <div className="skeleton w-32 h-4 mx-auto mb-2"></div>
                  <div className="skeleton w-48 h-3 mx-auto"></div>
                </div>
              )}
            </DashboardCard>
            
            {/* Stats Grid (2x2) */}
            <div className="grid grid-cols-2 gap-3">
              {/* Power Card */}
              <DashboardCard title="íŒŒì›Œ">
                <div className="text-2xl font-bold text-gray-900 mb-1">{stats.ftp}W</div>
                <div className="text-sm text-gray-600">{stats.wkg} W/kg</div>
              </DashboardCard>
              
              {/* Rewards/Points Card */}
              <DashboardCard title="í¬ì¸íŠ¸">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-2xl">ğŸ’°</span>
                  <div>
                    <div className="text-lg font-bold text-gray-900">{stats.currentPoints}</div>
                    <div className="text-xs text-gray-500">ë³´ìœ </div>
                  </div>
                </div>
                <div className="text-xs text-gray-600 border-t border-gray-100 pt-2 mt-2">
                  ëˆ„ì : {stats.totalPoints}pt
                </div>
              </DashboardCard>
              
              {/* Physique Card */}
              <DashboardCard title="ì²´í˜•">
                <div className="text-2xl font-bold text-gray-900 mb-1">{stats.weight}kg</div>
                <div className="text-sm text-gray-600">ì²´ì¤‘</div>
              </DashboardCard>
              
              {/* Progress Card â€” ì£¼ê°„ ì‹¤ì  = ìµœê·¼ 7ì¼ TSS (ì½”ë©˜íŠ¸ì™€ ë™ì¼ ê³„ì‚°) */}
              <DashboardCard title="ì£¼ê°„ ëª©í‘œì™€ ì‹¤ì ">
                <div className="relative w-16 h-16 mx-auto mb-2">
                  <svg className="w-16 h-16 transform -rotate-90">
                    <circle
                      cx="32"
                      cy="32"
                      r="28"
                      stroke="#e5e7eb"
                      strokeWidth="6"
                      fill="none"
                    />
                    <circle
                      cx="32"
                      cy="32"
                      r="28"
                      stroke="#3b82f6"
                      strokeWidth="6"
                      fill="none"
                      strokeDasharray={`${2 * Math.PI * 28}`}
                      strokeDashoffset={`${2 * Math.PI * 28 * (1 - Math.min((stats.weeklyProgress || 0) / 600, 1))}`}
                      strokeLinecap="round"
                    />
                  </svg>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <span className="text-sm font-bold text-gray-900">
                      {Math.min(Math.round(((stats.weeklyProgress || 0) / 600) * 100), 100)}%
                    </span>
                  </div>
                </div>
                <div className="text-xs text-gray-600 text-center">
                  ì£¼ê°„ ì‹¤ì  {stats.weeklyProgress ?? 0}/600 TSS
                </div>
              </DashboardCard>
            </div>
            
            {/* Training Trend Chart */}
            <TrainingTrendChart data={fitnessData} />
          </div>
        </div>
      );
    }
    
    // React ì•± ë Œë”ë§ (React 18 í˜¸í™˜)
    const rootElement = document.getElementById('dashboard-root');
    if (ReactDOM.createRoot) {
      // React 18+
      const root = ReactDOM.createRoot(rootElement);
      root.render(<PerformanceDashboard />);
    } else {
      // React 17 ì´í•˜
      ReactDOM.render(<PerformanceDashboard />, rootElement);
    }
  </script>
</body>
</html>
