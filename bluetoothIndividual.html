<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bluetooth ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ</title>
    
    <!-- Favicon ì„¤ì • -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš´</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš´</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="assets/js/firebaseConfig.js"></script>
    
    <!-- Google Apps Script URL ì„¤ì • -->
    <script>
        window.CONFIG = {
            GAS_WEB_APP_URL: "https://script.google.com/macros/s/AKfycbzF8br63uD3ziNxCFkp0UUSpP49zURthDsEVZ6o3uRu47pdS5uXE5S1oJ3d7AKHFouJ/exec"
        };
        window.GAS_URL = window.CONFIG.GAS_WEB_APP_URL;
    </script>

    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Pretendard', sans-serif;
            margin: 0;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ê³ ë ¤ (Dynamic Viewport Height) */
            min-height: -webkit-fill-available; /* iOS Safari ëŒ€ì‘ */
            /* Pull-to-refresh ë°©ì§€ (ê°•í™”) */
            overscroll-behavior-y: none !important; /* contain ëŒ€ì‹  none ì‚¬ìš© (ë” ê°•ë ¥) */
            overscroll-behavior: none !important;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation !important; /* pan-y ëŒ€ì‹  manipulation ì‚¬ìš© (ë” ê°•ë ¥í•œ ì°¨ë‹¨) */
            /* iOS Safari/Bluefy ì¶”ê°€ ëŒ€ì‘ */
            -webkit-user-select: none;
            user-select: none;
            /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            overflow-y: hidden !important;
            overflow-x: hidden !important;
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        /* ê°€ë¡œ ëª¨ë“œ ë°©ì§€ (ì„¸ë¡œ ëª¨ë“œë¡œ ê³ ì •) */
        @media screen and (orientation: landscape) {
            body::before {
                content: 'ì„¸ë¡œ ëª¨ë“œë¡œ ê¸°ê¸°ë¥¼ íšŒì „í•´ì£¼ì„¸ìš”';
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.95);
                color: #fff;
                padding: 30px 50px;
                border-radius: 15px;
                font-size: 20px;
                font-weight: bold;
                z-index: 10000;
                text-align: center;
                white-space: nowrap;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            }
            
            body > * {
                opacity: 0.3;
                pointer-events: none;
            }
        }

        /* ìƒë‹¨ í—¤ë” */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
            position: relative; /* ì„¸ê·¸ë¨¼íŠ¸ ì •ë³´ ì ˆëŒ€ ìœ„ì¹˜ ê¸°ì¤€ */
        }
        
        /* ì„¸ê·¸ë¨¼íŠ¸ ì •ë³´ (ê²Œì´ì§€ ë‚´ë¶€ì— í‘œì‹œ) */
        #segment-info {
            text-align: center;
            font-size: 0.9em;
            color: #ccc;
        }
        .bike-badge {
            background-color: #00d4aa;
            color: #000;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1.1em;
            display: inline-block; /* ê¸€ì í­ì— ë§ì¶¤ */
            width: auto; /* ë‚´ìš©ë¬¼ì— ë§ê²Œ ìë™ ì¡°ì • */
        }
        .timer {
            font-size: 1.5em;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            color: #fff;
        }
        
        /* ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ë²„íŠ¼ */
        .bluetooth-connect-btn {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 6px 12px;
            color: #fff;
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        .bluetooth-connect-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .bluetooth-connect-btn.has-connection {
            background: rgba(0, 212, 170, 0.2);
            border-color: #00d4aa;
            color: #00d4aa;
        }
        .bluetooth-connect-btn .bluetooth-icon {
            width: 16px;
            height: 16px;
        }
        
        /* ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ë“œë¡­ë‹¤ìš´ */
        .bluetooth-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 8px;
            min-width: 200px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .bluetooth-dropdown.show {
            display: block;
        }
        .bluetooth-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease;
            color: #fff;
            font-size: 0.9em;
        }
        .bluetooth-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .bluetooth-dropdown-item.connected {
            color: #00d4aa;
        }
        .bluetooth-dropdown-item img {
            width: 24px;
            height: 24px;
        }
        .bluetooth-dropdown-item .status {
            margin-left: auto;
            font-size: 0.8em;
            color: #888;
        }
        .bluetooth-dropdown-item.connected .status {
            color: #00d4aa;
        }
        
        /* ì¢…ë£Œ ë©”ë‰´ í•­ëª© ìŠ¤íƒ€ì¼ (Bluetooth ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ ì „ìš©, ë…ë¦½ì  êµ¬ë™) */
        .bluetooth-dropdown-item-exit {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 4px;
            padding-top: 12px;
        }
        
        .bluetooth-dropdown-item-exit:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .bluetooth-dropdown-item-exit img {
            filter: brightness(0) saturate(100%) invert(48%) sepia(79%) saturate(2476%) hue-rotate(340deg) brightness(98%) contrast(96%);
        }
        
        .bluetooth-dropdown-item-exit:hover img {
            filter: brightness(0) saturate(100%) invert(48%) sepia(79%) saturate(2476%) hue-rotate(340deg) brightness(98%) contrast(96%);
        }

        /* ë©”ì¸ ì½˜í…ì¸  (ê²Œì´ì§€ ì˜ì—­) */
        .main-content {
            flex: 1 1 0; /* flex-grow: 1, flex-shrink: 1, flex-basis: 0 (ê°€ìš© ê³µê°„ì„ ê· ë“±í•˜ê²Œ ë¶„ë°°) */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 0; /* flex ì•„ì´í…œì´ ì¶•ì†Œ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
            overflow: hidden; /* ë„˜ì¹˜ëŠ” ë‚´ìš© ìˆ¨ê¹€ */
        }

        /* ì†ë„ê³„ ì»¨í…Œì´ë„ˆ */
        .gauge-container {
            width: 90vw;
            max-width: 500px;
            aspect-ratio: 1/1;
            position: relative;
        }

        /* í†µê³„ ì •ë³´ (í•˜ë‹¨) */
        .stats-footer {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            background-color: #1e1e1e;
            padding: 15px 0;
            border-top: 1px solid #333;
        }
        .stat-box {
            text-align: center;
            border-right: 1px solid #333;
        }
        .stat-box:last-child { border-right: none; }
        .stat-label { font-size: 0.8em; color: #888; margin-bottom: 5px; }
        .stat-value { font-size: 1.8em; font-weight: bold; }
        .unit { font-size: 0.5em; color: #aaa; }

        /* ìƒ‰ìƒ í´ë˜ìŠ¤ */
        .c-power { color: #fff; }
        .c-cadence { color: #ff4444; }
        .c-hr { color: #00d4aa; }
        .c-target { color: #ff8c00; }

        /* ì„¸ê·¸ë¨¼íŠ¸ ê·¸ë˜í”„ ì»¨í…Œì´ë„ˆ */
        .segment-graph-section {
            padding: 0 20px; /* ìƒí•˜ íŒ¨ë”© ì œê±°, ì¢Œìš° íŒ¨ë”©ë§Œ ìœ ì§€ */
            background-color: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: center;
            align-items: center; /* ê·¸ë˜í”„ë¥¼ ì„¸ë¡œ ì¤‘ì•™ì— ë°°ì¹˜ */
            flex: 0.4 0.4 0; /* flex-grow: 0.4, flex-shrink: 0.4 (20% ì¶•ì†Œ: 0.5 * 0.8 = 0.4) */
            min-height: 80px; /* ìµœì†Œ ë†’ì´ ë³´ì¥ (20% ì¶•ì†Œ: 100px * 0.8 = 80px) */
            position: relative;
            overflow: hidden; /* ë„˜ì¹˜ëŠ” ë‚´ìš© ìˆ¨ê¹€ */
        }
        
        /* ëª¨ë°”ì¼ í™˜ê²½ ìµœì í™” */
        @media (max-height: 800px) {
            .segment-graph-section {
                min-height: 72px; /* ì‘ì€ í™”ë©´ì—ì„œë„ ì ì ˆí•œ ë†’ì´ (20% ì¶•ì†Œ: 90px * 0.8 = 72px) */
            }
        }
        
        @media (max-height: 600px) {
            .segment-graph-section {
                min-height: 60px; /* ë§¤ìš° ì‘ì€ í™”ë©´ ëŒ€ì‘ (20% ì¶•ì†Œ: 75px * 0.8 = 60px) */
            }
        }
        
        .segment-graph-container {
            width: 98%; /* ê·¸ë˜í”„ ë¸”ëŸ­ì˜ 98% ë„ˆë¹„ */
            max-width: 600px;
            height: 95% !important; /* ê·¸ë˜í”„ ë¸”ëŸ­ì˜ 95% ë†’ì´ */
            position: relative;
            display: flex;
            align-items: center; /* Canvasë¥¼ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ì— ë°°ì¹˜ */
            justify-content: center;
        }
        .segment-graph-container canvas {
            width: 100% !important;
            height: 100% !important; /* ì»¨í…Œì´ë„ˆ ë†’ì´ì— ë§ì¶¤ */
            display: block;
            /* object-fit ì œê±°: Canvasì˜ ì‹¤ì œ í”½ì…€ í¬ê¸°ë¥¼ ì¡°ì •í•˜ë¯€ë¡œ ë¶ˆí•„ìš” */
        }

        /* 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        .countdown-overlay.hidden {
            display: none;
        }
        .countdown-number {
            font-size: 200px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5), 0 0 60px rgba(255, 255, 255, 0.3);
            animation: countdownPulse 0.8s ease-out;
            user-select: none;
        }
        @keyframes countdownPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* í›ˆë ¨ ê²°ê³¼ íŒì—… ìŠ¤íƒ€ì¼ */
        .training-result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .training-result-modal.hidden {
            display: none;
        }

        /* ì¶•í•˜ ì˜¤ë²„ë ˆì´ ì• ë‹ˆë©”ì´ì…˜ (ëª¨ë°”ì¼ê³¼ ë™ì¼) */
        @keyframes celebrationPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 20px 60px rgba(255, 215, 0, 0.5), 0 0 100px rgba(255, 107, 53, 0.3);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 25px 70px rgba(255, 215, 0, 0.6), 0 0 120px rgba(255, 107, 53, 0.4);
            }
        }
        
        @keyframes celebrationBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .training-result-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0.1;
        }

        .result-background-logo {
            max-width: 400px;
            max-height: 400px;
            width: 100%;
            height: auto;
            object-fit: contain;
            opacity: 0.08;
            filter: blur(1px);
        }

        .training-result-content {
            position: relative;
            background: rgba(30, 30, 30, 0.95);
            border: 2px solid #00d4aa;
            border-radius: 12px;
            padding: 16px 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 212, 170, 0.3);
            animation: slideUp 0.4s ease-out;
            backdrop-filter: blur(10px);
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .result-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .result-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #00d4aa;
            margin: 0 0 4px 0;
            text-shadow: 0 0 10px rgba(0, 212, 170, 0.5);
        }

        .result-subtitle {
            font-size: 0.9em;
            color: #ffffff;
            margin: 0;
            opacity: 0.9;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .result-stat-item {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid rgba(0, 212, 170, 0.3);
            border-radius: 6px;
            padding: 6px 8px;
            text-align: center;
        }

        .result-stat-label {
            font-size: 0.7em;
            color: #aaa;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .result-stat-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #00d4aa;
            text-shadow: 0 0 8px rgba(0, 212, 170, 0.4);
        }

        .result-close-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00d4aa 0%, #00a88a 100%);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.4);
        }

        .result-close-btn:hover {
            background: linear-gradient(135deg, #00e8c2 0%, #00d4aa 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 212, 170, 0.6);
        }

        .result-close-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 212, 170, 0.4);
        }

        /* ì €ì¥ ì¤‘ ìƒíƒœ ìŠ¤íƒ€ì¼ (Bluetooth ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ ì „ìš©, ë…ë¦½ì  êµ¬ë™) */
        .bluetooth-result-saving-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .bluetooth-saving-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(0, 212, 170, 0.2);
            border-top-color: #00d4aa;
            border-radius: 50%;
            animation: bluetooth-saving-spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes bluetooth-saving-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .bluetooth-saving-text {
            font-size: 1.2em;
            font-weight: 600;
            color: #00d4aa;
            margin: 0;
            text-shadow: 0 0 10px rgba(0, 212, 170, 0.5);
            animation: bluetooth-saving-pulse 1.5s ease-in-out infinite;
        }

        @keyframes bluetooth-saving-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .bluetooth-result-content-area {
            display: none;
        }

        .bluetooth-result-content-area.show {
            display: block;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .training-result-content {
                padding: 12px 16px;
                max-width: 95%;
                max-height: 95vh;
            }

            .result-header {
                margin-bottom: 12px;
            }

            .result-title {
                font-size: 1.3em;
                margin-bottom: 2px;
            }

            .result-subtitle {
                font-size: 0.85em;
            }

            .result-stats {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 16px;
            }

            .result-stat-item {
                padding: 6px 8px;
            }

            .result-stat-label {
                font-size: 0.7em;
                margin-bottom: 3px;
            }

            .result-stat-value {
                font-size: 1.1em;
            }

            .result-close-btn {
                padding: 10px;
                font-size: 0.95em;
            }

            .result-background-logo {
                max-width: 200px;
            }
        }

        /* ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ ê°•ë„ ì¡°ì ˆ ìŠ¬ë¼ì´ë“œ ë°” ìŠ¤íƒ€ì¼ */
        .individual-intensity-adjustment-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(26, 29, 41, 0.6);
            border-top: 1px solid #333;
        }

        .individual-intensity-adjustment-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .individual-intensity-adjustment-value {
            font-size: 16px;
            font-weight: 700;
            color: #9ca3af;
            min-width: 45px;
            text-align: center;
        }

        .individual-intensity-adjustment-slider-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 400px;
        }

        .individual-intensity-adjustment-min,
        .individual-intensity-adjustment-max {
            font-size: 11px;
            color: #64748b;
            min-width: 35px;
            text-align: center;
        }

        .individual-intensity-adjustment-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .individual-intensity-adjustment-slider:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* ìŠ¬ë¼ì´ë” thumb ìŠ¤íƒ€ì¼ (WebKit) */
        .individual-intensity-adjustment-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff8c00 0%, #ff6600 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(255, 140, 0, 0.4);
            transition: all 0.2s ease;
        }

        .individual-intensity-adjustment-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 8px rgba(255, 140, 0, 0.6);
        }

        /* ìŠ¬ë¼ì´ë” thumb ìŠ¤íƒ€ì¼ (Firefox) */
        .individual-intensity-adjustment-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff8c00 0%, #ff6600 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(255, 140, 0, 0.4);
            transition: all 0.2s ease;
        }

        .individual-intensity-adjustment-slider::-moz-range-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 8px rgba(255, 140, 0, 0.6);
        }

        /* ìŠ¬ë¼ì´ë” íŠ¸ë™ ìŠ¤íƒ€ì¼ (Firefox) */
        .individual-intensity-adjustment-slider::-moz-range-track {
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>

    <div class="header">
        <div id="bike-id-display" class="bike-badge">Bike ?</div>
        <div id="main-timer" class="timer" style="position: absolute; left: 50%; transform: translateX(-50%);">00:00:00</div>
        <div style="display: flex; align-items: center; gap: 12px; margin-left: auto;">
            <div style="position: relative;">
                <button id="bluetoothConnectBtn" class="bluetooth-connect-btn" onclick="toggleBluetoothDropdown()">
                    <img src="assets/img/wifi2.png" alt="ì—°ê²°" class="bluetooth-icon" style="width: 16px; height: 16px;">
                    <span>ì—°ê²°</span>
                </button>
                <div id="bluetoothDropdown" class="bluetooth-dropdown">
                    <div id="bluetoothTrainerItem" class="bluetooth-dropdown-item" onclick="connectBluetoothDevice('trainer')">
                        <img src="assets/img/trainer_i.png" alt="ìŠ¤ë§ˆíŠ¸ íŠ¸ë ˆì´ë„ˆ">
                        <span>ìŠ¤ë§ˆíŠ¸ íŠ¸ë ˆì´ë„ˆ</span>
                        <span class="status" id="trainerStatus">ë¯¸ì—°ê²°</span>
                    </div>
                    <!-- ERG ë™ì‘ ë©”ë‰´ (ìŠ¤ë§ˆíŠ¸ íŠ¸ë ˆì´ë„ˆ ì—°ê²° ì‹œ í‘œì‹œ) -->
                    <div id="bluetoothErgMenu" class="bluetooth-erg-menu" style="display: none; padding: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">ERG ë™ì‘</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="bluetoothErgToggle" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>ERG ëª¨ë“œ</span>
                            </label>
                            <span id="bluetoothErgStatus" style="font-size: 12px; color: #888;">OFF</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 12px; color: #888;">ëª©í‘œ íŒŒì›Œ (W):</label>
                            <input type="number" id="bluetoothErgTargetPower" min="0" max="1000" value="0" 
                                   style="width: 80px; padding: 4px 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; color: #fff; font-size: 14px;">
                            <button id="bluetoothErgSetBtn" style="padding: 4px 12px; background: #00d4aa; border: none; border-radius: 4px; color: #000; font-size: 12px; font-weight: bold; cursor: pointer;">ì„¤ì •</button>
                        </div>
                    </div>
                    <div id="bluetoothHRItem" class="bluetooth-dropdown-item" onclick="connectBluetoothDevice('heartRate')">
                        <img src="assets/img/bpm_i.png" alt="ì‹¬ë°•ê³„">
                        <span>ì‹¬ë°•ê³„</span>
                        <span class="status" id="heartRateStatus">ë¯¸ì—°ê²°</span>
                    </div>
                    <div id="bluetoothPMItem" class="bluetooth-dropdown-item" onclick="connectBluetoothDevice('powerMeter')">
                        <img src="assets/img/power_i.png" alt="íŒŒì›Œë¯¸í„°">
                        <span>íŒŒì›Œë¯¸í„°</span>
                        <span class="status" id="powerMeterStatus">ë¯¸ì—°ê²°</span>
                    </div>
                    <!-- ì¢…ë£Œ ë©”ë‰´ (Bluetooth ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ ì „ìš©, ë…ë¦½ì  êµ¬ë™) -->
                    <div class="bluetooth-dropdown-item bluetooth-dropdown-item-exit" onclick="exitBluetoothIndividualTraining()">
                        <img src="assets/img/logout.png" alt="ì¢…ë£Œ">
                        <span>ì¢…ë£Œ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="segment-graph-section">
        <div class="segment-graph-container">
            <canvas id="individualSegmentGraph"></canvas>
        </div>
    </div>

    <div class="main-content">
        <div class="gauge-container">
            <svg viewBox="0 0 200 220" style="width:100%; height:100%;">
                <!-- ì›í˜¸ ë°°ê²½ -->
                <path d="M 20 140 A 80 80 0 0 1 180 140" fill="none" stroke="#333" stroke-width="12" stroke-linecap="round"/>
                
                <!-- ëˆˆê¸ˆ ê·¸ë£¹ (JavaScriptë¡œ ë™ì  ìƒì„±) -->
                <g id="gauge-ticks"></g>
                
                <!-- ë ˆì´ë¸” ê·¸ë£¹ (JavaScriptë¡œ ë™ì  ìƒì„±) -->
                <g id="gauge-labels"></g>
                
                <!-- ë©ì¹´ìš´íŠ¸ë‹¤ìš´ (ì†ë„ê³„ ìƒë‹¨) -->
                <text x="100" y="0" text-anchor="middle" fill="#888" font-size="8">LAP COUNTDOWN</text>
                <text id="ui-lap-time" x="100" y="34" text-anchor="middle" fill="#00d4aa" font-size="20" font-weight="bold">00:00</text>
                
                <text id="ui-target-label" x="100" y="90" text-anchor="middle" fill="#888" font-size="6">TARGET</text>
                <text id="ui-target-rpm-unit" x="100" y="98" text-anchor="middle" fill="#888" font-size="5" style="display: none;">RPM</text>
                <text id="ui-target-power" x="100" y="120" text-anchor="middle" fill="#ff8c00" font-size="28" font-weight="bold">0</text>
                
                <text x="100" y="160" text-anchor="middle" fill="#aaa" font-size="8.4">WATTS</text>
                <text id="ui-current-power" x="100" y="200" text-anchor="middle" fill="#fff" font-size="48" font-weight="bold">0</text>
                
                <!-- ì„¸ê·¸ë¨¼íŠ¸ ì •ë³´ (íŒŒì›Œê°’ ì•„ë˜) -->
                <text id="segment-info" x="100" y="215" text-anchor="middle" fill="#ccc" font-size="9">ì¤€ë¹„ ì¤‘</text>

                <g id="gauge-needle" transform="translate(100, 140) rotate(-90)">
                    <line x1="0" y1="0" x2="0" y2="-75" stroke="#ff0000" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="0" cy="0" r="6" fill="#fff"/>
                </g>
            </svg>
        </div>
    </div>

    <div class="stats-footer">
        <div class="stat-box">
            <div class="stat-label">CADENCE</div>
            <div class="stat-value c-cadence"><span id="ui-cadence">0</span><span class="unit">rpm</span></div>
        </div>
        <div class="stat-box">
            <div class="stat-label">LAP AVG</div>
            <div class="stat-value c-target"><span id="ui-lap-power">0</span><span class="unit">w</span></div>
        </div>
        <div class="stat-box">
            <div class="stat-label">HEART RATE</div>
            <div class="stat-value c-hr"><span id="ui-hr">0</span><span class="unit">bpm</span></div>
        </div>
    </div>

    <!-- ëª©í‘œê°’ ì¡°ì ˆ ìŠ¬ë¼ì´ë“œ ë°” (ì†ë„ê³„ í•˜ë‹¨) -->
    <div class="individual-intensity-adjustment-container">
        <div class="individual-intensity-adjustment-label">
            <span>ëª©í‘œê°’ ì¡°ì ˆ</span>
            <span class="individual-intensity-adjustment-value" id="individualIntensityAdjustmentValue">0%</span>
        </div>
        <div class="individual-intensity-adjustment-slider-wrapper">
            <span class="individual-intensity-adjustment-min">-5%</span>
            <input type="range" id="individualIntensityAdjustmentSlider" 
                   min="-5" max="5" step="1" value="0" 
                   class="individual-intensity-adjustment-slider">
            <span class="individual-intensity-adjustment-max">+5%</span>
        </div>
    </div>

    <!-- 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ -->
    <div id="countdownOverlay" class="countdown-overlay hidden" style="display: none;">
        <div class="countdown-number" id="countdownNumber">5</div>
    </div>

    <!-- í›ˆë ¨ ê²°ê³¼ íŒì—… -->
    <div id="trainingResultModal" class="training-result-modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; animation: fadeIn 0.3s ease-out;">
        <div class="training-result-background" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none; opacity: 0.1;">
            <img src="assets/img/STELVIO AI.png" alt="Stelvio" class="result-background-logo" style="max-width: 400px; max-height: 400px; width: 100%; height: auto; object-fit: contain; opacity: 0.08; filter: blur(1px);" />
        </div>
        <div class="training-result-content" style="position: relative; background: rgba(30, 30, 30, 0.95); border: 2px solid #00d4aa; border-radius: 12px; padding: 16px 20px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0, 212, 170, 0.3); animation: slideUp 0.4s ease-out; backdrop-filter: blur(10px);">
            <!-- ì €ì¥ ì¤‘ ìƒíƒœ í‘œì‹œ (Bluetooth ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ ì „ìš©, ë…ë¦½ì  êµ¬ë™) -->
            <div id="bluetoothResultSavingState" class="bluetooth-result-saving-state" style="display: none;">
                <div class="bluetooth-saving-spinner"></div>
                <p class="bluetooth-saving-text">ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            
            <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ (ì €ì¥ ì™„ë£Œ í›„ í‘œì‹œ) -->
            <div id="bluetoothResultContent" class="bluetooth-result-content-area">
            <div class="result-header">
                <h2 class="result-title">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤</h2>
                <p class="result-subtitle">í›ˆë ¨ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</p>
            </div>
            <div class="result-stats" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                <div class="result-stat-item" style="background: rgba(0, 212, 170, 0.1); border: 1px solid rgba(0, 212, 170, 0.3); border-radius: 6px; padding: 6px 8px; text-align: center;">
                    <div class="result-stat-label" style="font-size: 0.7em; color: #aaa; margin-bottom: 3px; font-weight: 500;">í›ˆë ¨ ì‹œê°„</div>
                    <div class="result-stat-value" id="result-duration" style="font-size: 1.1em; font-weight: bold; color: #00d4aa; text-shadow: 0 0 8px rgba(0, 212, 170, 0.4);">0ë¶„</div>
                </div>
                <div class="result-stat-item" style="background: rgba(0, 212, 170, 0.1); border: 1px solid rgba(0, 212, 170, 0.3); border-radius: 6px; padding: 6px 8px; text-align: center;">
                    <div class="result-stat-label" style="font-size: 0.7em; color: #aaa; margin-bottom: 3px; font-weight: 500;">í‰ê·  íŒŒì›Œ</div>
                    <div class="result-stat-value" id="result-avg-power" style="font-size: 1.1em; font-weight: bold; color: #00d4aa; text-shadow: 0 0 8px rgba(0, 212, 170, 0.4);">0W</div>
                </div>
                <div class="result-stat-item" style="background: rgba(0, 212, 170, 0.1); border: 1px solid rgba(0, 212, 170, 0.3); border-radius: 6px; padding: 6px 8px; text-align: center;">
                    <div class="result-stat-label" style="font-size: 0.7em; color: #aaa; margin-bottom: 3px; font-weight: 500;">NP</div>
                    <div class="result-stat-value" id="result-np" style="font-size: 1.1em; font-weight: bold; color: #00d4aa; text-shadow: 0 0 8px rgba(0, 212, 170, 0.4);">0W</div>
                </div>
                <div class="result-stat-item" style="background: rgba(0, 212, 170, 0.1); border: 1px solid rgba(0, 212, 170, 0.3); border-radius: 6px; padding: 6px 8px; text-align: center;">
                    <div class="result-stat-label" style="font-size: 0.7em; color: #aaa; margin-bottom: 3px; font-weight: 500;">TSS</div>
                    <div class="result-stat-value" id="result-tss" style="font-size: 1.1em; font-weight: bold; color: #00d4aa; text-shadow: 0 0 8px rgba(0, 212, 170, 0.4);">0</div>
                </div>
                <div class="result-stat-item" style="background: rgba(0, 212, 170, 0.1); border: 1px solid rgba(0, 212, 170, 0.3); border-radius: 6px; padding: 6px 8px; text-align: center;">
                    <div class="result-stat-label" style="font-size: 0.7em; color: #aaa; margin-bottom: 3px; font-weight: 500;">í‰ê·  ì‹¬ë°•ìˆ˜</div>
                    <div class="result-stat-value" id="result-hr-avg" style="font-size: 1.1em; font-weight: bold; color: #00d4aa; text-shadow: 0 0 8px rgba(0, 212, 170, 0.4);">0bpm</div>
                </div>
                <div class="result-stat-item" style="background: rgba(0, 212, 170, 0.1); border: 1px solid rgba(0, 212, 170, 0.3); border-radius: 6px; padding: 6px 8px; text-align: center;">
                    <div class="result-stat-label" style="font-size: 0.7em; color: #aaa; margin-bottom: 3px; font-weight: 500;">ì¹¼ë¡œë¦¬</div>
                    <div class="result-stat-value" id="result-calories" style="font-size: 1.1em; font-weight: bold; color: #00d4aa; text-shadow: 0 0 8px rgba(0, 212, 170, 0.4);">0kcal</div>
                </div>
            </div>
            <!-- ë§ˆì¼ë¦¬ì§€ ì •ë³´ (ì£¼í™©ìƒ‰í†¤) - ëª¨ë°”ì¼ê³¼ ë™ì¼ -->
            <div class="result-stats" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 16px; margin-top: 8px;">
                <div class="result-stat-item" style="background: rgba(251, 146, 60, 0.1); border: 1px solid rgba(251, 146, 60, 0.3); border-radius: 6px; padding: 6px 8px; text-align: center;">
                    <div class="result-stat-label" style="font-size: 0.7em; color: #aaa; margin-bottom: 3px; font-weight: 500;">ëˆ„ì  í¬ì¸íŠ¸</div>
                    <div class="result-stat-value" id="result-acc-points" style="font-size: 1.1em; font-weight: bold; color: #fb923c; text-shadow: 0 0 8px rgba(251, 146, 60, 0.4);">0</div>
                </div>
                <div class="result-stat-item" style="background: rgba(251, 146, 60, 0.1); border: 1px solid rgba(251, 146, 60, 0.3); border-radius: 6px; padding: 6px 8px; text-align: center;">
                    <div class="result-stat-label" style="font-size: 0.7em; color: #aaa; margin-bottom: 3px; font-weight: 500;">ë³´ìœ  í¬ì¸íŠ¸</div>
                    <div class="result-stat-value" id="result-rem-points" style="font-size: 1.1em; font-weight: bold; color: #fb923c; text-shadow: 0 0 8px rgba(251, 146, 60, 0.4);">0</div>
                </div>
                <div class="result-stat-item" style="background: rgba(251, 146, 60, 0.1); border: 1px solid rgba(251, 146, 60, 0.3); border-radius: 6px; padding: 6px 8px; text-align: center;">
                    <div class="result-stat-label" style="font-size: 0.7em; color: #aaa; margin-bottom: 3px; font-weight: 500;">íšë“ í¬ì¸íŠ¸</div>
                    <div class="result-stat-value" id="result-earned-points" style="font-size: 1.1em; font-weight: bold; color: #fb923c; text-shadow: 0 0 8px rgba(251, 146, 60, 0.4);">0</div>
                </div>
            </div>
            <button class="result-close-btn" onclick="closeTrainingResultModal()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #00d4aa 0%, #00a88a 100%); border: none; border-radius: 8px; color: #000; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 212, 170, 0.4);">í™•ì¸</button>
            </div>
        </div>
    </div>
    
    <!-- ì¶•í•˜ ì˜¤ë²„ë ˆì´ (ë§ˆì¼ë¦¬ì§€ ì—°ì¥ ì‹œ) - ëª¨ë°”ì¼ê³¼ ë™ì¼í•œ ë””ìì¸ -->
    <div id="bluetoothMileageCelebrationModal" class="bluetooth-mileage-celebration-modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: none; align-items: center; justify-content: center; z-index: 10001; animation: fadeIn 0.5s ease-out;">
      <div class="celebration-content" style="position: relative; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ffd700 100%); border: 3px solid #ffd700; border-radius: 20px; padding: 30px 25px; max-width: 90%; width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(255, 215, 0, 0.5), 0 0 100px rgba(255, 107, 53, 0.3); animation: celebrationPulse 2s ease-in-out infinite; transform-origin: center;">
        <div class="celebration-icon" style="font-size: 4em; margin-bottom: 15px; animation: celebrationBounce 1s ease-in-out infinite; filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));">ğŸ‰</div>
        <h2 class="celebration-title" style="font-size: 1.4em; font-weight: bold; color: #fff; margin: 0 0 15px 0; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); line-height: 1.3;">ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
        <div class="celebration-message" id="bluetooth-celebration-message" style="font-size: 1em; color: #fff; line-height: 1.6; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);">
        </div>
        <button class="celebration-close-btn" onclick="closeBluetoothMileageCelebration()" style="width: 100%; padding: 14px; background: rgba(255, 255, 255, 0.95); border: 2px solid #ffd700; border-radius: 10px; color: #ff6b35; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);">í™•ì¸</button>
      </div>
    </div>

    <!-- Firebase v9 Modular SDK (í›ˆë ¨ ê²°ê³¼ ì €ì¥ìš©) -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
      import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
      
      const firebaseConfig = {
        apiKey: "AIzaSyDVQJZV6NIbqhPdz1CKfbA8yHHYClSC35Q",
        authDomain: "stelvio-ai.firebaseapp.com",
        projectId: "stelvio-ai",
        storageBucket: "stelvio-ai.firebasestorage.app",
        messagingSenderId: "752285835508",
        appId: "1:752285835508:web:0662a24874209ebb483ea1"
      };
      
      try {
        const appV9 = initializeApp(firebaseConfig, 'bluetoothIndividualV9');
        window.firestoreV9 = getFirestore(appV9);
        console.log('âœ… Bluetooth ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ - Firebase v9 Modular SDK ì´ˆê¸°í™” ì™„ë£Œ');
      } catch (error) {
        console.error('âŒ Bluetooth ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ - Firebase v9 ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      }
    </script>
    
    <!-- í›ˆë ¨ ê²°ê³¼ ì €ì¥ ì„œë¹„ìŠ¤ (Firebase Firestore v9) -->
    <script type="module">
      import { saveTrainingSession, getUserTrainingLogs } from './assets/js/trainingResultService.js';
      
      // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
      window.saveTrainingSession = async (userId, trainingData) => {
        return await saveTrainingSession(userId, trainingData, window.firestoreV9);
      };
      
      // ì‚¬ìš©ì í›ˆë ¨ ë¡œê·¸ ì¡°íšŒ í•¨ìˆ˜ ë…¸ì¶œ
      window.getUserTrainingLogs = async (userId, options) => {
        return await getUserTrainingLogs(userId, options, window.firestoreV9);
      };
      
      console.log('âœ… Bluetooth ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ - í›ˆë ¨ ê²°ê³¼ ì €ì¥ ì„œë¹„ìŠ¤ ë¡œë“œ ì™„ë£Œ (Subcollection êµ¬ì¡°)');
    </script>
    
    <script src="assets/js/workoutManager.js"></script>
    <script src="assets/js/resultManager.js"></script>
    
    <!-- í™”ë©´ ì ê¸ˆ ë°©ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // í™”ë©´ ì ê¸ˆ ë°©ì§€ (Screen Wake Lock API)
        let wakeLock = null;
        let wakeLockVideo = null;
        let videoWakeLockInterval = null;
        const wakeLockSupported = 'wakeLock' in navigator;
        
        // iOS, ì•ˆë“œë¡œì´ë“œ ë° í¬ë¡¬ ë¸Œë¼ìš°ì € ê°ì§€
        function isIOS() {
            const ua = navigator.userAgent || '';
            return /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
        
        function isAndroid() {
            const ua = navigator.userAgent || '';
            return /Android/.test(ua);
        }
        
        function isChrome() {
            const ua = navigator.userAgent || '';
            return /Chrome/.test(ua) && !/Edge|OPR|Edg/.test(ua);
        }
        
        // ëª¨ë°”ì¼ í¬ë¡¬ ë¸Œë¼ìš°ì € ê°ì§€ (iOS ë˜ëŠ” ì•ˆë“œë¡œì´ë“œ)
        function isMobileChrome() {
            return (isIOS() || isAndroid()) && isChrome();
        }
        
        // Bluefy ì•± ê°ì§€ (iOS)
        function isBluefy() {
            const ua = navigator.userAgent || '';
            return /Bluefy/i.test(ua);
        }
        
        // Wake Lock API ì‚¬ìš©
        async function requestWakeLock() {
            // ëª¨ë°”ì¼ í¬ë¡¬(iOS/ì•ˆë“œë¡œì´ë“œ) ë˜ëŠ” Bluefyì—ì„œëŠ” ë¹„ë””ì˜¤ íŠ¸ë¦­ì„ ìš°ì„  ì‚¬ìš© (ë” ì•ˆì •ì )
            if (isMobileChrome() || (isIOS() && isBluefy())) {
                const deviceType = isIOS() ? 'iOS' : 'Android';
                const appType = isBluefy() ? ' (Bluefy)' : '';
                console.log(`[Screen Wake Lock] ${deviceType}${appType} ê°ì§€ - ë¹„ë””ì˜¤ íŠ¸ë¦­ ì‚¬ìš©`);
                if (!wakeLockVideo) {
                    startVideoWakeLock();
                }
                return;
            }
            
            if (wakeLockSupported) {
                try {
                    // ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¬ìš”ì²­í•˜ì§€ ì•ŠìŒ
                    if (wakeLock) return;
                    
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('[Screen Wake Lock] í™”ë©´ ì ê¸ˆ ë°©ì§€ í™œì„±í™”');
                    
                    // ì‹œìŠ¤í…œì´ í•´ì œí–ˆì„ ë•Œ í”Œë˜ê·¸ ì •ë¦¬
                    wakeLock.addEventListener('release', () => {
                        console.log('[Screen Wake Lock] ì‹œìŠ¤í…œì— ì˜í•´ í•´ì œë¨');
                        wakeLock = null;
                        // ë‹¤ì‹œ ìš”ì²­ ì‹œë„
                        if (document.visibilityState === 'visible') {
                            requestWakeLock();
                        }
                    });
                    
                    // ëª¨ë°”ì¼(iOS/ì•ˆë“œë¡œì´ë“œ)ì—ì„œëŠ” Wake Lockì´ ì„±ê³µí•´ë„ ë¹„ë””ì˜¤ íŠ¸ë¦­ë„ í•¨ê»˜ ì‚¬ìš© (ì´ì¤‘ ë³´ì¥)
                    if ((isIOS() || isAndroid()) && !wakeLockVideo) {
                        startVideoWakeLock();
                    }
                } catch (err) {
                    console.warn('[Screen Wake Lock] í™œì„±í™” ì‹¤íŒ¨:', err);
                    // Wake Lockì´ ì‹¤íŒ¨í•˜ë©´ ë¹„ë””ì˜¤ íŠ¸ë¦­ ì‚¬ìš©
                    if (!wakeLockVideo) {
                        startVideoWakeLock();
                    }
                }
            } else {
                // Wake Lock API ë¯¸ì§€ì› ì‹œ ë¹„ë””ì˜¤ íŠ¸ë¦­ ì‚¬ìš©
                if (!wakeLockVideo) {
                    startVideoWakeLock();
                }
            }
        }
        
        // ë¹„ë””ì˜¤ íŠ¸ë¦­ ì‚¬ìš© (iOS Safari ë° êµ¬í˜• ë¸Œë¼ìš°ì € ëŒ€ì‘)
        function startVideoWakeLock() {
            try {
                // ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆìœ¼ë©´ ì¬ìƒì„±í•˜ì§€ ì•ŠìŒ
                if (wakeLockVideo) return;
                
                // í›ˆë ¨ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ ë¹„ë””ì˜¤ íŠ¸ë¦­ í™œì„±í™”
                const isTrainingRunning = window.currentTrainingState === 'running';
                if (!isTrainingRunning) {
                    console.log('[Video Wake Lock] í›ˆë ¨ ì§„í–‰ ì¤‘ì´ ì•„ë‹ˆë¯€ë¡œ ë¹„ë””ì˜¤ íŠ¸ë¦­ ë¹„í™œì„±í™”');
                    return;
                }
                
                // Canvasë¡œ ìµœì†Œ í¬ê¸°ì˜ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìƒì„±
                const canvas = document.createElement('canvas');
                canvas.width = 2;
                canvas.height = 2;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 2, 2);
                
                // Canvasë¥¼ MediaStreamìœ¼ë¡œ ë³€í™˜ (iOS í¬ë¡¬ ëŒ€ì‘ì„ ìœ„í•´ 30fps ì‚¬ìš©)
                const stream = canvas.captureStream(30);
                
                // íˆ¬ëª…í•œ ë¹„ë””ì˜¤ ìš”ì†Œ ìƒì„±
                wakeLockVideo = document.createElement('video');
                wakeLockVideo.setAttribute('playsinline', '');
                wakeLockVideo.setAttribute('muted', '');
                wakeLockVideo.setAttribute('loop', '');
                wakeLockVideo.setAttribute('webkit-playsinline', '');
                wakeLockVideo.setAttribute('autoplay', '');
                wakeLockVideo.style.position = 'fixed';
                wakeLockVideo.style.top = '0';
                wakeLockVideo.style.left = '0';
                wakeLockVideo.style.width = '1px';
                wakeLockVideo.style.height = '1px';
                wakeLockVideo.style.opacity = '0';
                wakeLockVideo.style.pointerEvents = 'none';
                wakeLockVideo.style.zIndex = '-9999';
                
                // ìŠ¤íŠ¸ë¦¼ì„ ë¹„ë””ì˜¤ì— ì—°ê²°
                wakeLockVideo.srcObject = stream;
                document.body.appendChild(wakeLockVideo);
                
                // ë¹„ë””ì˜¤ ì¬ìƒ í•¨ìˆ˜ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
                const playVideo = () => {
                    const playPromise = wakeLockVideo.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('[Video Wake Lock] í™”ë©´ ì ê¸ˆ ë°©ì§€ í™œì„±í™” (ë¹„ë””ì˜¤ íŠ¸ë¦­)');
                        }).catch(err => {
                            console.warn('[Video Wake Lock] ì¬ìƒ ì‹¤íŒ¨, ì¬ì‹œë„:', err);
                            // ì¬ìƒ ì‹¤íŒ¨ ì‹œ ì ì‹œ í›„ ì¬ì‹œë„
                            setTimeout(playVideo, 1000);
                        });
                    }
                };
                
                // ì´ˆê¸° ì¬ìƒ ì‹œë„
                playVideo();
                
                // ëª¨ë°”ì¼(iOS/ì•ˆë“œë¡œì´ë“œ)ì—ì„œëŠ” ì£¼ê¸°ì ìœ¼ë¡œ ë¹„ë””ì˜¤ ì¬ìƒ ìƒíƒœ í™•ì¸ ë° ì¬ì‹œì‘ (í¬ë¡¬ ëŒ€ì‘)
                if (isIOS() || isAndroid()) {
                    if (videoWakeLockInterval) {
                        clearInterval(videoWakeLockInterval);
                    }
                    videoWakeLockInterval = setInterval(() => {
                        if (wakeLockVideo && (wakeLockVideo.paused || wakeLockVideo.ended)) {
                            console.log('[Video Wake Lock] ë¹„ë””ì˜¤ê°€ ì¼ì‹œì •ì§€ë¨, ì¬ì‹œì‘');
                            playVideo();
                        }
                    }, 5000); // 5ì´ˆë§ˆë‹¤ í™•ì¸
                }
            } catch (err) {
                console.warn('[Video Wake Lock] ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
            }
        }
        
        // í™”ë©´ ì ê¸ˆ í•´ì œ
        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                    console.log('[Screen Wake Lock] í™”ë©´ ì ê¸ˆ ë°©ì§€ í•´ì œ');
                }).catch(err => {
                    console.warn('[Screen Wake Lock] í•´ì œ ì‹¤íŒ¨:', err);
                    wakeLock = null;
                });
            }
            
            // ë¹„ë””ì˜¤ íŠ¸ë¦­ ì£¼ê¸°ì  í™•ì¸ ì¤‘ì§€
            if (videoWakeLockInterval !== null) {
                clearInterval(videoWakeLockInterval);
                videoWakeLockInterval = null;
            }
            
            if (wakeLockVideo !== null) {
                try {
                    if (wakeLockVideo.srcObject) {
                        wakeLockVideo.srcObject.getTracks().forEach(track => track.stop());
                        wakeLockVideo.srcObject = null;
                    }
                    wakeLockVideo.pause();
                    if (wakeLockVideo.parentNode) {
                        wakeLockVideo.parentNode.removeChild(wakeLockVideo);
                    }
                    wakeLockVideo = null;
                    console.log('[Video Wake Lock] í™”ë©´ ì ê¸ˆ ë°©ì§€ í•´ì œ (ë¹„ë””ì˜¤ íŠ¸ë¦­)');
                } catch (err) {
                    console.warn('[Video Wake Lock] í•´ì œ ì‹¤íŒ¨:', err);
                }
            }
        }
        
        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ì¬ìš”ì²­ (í›ˆë ¨ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ)
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                // í›ˆë ¨ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ Wake Lock ì¬ìš”ì²­
                const isTrainingRunning = window.currentTrainingState === 'running';
                if (isTrainingRunning) {
                    // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ë©´ Wake Lock ì¬ìš”ì²­
                    if (wakeLockSupported && !wakeLock) {
                        await requestWakeLock();
                    }
                    // ë¹„ë””ì˜¤ íŠ¸ë¦­ë„ ì¬ì‹œì‘
                    if (wakeLockVideo && wakeLockVideo.paused) {
                        wakeLockVideo.play().catch(err => {
                            console.warn('[Video Wake Lock] ì¬ì‹œì‘ ì‹¤íŒ¨:', err);
                        });
                    }
                }
            }
        });
        
        // Pull-to-refresh ë°©ì§€ ì´ˆê¸°í™” (Bluefy/iOS ê°•í™” ë²„ì „)
        function initializeIndividualDashboardPullToRefreshPrevention() {
            const body = document.body;
            if (!body) return;
            
            // iOS/Bluefy ê°ì§€
            function isIOS() {
                const ua = navigator.userAgent || '';
                return /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }
            
            function isBluefy() {
                const ua = navigator.userAgent || '';
                return /Bluefy/i.test(ua);
            }
            
            const isIOSDevice = isIOS();
            const isBluefyApp = isBluefy();
            
            let touchStartY = 0;
            let touchStartTime = 0;
            let isScrolling = false;
            let lastScrollY = 0;
            
            // í›ˆë ¨ ì¤‘ì¸ì§€ í™•ì¸
            function isTrainingActive() {
                return window.trainingState && window.trainingState.timerId !== null;
            }
            
            // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ í™•ì¸ (ë” ì •í™•í•œ ë°©ë²•)
            function isAtTop() {
                // window.scrollYê°€ 0ì´ê±°ë‚˜, bodyì˜ scrollTopì´ 0ì¸ ê²½ìš°
                return (window.scrollY === 0 || window.scrollY <= 1) && 
                       (document.documentElement.scrollTop === 0 || document.documentElement.scrollTop <= 1);
            }
            
            // í„°ì¹˜ ì‹œì‘
            const touchStartHandler = (e) => {
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
                isScrolling = false;
                lastScrollY = window.scrollY || document.documentElement.scrollTop || 0;
            };
            
            // í„°ì¹˜ ì´ë™ ì¤‘ - iOS/Bluefyì—ì„œëŠ” ë” ì ê·¹ì ìœ¼ë¡œ ì°¨ë‹¨
            const touchMoveHandler = (e) => {
                if (!e.touches || e.touches.length === 0) return;
                
                const touchY = e.touches[0].clientY;
                const deltaY = touchY - touchStartY;
                const currentScrollY = window.scrollY || document.documentElement.scrollTop || 0;
                
                // ìŠ¤í¬ë¡¤ ì¤‘ì¸ì§€ í™•ì¸
                if (Math.abs(currentScrollY - lastScrollY) > 1) {
                    isScrolling = true;
                }
                lastScrollY = currentScrollY;
                
                // í›ˆë ¨ ì¤‘ì´ê³ , ìŠ¤í¬ë¡¤ì´ ë§¨ ìœ„ì— ìˆê³ , ì•„ë˜ë¡œ ë‹¹ê¸°ëŠ” ë™ì‘ì¼ ë•Œ
                if (isTrainingActive() && isAtTop() && deltaY > 0 && !isScrolling) {
                    // iOS/Bluefyì—ì„œëŠ” ë” ì¼ì° ì°¨ë‹¨ (10px ì´ìƒë§Œ)
                    const threshold = (isIOSDevice || isBluefyApp) ? 10 : 30;
                    if (deltaY > threshold) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }
                
                // iOS/Bluefyì—ì„œ í›ˆë ¨ ì¤‘ì¼ ë•ŒëŠ” ì•„ë˜ë¡œ ë‹¹ê¸°ëŠ” ëª¨ë“  ë™ì‘ ì°¨ë‹¨ (ë” ê°•ë ¥)
                if ((isIOSDevice || isBluefyApp) && isTrainingActive() && isAtTop() && deltaY > 5) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            };
            
            // í„°ì¹˜ ì¢…ë£Œ
            const touchEndHandler = (e) => {
                touchStartY = 0;
                touchStartTime = 0;
                isScrolling = false;
            };
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (capture phaseì—ì„œë„ ì²˜ë¦¬)
            body.addEventListener('touchstart', touchStartHandler, { passive: true, capture: true });
            body.addEventListener('touchmove', touchMoveHandler, { passive: false, capture: true });
            body.addEventListener('touchend', touchEndHandler, { passive: true, capture: true });
            
            // document ë ˆë²¨ì—ì„œë„ ì°¨ë‹¨ (Bluefy ëŒ€ì‘)
            document.addEventListener('touchmove', (e) => {
                // í›ˆë ¨ ì¤‘ì´ê³  ìŠ¤í¬ë¡¤ì´ ë§¨ ìœ„ì— ìˆì„ ë•Œ
                if (isTrainingActive() && isAtTop()) {
                    const touchY = e.touches && e.touches[0] ? e.touches[0].clientY : 0;
                    const deltaY = touchY - touchStartY;
                    
                    // ì•„ë˜ë¡œ ë‹¹ê¸°ëŠ” ë™ì‘ ì°¨ë‹¨
                    if (deltaY > 5 && (isIOSDevice || isBluefyApp)) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }
            }, { passive: false, capture: true });
            
            // beforeunload ì´ë²¤íŠ¸ë¡œ ìƒˆë¡œê³ ì¹¨ ë°©ì§€ (í›ˆë ¨ ì¤‘ì¼ ë•Œ)
            window.addEventListener('beforeunload', (e) => {
                if (isTrainingActive()) {
                    e.preventDefault();
                    e.returnValue = 'í›ˆë ¨ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
                    return e.returnValue;
                }
            });
            
            console.log('[Bluetooth Individual Dashboard] Pull-to-refresh ë°©ì§€ ì´ˆê¸°í™” ì™„ë£Œ', {
                isIOS: isIOSDevice,
                isBluefy: isBluefyApp,
                trainingActive: isTrainingActive()
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í™”ë©´ ì ê¸ˆ ë°©ì§€ ì‹œì‘ (í›ˆë ¨ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ)
        document.addEventListener('DOMContentLoaded', () => {
            // Pull-to-refresh ë°©ì§€ ì´ˆê¸°í™”
            initializeIndividualDashboardPullToRefreshPrevention();
            
            // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì—ë§Œ í™œì„±í™” (ë¸Œë¼ìš°ì € ì •ì±…)
            const activateWakeLock = () => {
                // í›ˆë ¨ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ í™œì„±í™”
                const isTrainingRunning = window.currentTrainingState === 'running';
                if (isTrainingRunning) {
                    requestWakeLock();
                }
            };
            
            // ì²« í„°ì¹˜/í´ë¦­ ì‹œ í™œì„±í™” (í›ˆë ¨ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ)
            document.addEventListener('touchstart', activateWakeLock, { once: true, passive: true });
            document.addEventListener('click', activateWakeLock, { once: true });
            document.addEventListener('pointerdown', activateWakeLock, { once: true, passive: true });
        });
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ í•´ì œ
        window.addEventListener('beforeunload', releaseWakeLock);
        window.addEventListener('pagehide', releaseWakeLock);
        
        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (í•„ìš”ì‹œ ìˆ˜ë™ ì œì–´ ê°€ëŠ¥)
        window.wakeLockControl = {
            request: requestWakeLock,
            release: releaseWakeLock
        };
    </script>
    
    <script src="assets/js/bluetooth.js"></script>
    <script src="assets/js/ErgController.js"></script>
    <script src="assets/js/bluetoothIndividual.js"></script>
</body>
</html>
