<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="STELVIO AI - Performance Dashboard">
  <title>STELVIO AI - Performance Dashboard</title>
  
  <!-- Tailwind / Babel CDN Í≤ΩÍ≥† ÌïÑÌÑ∞ (Î∞òÎìúÏãú ÏµúÏÉÅÎã®, CDN Î°úÎìú Ï†Ñ) -->
  <script>
    (function() {
      if (typeof console === 'undefined' || !console.warn) return;
      var orig = console.warn;
      console.warn = function() {
        var msg = (arguments[0] && String(arguments[0])) || '';
        if (msg.indexOf('cdn.tailwindcss.com') !== -1 || msg.indexOf('Tailwind CSS') !== -1 && msg.indexOf('production') !== -1 ||
            msg.indexOf('in-browser Babel') !== -1 || msg.indexOf('precompile your scripts') !== -1 || (msg.indexOf('Babel') !== -1 && msg.indexOf('production') !== -1)) {
          return;
        }
        return orig.apply(console, arguments);
      };
    })();
  </script>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone (JSX Î≥ÄÌôòÏö©) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Chart.js (Ï∞®Ìä∏ ÎùºÏù¥Î∏åÎü¨Î¶¨) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="assets/js/firebaseConfig.js"></script>
  
  <!-- ÌîÑÎ°úÏ†ùÌä∏ Ïä§ÌÅ¨Î¶ΩÌä∏ (assets/js/) -->
  <script src="assets/js/stravaManager.js"></script>
  <script src="assets/js/userManager.js"></script>
  
  <!-- Dashboard Ï†ÑÏö©: Gemini ÏΩîÏπò ÌîÑÎ°¨ÌîÑÌä∏ Î∞è API (Ïù∏ÎùºÏù∏, 404 Î∞©ÏßÄ) -->
  <script>
    window.GEMINI_COACH_SYSTEM_PROMPT = `Role: ÎãπÏã†ÏùÄ 'Stelvio AI'Ïùò ÏàòÏÑù ÏÇ¨Ïù¥ÌÅ¥ÎßÅ ÏΩîÏπòÏù¥Ïûê Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÍ∞ÄÏûÖÎãàÎã§.
Context: ÏÇ¨Ïö©ÏûêÏùò ÌîÑÎ°úÌïÑ({{userProfile}})Í≥º ÏµúÍ∑º 30ÏùºÍ∞ÑÏùò ÌõàÎ†® Î°úÍ∑∏({{recentLogs}})Î•º Î∂ÑÏÑùÌïòÏó¨ JSON ÌòïÏãùÏúºÎ°ú Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º Ï†úÍ≥µÌï¥Ïïº Ìï©ÎãàÎã§.
Task Requirements:
1. **Condition Score (0~100):** TSB(Training Stress Balance)ÏôÄ ÏµúÍ∑º Ïö¥Îèô Í∞ïÎèÑÎ•º Í∏∞Î∞òÏúºÎ°ú Ïª®ÎîîÏÖò Ï†êÏàòÎ•º ÏÇ∞Ï∂úÌïòÏÑ∏Ïöî.
2. **Training Status:** ÌòÑÏû¨ ÏÉÅÌÉúÎ•º Ìïú Îã®Ïñ¥Î°ú Ï†ïÏùòÌïòÏÑ∏Ïöî (Ïòà: "Ready to Race", "Recovery Needed", "Building Base", "Peaking").
3. **Coach Comment:** ÏÇ¨Ïö©ÏûêÏùò Ïù¥Î¶Ñ({{userName}})ÏùÑ Î∂ÄÎ•¥Î©∞, ÏµúÍ∑º ÌõàÎ†® ÏÑ±Í≥º(FTP Î≥ÄÌôî, TSS ÎàÑÏ†Å Îì±)Î•º Ïñ∏Í∏âÌïòÍ≥† ÎèôÍ∏∞Î•º Î∂ÄÏó¨ÌïòÎäî Îî∞ÎúªÌïú Ï°∞Ïñ∏ÏùÑ ÌïúÍµ≠Ïñ¥(Í≤ΩÏñ¥Ï≤¥)Î°ú Ìïú Î¨∏Ïû• ÏûëÏÑ±ÌïòÏÑ∏Ïöî.
4. **VO2max Estimate:** ÌååÏõå Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú Ï∂îÏ†ïÎêú VO2max Í∞íÏùÑ Ï†ïÏàòÎ°ú Î∞òÌôòÌïòÏÑ∏Ïöî.
5. **Recommended Workout:** Ïò§Îäò ÏàòÌñâÌï¥Ïïº Ìï† Ï∂îÏ≤ú ÌõàÎ†® ÌÉÄÏûÖÏùÑ Ï†úÏïàÌïòÏÑ∏Ïöî.
Output Format (JSON Only):
{ "condition_score": 85, "training_status": "Ready to Race", "vo2max_estimate": 54, "coach_comment": "ÏßÄÏÑ±Îãò, Ïù¥Î≤à Ï£º TSS Î™©ÌëúÎ•º Í±∞Ïùò Îã¨ÏÑ±ÌïòÏÖ®ÎÑ§Ïöî! Ïò§ÎäòÏùÄ Í∞ÄÎ≤ºÏö¥ Î¶¨Ïª§Î≤ÑÎ¶¨Î°ú Ïª®ÎîîÏÖòÏùÑ Ï°∞Ï†àÌïòÏÑ∏Ïöî.", "recommended_workout": "Active Recovery (Z1)" }`;
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
    }
    async function callGeminiCoach(userProfile, recentLogs) {
      var apiKey;
      try {
        apiKey = localStorage.getItem('geminiApiKey');
      } catch (e) {
        apiKey = null;
      }
      if (!apiKey) throw new Error('Gemini API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÌôòÍ≤Ω ÏÑ§Ï†ïÏóêÏÑú API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      var prompt = (window.GEMINI_COACH_SYSTEM_PROMPT || '')
        .replace('{{userProfile}}', JSON.stringify(userProfile, null, 2))
        .replace('{{recentLogs}}', JSON.stringify(recentLogs || [], null, 2))
        .replace('{{userName}}', (userProfile && userProfile.name) || 'ÏÇ¨Ïö©Ïûê');
      var modelName = localStorage.getItem('geminiModelName') || 'gemini-2.5-flash';
      var apiVersion = localStorage.getItem('geminiApiVersion') || 'v1beta';
      var url = 'https://generativelanguage.googleapis.com/' + apiVersion + '/models/' + modelName + ':generateContent?key=' + apiKey;
      var body = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { maxOutputTokens: 2048, temperature: 0.7, topP: 0.8, topK: 40 } };
      var timeoutMs = isMobile() ? 45000 : 25000;
      var lastErr = null;
      for (var attempt = 0; attempt < 3; attempt++) {
        try {
          var controller = new AbortController();
          var timeoutId = setTimeout(function() { controller.abort(); }, timeoutMs);
          var res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body), signal: controller.signal });
          clearTimeout(timeoutId);
          
          if (!res.ok) {
            var errBody = await res.text();
            var errMsg = '';
            try {
              var ed = JSON.parse(errBody);
              errMsg = (ed.error && ed.error.message) || errBody;
            } catch (e2) { errMsg = errBody.substring(0, 200); }
            throw new Error('Gemini API Ïò§Î•ò (' + res.status + '): ' + errMsg);
          }
          
          var data = await res.json();
          if (!data || !data.candidates || !Array.isArray(data.candidates) || data.candidates.length === 0) {
            throw new Error('Gemini API ÏùëÎãµÏóê candidatesÍ∞Ä ÏóÜÏäµÎãàÎã§.');
          }
          var candidate = data.candidates[0];
          if (candidate.finishReason === 'SAFETY') {
            throw new Error('Gemini APIÍ∞Ä ÏïàÏ†Ñ Ï†ïÏ±ÖÏúºÎ°ú ÏùëÎãµÏùÑ Ï∞®Îã®ÌñàÏäµÎãàÎã§.');
          }
          if (!candidate.content || !candidate.content.parts || !candidate.content.parts[0]) {
            throw new Error('Gemini API ÏùëÎãµÏóê content.partsÍ∞Ä ÏóÜÏäµÎãàÎã§.');
          }
          var text = (candidate.content.parts[0].text || '').trim();
          if (!text) throw new Error('Gemini API ÏùëÎãµÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
          if (text.indexOf('```') === 0) {
            text = text.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '');
          }
          var result = JSON.parse(text);
          return {
            condition_score: (typeof result.condition_score === 'number') ? Math.max(0, Math.min(100, result.condition_score)) : 50,
            training_status: result.training_status || 'Building Base',
            vo2max_estimate: (typeof result.vo2max_estimate === 'number') ? Math.max(20, Math.min(100, result.vo2max_estimate)) : 40,
            coach_comment: result.coach_comment || ((userProfile && userProfile.name) || 'ÏÇ¨Ïö©Ïûê') + 'Îãò, Ïò§ÎäòÎèÑ ÌôîÏù¥ÌåÖÌïòÏÑ∏Ïöî!',
            recommended_workout: result.recommended_workout || 'Active Recovery (Z1)'
          };
        } catch (e) {
          lastErr = e;
          if (attempt < 2) {
            await new Promise(function(r) { setTimeout(r, 2000); });
          }
        }
      }
      console.warn('[callGeminiCoach] Ïû¨ÏãúÎèÑ 3Ìöå ÌõÑ Ïã§Ìå® (Î™®Î∞îÏùº Í∞ÄÎä•ÏÑ±):', lastErr ? lastErr.message : 'unknown');
      return {
        condition_score: 50,
        training_status: 'Building Base',
        vo2max_estimate: 40,
        coach_comment: ((userProfile && userProfile.name) || 'ÏÇ¨Ïö©Ïûê') + 'Îãò, Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë ÏùºÏãúÏ†ÅÏù∏ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.',
        recommended_workout: 'Active Recovery (Z1)'
      };
    }
    window.callGeminiCoach = callGeminiCoach;
  </script>
  
  <style>
    /* Ïä§ÌÅ¨Î°§Î∞î Ïà®ÍπÄ - Ï†ÑÏ≤¥(html/body) Î∞è .scrollbar-hide */
    html, body {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    html::-webkit-scrollbar, body::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    
    /* Circular Progress Bar Ïï†ÎãàÎ©îÏù¥ÏÖò */
    @keyframes progress {
      from {
        stroke-dashoffset: 283;
      }
    }
    
    .circular-progress {
      animation: progress 1s ease-out;
    }
    
    /* Skeleton UI Ïï†ÎãàÎ©îÏù¥ÏÖò */
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }
    
    .skeleton {
      background: linear-gradient(
        90deg,
        #f0f0f0 0px,
        #e0e0e0 40px,
        #f0f0f0 80px
      );
      background-size: 1000px;
      animation: shimmer 2s infinite;
    }
  </style>
</head>
<body class="bg-gray-50 scrollbar-hide">
  <script>
    window.__dashboardUserFromParent = null;
    window.addEventListener('message', function (e) {
      if (e.data && e.data.type === 'DASHBOARD_USER' && e.data.user) {
        window.__dashboardUserFromParent = e.data.user;
      }
    });
  </script>
  <div id="dashboard-root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // DashboardCard Ïª¥Ìè¨ÎÑåÌä∏
    function DashboardCard({ title, children, className = "" }) {
      return (
        <div className={`bg-white rounded-2xl p-4 shadow-sm border border-gray-100 ${className}`}>
          {title && (
            <h3 className="text-sm font-semibold text-gray-600 mb-3">{title}</h3>
          )}
          {children}
        </div>
      );
    }
    
    // Training Trend Chart Ïª¥Ìè¨ÎÑåÌä∏ (Chart.js ÏÇ¨Ïö©)
    function TrainingTrendChart({ data }) {
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);
      
      useEffect(() => {
        if (!data || data.length === 0) return;
        
        const ctx = chartRef.current?.getContext('2d');
        if (!ctx) return;
        
        // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
        if (chartInstanceRef.current) {
          chartInstanceRef.current.destroy();
        }
        
        // Chart.jsÎ°ú Ï∞®Ìä∏ ÏÉùÏÑ±
        chartInstanceRef.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => d.date),
            datasets: [
              {
                label: 'Fitness',
                data: data.map(d => d.fitness),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointBackgroundColor: '#3b82f6'
              },
              {
                label: 'Fatigue',
                data: data.map(d => d.fatigue),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointBackgroundColor: '#ef4444'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  usePointStyle: true,
                  padding: 15,
                  font: {
                    size: 12
                  }
                }
              },
              tooltip: {
                backgroundColor: 'white',
                borderColor: '#e5e7eb',
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                titleFont: {
                  size: 13,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 12
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: true,
                  color: '#e5e7eb',
                  drawBorder: false
                },
                ticks: {
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                }
              },
              y: {
                grid: {
                  display: true,
                  color: '#e5e7eb',
                  drawBorder: false
                },
                ticks: {
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                },
                beginAtZero: true
              }
            }
          }
        });
        
        // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Ï∞®Ìä∏ Ï†ïÎ¶¨
        return () => {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
            chartInstanceRef.current = null;
          }
        };
      }, [data]);
      
      if (!data || data.length === 0) {
        return (
          <DashboardCard title="ÌõàÎ†® Ìä∏Î†åÎìú (ÏµúÍ∑º 7Ïùº)">
            <div className="h-[200px] flex items-center justify-center text-gray-400 text-sm">
              Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§
            </div>
          </DashboardCard>
        );
      }
      
      return (
        <DashboardCard title="ÌõàÎ†® Ìä∏Î†åÎìú (ÏµúÍ∑º 7Ïùº)">
          <div className="h-[200px]">
            <canvas ref={chartRef}></canvas>
          </div>
        </DashboardCard>
      );
    }
    
    // Circular Progress Ïª¥Ìè¨ÎÑåÌä∏
    function CircularProgress({ value, max = 100, size = 120, strokeWidth = 8 }) {
      const percentage = Math.min((value / max) * 100, 100);
      const radius = (size - strokeWidth) / 2;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (percentage / 100) * circumference;
      
      const getColor = () => {
        if (percentage >= 80) return '#10b981'; // green
        if (percentage >= 60) return '#3b82f6'; // blue
        if (percentage >= 40) return '#f59e0b'; // amber
        return '#ef4444'; // red
      };
      
      return (
        <div className="relative inline-flex items-center justify-center" style={{ width: size, height: size }}>
          <svg width={size} height={size} className="transform -rotate-90">
            {/* Î∞∞Í≤Ω Ïõê */}
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              stroke="#e5e7eb"
              strokeWidth={strokeWidth}
              fill="none"
            />
            {/* ÏßÑÌñâ Ïõê */}
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              stroke={getColor()}
              strokeWidth={strokeWidth}
              fill="none"
              strokeDasharray={circumference}
              strokeDashoffset={offset}
              strokeLinecap="round"
              className="circular-progress transition-all duration-500"
            />
          </svg>
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="text-center">
              <div className="text-3xl font-bold" style={{ color: getColor() }}>
                {Math.round(value)}
              </div>
              <div className="text-xs text-gray-500">Ï†ê</div>
            </div>
          </div>
        </div>
      );
    }
    
    // Î©îÏù∏ Dashboard Ïª¥Ìè¨ÎÑåÌä∏
    function PerformanceDashboard() {
      const [userProfile, setUserProfile] = useState(null);
      const [coachData, setCoachData] = useState(null);
      const [recentLogs, setRecentLogs] = useState([]);
      const [loading, setLoading] = useState(true);
      const [stats, setStats] = useState({
        ftp: 0,
        wkg: 0,
        weight: 0,
        totalPoints: 0,
        currentPoints: 0,
        weeklyGoal: 0,
        weeklyProgress: 0
      });
      const [aiPairingStatus, setAiPairingStatus] = useState(false);
      const [stravaStatus, setStravaStatus] = useState({ connected: false, lastSync: null });
      const [fitnessData, setFitnessData] = useState([]);
      
      // ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ Î°úÎìú: URL/postMessage/localStorage Ï¶âÏãú ÌëúÏãú, FirestoreÎäî ÎÇòÏ§ëÏóê Î≥¥Í∞ï
      useEffect(() => {
        function applyProfileFromUser(u) {
          const id = u.id || u.uid;
          const name = u.name || u.displayName || 'ÏÇ¨Ïö©Ïûê';
          const ftp = Number(u.ftp) || 0;
          const weight = Number(u.weight) || 0;
          const wkg = weight > 0 ? (ftp / weight).toFixed(2) : 0;
          setUserProfile({
            id: id,
            name: name,
            ftp: ftp,
            weight: weight,
            grade: u.grade || '2',
            acc_points: u.acc_points || 0,
            rem_points: u.rem_points || 0,
            ...u
          });
          setStats({
            ftp: ftp,
            wkg: parseFloat(wkg),
            weight: weight,
            totalPoints: Number(u.acc_points || 0),
            currentPoints: Number(u.rem_points || 0)
          });
          setStravaStatus({
            connected: !!(u.strava_refresh_token),
            lastSync: u.strava_last_sync || null
          });
        }
        
        function phase1Immediate() {
          let userId = null;
          let fullUser = null;
          try {
            const params = new URLSearchParams(window.location.search);
            userId = params.get('userId') || params.get('user_id') || null;
            if (userId) console.log('[Dashboard] URLÏóêÏÑú ÏÇ¨Ïö©Ïûê ID Í∞ÄÏ†∏Ïò¥:', userId);
          } catch (e) {}
          if (!userId && window.__dashboardUserFromParent && window.__dashboardUserFromParent.id) {
            fullUser = window.__dashboardUserFromParent;
            userId = fullUser.id;
            console.log('[Dashboard] postMessageÏóêÏÑú ÏÇ¨Ïö©Ïûê Í∞ÄÏ†∏Ïò¥:', userId);
          }
          if (!fullUser) {
            try {
              const stored = localStorage.getItem('currentUser');
              if (stored) {
                const parsed = JSON.parse(stored);
                if (parsed && (parsed.id || parsed.uid)) {
                  fullUser = parsed;
                  userId = fullUser.id || fullUser.uid;
                  if (!userId) console.log('[Dashboard] localStorageÏóêÏÑú ÏÇ¨Ïö©Ïûê Í∞ÄÏ†∏Ïò¥');
                }
              }
            } catch (e) {
              console.warn('[Dashboard] localStorage ÏÇ¨Ïö©Ïûê Ï°∞Ìöå Ïã§Ìå®:', e);
            }
          }
          if (!userId && window.parent && window.parent !== window) {
            try {
              const auth = window.parent.auth || window.parent.window?.auth;
              const cu = auth && auth.currentUser;
              if (cu && cu.uid) {
                userId = cu.uid;
                console.log('[Dashboard] Î∂ÄÎ™® Ï∞Ω authÏóêÏÑú ÏÇ¨Ïö©Ïûê ID Í∞ÄÏ†∏Ïò¥:', userId);
              }
            } catch (e) {}
          }
          if (!userId && window.auth) {
            try {
              const cu = window.auth.currentUser;
              if (cu && cu.uid) {
                userId = cu.uid;
                console.log('[Dashboard] ÌòÑÏû¨ Ï∞Ω authÏóêÏÑú ÏÇ¨Ïö©Ïûê ID Í∞ÄÏ†∏Ïò¥:', userId);
              }
            } catch (e) {}
          }
          if (!userId) {
            console.warn('[Dashboard] ÏÇ¨Ïö©Ïûê IDÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
            setUserProfile({ id: '', name: 'ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù ÌïÑÏöî', ftp: 0, weight: 0, grade: '2', acc_points: 0, rem_points: 0 });
            setLoading(false);
            return null;
          }
          if (fullUser) {
            applyProfileFromUser(fullUser);
            setLoading(false);
          } else {
            applyProfileFromUser({ id: userId, name: 'ÏÇ¨Ïö©Ïûê', ftp: 0, weight: 0 });
            setLoading(false);
          }
          return userId;
        }
        
        async function phase2Firestore(userId) {
          let firestore = window.firestore;
          if (window.parent && window.parent !== window) {
            try {
              firestore = window.parent.firestore || (window.parent.window && window.parent.window.firestore);
            } catch (e) {}
          }
          if (!firestore || !userId) return;
          try {
            const userDoc = await firestore.collection('users').doc(userId).get();
            if (!userDoc.exists) return;
            const userData = userDoc.data();
            applyProfileFromUser({ id: userId, ...userData });
          } catch (e) {
            console.warn('[Dashboard] Firestore ÌîÑÎ°úÌïÑ Î≥¥Í∞ï Ïã§Ìå®:', e);
          }
        }
        
        const uid = phase1Immediate();
        
        const onParentUser = function (e) {
          if (e.data && e.data.type === 'DASHBOARD_USER' && e.data.user) {
            applyProfileFromUser(e.data.user);
          }
        };
        window.addEventListener('message', onParentUser);
        
        let firestoreCheck = setInterval(function () {
          const fs = window.firestore || (window.parent && window.parent !== window && (window.parent.firestore || (window.parent.window && window.parent.window.firestore)));
          if (fs && uid) {
            clearInterval(firestoreCheck);
            phase2Firestore(uid);
          }
        }, 200);
        const t = setTimeout(function () {
          clearInterval(firestoreCheck);
          if (uid) phase2Firestore(uid);
        }, 8000);
        return function () {
          window.removeEventListener('message', onParentUser);
          clearInterval(firestoreCheck);
          clearTimeout(t);
        };
      }, []);
      
      // ÏµúÍ∑º ÌõàÎ†® Î°úÍ∑∏ Î°úÎìú
      useEffect(() => {
        async function loadRecentLogs() {
          if (!userProfile) return;
          
          try {
            // Firestore Ï∞∏Ï°∞ Í∞ÄÏ†∏Ïò§Í∏∞
            let firestore = window.firestore;
            if (window.parent && window.parent !== window) {
              try {
                firestore = window.parent.firestore || window.parent.window?.firestore;
              } catch (e) {
                console.warn('Î∂ÄÎ™® Ï∞Ω Firestore Ï†ëÍ∑º Ïã§Ìå®:', e);
              }
            }
            
            if (!firestore) {
              console.error('FirestoreÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
              return;
            }
            
            // ÏµúÍ∑º 30ÏùºÍ∞ÑÏùò training_log Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            // users/{userId}/logs ÏÑúÎ∏åÏª¨Î†âÏÖò ÏÇ¨Ïö© (Î≥µÌï© Ïù∏Îç±Ïä§ ÏóÜÏù¥ Îã®Ïùº orderBy + ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÌïÑÌÑ∞)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const dateStr = thirtyDaysAgo.toISOString().split('T')[0];
            
            let logs = [];
            
            try {
              const userLogsRef = firestore.collection('users').doc(userProfile.id).collection('logs');
              let logsSnapshot;
              try {
                logsSnapshot = await userLogsRef.orderBy('date', 'desc').limit(50).get();
              } catch (indexErr) {
                console.warn('ÌõàÎ†® Î°úÍ∑∏ orderBy Ïã§Ìå®, Ï†ÑÏ≤¥ Ï°∞Ìöå ÌõÑ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï†ïÎ†¨:', indexErr.message);
                logsSnapshot = await userLogsRef.limit(100).get();
              }
              
              const raw = [];
              logsSnapshot.docs.forEach(doc => {
                const d = doc.data();
                if ((d.source === 'strava' || !d.source) && d.date && d.date >= dateStr) {
                  raw.push({ id: doc.id, ...d });
                }
              });
              
              raw.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
              logs = raw.slice(0, 30);
              setRecentLogs(logs);
            } catch (queryError) {
              console.warn('ÌõàÎ†® Î°úÍ∑∏ Ï°∞Ìöå Ïã§Ìå®:', queryError);
              setRecentLogs([]);
            }
            
            // TSS Í∏∞Î∞ò Ìè¨Ïù∏Ìä∏ Í≥ÑÏÇ∞ Î∞è Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ (logs Ìï≠ÏÉÅ Ï†ïÏùòÎê®)
            const totalTss = logs.reduce((sum, log) => sum + (Number(log.tss) || 0), 0);
            setStats(prev => ({
              ...prev,
              weeklyProgress: totalTss
            }));
            
            const last7Days = logs.slice(0, 7).reverse();
            const fitnessChartData = last7Days.map((log) => ({
              date: new Date(log.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }),
              fitness: Number(log.tss) || 0,
              fatigue: (Number(log.tss) || 0) * 0.7
            }));
            setFitnessData(fitnessChartData);
            
          } catch (error) {
            console.error('ÌõàÎ†® Î°úÍ∑∏ Î°úÎìú Ïò§Î•ò:', error);
          }
        }
        
        if (userProfile) {
          loadRecentLogs();
        }
      }, [userProfile]);
      
      // Gemini AI ÏΩîÏπò Î∂ÑÏÑù Ìò∏Ï∂ú (recentLogs ÏóÜÏñ¥ÎèÑ ÌîÑÎ°úÌïÑÎßåÏúºÎ°ú Ìò∏Ï∂ú)
      useEffect(() => {
        async function fetchCoachAnalysis() {
          if (!userProfile) {
            setLoading(false);
            return;
          }
          
          try {
            var cacheKey = 'coach_analysis_' + userProfile.id;
            var useCache = false;
            try {
              var cached = localStorage.getItem(cacheKey);
              if (cached) {
                var parsed = JSON.parse(cached);
                var oneHour = 60 * 60 * 1000;
                if (parsed.data && parsed.timestamp && (Date.now() - parsed.timestamp < oneHour)) {
                  setCoachData(parsed.data);
                  useCache = true;
                }
              }
            } catch (e) {
              useCache = false;
            }
            if (useCache) {
              setAiPairingStatus(true);
              setLoading(false);
              return;
            }
            
            if (typeof window.callGeminiCoach === 'function') {
              var logs = Array.isArray(recentLogs) ? recentLogs : [];
              var analysis = await window.callGeminiCoach(userProfile, logs);
              var isFallback = !analysis || (analysis.coach_comment && analysis.coach_comment.indexOf('ÏùºÏãúÏ†ÅÏù∏ Ïò§Î•ò') !== -1);
              setCoachData(analysis);
              setAiPairingStatus(!isFallback);
              try {
                localStorage.setItem(cacheKey, JSON.stringify({ data: analysis, timestamp: Date.now() }));
              } catch (e) {}
            }
          } catch (error) {
            console.error('AI ÏΩîÏπò Î∂ÑÏÑù Ïò§Î•ò:', error);
            setAiPairingStatus(false);
            setCoachData({
              condition_score: 50,
              training_status: 'Building Base',
              vo2max_estimate: 40,
              coach_comment: (userProfile && userProfile.name || 'ÏÇ¨Ïö©Ïûê') + 'Îãò, Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§.',
              recommended_workout: 'Active Recovery (Z1)'
            });
          } finally {
            setLoading(false);
          }
        }
        
        if (userProfile) {
          fetchCoachAnalysis();
        } else {
          setLoading(false);
        }
      }, [userProfile, recentLogs]);
      
      // Îì±Í∏â Î±ÉÏßÄ ÌÖçÏä§Ìä∏
      const getGradeBadge = (grade) => {
        const badges = {
          '1': 'üíé Diamond',
          '2': '‚≠ê Member',
          '3': 'üëë Admin'
        };
        return badges[grade] || '‚≠ê Member';
      };
      
      if (loading) {
        return (
          <div className="max-w-[480px] mx-auto min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="skeleton w-32 h-32 rounded-full mx-auto mb-4"></div>
              <div className="skeleton w-48 h-6 mx-auto mb-2"></div>
              <div className="skeleton w-64 h-4 mx-auto"></div>
            </div>
          </div>
        );
      }
      
      return (
        <div className="max-w-[480px] mx-auto min-h-screen bg-gray-50 scrollbar-hide">
          {/* Header */}
          <header className="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-gray-200 px-4 py-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold">
                  {userProfile?.name?.charAt(0) || 'U'}
                </div>
                <div>
                  <div className="font-semibold text-gray-900">{userProfile?.name || 'ÏÇ¨Ïö©Ïûê'}</div>
                  <div className="text-xs text-gray-500">{getGradeBadge(userProfile?.grade)}</div>
                </div>
              </div>
              <button
                className="p-2 rounded-lg hover:bg-gray-100 active:opacity-80 transition-all"
                onClick={() => {
                  // ÌîÑÎ°úÌïÑ Ìé∏Ïßë Î™®Îã¨ Ïó¥Í∏∞ (Ï∂îÌõÑ Íµ¨ÌòÑ)
                  alert('ÌîÑÎ°úÌïÑ Ìé∏Ïßë Í∏∞Îä•ÏùÄ Ï∂îÌõÑ Íµ¨ÌòÑ ÏòàÏ†ïÏûÖÎãàÎã§.');
                }}
              >
                <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
            </div>
          </header>
          
          <div className="px-4 py-6 space-y-6 pb-24">
            {/* Status Control Center */}
            <div className="flex gap-3 overflow-x-auto scrollbar-hide pb-2">
              <DashboardCard className="min-w-[140px]">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${aiPairingStatus ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                  <span className="text-sm text-gray-700">AI ÌéòÏñ¥ÎßÅ</span>
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  {aiPairingStatus ? 'Ïó∞Í≤∞Îê®' : 'Ïó∞Í≤∞ ÎåÄÍ∏∞'}
                </div>
              </DashboardCard>
              
              <DashboardCard className="min-w-[140px]">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${stravaStatus.connected ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                  <span className="text-sm text-gray-700">Strava</span>
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  {stravaStatus.connected 
                    ? stravaStatus.lastSync 
                      ? `ÎèôÍ∏∞Ìôî: ${new Date(stravaStatus.lastSync).toLocaleDateString('ko-KR')}`
                      : 'Ïó∞Í≤∞Îê®'
                    : 'Ïó∞Í≤∞ ÎåÄÍ∏∞'}
                </div>
              </DashboardCard>
            </div>
            
            {/* Gemini Coach Insight */}
            <DashboardCard className="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200">
              {coachData ? (
                <>
                  <div className="flex items-center justify-center mb-4">
                    <CircularProgress value={coachData.condition_score} />
                  </div>
                  <div className="text-center mb-3">
                    <div className="text-lg font-bold text-gray-900 mb-1">
                      {coachData.training_status}
                    </div>
                    <div className="text-sm text-gray-600">
                      VO‚ÇÇmax Ï∂îÏ†ï: {coachData.vo2max_estimate} ml/kg/min
                    </div>
                  </div>
                  <div className="bg-white/80 rounded-xl p-4 mb-3">
                    <p className="text-sm text-gray-800 leading-relaxed">
                      {coachData.coach_comment}
                    </p>
                  </div>
                  <div className="text-center">
                    <span className="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full">
                      Ï∂îÏ≤ú: {coachData.recommended_workout}
                    </span>
                  </div>
                </>
              ) : (
                <div className="text-center py-8">
                  <div className="skeleton w-24 h-24 rounded-full mx-auto mb-4"></div>
                  <div className="skeleton w-32 h-4 mx-auto mb-2"></div>
                  <div className="skeleton w-48 h-3 mx-auto"></div>
                </div>
              )}
            </DashboardCard>
            
            {/* Stats Grid (2x2) */}
            <div className="grid grid-cols-2 gap-3">
              {/* Power Card */}
              <DashboardCard title="ÌååÏõå">
                <div className="text-2xl font-bold text-gray-900 mb-1">{stats.ftp}W</div>
                <div className="text-sm text-gray-600">{stats.wkg} W/kg</div>
              </DashboardCard>
              
              {/* Rewards/Points Card */}
              <DashboardCard title="Ìè¨Ïù∏Ìä∏">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-2xl">üí∞</span>
                  <div>
                    <div className="text-lg font-bold text-gray-900">{stats.currentPoints}</div>
                    <div className="text-xs text-gray-500">Î≥¥Ïú†</div>
                  </div>
                </div>
                <div className="text-xs text-gray-600 border-t border-gray-100 pt-2 mt-2">
                  ÎàÑÏ†Å: {stats.totalPoints}pt
                </div>
              </DashboardCard>
              
              {/* Physique Card */}
              <DashboardCard title="Ï≤¥Ìòï">
                <div className="text-2xl font-bold text-gray-900 mb-1">{stats.weight}kg</div>
                <div className="text-sm text-gray-600">Ï≤¥Ï§ë</div>
              </DashboardCard>
              
              {/* Progress Card */}
              <DashboardCard title="Ï£ºÍ∞Ñ Î™©Ìëú">
                <div className="relative w-16 h-16 mx-auto mb-2">
                  <svg className="w-16 h-16 transform -rotate-90">
                    <circle
                      cx="32"
                      cy="32"
                      r="28"
                      stroke="#e5e7eb"
                      strokeWidth="6"
                      fill="none"
                    />
                    <circle
                      cx="32"
                      cy="32"
                      r="28"
                      stroke="#3b82f6"
                      strokeWidth="6"
                      fill="none"
                      strokeDasharray={`${2 * Math.PI * 28}`}
                      strokeDashoffset={`${2 * Math.PI * 28 * (1 - Math.min(stats.weeklyProgress / 100, 1))}`}
                      strokeLinecap="round"
                    />
                  </svg>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <span className="text-sm font-bold text-gray-900">
                      {Math.min(Math.round((stats.weeklyProgress / 100) * 100), 100)}%
                    </span>
                  </div>
                </div>
                <div className="text-xs text-gray-600 text-center">
                  {stats.weeklyProgress}/100 TSS
                </div>
              </DashboardCard>
            </div>
            
            {/* Training Trend Chart */}
            <TrainingTrendChart data={fitnessData} />
          </div>
        </div>
      );
    }
    
    // React Ïï± Î†åÎçîÎßÅ (React 18 Ìò∏Ìôò)
    const rootElement = document.getElementById('dashboard-root');
    if (ReactDOM.createRoot) {
      // React 18+
      const root = ReactDOM.createRoot(rootElement);
      root.render(<PerformanceDashboard />);
    } else {
      // React 17 Ïù¥Ìïò
      ReactDOM.render(<PerformanceDashboard />, rootElement);
    }
  </script>
</body>
</html>
