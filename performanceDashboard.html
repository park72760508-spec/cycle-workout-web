<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="STELVIO AI - Performance Dashboard">
  <title>STELVIO AI - Performance Dashboard</title>
  
  <!-- Tailwind / Babel CDN ê²½ê³  í•„í„° (ë°˜ë“œì‹œ ìµœìƒë‹¨, CDN ë¡œë“œ ì „) -->
  <script>
    (function() {
      if (typeof console === 'undefined' || !console.warn) return;
      var orig = console.warn;
      console.warn = function() {
        var msg = (arguments[0] && String(arguments[0])) || '';
        if (msg.indexOf('cdn.tailwindcss.com') !== -1 || msg.indexOf('Tailwind CSS') !== -1 && msg.indexOf('production') !== -1 ||
            msg.indexOf('in-browser Babel') !== -1 || msg.indexOf('precompile your scripts') !== -1 || (msg.indexOf('Babel') !== -1 && msg.indexOf('production') !== -1)) {
          return;
        }
        return orig.apply(console, arguments);
      };
    })();
  </script>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone (JSX ë³€í™˜ìš©) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Chart.js (ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="assets/js/firebaseConfig.js"></script>
  
  <!-- í”„ë¡œì íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (assets/js/) -->
  <script src="assets/js/trainingManager.js"></script>
  <script src="assets/js/stravaManager.js"></script>
  <script src="assets/js/userManager.js"></script>
  
  <!-- Dashboard ì „ìš©: Firebase Standalone Fallback (iOS Bluefy í˜¸í™˜) -->
  <script>
    // Firebase ë…ë¦½ ì´ˆê¸°í™” í•¨ìˆ˜ (ë¶€ëª¨ ì°½ ì˜ì¡´ì„± ì œê±°)
    window.initFirebaseStandalone = function() {
      if (typeof firebase === 'undefined') {
        console.warn('[Dashboard] Firebase SDKê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•ŠìŒ');
        return null;
      }
      
      try {
        // Firebase ì„¤ì • (firebaseConfig.jsì™€ ë™ì¼)
        var firebaseConfig = {
          apiKey: "AIzaSyDVQJZV6NIbqhPdz1CKfbA8yHHYClSC35Q",
          authDomain: "stelvio-ai.firebaseapp.com",
          projectId: "stelvio-ai",
          storageBucket: "stelvio-ai.firebasestorage.app",
          messagingSenderId: "752285835508",
          appId: "1:752285835508:web:0662a24874209ebb483ea1",
          databaseURL: "https://stelvio-ai-default-rtdb.firebaseio.com"
        };
        
        // ìš°ì„ ìˆœìœ„: ê¸°ë³¸ ì•± ì‚¬ìš© (ì¸ì¦ ìƒíƒœ ê³µìœ )
        var app = null;
        var useDefaultApp = false;
        
        // 1ìˆœìœ„: ê¸°ë³¸ ì•± ì‚¬ìš© (ì¸ì¦ ìƒíƒœ ê³µìœ ë¨)
        if (firebase.apps.length > 0) {
          try {
            app = firebase.app();
            useDefaultApp = true;
            console.log('[Dashboard] ê¸°ë³¸ Firebase ì•± ì‚¬ìš© (ì¸ì¦ ìƒíƒœ ê³µìœ )');
          } catch (e) {
            console.warn('[Dashboard] ê¸°ë³¸ ì•± ì ‘ê·¼ ì‹¤íŒ¨:', e);
          }
        }
        
        // 2ìˆœìœ„: ê¸°ë³¸ ì•±ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ì´ˆê¸°í™” (ê¸°ë³¸ ì´ë¦„ ì‚¬ìš©)
        if (!app) {
          try {
            app = firebase.initializeApp(firebaseConfig);
            useDefaultApp = true;
            console.log('[Dashboard] Firebase ê¸°ë³¸ ì•± ì´ˆê¸°í™” ì„±ê³µ');
          } catch (initErr) {
            // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆìœ¼ë©´ ê·¸ê²ƒ ì‚¬ìš©
            if (firebase.apps.length > 0) {
              app = firebase.app();
              useDefaultApp = true;
              console.log('[Dashboard] ê¸°ì¡´ Firebase ì•± ì‚¬ìš©');
            } else {
              console.error('[Dashboard] Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', initErr);
              return null;
            }
          }
        }
        
        // Auth ì´ˆê¸°í™” ë° Persistence ì„¤ì •
        var auth = null;
        if (app && firebase.auth) {
          try {
            auth = firebase.auth(app);
            
            // ì¸ì¦ ìƒíƒœ ë³µì› ì‹œë„ (localStorageì—ì„œ)
            if (!auth.currentUser) {
              try {
                // localStorageì—ì„œ ì¸ì¦ ì •ë³´ í™•ì¸
                var storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                  var parsed = JSON.parse(storedUser);
                  if (parsed && parsed.id) {
                    console.log('[Dashboard] localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ë°œê²¬, ì¸ì¦ ìƒíƒœ ë³µì› ì‹œë„');
                    // onAuthStateChangedë¡œ ìë™ ë³µì›ë¨ (LOCAL persistence)
                  }
                }
              } catch (e) {
                console.warn('[Dashboard] localStorage ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì‹¤íŒ¨:', e);
              }
            }
            
            window.auth = auth;
            console.log('[Dashboard] Auth ì´ˆê¸°í™” ì™„ë£Œ', {
              hasCurrentUser: !!auth.currentUser,
              useDefaultApp: useDefaultApp
            });
          } catch (authErr) {
            console.warn('[Dashboard] Auth ì´ˆê¸°í™” ì‹¤íŒ¨:', authErr);
          }
        }
        
        // Firestore ì´ˆê¸°í™”
        var firestore = null;
        if (app && firebase.firestore) {
          try {
            firestore = firebase.firestore(app);
            window.firestore = firestore;
            console.log('[Dashboard] Firestore ì´ˆê¸°í™” ì„±ê³µ', {
              useDefaultApp: useDefaultApp
            });
          } catch (fsErr) {
            console.warn('[Dashboard] Firestore ì´ˆê¸°í™” ì‹¤íŒ¨:', fsErr);
          }
        }
        
        return { app: app, auth: auth, firestore: firestore, useDefaultApp: useDefaultApp };
      } catch (e) {
        console.error('[Dashboard] Firebase ë…ë¦½ ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
        return null;
      }
    };
  </script>
  
  <!-- Dashboard ì „ìš©: Gemini ì½”ì¹˜ í”„ë¡¬í”„íŠ¸ ë° API (ì¸ë¼ì¸, 404 ë°©ì§€) -->
  <script>
    window.GEMINI_COACH_SYSTEM_PROMPT = `Role: ë‹¹ì‹ ì€ 'Stelvio AI'ì˜ ìˆ˜ì„ ì‚¬ì´í´ë§ ì½”ì¹˜ì´ì ë°ì´í„° ë¶„ì„ê°€ì…ë‹ˆë‹¤.
Context: ì‚¬ìš©ìì˜ í”„ë¡œí•„({{userProfile}})ê³¼ ìµœê·¼ 30ì¼ê°„ì˜ í›ˆë ¨ ë¡œê·¸({{recentLogs}})ë¥¼ ë¶„ì„í•˜ì—¬ JSON í˜•ì‹ìœ¼ë¡œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.

[ë°ì´í„° ì¶œì²˜]
- userProfile: Firestore users/{userId} ì»¬ë ‰ì…˜ (id, name, ftp, weight, grade, challenge, acc_points, rem_points ë“±)
- recentLogs: Firestore users/{userId}/logs ì„œë¸Œì»¬ë ‰ì…˜ (ìµœê·¼ 30ì¼, source='strava' ë˜ëŠ” source ì—†ìŒ)
  * ë¡œê·¸ í•„ë“œ: activity_id, date, title, distance_km, time, duration_sec, tss, user_id, source ë“±
  * ìµœëŒ€ 30ê°œ, ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
Task Requirements:
1. **Condition Score (0~100):** TSB(Training Stress Balance)ì™€ ìµœê·¼ ìš´ë™ ê°•ë„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì»¨ë””ì…˜ ì ìˆ˜ë¥¼ ì‚°ì¶œí•˜ì„¸ìš”.
2. **Training Status:** í˜„ì¬ ìƒíƒœë¥¼ í•œ ë‹¨ì–´ë¡œ ì •ì˜í•˜ì„¸ìš” (ì˜ˆ: "Ready to Race", "Recovery Needed", "Building Base", "Peaking").
3. **Coach Comment:** ì‚¬ìš©ìì˜ ì´ë¦„({{userName}})ì„ ë¶€ë¥´ë©°, ìµœê·¼ í›ˆë ¨ ì„±ê³¼(FTP ë³€í™”, TSS ëˆ„ì  ë“±)ë¥¼ ì–¸ê¸‰í•˜ê³  ë™ê¸°ë¥¼ ë¶€ì—¬í•˜ëŠ” ë”°ëœ»í•œ ì¡°ì–¸ì„ í•œêµ­ì–´(ê²½ì–´ì²´)ë¡œ í•œ ë¬¸ì¥ ì‘ì„±í•˜ì„¸ìš”.
4. **VO2max Estimate:** íŒŒì›Œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì •ëœ VO2max ê°’ì„ ì •ìˆ˜ë¡œ ë°˜í™˜í•˜ì„¸ìš”.
5. **Recommended Workout:** ì˜¤ëŠ˜ ìˆ˜í–‰í•´ì•¼ í•  ì¶”ì²œ í›ˆë ¨ íƒ€ì…ì„ ì œì•ˆí•˜ì„¸ìš”.
Output Format (JSON Only):
{ "condition_score": 85, "training_status": "Ready to Race", "vo2max_estimate": 54, "coach_comment": "ì§€ì„±ë‹˜, ì´ë²ˆ ì£¼ TSS ëª©í‘œë¥¼ ê±°ì˜ ë‹¬ì„±í•˜ì…¨ë„¤ìš”! ì˜¤ëŠ˜ì€ ê°€ë²¼ìš´ ë¦¬ì»¤ë²„ë¦¬ë¡œ ì»¨ë””ì…˜ì„ ì¡°ì ˆí•˜ì„¸ìš”.", "recommended_workout": "Active Recovery (Z1)" }`;
    function isMobile() {
      var ua = navigator.userAgent || '';
      var isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      var isTouchDevice = (navigator.maxTouchPoints && navigator.maxTouchPoints > 2) || ('ontouchstart' in window);
      var isBluefy = /Bluefy/i.test(ua) || (window.navigator && window.navigator.standalone === false && window.navigator.standalone !== undefined);
      return isMobileUA || isTouchDevice || isBluefy;
    }
    async function callGeminiCoach(userProfile, recentLogs) {
      var apiKey;
      try {
        apiKey = localStorage.getItem('geminiApiKey');
      } catch (e) {
        apiKey = null;
      }
      if (!apiKey) throw new Error('Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í™˜ê²½ ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      var prompt = (window.GEMINI_COACH_SYSTEM_PROMPT || '')
        .replace('{{userProfile}}', JSON.stringify(userProfile, null, 2))
        .replace('{{recentLogs}}', JSON.stringify(recentLogs || [], null, 2))
        .replace('{{userName}}', (userProfile && userProfile.name) || 'ì‚¬ìš©ì');
      var modelName = localStorage.getItem('geminiModelName') || 'gemini-2.5-flash';
      var apiVersion = localStorage.getItem('geminiApiVersion') || 'v1beta';
      var url = 'https://generativelanguage.googleapis.com/' + apiVersion + '/models/' + modelName + ':generateContent?key=' + apiKey;
      var generationConfig = {
        maxOutputTokens: 20000, // ì¶©ë¶„í•œ í† í°ìœ¼ë¡œ ì‹œì‘í•˜ì—¬ MAX_TOKENS ì˜¤ë¥˜ ë°©ì§€ ë° ì†ë„ í–¥ìƒ (10000 â†’ 20000 ì¦ê°€)
        temperature: 0.7,
        topP: 0.8,
        topK: 40
      };
      // gemini-2.5-proëŠ” thinking ëª¨ë“œê°€ í•„ìˆ˜ì´ë¯€ë¡œ thinkingConfigë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
      // ë‹¤ë¥¸ ëª¨ë¸(ì˜ˆ: gemini-2.5-flash)ì€ thinkingì„ ë¹„í™œì„±í™”í•˜ì—¬ parts[0]ì´ í…ìŠ¤íŠ¸ê°€ ë˜ë„ë¡ í•¨
      if (modelName.indexOf('pro') === -1 && modelName.indexOf('thinking') === -1) {
        generationConfig.thinkingConfig = { thinkingBudget: 0 };
      }
      var body = {
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: generationConfig
      };
      var timeoutMs = isMobile() ? 45000 : 25000;
      var lastErr = null;
      var hasAbortController = typeof AbortController !== 'undefined';
      for (var attempt = 0; attempt < 3; attempt++) {
        try {
          var controller = null;
          var timeoutId = null;
          var wasAborted = false;
          var fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) };
          if (hasAbortController) {
            try {
              controller = new AbortController();
              timeoutId = setTimeout(function() {
                if (controller) {
                  wasAborted = true;
                  controller.abort();
                }
              }, timeoutMs);
              fetchOptions.signal = controller.signal;
            } catch (e) {
              hasAbortController = false;
            }
          }
          var fetchPromise = fetch(url, fetchOptions).catch(function(fetchErr) {
            var errMsg = fetchErr && fetchErr.message ? fetchErr.message : String(fetchErr);
            var isAbort = wasAborted || (fetchErr && fetchErr.name === 'AbortError');
            console.error('[callGeminiCoach] fetch ì‹¤íŒ¨ (ì‹œë„ ' + (attempt + 1) + '):', {
              error: errMsg,
              isAborted: isAbort,
              url: url.substring(0, 100) + '...',
              timeoutMs: timeoutMs
            });
            if (isAbort) {
              throw new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (' + timeoutMs + 'ms)');
            }
            throw fetchErr;
          });
          var timeoutPromise = hasAbortController ? null : new Promise(function(resolve, reject) {
            timeoutId = setTimeout(function() { reject(new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼')); }, timeoutMs);
          });
          var res;
          try {
            res = hasAbortController ? await fetchPromise : await Promise.race([fetchPromise, timeoutPromise]);
          } catch (fetchErr) {
            if (timeoutId) clearTimeout(timeoutId);
            var errMsg = fetchErr && fetchErr.message ? fetchErr.message : String(fetchErr);
            if (errMsg.indexOf('Failed to fetch') !== -1 && !wasAborted) {
              // Failed to fetchëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ
              throw new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜, ë°©í™”ë²½/ë³´ì•ˆ ì†Œí”„íŠ¸ì›¨ì–´ê°€ API ìš”ì²­ì„ ì°¨ë‹¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            throw fetchErr;
          }
          if (timeoutId) clearTimeout(timeoutId);
          
          if (!res.ok) {
            var errBody = await res.text();
            var errMsg = '';
            try {
              var ed = JSON.parse(errBody);
              errMsg = (ed.error && ed.error.message) || errBody;
            } catch (e2) { errMsg = errBody.substring(0, 200); }
            throw new Error('Gemini API ì˜¤ë¥˜ (' + res.status + '): ' + errMsg);
          }
          
          var data = await res.json();
          if (!data || !data.candidates || !Array.isArray(data.candidates) || data.candidates.length === 0) {
            throw new Error('Gemini API ì‘ë‹µì— candidatesê°€ ì—†ìŠµë‹ˆë‹¤.');
          }
          var candidate = data.candidates[0];
          if (candidate.finishReason === 'SAFETY') {
            throw new Error('Gemini APIê°€ ì•ˆì „ ì •ì±…ìœ¼ë¡œ ì‘ë‹µì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.');
          }
          var parts = candidate.content && candidate.content.parts ? candidate.content.parts : [];
          // MAX_TOKENSì¸ ê²½ìš° maxOutputTokensë¥¼ ì¦ê°€ì‹œì¼œ ì¬ì‹œë„ (ì•ˆì „ì¥ì¹˜, ì´ˆê¸°ê°’ 20000ì´ë©´ ê±°ì˜ ë°œìƒí•˜ì§€ ì•ŠìŒ)
          if (candidate.finishReason === 'MAX_TOKENS' && (!parts.length || !parts.find(function(p) { return p && p.text && p.text.trim(); }))) {
            if (attempt < 2) {
              // ì´ë¯¸ 20000ì´ë©´ 32000ìœ¼ë¡œ ì¦ê°€ (ìµœëŒ€ 32000ê¹Œì§€)
              generationConfig.maxOutputTokens = Math.min(32000, generationConfig.maxOutputTokens < 20000 ? 20000 : generationConfig.maxOutputTokens * 2);
              body.generationConfig = generationConfig;
              console.warn('[callGeminiCoach] MAX_TOKENS ë„ë‹¬, maxOutputTokens ì¦ê°€:', generationConfig.maxOutputTokens);
              throw new Error('MAX_TOKENS - ì¬ì‹œë„');
            } else {
              throw new Error('Gemini API ì‘ë‹µì´ í† í° ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. (MAX_TOKENS)');
            }
          }
          if (!parts.length) {
            console.error('[callGeminiCoach] content.parts ì—†ìŒ:', {
              finishReason: candidate.finishReason,
              hasContent: !!candidate.content,
              partsLength: parts.length,
              candidate: JSON.stringify(candidate).substring(0, 500)
            });
            throw new Error('Gemini API ì‘ë‹µì— content.partsê°€ ì—†ìŠµë‹ˆë‹¤.');
          }
          var text = '';
          for (var i = 0; i < parts.length; i++) {
            if (parts[i] && typeof parts[i].text === 'string' && parts[i].text.trim()) {
              text = parts[i].text.trim();
              break;
            }
          }
          if (!text) {
            console.error('[callGeminiCoach] textê°€ ìˆëŠ” part ì—†ìŒ:', { finishReason: candidate.finishReason, partsLength: parts.length });
            throw new Error('Gemini API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
          }
          if (text.indexOf('```') === 0) {
            text = text.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '');
          }
          var result = JSON.parse(text);
          return {
            condition_score: (typeof result.condition_score === 'number') ? Math.max(0, Math.min(100, result.condition_score)) : 50,
            training_status: result.training_status || 'Building Base',
            vo2max_estimate: (typeof result.vo2max_estimate === 'number') ? Math.max(20, Math.min(100, result.vo2max_estimate)) : 40,
            coach_comment: result.coach_comment || ((userProfile && userProfile.name) || 'ì‚¬ìš©ì') + 'ë‹˜, ì˜¤ëŠ˜ë„ í™”ì´íŒ…í•˜ì„¸ìš”!',
            recommended_workout: result.recommended_workout || 'Active Recovery (Z1)'
          };
        } catch (e) {
          lastErr = e;
          var errType = 'unknown';
          var errDetail = '';
          var isMaxTokens = false;
          if (e && e.message) {
            errType = e.message;
            if (e.message.indexOf('MAX_TOKENS') !== -1 || (e.message.indexOf('ì¬ì‹œë„') !== -1 && e.message.indexOf('MAX_TOKENS') === -1)) {
              isMaxTokens = true;
              errType = 'MAX_TOKENS';
              errDetail = 'ì‘ë‹µì´ í† í° ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. maxOutputTokensë¥¼ ì¦ê°€ì‹œì¼œ ì¬ì‹œë„í•©ë‹ˆë‹¤.';
            } else if (e.message.indexOf('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜') !== -1 || e.message.indexOf('Failed to fetch') !== -1 || e.message.indexOf('NetworkError') !== -1) {
              errType = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
              errDetail = 'ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜, ë°©í™”ë²½/ë³´ì•ˆ ì†Œí”„íŠ¸ì›¨ì–´ê°€ API ìš”ì²­ì„ ì°¨ë‹¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
              if (window.parent && window.parent !== window) {
                errDetail += ' (iframe í™˜ê²½ì—ì„œëŠ” ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì™¸ë¶€ API í˜¸ì¶œì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)';
              }
            } else if (e.message.indexOf('CORS') !== -1 || e.message.indexOf('cross-origin') !== -1) {
              errType = 'CORS ì˜¤ë¥˜';
              errDetail = 'ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ API í˜¸ì¶œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
            } else if (e.message.indexOf('aborted') !== -1 || e.message.indexOf('ì‹œê°„ ì´ˆê³¼') !== -1 || e.message.indexOf('AbortError') !== -1) {
              errType = 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼';
              errDetail = 'ë„¤íŠ¸ì›Œí¬ê°€ ëŠë¦¬ê±°ë‚˜ ì„œë²„ ì‘ë‹µì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤.';
            }
          }
          if (attempt < 2) {
            console.warn('[callGeminiCoach] ì¬ì‹œë„ ' + (attempt + 1) + '/3:', errType, errDetail || '');
            // MAX_TOKENSì¸ ê²½ìš° ì¦‰ì‹œ ì¬ì‹œë„
            // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ëŠ” 3ì´ˆ ëŒ€ê¸° (ì—°ê²° ë³µêµ¬ ì‹œê°„ í™•ë³´)
            // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” 2ì´ˆ ëŒ€ê¸°
            if (isMaxTokens) {
              // ì¦‰ì‹œ ì¬ì‹œë„
            } else if (errType === 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜' || errType === 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼') {
              await new Promise(function(r) { setTimeout(r, 3000); });
            } else {
              await new Promise(function(r) { setTimeout(r, 2000); });
            }
          }
        }
      }
      var errMsg = lastErr && lastErr.message ? lastErr.message : 'unknown';
      var errDisplay = errMsg;
      if (errMsg.indexOf('Failed to fetch') !== -1) {
        errDisplay = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜, ë°©í™”ë²½ì´ API ìš”ì²­ì„ ì°¨ë‹¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        if (window.parent && window.parent !== window) {
          errDisplay += ' (iframe í™˜ê²½ ì œí•œ ê°€ëŠ¥)';
        }
      }
      console.warn('[callGeminiCoach] AI ë¶„ì„ ì‹¤íŒ¨ (ì¬ì‹œë„ 3íšŒ í›„):', errMsg);
      if (lastErr && lastErr.stack) {
        console.error('[callGeminiCoach] ì˜¤ë¥˜ ìŠ¤íƒ:', lastErr.stack.substring(0, 500));
      }
      return {
        condition_score: 50,
        training_status: 'Building Base',
        vo2max_estimate: 40,
        coach_comment: ((userProfile && userProfile.name) || 'ì‚¬ìš©ì') + 'ë‹˜, ë°ì´í„° ë¶„ì„ ì¤‘ ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
        recommended_workout: 'Active Recovery (Z1)',
        error_reason: errDisplay || errMsg
      };
    }
    window.callGeminiCoach = callGeminiCoach;
  </script>
  
  <style>
    /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ - ì „ì²´(html/body) ë° .scrollbar-hide */
    html, body {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    html::-webkit-scrollbar, body::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    
    /* Circular Progress Bar ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes progress {
      from {
        stroke-dashoffset: 283;
      }
    }
    
    .circular-progress {
      animation: progress 1s ease-out;
    }
    
    /* Skeleton UI ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }
    
    .skeleton {
      background: linear-gradient(
        90deg,
        #f0f0f0 0px,
        #e0e0e0 40px,
        #f0f0f0 80px
      );
      background-size: 1000px;
      animation: shimmer 2s infinite;
    }
  </style>
</head>
<body class="bg-gray-50 scrollbar-hide">
  <script>
    window.__dashboardUserFromParent = null;
    window.addEventListener('message', function (e) {
      try {
        if (e.data && e.data.type === 'DASHBOARD_USER' && e.data.user) {
          if (window.parent && window.parent !== window) {
            var origin = e.origin || '';
            var parentOrigin = window.location.origin || '';
            if (origin === parentOrigin || origin === '*' || parentOrigin === '') {
              window.__dashboardUserFromParent = e.data.user;
            }
          } else {
            window.__dashboardUserFromParent = e.data.user;
          }
        }
      } catch (err) {
        console.warn('[Dashboard] postMessage ì²˜ë¦¬ ì˜¤ë¥˜:', err);
      }
    });
  </script>
  <div id="dashboard-root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // í¬ì¸íŠ¸ í¬ë§·íŒ… ìœ í‹¸ë¦¬í‹° (ì •ìˆ˜, 1000 ì´ìƒì€ k í˜•ì‹)
    function formatPoints(points) {
      const num = Math.round(Number(points) || 0);
      if (num >= 1000) {
        const k = num / 1000;
        return k % 1 === 0 ? k + 'k' : k.toFixed(1) + 'k';
      }
      return num.toString();
    }
    
    // DashboardCard ì»´í¬ë„ŒíŠ¸
    function DashboardCard({ title, children, className = "" }) {
      return (
        <div className={`bg-white rounded-2xl p-4 shadow-sm border border-gray-100 ${className}`}>
          {title && (
            <h3 className="text-sm font-semibold text-gray-600 mb-3">{title}</h3>
          )}
          {children}
        </div>
      );
    }
    
    // Training Trend Chart ì»´í¬ë„ŒíŠ¸ (Chart.js ì‚¬ìš©)
    function TrainingTrendChart({ data }) {
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);
      
      useEffect(() => {
        if (!data || data.length === 0) return;
        
        const ctx = chartRef.current?.getContext('2d');
        if (!ctx) return;
        
        // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
        if (chartInstanceRef.current) {
          chartInstanceRef.current.destroy();
        }
        
        // Chart.jsë¡œ ì°¨íŠ¸ ìƒì„±
        chartInstanceRef.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => d.date),
            datasets: [
              {
                label: 'Fitness',
                data: data.map(d => d.fitness),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointBackgroundColor: '#3b82f6'
              },
              {
                label: 'Fatigue',
                data: data.map(d => d.fatigue),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointBackgroundColor: '#ef4444'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  usePointStyle: true,
                  padding: 10,
                  font: {
                    size: 11
                  },
                  boxWidth: 12,
                  boxHeight: 12
                }
              },
              tooltip: {
                backgroundColor: 'white',
                borderColor: '#e5e7eb',
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                titleFont: {
                  size: 13,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 12
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: true,
                  color: '#e5e7eb',
                  drawBorder: false
                },
                ticks: {
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                }
              },
              y: {
                grid: {
                  display: true,
                  color: '#e5e7eb',
                  drawBorder: false
                },
                ticks: {
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                },
                beginAtZero: true
              }
            }
          }
        });
        
        // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì°¨íŠ¸ ì •ë¦¬
        return () => {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
            chartInstanceRef.current = null;
          }
        };
      }, [data]);
      
      if (!data || data.length === 0) {
        return (
          <DashboardCard title="í›ˆë ¨ íŠ¸ë Œë“œ (ìµœê·¼ 7ì¼)">
            <div className="h-[200px] flex items-center justify-center text-gray-400 text-sm">
              ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
            </div>
          </DashboardCard>
        );
      }
      
      return (
        <DashboardCard title="í›ˆë ¨ íŠ¸ë Œë“œ (ìµœê·¼ 7ì¼)">
          <div className="h-[200px]">
            <canvas ref={chartRef}></canvas>
          </div>
          <div className="mt-2 px-2 pb-1 text-xs text-gray-500 leading-relaxed">
            <div className="flex items-start gap-2 mb-1">
              <span className="text-blue-500">ğŸŸ¦</span>
              <span><strong className="text-gray-700">Fitness (ì²´ë ¥)</strong>: ì§€ë‚œ 6ì£¼ê°„ ê¾¸ì¤€íˆ ìŒ“ì•„ì˜¬ë¦° ê¸°ì´ˆ ì²´ë ¥ (ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ)</span>
            </div>
            <div className="flex items-start gap-2">
              <span className="text-red-500">ğŸŸ¥</span>
              <span><strong className="text-gray-700">Fatigue (í”¼ë¡œë„)</strong>: ìµœê·¼ 7ì¼ê°„ì˜ í›ˆë ¨ìœ¼ë¡œ ìŒ“ì¸ ë‹¨ê¸° í”¼ë¡œ (ë†’ìœ¼ë©´ íœ´ì‹ í•„ìš”)</span>
            </div>
          </div>
        </DashboardCard>
      );
    }
    
    // Circular Progress ì»´í¬ë„ŒíŠ¸
    function CircularProgress({ value, max = 100, size = 120, strokeWidth = 8 }) {
      const percentage = Math.min((value / max) * 100, 100);
      const radius = (size - strokeWidth) / 2;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (percentage / 100) * circumference;
      
      const getColor = () => {
        if (percentage >= 80) return '#10b981'; // green
        if (percentage >= 60) return '#3b82f6'; // blue
        if (percentage >= 40) return '#f59e0b'; // amber
        return '#ef4444'; // red
      };
      
      return (
        <div className="relative inline-flex items-center justify-center" style={{ width: size, height: size }}>
          <svg width={size} height={size} className="transform -rotate-90">
            {/* ë°°ê²½ ì› */}
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              stroke="#e5e7eb"
              strokeWidth={strokeWidth}
              fill="none"
            />
            {/* ì§„í–‰ ì› */}
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              stroke={getColor()}
              strokeWidth={strokeWidth}
              fill="none"
              strokeDasharray={circumference}
              strokeDashoffset={offset}
              strokeLinecap="round"
              className="circular-progress transition-all duration-500"
            />
          </svg>
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="text-center">
              <div className="text-3xl font-bold" style={{ color: getColor() }}>
                {Math.round(value)}
              </div>
              <div className="text-xs text-gray-500">ì </div>
            </div>
          </div>
        </div>
      );
    }
    
    // ë©”ì¸ Dashboard ì»´í¬ë„ŒíŠ¸
    function PerformanceDashboard() {
      const [userProfile, setUserProfile] = useState(null);
      const [coachData, setCoachData] = useState(null);
      const [recentLogs, setRecentLogs] = useState([]);
      const [logsLoaded, setLogsLoaded] = useState(false);
      const [logsLoading, setLogsLoading] = useState(false); // ë¡œê·¸ ë¡œë”© ìƒíƒœ (ë¡œë”© ì¤‘/ì‹¤íŒ¨/ì„±ê³µ êµ¬ë¶„)
      const [logsLoadError, setLogsLoadError] = useState(null); // ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨ ì›ì¸
      const [logsProxyPending, setLogsProxyPending] = useState(false); // Data Proxy Fallback ëŒ€ê¸° ì¤‘
      const [loading, setLoading] = useState(true);
      const [stats, setStats] = useState({
        ftp: 0,
        wkg: 0,
        weight: 0,
        totalPoints: 0,
        currentPoints: 0,
        weeklyGoal: 0,
        weeklyProgress: 0
      });
      const [aiPairingStatus, setAiPairingStatus] = useState(false);
      const [stravaStatus, setStravaStatus] = useState({ connected: false, lastSync: null });
      const [fitnessData, setFitnessData] = useState([]);
      const [retryCoach, setRetryCoach] = useState(0);
      const userProfileRef = useRef(null);
      const proxyTimeoutRef = useRef(null);
      const requestIntervalRef = useRef(null);
      const logsLoadedRef = useRef(false);
      
      useEffect(function() {
        userProfileRef.current = userProfile;
      }, [userProfile]);
      useEffect(function() {
        logsLoadedRef.current = logsLoaded;
      }, [logsLoaded]);
      
      // iOS Bluefy: í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ Firebase Standalone ì´ˆê¸°í™” ì‹œë„
      useEffect(function() {
        // Firebase SDK ë¡œë“œ ëŒ€ê¸° í›„ ì¦‰ì‹œ Standalone Fallback ì‹œë„
        var initAttempts = 0;
        var maxInitAttempts = 10;
        var initInterval = setInterval(function() {
          initAttempts++;
          if (typeof firebase !== 'undefined' && typeof window.initFirebaseStandalone === 'function') {
            clearInterval(initInterval);
            try {
              var standalone = window.initFirebaseStandalone();
              if (standalone && standalone.firestore) {
                window.firestore = standalone.firestore;
                if (standalone.auth) {
                  window.auth = standalone.auth;
                  // Auth Persistence ì„¤ì •
                  if (standalone.auth.setPersistence) {
                    standalone.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                      .then(function() {
                        console.log('[Dashboard] í˜ì´ì§€ ë¡œë“œ: Auth Persistence ì„¤ì • ì™„ë£Œ (LOCAL) - iOS Bluefy');
                      })
                      .catch(function(e) {
                        console.warn('[Dashboard] í˜ì´ì§€ ë¡œë“œ: Auth Persistence ì„¤ì • ì‹¤íŒ¨:', e);
                      });
                  }
                }
                console.log('[Dashboard] í˜ì´ì§€ ë¡œë“œ: Firebase Standalone ì´ˆê¸°í™” ì„±ê³µ');
              }
            } catch (e) {
              console.warn('[Dashboard] í˜ì´ì§€ ë¡œë“œ: Firebase Standalone ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
            }
          } else if (initAttempts >= maxInitAttempts) {
            clearInterval(initInterval);
            console.warn('[Dashboard] í˜ì´ì§€ ë¡œë“œ: Firebase SDK ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
          }
        }, 500);
        
        return function() {
          clearInterval(initInterval);
        };
      }, []);
      
      // ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ: URL/postMessage/localStorage ì¦‰ì‹œ í‘œì‹œ, FirestoreëŠ” ë‚˜ì¤‘ì— ë³´ê°•
      // AI ë¶„ì„ì— ì‚¬ìš©ë˜ëŠ” userProfile í•„ë“œ:
      // - id, name, ftp, weight, grade, challenge, acc_points, rem_points ë“±
      // - ì¶œì²˜: Firestore users/{userId} ì»¬ë ‰ì…˜ ë˜ëŠ” localStorage/postMessage
      useEffect(() => {
        function applyProfileFromUser(u) {
          const id = u.id || u.uid;
          const name = u.name || u.displayName || 'ì‚¬ìš©ì';
          const ftp = Number(u.ftp) || 0;
          const weight = Number(u.weight) || 0;
          const wkg = weight > 0 ? (ftp / weight).toFixed(2) : 0;
          setUserProfile({
            id: id,
            name: name,
            ftp: ftp,
            weight: weight,
            grade: u.grade || '2',
            challenge: u.challenge || 'Fitness',
            acc_points: u.acc_points || 0,
            rem_points: u.rem_points || 0,
            ...u
          });
          var challenge = u.challenge || 'Fitness';
          var weeklyTarget = 100;
          if (typeof window.getWeeklyTargetTSS === 'function') {
            var targetInfo = window.getWeeklyTargetTSS(challenge);
            weeklyTarget = targetInfo.target;
          }
          setStats({
            ftp: ftp,
            wkg: parseFloat(wkg),
            weight: weight,
            totalPoints: Number(u.acc_points || 0),
            currentPoints: Number(u.rem_points || 0),
            weeklyGoal: weeklyTarget,
            weeklyProgress: 0
          });
          setStravaStatus({
            connected: !!(u.strava_refresh_token),
            lastSync: u.strava_last_sync || null
          });
        }
        
        function phase1Immediate() {
          let userId = null;
          let fullUser = null;
          try {
            var search = window.location.search || '';
            if (search && typeof URLSearchParams !== 'undefined') {
              const params = new URLSearchParams(search);
              userId = params.get('userId') || params.get('user_id') || null;
            } else if (search) {
              var match = search.match(/[?&](?:userId|user_id)=([^&]+)/);
              if (match) userId = decodeURIComponent(match[1]);
            }
            if (userId) console.log('[Dashboard] URLì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜´:', userId);
          } catch (e) {
            console.warn('[Dashboard] URL íŒŒë¼ë¯¸í„° íŒŒì‹± ì‹¤íŒ¨:', e);
          }
          if (!userId && window.__dashboardUserFromParent && window.__dashboardUserFromParent.id) {
            fullUser = window.__dashboardUserFromParent;
            userId = fullUser.id;
            console.log('[Dashboard] postMessageì—ì„œ ì‚¬ìš©ì ê°€ì ¸ì˜´:', userId);
          }
          if (!fullUser) {
            try {
              const stored = localStorage.getItem('currentUser');
              if (stored) {
                const parsed = JSON.parse(stored);
                if (parsed && (parsed.id || parsed.uid)) {
                  fullUser = parsed;
                  userId = fullUser.id || fullUser.uid;
                  if (!userId) console.log('[Dashboard] localStorageì—ì„œ ì‚¬ìš©ì ê°€ì ¸ì˜´');
                }
              }
            } catch (e) {
              console.warn('[Dashboard] localStorage ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨:', e);
            }
          }
          if (!userId && window.parent && window.parent !== window) {
            try {
              const auth = window.parent.auth || window.parent.window?.auth;
              const cu = auth && auth.currentUser;
              if (cu && cu.uid) {
                userId = cu.uid;
                console.log('[Dashboard] ë¶€ëª¨ ì°½ authì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜´:', userId);
              }
            } catch (e) {}
          }
          if (!userId && window.auth) {
            try {
              const cu = window.auth.currentUser;
              if (cu && cu.uid) {
                userId = cu.uid;
                console.log('[Dashboard] í˜„ì¬ ì°½ authì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜´:', userId);
              }
            } catch (e) {
              console.warn('[Dashboard] í˜„ì¬ ì°½ auth ì ‘ê·¼ ì‹¤íŒ¨:', e);
            }
          }
          
          // ì¸ì¦ ìƒíƒœ ë³µì› ì‹œë„ (onAuthStateChanged ëŒ€ê¸°)
          if (!userId && typeof firebase !== 'undefined' && firebase.auth) {
            try {
              var auth = window.auth;
              if (!auth && firebase.apps && firebase.apps.length > 0) {
                auth = firebase.auth();
                window.auth = auth;
              }
              if (auth) {
                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆë¡œ ì‚¬ìš©ì í™•ì¸
                auth.onAuthStateChanged(function(user) {
                  if (user && user.uid && !userId) {
                    userId = user.uid;
                    console.log('[Dashboard] onAuthStateChangedì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜´:', userId);
                    if (userId && !userProfile) {
                      phase1Immediate();
                    }
                  }
                });
                
                // ì¦‰ì‹œ í™•ì¸
                var currentUser = auth.currentUser;
                if (currentUser && currentUser.uid) {
                  userId = currentUser.uid;
                  console.log('[Dashboard] auth.currentUserì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜´:', userId);
                }
              }
            } catch (e) {
              console.warn('[Dashboard] ì¸ì¦ ìƒíƒœ ë³µì› ì‹œë„ ì‹¤íŒ¨:', e);
            }
          }
          if (!userId) {
            console.warn('[Dashboard] ì‚¬ìš©ì IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            setUserProfile({ id: '', name: 'ì‚¬ìš©ì ì„ íƒ í•„ìš”', ftp: 0, weight: 0, grade: '2', acc_points: 0, rem_points: 0 });
            setLoading(false);
            return null;
          }
          if (fullUser) {
            applyProfileFromUser(fullUser);
            setLoading(false);
          } else {
            applyProfileFromUser({ id: userId, name: 'ì‚¬ìš©ì', ftp: 0, weight: 0 });
            setLoading(false);
          }
          return userId;
        }
        
        async function phase2Firestore(userId) {
          // iOS Bluefy í˜¸í™˜: Auth Persistence ì„¤ì • (ì„¸ì…˜ ìœ ì§€) - ìµœìš°ì„  ì‹¤í–‰
          if (typeof firebase !== 'undefined' && firebase.auth) {
            try {
              var auth = window.auth;
              if (!auth) {
                // Standalone Fallbackìœ¼ë¡œ Auth ê°€ì ¸ì˜¤ê¸°
                if (typeof window.initFirebaseStandalone === 'function') {
                  var standalone = window.initFirebaseStandalone();
                  if (standalone && standalone.auth) {
                    auth = standalone.auth;
                    window.auth = auth;
                    console.log('[Dashboard] phase2Firestore: Standalone Auth ì‚¬ìš©');
                  }
                }
                // ì—¬ì „íˆ ì—†ìœ¼ë©´ ê¸°ë³¸ auth ì‚¬ìš©
                if (!auth && firebase.apps && firebase.apps.length > 0) {
                  try {
                    auth = firebase.auth();
                    window.auth = auth;
                    console.log('[Dashboard] phase2Firestore: ê¸°ë³¸ Auth ì‚¬ìš©');
                  } catch (authErr) {
                    console.warn('[Dashboard] phase2Firestore: ê¸°ë³¸ Auth ì´ˆê¸°í™” ì‹¤íŒ¨:', authErr);
                  }
                }
              }
              
              // Auth Persistence ì„¤ì • (iOS í•„ìˆ˜)
              if (auth && auth.setPersistence) {
                try {
                  await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                  console.log('[Dashboard] phase2Firestore: Auth Persistence ì„¤ì • ì™„ë£Œ (LOCAL) - iOS Bluefy í˜¸í™˜');
                } catch (persistErr) {
                  console.warn('[Dashboard] phase2Firestore: Auth Persistence ì„¤ì • ì‹¤íŒ¨:', persistErr);
                }
              } else if (auth) {
                console.warn('[Dashboard] phase2Firestore: auth.setPersistence ë©”ì„œë“œ ì—†ìŒ (í˜¸í™˜ì„± ëª¨ë“œ ê°€ëŠ¥)');
              }
            } catch (persistErr) {
              console.warn('[Dashboard] phase2Firestore: Auth Persistence ì„¤ì • ì¤‘ ì˜¤ë¥˜:', persistErr);
            }
          }
          
          let firestore = window.firestore;
          if (window.parent && window.parent !== window) {
            try {
              firestore = window.parent.firestore || (window.parent.window && window.parent.window.firestore);
            } catch (e) {
              console.warn('[Dashboard] parent.firestore ì ‘ê·¼ ì‹¤íŒ¨ (iOS ìƒŒë“œë°•ìŠ¤ ê°€ëŠ¥ì„±):', e);
            }
          }
          
          // Standalone Fallback (iOS Bluefy í•„ìˆ˜)
          // ì£¼ì˜: ê¸°ë³¸ ì•±ì„ ìš°ì„  ì‚¬ìš©í•˜ì—¬ ì¸ì¦ ìƒíƒœ ê³µìœ 
          if (!firestore && typeof window.initFirebaseStandalone === 'function') {
            try {
              var standalone = window.initFirebaseStandalone();
              if (standalone && standalone.firestore) {
                firestore = standalone.firestore;
                window.firestore = firestore;
                if (standalone.auth) {
                  window.auth = standalone.auth;
                }
                console.log('[Dashboard] phase2Firestore: Standalone Fallback ì„±ê³µ', {
                  hasAuth: !!standalone.auth,
                  hasCurrentUser: !!(standalone.auth && standalone.auth.currentUser)
                });
                
                // ì¸ì¦ ìƒíƒœê°€ ì—†ìœ¼ë©´ ê²½ê³ 
                if (standalone.auth && !standalone.auth.currentUser) {
                  console.warn('[Dashboard] phase2Firestore: Standalone Fallback ì‚¬ìš© ì¤‘ì´ì§€ë§Œ ì¸ì¦ ìƒíƒœ ì—†ìŒ - ê¶Œí•œ ì˜¤ë¥˜ ê°€ëŠ¥');
                }
              }
            } catch (e) {
              console.warn('[Dashboard] phase2Firestore: Standalone Fallback ì‹¤íŒ¨:', e);
            }
          }
          
          // Firebase SDK ì§ì ‘ ì´ˆê¸°í™” (ìµœì¢… ë°±ì—…)
          if (!firestore && typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
            try {
              firestore = firebase.firestore();
              window.firestore = firestore;
              console.log('[Dashboard] phase2Firestore: Firebase SDK ì§ì ‘ ì´ˆê¸°í™” ì„±ê³µ');
            } catch (e) {
              console.warn('[Dashboard] phase2Firestore: Firebase SDK ì§ì ‘ ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
            }
          }
          
          if (!firestore || !userId) {
            console.warn('[Dashboard] phase2Firestore: Firestore ë˜ëŠ” userId ì—†ìŒ', {
              hasFirestore: !!firestore,
              hasUserId: !!userId
            });
            return;
          }
          
          // ì¸ì¦ ìƒíƒœ í™•ì¸ (Firestore ê¶Œí•œ ì˜¤ë¥˜ ë°©ì§€)
          var auth = window.auth;
          if (auth) {
            var currentUser = auth.currentUser;
            if (!currentUser) {
              console.warn('[Dashboard] phase2Firestore: ì¸ì¦ ìƒíƒœ ì—†ìŒ - Firestore ê¶Œí•œ ì˜¤ë¥˜ ê°€ëŠ¥ì„±');
              // ì¸ì¦ ìƒíƒœ ë³µì› ëŒ€ê¸° (ìµœëŒ€ 3ì´ˆ)
              var authWaitStart = Date.now();
              while (!auth.currentUser && (Date.now() - authWaitStart < 3000)) {
                await new Promise(function(r) { setTimeout(r, 200); });
              }
              if (!auth.currentUser) {
                console.error('[Dashboard] phase2Firestore: ì¸ì¦ ìƒíƒœ ë³µì› ì‹¤íŒ¨ - Firestore ì¿¼ë¦¬ ë¶ˆê°€');
                // ì¸ì¦ ì—†ì´ë„ ì‹œë„ (ë³´ì•ˆ ê·œì¹™ì— ë”°ë¼ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ)
              } else {
                console.log('[Dashboard] phase2Firestore: ì¸ì¦ ìƒíƒœ ë³µì› ì„±ê³µ');
              }
            } else {
              console.log('[Dashboard] phase2Firestore: ì¸ì¦ ìƒíƒœ í™•ì¸ë¨', {
                uid: currentUser.uid,
                email: currentUser.email
              });
            }
          } else {
            console.warn('[Dashboard] phase2Firestore: Auth ê°ì²´ ì—†ìŒ - Firestore ê¶Œí•œ ì˜¤ë¥˜ ê°€ëŠ¥ì„±');
          }
          
          try {
            const userDoc = await firestore.collection('users').doc(userId).get();
            if (!userDoc.exists) {
              console.warn('[Dashboard] phase2Firestore: ì‚¬ìš©ì ë¬¸ì„œ ì—†ìŒ:', userId);
              return;
            }
            const userData = userDoc.data();
            applyProfileFromUser({ id: userId, ...userData });
          } catch (e) {
            console.warn('[Dashboard] Firestore í”„ë¡œí•„ ë³´ê°• ì‹¤íŒ¨:', e);
          }
        }
        
        const uid = phase1Immediate();
        
        const onParentUser = function (e) {
          try {
            if (e.data && e.data.type === 'DASHBOARD_USER' && e.data.user) {
              if (window.parent && window.parent !== window) {
                var origin = e.origin || '';
                var parentOrigin = window.location.origin || '';
                if (origin === parentOrigin || origin === '*' || parentOrigin === '') {
                  applyProfileFromUser(e.data.user);
                }
              } else {
                applyProfileFromUser(e.data.user);
              }
            }
            
            // ì¸ì¦ í† í° ë°›ì•„ì„œ ì¸ì¦ ìƒíƒœ ë³µì›
            if (e.data && e.data.type === 'DASHBOARD_AUTH_TOKEN' && e.data.token) {
              var token = e.data.token;
              var auth = window.auth;
              if (!auth && typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                auth = firebase.auth();
                window.auth = auth;
              }
              
              if (auth) {
                // í† í° ê²€ì¦ ë° ì¸ì¦ ìƒíƒœ ë³µì›
                // Firebase Admin SDK ì—†ì´ëŠ” ì§ì ‘ í† í°ì„ ì„¤ì •í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ,
                // ë¶€ëª¨ ì°½ì˜ ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë™ì¼í•œ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ ì‹œë„
                // ëŒ€ì‹ , localStorageì— í† í°ì„ ì €ì¥í•˜ê³  ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹œ ì‚¬ìš©
                console.log('[Dashboard] ì¸ì¦ í† í° ìˆ˜ì‹ , ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...');
                
                // ë¶€ëª¨ ì°½ì˜ ì¸ì¦ ìƒíƒœ í™•ì¸ (ê°€ëŠ¥í•œ ê²½ìš°)
                try {
                  if (window.parent && window.parent !== window && window.parent.auth) {
                    var parentAuth = window.parent.auth;
                    if (parentAuth.currentUser) {
                      console.log('[Dashboard] ë¶€ëª¨ ì°½ ì¸ì¦ ìƒíƒœ í™•ì¸ë¨:', parentAuth.currentUser.uid);
                      // ë¶€ëª¨ ì°½ì˜ ì¸ì¦ ìƒíƒœë¥¼ iframeì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡
                      // localStorageì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                      if (e.data.user) {
                        localStorage.setItem('currentUser', JSON.stringify(e.data.user));
                        localStorage.setItem('authToken', token);
                      }
                    }
                  }
                } catch (e) {
                  console.warn('[Dashboard] ë¶€ëª¨ ì°½ ì¸ì¦ í™•ì¸ ì‹¤íŒ¨:', e);
                }
                
                // í˜„ì¬ ì¸ì¦ ìƒíƒœ í™•ì¸
                auth.onAuthStateChanged(function(user) {
                  if (user) {
                    console.log('[Dashboard] ì¸ì¦ ìƒíƒœ ë³µì›ë¨:', user.uid);
                  } else {
                    console.warn('[Dashboard] ì¸ì¦ ìƒíƒœ ì—†ìŒ, localStorage ê¸°ë°˜ ë³µì› ì‹œë„...');
                    // localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
                    try {
                      var stored = localStorage.getItem('currentUser');
                      if (stored && e.data.user) {
                        localStorage.setItem('currentUser', JSON.stringify(e.data.user));
                        console.log('[Dashboard] localStorageì— ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì™„ë£Œ');
                      }
                    } catch (e) {
                      console.warn('[Dashboard] localStorage ì €ì¥ ì‹¤íŒ¨:', e);
                    }
                  }
                });
              }
              
              // ì‚¬ìš©ì ì •ë³´ë„ í•¨ê»˜ ë°›ì•˜ìœ¼ë©´ ì ìš©
              if (e.data.user) {
                applyProfileFromUser(e.data.user);
              }
            }
            
            // AI ì—°ê²° ìƒíƒœ ìˆ˜ì‹  (ë¶€ëª¨ ì•± â†’ ëŒ€ì‹œë³´ë“œ)
            if (e.data && e.data.type === 'AI_CONNECTION_STATUS') {
              setAiPairingStatus(!!e.data.isConnected);
            }
            
            // Data Proxy Fallback: ë¶€ëª¨ ì°½ì—ì„œ í›ˆë ¨ ë¡œê·¸ ìˆ˜ì‹ 
            if (e.data && e.data.type === 'DASHBOARD_LOGS_DATA' && Array.isArray(e.data.logs)) {
              var logs = e.data.logs;
              var proxyUserId = e.data.userId;
              console.log('[Dashboard] DASHBOARD_LOGS_DATA ìˆ˜ì‹ :', logs.length + 'ê°œ', { userId: proxyUserId });
              
              if (proxyTimeoutRef.current) {
                clearTimeout(proxyTimeoutRef.current);
                proxyTimeoutRef.current = null;
              }
              if (requestIntervalRef.current) {
                clearInterval(requestIntervalRef.current);
                requestIntervalRef.current = null;
              }
              
              setRecentLogs(logs);
              setLogsLoaded(true);
              setLogsLoadError(null);
              setLogsLoading(false);
              setLogsProxyPending(false);
              logsLoadedRef.current = true; // ref ë™ê¸°í™”
              
              var profile = userProfileRef.current;
              var challenge = (profile && profile.challenge) || 'Fitness';
              var weeklyTarget = 100;
              if (typeof window.getWeeklyTargetTSS === 'function') {
                var targetInfo = window.getWeeklyTargetTSS(challenge);
                weeklyTarget = targetInfo.target;
              }
              var today = new Date();
              var dayOfWeek = today.getDay();
              var mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
              var monday = new Date(today);
              monday.setDate(today.getDate() + mondayOffset);
              monday.setHours(0, 0, 0, 0);
              var mondayStr = monday.toISOString().split('T')[0];
              var weeklyTss = 0;
              logs.forEach(function(log) {
                if (log.date && log.date >= mondayStr) {
                  weeklyTss += (Number(log.tss) || 0);
                }
              });
              var weeklyTssRounded = Math.round(weeklyTss);
              
              setStats(function(prev) {
                return { ...prev, weeklyGoal: weeklyTarget, weeklyProgress: Math.min(weeklyTssRounded, 9999) };
              });
              
              var sorted = logs.slice().sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
              var last7 = sorted.slice(0, 7).reverse();
              var chartData = last7.map(function(log) {
                return {
                  date: new Date(log.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }),
                  fitness: Number(log.tss) || 0,
                  fatigue: (Number(log.tss) || 0) * 0.7
                };
              });
              setFitnessData(chartData);
            }
          } catch (err) {
            console.warn('[Dashboard] postMessage ì²˜ë¦¬ ì˜¤ë¥˜:', err);
          }
        };
        window.addEventListener('message', onParentUser);
        
        // ê¸°ë³¸ ì•± ìš°ì„  ì‚¬ìš© (ì¸ì¦ ê³µìœ ). Standaloneì€ firestoreCheckì—ì„œë§Œ ìµœí›„ ìˆ˜ë‹¨ìœ¼ë¡œ ì‚¬ìš©.
        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
          try {
            var auth = firebase.auth();
            window.auth = auth;
            if (auth.setPersistence) {
              auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(function() {
                  console.log('[Dashboard] ì´ˆê¸° ì§„ì…: Auth Persistence ì„¤ì • ì™„ë£Œ (LOCAL)');
                })
                .catch(function(e) {
                  console.warn('[Dashboard] ì´ˆê¸° ì§„ì…: Auth Persistence ì„¤ì • ì‹¤íŒ¨:', e);
                });
            }
            var fs = firebase.firestore();
            window.firestore = fs;
            console.log('[Dashboard] ì´ˆê¸° ì§„ì…: ê¸°ë³¸ ì•± ì‚¬ìš© (ì¸ì¦ ê³µìœ )', { hasAuth: !!auth });
            if (uid) phase2Firestore(uid);
          } catch (e) {
            console.warn('[Dashboard] ì´ˆê¸° ì§„ì…: ê¸°ë³¸ ì•± ì„¤ì • ì‹¤íŒ¨, firestoreCheck ëŒ€ê¸°:', e);
          }
        }
        
        let firestoreCheck = setInterval(function () {
          var fs = window.firestore;
          if (window.parent && window.parent !== window) {
            try {
              fs = window.parent.firestore || (window.parent.window && window.parent.window.firestore) || fs;
            } catch (e) {
              // iOS ìƒŒë“œë°•ìŠ¤ë¡œ ì¸í•œ ì ‘ê·¼ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
            }
          }
          
          // ê¸°ë³¸ ì•± ìš°ì„  (ì¸ì¦ ê³µìœ )
          if (!fs && typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
            try {
              fs = firebase.firestore();
              window.firestore = fs;
              var a = firebase.auth();
              if (a) window.auth = a;
            } catch (e) {
              console.warn('[Dashboard] firestoreCheck: ê¸°ë³¸ ì•± Firestore ì‹¤íŒ¨:', e);
            }
          }
          
          // ìµœí›„ ìˆ˜ë‹¨: Standalone Fallback
          if (!fs && typeof window.initFirebaseStandalone === 'function') {
            try {
              var standalone = window.initFirebaseStandalone();
              if (standalone && standalone.firestore) {
                fs = standalone.firestore;
                window.firestore = fs;
                if (standalone.auth) window.auth = standalone.auth;
              }
            } catch (e) {
              console.warn('[Dashboard] firestoreCheck: Standalone Fallback ì‹¤íŒ¨:', e);
            }
          }
          
          if (fs && uid) {
            clearInterval(firestoreCheck);
            phase2Firestore(uid);
          }
        }, isMobile() ? 300 : 200);
        const t = setTimeout(function () {
          clearInterval(firestoreCheck);
          // ìµœì¢… ì‹œë„: Standalone Fallback ê°•ì œ ì‹¤í–‰
          if (!window.firestore && typeof window.initFirebaseStandalone === 'function') {
            try {
              var standalone = window.initFirebaseStandalone();
              if (standalone && standalone.firestore) {
                window.firestore = standalone.firestore;
                if (standalone.auth) {
                  window.auth = standalone.auth;
                }
                console.log('[Dashboard] firestoreCheck íƒ€ì„ì•„ì›ƒ: ìµœì¢… Standalone Fallback ì„±ê³µ');
              }
            } catch (e) {
              console.error('[Dashboard] firestoreCheck íƒ€ì„ì•„ì›ƒ: ìµœì¢… Standalone Fallback ì‹¤íŒ¨:', e);
            }
          }
          if (uid) phase2Firestore(uid);
        }, isMobile() ? 20000 : 8000);
        return function () {
          window.removeEventListener('message', onParentUser);
          clearInterval(firestoreCheck);
          clearTimeout(t);
          if (proxyTimeoutRef.current) {
            clearTimeout(proxyTimeoutRef.current);
            proxyTimeoutRef.current = null;
          }
        };
      }, []);
      
      // ì¬ì‹œë„ ë²„íŠ¼ìš© ref (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡)
      const retryLogsRef = useRef(null);
      
      // ìµœê·¼ í›ˆë ¨ ë¡œê·¸ ë¡œë“œ â€” Hybrid Dual-Track: Direct Access (PC) + Proxy Polling (Mobile)
      useEffect(() => {
        var isMounted = true;
        
        function applyLogsToState(logs, profile) {
          var challenge = (profile && profile.challenge) || 'Fitness';
          var weeklyTarget = 100;
          if (typeof window.getWeeklyTargetTSS === 'function') {
            var targetInfo = window.getWeeklyTargetTSS(challenge);
            weeklyTarget = targetInfo.target;
          }
          var today = new Date();
          var dayOfWeek = today.getDay();
          var mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
          var monday = new Date(today);
          monday.setDate(today.getDate() + mondayOffset);
          monday.setHours(0, 0, 0, 0);
          var mondayStr = monday.toISOString().split('T')[0];
          var weeklyTss = 0;
          logs.forEach(function(log) {
            if (log.date && log.date >= mondayStr) {
              weeklyTss += (Number(log.tss) || 0);
            }
          });
          var weeklyTssRounded = Math.round(weeklyTss);
          var sorted = logs.slice().sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
          var last7 = sorted.slice(0, 7).reverse();
          var chartData = last7.map(function(log) {
            return {
              date: new Date(log.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }),
              fitness: Number(log.tss) || 0,
              fatigue: (Number(log.tss) || 0) * 0.7
            };
          });
          setRecentLogs(logs);
          setLogsLoaded(true);
          setLogsLoading(false);
          setLogsLoadError(null);
          setLogsProxyPending(false);
          logsLoadedRef.current = true;
          setStats(function(prev) {
            return { ...prev, weeklyGoal: weeklyTarget, weeklyProgress: Math.min(weeklyTssRounded, 9999) };
          });
          setFitnessData(chartData);
        }
        
        /* [Hybrid Logic] Supports both PC (Direct) and Mobile (Proxy) */
        async function loadRecentLogs() {
          // Prevent duplicate loading
          if (logsLoadedRef.current) return;
          if (!userProfile || !userProfile.id) {
            setLogsLoading(false);
            return;
          }
          
          setLogsLoading(true);
          setLogsLoadError(null);
          
          // Clear any existing intervals/timeouts
          if (proxyTimeoutRef.current) {
            clearTimeout(proxyTimeoutRef.current);
            proxyTimeoutRef.current = null;
          }
          if (requestIntervalRef.current) {
            clearInterval(requestIntervalRef.current);
            requestIntervalRef.current = null;
          }
          
          var directLoadSuccess = false;
          var profile = userProfile;

          // =========================================================
          // [Track 1] Method A: Direct Firestore Access (For PC/Fast)
          // Supports Firebase v9 (Modular) & v8 (Compat)
          // =========================================================
          try {
            var parent = window.parent;
            var parentDB = null;
            var localDB = null;
            
            // Priority 1: Check parent window for Firestore (v8 Compat or v9)
            if (parent && parent !== window) {
              try {
                // Case A: Firebase v8 Compat SDK (Legacy)
                if (parent.firestore) {
                  parentDB = parent.firestore;
                } else if (parent.firebase && typeof parent.firebase.firestore === 'function') {
                  parentDB = parent.firebase.firestore();
                }
                // Case B: Firebase v9 Modular SDK
                // Note: v9 requires getDocs/query functions which may not be in iframe scope
                // If parent exposes firestoreV9 instance, we try to use it via compat layer if available
                // Otherwise, we'll fallback to Proxy
                if (!parentDB && parent.firestoreV9) {
                  console.log('[Dashboard] ğŸ” Detected parent.firestoreV9 (v9 Modular), checking for compat access...');
                  // Try to get compat layer from parent if available
                  if (parent.firebase && typeof parent.firebase.firestore === 'function') {
                    parentDB = parent.firebase.firestore();
                  }
                }
              } catch (e) {
                console.warn('[Dashboard] Parent Firestore access failed:', e);
                parentDB = null;
              }
            }
            
            // Priority 2: Try local Firestore as fallback
            try {
              localDB = window.firestore || (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0 ? firebase.firestore() : null);
            } catch (e) {
              localDB = null;
            }
            
            var db = parentDB || localDB;
            
            // Only attempt if DB and User ID exist
            if (db && profile && profile.id) {
              console.log('[Dashboard] ğŸ–¥ï¸ PC Environment Detected: Attempting Direct DB Access...');
              
              // Calculate date 30 days ago
              var thirtyDaysAgo = new Date();
              thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
              var dateStr = thirtyDaysAgo.toISOString().split('T')[0];
              
              // Query Firestore directly (with index fallback)
              var logsSnapshot;
              try {
                logsSnapshot = await db.collection('users')
                  .doc(profile.id)
                  .collection('logs')
                  .where('date', '>=', dateStr)
                  .orderBy('date', 'desc')
                  .limit(50)
                  .get();
              } catch (idxErr) {
                if (String(idxErr.message || '').indexOf('index') !== -1) {
                  logsSnapshot = await db.collection('users').doc(profile.id).collection('logs').limit(100).get();
                } else {
                  throw idxErr;
                }
              }

              var logs = [];
              logsSnapshot.forEach(function(doc) {
                var d = doc.data();
                // Filter: source='strava' or no source (exclude Stelvio direct entries
                if ((d.source === 'strava' || !d.source) && d.date && d.date >= dateStr) {
                  logs.push({ id: doc.id, ...d });
                }
              });
              logs.sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
              logs = logs.slice(0, 50);
              
              // If successful, render immediately and skip polling
              if (!isMounted || logsLoadedRef.current) return;
              console.log('[Dashboard] âœ… Direct Access Success:', logs.length, 'logs found');
              
              // Clear any proxy polling that might have started
              if (requestIntervalRef.current) {
                clearInterval(requestIntervalRef.current);
                requestIntervalRef.current = null;
              }
              if (proxyTimeoutRef.current) {
                clearTimeout(proxyTimeoutRef.current);
                proxyTimeoutRef.current = null;
              }
              
              // Apply logs with stats/chart calculation
              applyLogsToState(logs, profile);
              directLoadSuccess = true;
              return; 
            }
          } catch (e) {
            console.warn('[Dashboard] âš ï¸ Direct Access Failed (Likely Mobile/Security Restricted):', e);
            // Continue to Track 2...
          }

          // =========================================================
          // [Track 2] Method B: Proxy Polling (For Mobile/Bluefy & PC Fallback)
          // =========================================================
          if (!directLoadSuccess && window.parent && window.parent !== window) {
            setLogsProxyPending(true);
            console.log('[Dashboard] ğŸ”„ Starting Proxy Polling (Fallback)...');
            
            // Retry every 1 second until parent app responds (faster than 1.5s)
            function sendRequest() {
              if (!isMounted) return;
              if (logsLoadedRef.current) return; // Use ref to avoid stale closure
              try {
                // Request Data
                window.parent.postMessage({ type: 'REQUEST_LOGS', userId: profile.id }, '*');
                // Request Connection Status (for AI Pairing)
                window.parent.postMessage({ type: 'REQUEST_STATUS' }, '*');
              } catch (e) {
                console.warn('[Dashboard] postMessage ì‹¤íŒ¨:', e);
              }
            }
            sendRequest();
            requestIntervalRef.current = setInterval(sendRequest, 1000);

            // Safety timeout: Force stop spinner after 10 seconds
            proxyTimeoutRef.current = setTimeout(function() {
              if (requestIntervalRef.current) {
                clearInterval(requestIntervalRef.current);
                requestIntervalRef.current = null;
              }
              proxyTimeoutRef.current = null;
              if (!isMounted) return;
              if (logsLoadedRef.current) return; // Already loaded, skip
              
              // Force stop spinner to show empty state instead of infinite spinner
              console.error('[Dashboard] âŒ Load Timeout. Showing empty state.');
              setLogsLoading(false);
              setLogsLoaded(true);
              setLogsProxyPending(false);
              logsLoadedRef.current = true;
              // Don't set error text to avoid ugly red box, just show empty charts
              // User can retry if needed
            }, 10000);
          } else if (!directLoadSuccess && (!window.parent || window.parent === window)) {
            // No parent and no direct access available
            console.warn('[Dashboard] âš ï¸ No Firestore access available');
            setLogsLoadError('Firestore ì ‘ê·¼ ë¶ˆê°€. ì•± ë‚´ ëŒ€ì‹œë³´ë“œì—ì„œ ì´ìš©í•´ ì£¼ì„¸ìš”.');
            setLogsLoading(false);
            setLogsLoaded(true);
            logsLoadedRef.current = true;
          }
        }

        if (userProfile && userProfile.id) {
          setLogsLoading(true);
          setLogsLoadError(null);
          loadRecentLogs();
        } else {
          setLogsLoading(false);
        }
        
        retryLogsRef.current = function() {
          if (userProfile && userProfile.id && isMounted) {
            logsLoadedRef.current = false;
            setLogsLoading(true);
            setLogsLoadError(null);
            setLogsLoaded(false);
            loadRecentLogs();
          }
        };
        
        return function() {
          isMounted = false;
          retryLogsRef.current = null;
          if (proxyTimeoutRef.current) {
            clearTimeout(proxyTimeoutRef.current);
            proxyTimeoutRef.current = null;
          }
          if (requestIntervalRef.current) {
            clearInterval(requestIntervalRef.current);
            requestIntervalRef.current = null;
          }
        };
      }, [userProfile]);
      
      // Gemini AI ì½”ì¹˜ ë¶„ì„ í˜¸ì¶œ (ë¡œê·¸ ë¡œë“œ ì™„ë£Œ í›„ ìë™ ì¬í˜¸ì¶œ)
      useEffect(() => {
        async function fetchCoachAnalysis() {
          if (!userProfile) {
            setLoading(false);
            return;
          }
          
          // logsLoadedê°€ falseì´ê±°ë‚˜ logsLoadingì´ trueì´ë©´ ë¡œê·¸ ë¡œë”©ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ëŒ€ê¸°
          // logsLoadedRefë„ í™•ì¸í•˜ì—¬ ìƒíƒœ ë™ê¸°í™” ë³´ì¥
          if (!logsLoaded || !logsLoadedRef.current || logsLoading) {
            console.log('[Dashboard] AI ë¶„ì„ ëŒ€ê¸°: ë¡œê·¸ ë¡œë”© ì¤‘...', { 
              logsLoaded: logsLoaded, 
              logsLoadedRef: logsLoadedRef.current,
              logsLoading: logsLoading 
            });
            return;
          }
          
          // ë¡œê·¸ ë¡œë”©ì´ ì‹¤íŒ¨í–ˆìœ¼ë©´ AI ë¶„ì„ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
          if (logsLoadError) {
            console.warn('[Dashboard] AI ë¶„ì„ ê±´ë„ˆëœ€: ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨', logsLoadError);
            setCoachData({
              condition_score: 50,
              training_status: 'Building Base',
              vo2max_estimate: 40,
              coach_comment: (userProfile && userProfile.name || 'ì‚¬ìš©ì') + 'ë‹˜, í›ˆë ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
              recommended_workout: 'Active Recovery (Z1)',
              error_reason: logsLoadError
            });
            setAiPairingStatus(false);
            setLoading(false);
            return;
          }
          
          var logs = Array.isArray(recentLogs) ? recentLogs : [];
          
          // íœ´ëŒ€í°ì—ì„œ ë¡œê·¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¶”ê°€ ëŒ€ê¸° í›„ ì¬í™•ì¸ (Firestore ì§€ì—° ê°€ëŠ¥ì„±)
          if (logs.length === 0 && isMobile()) {
            console.warn('[Dashboard] íœ´ëŒ€í°: ë¡œê·¸ê°€ ë¹„ì–´ìˆìŒ, ì¬í™•ì¸ ì‹œì‘...');
            
            // ì—¬ëŸ¬ ë²ˆ ì¬í™•ì¸ (ìµœëŒ€ 3íšŒ, ê° 3ì´ˆ ê°„ê²©)
            var checkAttempt = 0;
            var maxCheckAttempts = 3;
            var checkInterval = 3000;
            
            var checkLogs = function() {
              if (checkAttempt >= maxCheckAttempts) {
                console.warn('[Dashboard] íœ´ëŒ€í°: ì¬í™•ì¸ ìµœì¢… ì‹¤íŒ¨, ë¹ˆ ë¡œê·¸ë¡œ ì§„í–‰');
                // ìµœì¢… ì‹¤íŒ¨ ì‹œì—ë„ fallback ë©”ì‹œì§€ í‘œì‹œ
                setCoachData({
                  condition_score: 50,
                  training_status: 'Building Base',
                  vo2max_estimate: 40,
                  coach_comment: (userProfile && userProfile.name || 'ì‚¬ìš©ì') + 'ë‹˜, í›ˆë ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.',
                  recommended_workout: 'Active Recovery (Z1)',
                  error_reason: 'íœ´ëŒ€í°ì—ì„œ í›ˆë ¨ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
                });
                setAiPairingStatus(false);
                setLoading(false);
                return;
              }
              
              checkAttempt++;
              console.log('[Dashboard] íœ´ëŒ€í°: ì¬í™•ì¸ ì‹œë„ ' + checkAttempt + '/' + maxCheckAttempts);
              
              if (userProfile) {
                var firestore = window.firestore;
                if (window.parent && window.parent !== window) {
                  try {
                    firestore = window.parent.firestore || (window.parent.window && window.parent.window.firestore) || firestore;
                  } catch (e) {
                    console.warn('[Dashboard] parent.firestore ì ‘ê·¼ ì‹¤íŒ¨:', e);
                  }
                }
                
                if (firestore) {
                  var thirtyDaysAgo = new Date();
                  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                  var dateStr = thirtyDaysAgo.toISOString().split('T')[0];
                  
                  firestore.collection('users').doc(userProfile.id).collection('logs')
                    .limit(100).get()
                    .then(function(snapshot) {
                      var newLogs = [];
                      snapshot.docs.forEach(function(doc) {
                        var d = doc.data();
                        if ((d.source === 'strava' || !d.source) && d.date && d.date >= dateStr) {
                          newLogs.push({ id: doc.id, ...d });
                        }
                      });
                      newLogs.sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
                      newLogs = newLogs.slice(0, 30);
                      
                      if (newLogs.length > 0) {
                        console.log('[Dashboard] íœ´ëŒ€í°: ì¬í™•ì¸ í›„ ë¡œê·¸ ë°œê²¬:', newLogs.length + 'ê°œ');
                        setRecentLogs(newLogs);
                        
                        // ì£¼ê°„ ëª©í‘œ ì¬ê³„ì‚°
                        var today = new Date();
                        var dayOfWeek = today.getDay();
                        var mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        var monday = new Date(today);
                        monday.setDate(today.getDate() + mondayOffset);
                        monday.setHours(0, 0, 0, 0);
                        var mondayStr = monday.toISOString().split('T')[0];
                        
                        var weeklyTss = 0;
                        newLogs.forEach(function(log) {
                          if (log.date && log.date >= mondayStr) {
                            weeklyTss += (Number(log.tss) || 0);
                          }
                        });
                        var weeklyTssRounded = Math.round(weeklyTss);
                        
                        var challenge = userProfile.challenge || 'Fitness';
                        var weeklyTarget = 100;
                        if (typeof window.getWeeklyTargetTSS === 'function') {
                          var targetInfo = window.getWeeklyTargetTSS(challenge);
                          weeklyTarget = targetInfo.target;
                        }
                        setStats(function(prev) {
                          return { ...prev, weeklyGoal: weeklyTarget, weeklyProgress: Math.min(weeklyTssRounded, 9999) };
                        });
                        
                        // í›ˆë ¨ íŠ¸ë Œë“œ ë°ì´í„° ì—…ë°ì´íŠ¸
                        var last7 = newLogs.slice(0, 7).reverse();
                        var chartData = last7.map(function(log) {
                          return {
                            date: new Date(log.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }),
                            fitness: Number(log.tss) || 0,
                            fatigue: (Number(log.tss) || 0) * 0.7
                          };
                        });
                        setFitnessData(chartData);
                        
                        // AI ë¶„ì„ì€ useEffectê°€ ìë™ìœ¼ë¡œ ì¬ì‹¤í–‰ë¨ (recentLogs ë³€ê²½ ê°ì§€)
                      } else if (checkAttempt < maxCheckAttempts) {
                        // ì•„ì§ ë¡œê·¸ê°€ ì—†ìœ¼ë©´ ë‹¤ìŒ ì‹œë„
                        setTimeout(checkLogs, checkInterval);
                      }
                    })
                    .catch(function(err) {
                      console.warn('[Dashboard] íœ´ëŒ€í°: ì¬í™•ì¸ ì‹¤íŒ¨:', err);
                      if (checkAttempt < maxCheckAttempts) {
                        setTimeout(checkLogs, checkInterval);
                      }
                    });
                } else if (checkAttempt < maxCheckAttempts) {
                  console.warn('[Dashboard] íœ´ëŒ€í°: Firestore ì—†ìŒ, ì¬ì‹œë„...');
                  setTimeout(checkLogs, checkInterval);
                }
              }
            };
            
            // ì²« ì¬í™•ì¸ ì‹œì‘
            setTimeout(checkLogs, checkInterval);
            
            // ë¹ˆ ë¡œê·¸ë¡œ AI ë¶„ì„ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            return;
          }
          
          // logsHashì— TSS í•©ê³„ë„ í¬í•¨í•˜ì—¬ ë” ì •í™•í•œ ìºì‹œ í‚¤ ìƒì„±
          var logsTssSum = logs.reduce(function(s, log) { return s + (Number(log.tss) || 0); }, 0);
          var logsHash = logs.length > 0 
            ? logs.length + '_' + (logs[0] && logs[0].date || '') + '_' + (logs[logs.length - 1] && logs[logs.length - 1].date || '') + '_' + Math.round(logsTssSum)
            : 'empty';
          var cacheKey = 'coach_analysis_' + userProfile.id + '_' + logsHash;
          console.log('[Dashboard] AI ë¶„ì„ ì‹œì‘:', {
            logsCount: logs.length,
            logsHash: logsHash,
            cacheKey: cacheKey.substring(0, 50) + '...',
            device: isMobile() ? 'mobile' : 'desktop'
          });
          
          try {
            var useCache = false;
            var skipCache = retryCoach > 0;
            if (!skipCache) {
              try {
                var cached = localStorage.getItem(cacheKey);
                if (cached) {
                  var parsed = JSON.parse(cached);
                  var oneHour = 60 * 60 * 1000;
                  if (parsed.data && parsed.timestamp && (Date.now() - parsed.timestamp < oneHour) && !(parsed.data && parsed.data.error_reason)) {
                    setCoachData(parsed.data);
                    useCache = true;
                  }
                }
              } catch (e) {
                useCache = false;
              }
            }
            if (useCache) {
              setAiPairingStatus(true);
              setLoading(false);
              return;
            }
            if (skipCache) setLoading(true);
            
            if (typeof window.callGeminiCoach === 'function') {
              // AI ë¶„ì„ì— ì „ë‹¬ë˜ëŠ” ë°ì´í„°:
              // - userProfile: { id, name, ftp, weight, grade, challenge, acc_points, rem_points, ... }
              // - logs: ìµœê·¼ 30ì¼ê°„ í›ˆë ¨ ë¡œê·¸ ë°°ì—´ (Firestore users/{userId}/logs, source='strava' ë˜ëŠ” ì—†ìŒ)
              //   ê° ë¡œê·¸: { id, activity_id, date, title, distance_km, time, duration_sec, tss, user_id, source, ... }
              var analysis = await window.callGeminiCoach(userProfile, logs);
              var isFallback = !analysis || (analysis.coach_comment && analysis.coach_comment.indexOf('ì¼ì‹œì ì¸ ì˜¤ë¥˜') !== -1) || !!(analysis && analysis.error_reason);
              setCoachData(analysis);
              setAiPairingStatus(!isFallback);
              if (!isFallback && analysis && !analysis.error_reason) {
                try {
                  localStorage.setItem(cacheKey, JSON.stringify({ data: analysis, timestamp: Date.now() }));
                } catch (e) {}
              }
            }
          } catch (error) {
            var errMsg = (error && error.message) ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
            console.error('AI ì½”ì¹˜ ë¶„ì„ ì˜¤ë¥˜:', error);
            setAiPairingStatus(false);
            setCoachData({
              condition_score: 50,
              training_status: 'Building Base',
              vo2max_estimate: 40,
              coach_comment: (userProfile && userProfile.name || 'ì‚¬ìš©ì') + 'ë‹˜, ë°ì´í„° ë¶„ì„ ì¤‘ ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
              recommended_workout: 'Active Recovery (Z1)',
              error_reason: errMsg
            });
          } finally {
            setLoading(false);
          }
        }
        
        if (userProfile) {
          fetchCoachAnalysis();
        } else {
          setLoading(false);
        }
      }, [userProfile, recentLogs, retryCoach, logsLoaded, logsLoading, logsLoadError]);
      
      // ë“±ê¸‰ ë±ƒì§€ í…ìŠ¤íŠ¸
      const getGradeBadge = (grade) => {
        const badges = {
          '1': 'ğŸ’ Diamond',
          '2': 'â­ Member',
          '3': 'ğŸ‘‘ Admin'
        };
        return badges[grade] || 'â­ Member';
      };
      
      if (loading) {
        return (
          <div className="max-w-[480px] mx-auto min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="skeleton w-32 h-32 rounded-full mx-auto mb-4"></div>
              <div className="skeleton w-48 h-6 mx-auto mb-2"></div>
              <div className="skeleton w-64 h-4 mx-auto"></div>
            </div>
          </div>
        );
      }
      
      return (
        <div className="max-w-[480px] mx-auto min-h-screen bg-gray-50 scrollbar-hide">
          {/* Header */}
          <header className="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-gray-200 px-4 py-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold">
                  {userProfile?.name?.charAt(0) || 'U'}
                </div>
                <div>
                  <div className="font-semibold text-gray-900">{userProfile?.name || 'ì‚¬ìš©ì'}</div>
                  <div className="text-xs text-gray-500">{getGradeBadge(userProfile?.grade)}</div>
                </div>
              </div>
              <button
                className="p-2 rounded-lg hover:bg-gray-100 active:opacity-80 transition-all"
                onClick={() => {
                  // í”„ë¡œí•„ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸° (ì¶”í›„ êµ¬í˜„)
                  alert('í”„ë¡œí•„ í¸ì§‘ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
                }}
              >
                <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
            </div>
          </header>
          
          <div className="px-4 py-6 space-y-6 pb-24">
            {/* Status Control Center */}
            <div className="flex gap-3 overflow-x-auto scrollbar-hide pb-2">
              <DashboardCard className="min-w-[140px]">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${aiPairingStatus ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                  <span className="text-sm text-gray-700">AI í˜ì–´ë§</span>
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  {aiPairingStatus ? 'ì—°ê²°ë¨' : 'ì—°ê²° ëŒ€ê¸°'}
                </div>
              </DashboardCard>
              
              <DashboardCard className="min-w-[140px]">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${stravaStatus.connected ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                  <span className="text-sm text-gray-700">Strava</span>
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  {stravaStatus.connected 
                    ? stravaStatus.lastSync 
                      ? `ë™ê¸°í™”: ${new Date(stravaStatus.lastSync).toLocaleDateString('ko-KR')}`
                      : 'ì—°ê²°ë¨'
                    : 'ì—°ê²° ëŒ€ê¸°'}
                </div>
              </DashboardCard>
            </div>
            
            {/* Gemini Coach Insight */}
            <DashboardCard className="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200">
              {coachData ? (
                <>
                  <div className="flex items-center justify-center mb-4">
                    <CircularProgress value={coachData.condition_score} />
                  </div>
                  <div className="text-center mb-3">
                    <div className="text-lg font-bold text-gray-900 mb-1">
                      {coachData.training_status}
                    </div>
                    <div className="text-sm text-gray-600">
                      VOâ‚‚max ì¶”ì •: {coachData.vo2max_estimate} ml/kg/min
                    </div>
                  </div>
                  <div className="bg-white/80 rounded-xl p-4 mb-3">
                    <p className="text-sm text-gray-800 leading-relaxed">
                      {coachData.coach_comment}
                    </p>
                    {coachData.error_reason && (
                      <div className="mt-3 pt-3 border-t border-amber-200 space-y-1">
                        <p className="text-xs text-amber-700">ì›ì¸: {coachData.error_reason}</p>
                        {(coachData.error_reason.indexOf('API í‚¤') !== -1 || coachData.error_reason.indexOf('geminiApiKey') !== -1) && (
                          <p className="text-xs text-gray-600">í™˜ê²½ ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ì…ë ¥í•œ ë’¤ &quot;ë‹¤ì‹œ ë¶„ì„&quot;ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</p>
                        )}
                        {(coachData.error_reason.indexOf('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜') !== -1 || coachData.error_reason.indexOf('Failed to fetch') !== -1) && (
                          <p className="text-xs text-gray-600">ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜, ë°©í™”ë²½/ë³´ì•ˆ ì†Œí”„íŠ¸ì›¨ì–´ê°€ API ìš”ì²­ì„ ì°¨ë‹¨í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
                        )}
                      </div>
                    )}
                  </div>
                  <div className="text-center flex flex-wrap items-center justify-center gap-2">
                    <span className="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full">
                      ì¶”ì²œ: {coachData.recommended_workout}
                    </span>
                    {coachData.error_reason && (
                      <button
                        type="button"
                        onClick={() => {
                          try {
                            localStorage.removeItem('coach_analysis_' + (userProfile && userProfile.id));
                          } catch (e) {}
                          setRetryCoach(function(c) { return c + 1; });
                        }}
                        className="inline-block bg-amber-100 text-amber-800 text-xs font-semibold px-3 py-1.5 rounded-full hover:bg-amber-200 active:opacity-80 min-h-[44px]"
                      >
                        ë‹¤ì‹œ ë¶„ì„
                      </button>
                    )}
                  </div>
                </>
              ) : (
                <div className="text-center py-8">
                  <div className="skeleton w-24 h-24 rounded-full mx-auto mb-4"></div>
                  <div className="skeleton w-32 h-4 mx-auto mb-2"></div>
                  <div className="skeleton w-48 h-3 mx-auto"></div>
                </div>
              )}
            </DashboardCard>
            
            {/* Stats Grid (2x2) */}
            <div className="grid grid-cols-2 gap-3">
              {/* Power Card */}
              <DashboardCard title="íŒŒì›Œ">
                <div className="text-2xl font-bold text-gray-900 mb-1">{stats.ftp}W</div>
                <div className="text-sm text-gray-600">{stats.wkg} W/kg</div>
              </DashboardCard>
              
              {/* Rewards/Points Card */}
              <DashboardCard title="í¬ì¸íŠ¸">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-2xl">ğŸ’°</span>
                  <div>
                    <div className="text-lg font-bold text-gray-900">{formatPoints(stats.currentPoints)}</div>
                    <div className="text-xs text-gray-500">ë³´ìœ </div>
                  </div>
                </div>
                <div className="text-xs text-gray-600 border-t border-gray-100 pt-2 mt-2">
                  ëˆ„ì : {formatPoints(stats.totalPoints)}pt
                </div>
              </DashboardCard>
              
              {/* Physique Card */}
              <DashboardCard title="ì²´í˜•">
                <div className="text-2xl font-bold text-gray-900 mb-1">{stats.weight}kg</div>
                <div className="text-sm text-gray-600">ì²´ì¤‘</div>
              </DashboardCard>
              
              {/* Progress Card */}
              <DashboardCard title="ì£¼ê°„ ëª©í‘œ">
                {logsLoading ? (
                  <div className="flex flex-col items-center justify-center py-4">
                    <div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div>
                    <div className="text-xs text-gray-500">{logsProxyPending ? 'ì•±ì—ì„œ ë°ì´í„° ë™ê¸°í™” ì¤‘...' : 'ë°ì´í„° ë¡œë”© ì¤‘...'}</div>
                  </div>
                ) : logsLoadError ? (
                  <div className="flex flex-col items-center justify-center py-4 space-y-2">
                    <div className="text-xs text-red-600 text-center mb-2">{logsLoadError}</div>
                    <button
                      type="button"
                      onClick={function() {
                        if (retryLogsRef.current) {
                          retryLogsRef.current();
                        }
                      }}
                      className="px-3 py-1.5 bg-blue-500 text-white text-xs font-semibold rounded-lg hover:bg-blue-600 active:scale-95 transition-all min-h-[44px]"
                    >
                      ë‹¤ì‹œ ì‹œë„
                    </button>
                  </div>
                ) : (
                  <>
                    <div className="relative w-16 h-16 mx-auto mb-2">
                      <svg className="w-16 h-16 transform -rotate-90">
                        <circle
                          cx="32"
                          cy="32"
                          r="28"
                          stroke="#e5e7eb"
                          strokeWidth="6"
                          fill="none"
                        />
                        <circle
                          cx="32"
                          cy="32"
                          r="28"
                          stroke="#3b82f6"
                          strokeWidth="6"
                          fill="none"
                          strokeDasharray={`${2 * Math.PI * 28}`}
                          strokeDashoffset={`${2 * Math.PI * 28 * (1 - Math.min(stats.weeklyProgress / (stats.weeklyGoal || 100), 1))}`}
                          strokeLinecap="round"
                        />
                      </svg>
                      <div className="absolute inset-0 flex items-center justify-center">
                        <span className="text-sm font-bold text-gray-900">
                          {Math.min(Math.round((stats.weeklyProgress / (stats.weeklyGoal || 100)) * 100), 100)}%
                        </span>
                      </div>
                    </div>
                    <div className="text-xs text-gray-600 text-center">
                      {stats.weeklyProgress}/{stats.weeklyGoal || 100} TSS
                    </div>
                  </>
                )}
              </DashboardCard>
            </div>
            
            {/* Training Trend Chart */}
            {logsLoading ? (
              <DashboardCard title="í›ˆë ¨ íŠ¸ë Œë“œ (ìµœê·¼ 7ì¼)">
                <div className="h-[200px] flex items-center justify-center">
                  <div className="text-center">
                    <div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                    <div className="text-sm text-gray-500">{logsProxyPending ? 'ì•±ì—ì„œ ë°ì´í„° ë™ê¸°í™” ì¤‘...' : 'ë°ì´í„° ë¡œë”© ì¤‘...'}</div>
                  </div>
                </div>
              </DashboardCard>
            ) : logsLoadError ? (
              <DashboardCard title="í›ˆë ¨ íŠ¸ë Œë“œ (ìµœê·¼ 7ì¼)">
                <div className="h-[200px] flex items-center justify-center">
                  <div className="text-center">
                    <div className="text-sm text-red-600 mb-2">{logsLoadError}</div>
                    <button
                      type="button"
                      onClick={function() {
                        if (retryLogsRef.current) {
                          retryLogsRef.current();
                        }
                      }}
                      className="px-3 py-1.5 bg-blue-500 text-white text-xs font-semibold rounded-lg hover:bg-blue-600 active:scale-95 transition-all min-h-[44px]"
                    >
                      ë‹¤ì‹œ ì‹œë„
                    </button>
                  </div>
                </div>
              </DashboardCard>
            ) : (
              <TrainingTrendChart data={fitnessData} />
            )}
          </div>
        </div>
      );
    }
    
    // React ì•± ë Œë”ë§ (React 18 í˜¸í™˜)
    const rootElement = document.getElementById('dashboard-root');
    if (ReactDOM.createRoot) {
      // React 18+
      const root = ReactDOM.createRoot(rootElement);
      root.render(<PerformanceDashboard />);
    } else {
      // React 17 ì´í•˜
      ReactDOM.render(<PerformanceDashboard />, rootElement);
    }
  </script>
</body>
</html>

