<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AI 트레이닝 웹코치</title>

  <!-- GitHub Pages / HTTPS / BLE 권장 헤더 -->
  <meta http-equiv="origin-trial" content="">
  <meta name="theme-color" content="#2E74E8" />

  <!-- 파비콘 -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚴</text></svg>">
  <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚴</text></svg>">

  <!-- CSS 파일 링크 -->
  <link rel="stylesheet" href="style_fixed.css">
</head>
<body>

  <!-- 1) 연결 화면 -->
  <div id="connectionScreen" class="screen active">
    <div class="header">
      <h1>🚴 AI 트레이닝 웹코치</h1>
      <p class="subtitle">블루투스 기기를 연결하여 시작하세요</p>
    </div>

    <!-- iOS 안내 -->
    <div class="ios-info">
      <div class="ios-indicator">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        iOS 사용자
      </div>
      <div class="ios-text">
        iPhone/iPad에서는 브라우저 제한으로 블루투스 연결이 어려울 수 있습니다.<br>
        안드로이드나 PC 사용을 권장합니다.
      </div>
      <button class="btn-ios-continue" onclick="proceedWithoutBluetooth()">
        블루투스 없이 계속하기
      </button>
    </div>

    <!-- 블루투스 연결 섹션 -->
    <div class="card">
      <h3>🔗 기기 연결</h3>
      <div class="btn-row">
        <button class="btn" onclick="connectTrainer()">🚴 트레이너 연결</button>
        <button class="btn" onclick="connectPowerMeter()">⚡ 파워미터 연결</button>
        <button class="btn" onclick="connectHeartRate()">❤️ 심박수 연결</button>
      </div>
    </div>

    <!-- 연결된 기기 목록 -->
    <div id="connectedDevicesList"></div>
    
    <!-- 연결 완료 또는 건너뛰기 -->
    <div class="card">
      <div class="btn-row">
        <button class="btn btn-success" onclick="showScreen('profileScreen')">다음 단계</button>
        <button class="btn btn-secondary" onclick="proceedWithoutBluetooth()">연결 없이 진행</button>
      </div>
    </div>
  </div>

  <!-- 2) 프로필 선택 화면 -->
  <div id="profileScreen" class="screen">
    <div class="header">
      <h1>👤 사용자 선택</h1>
      <p class="subtitle">훈련할 사용자를 선택하거나 새로 추가하세요</p>
    </div>

    <div id="userList"></div>
    
    <div id="cardAddUser" class="user-card">
      <div class="text-center">
        <h3>➕ 새 사용자 추가</h3>
        <button class="btn btn-primary" onclick="showAddUserForm()">사용자 추가</button>
      </div>
    </div>

    <!-- 사용자 추가 폼 (처음에는 숨김) -->
    <div id="addUserForm" class="card hidden">
      <h3>새 사용자 정보</h3>
      <div class="form-group">
        <label for="userName">이름</label>
        <input type="text" id="userName" placeholder="이름을 입력하세요">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="userAge">나이</label>
          <input type="number" id="userAge" placeholder="30">
        </div>
        <div class="form-group">
          <label for="userWeight">체중 (kg)</label>
          <input type="number" id="userWeight" placeholder="70">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="userFTP">FTP (W)</label>
          <input type="number" id="userFTP" placeholder="250">
        </div>
        <div class="form-group">
          <label for="userMaxHR">최대심박수</label>
          <input type="number" id="userMaxHR" placeholder="190">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-success" onclick="saveUser()">저장</button>
        <button class="btn btn-secondary" onclick="cancelAddUser()">취소</button>
      </div>
    </div>
  </div>

  <!-- 3) 워크아웃 선택 화면 -->
  <div id="workoutScreen" class="screen">
    <div class="header">
      <h1>🏋️ 워크아웃 선택</h1>
      <p class="subtitle">원하는 훈련을 선택하세요</p>
    </div>

    <div class="workout-list" id="workoutList">
      <!-- 워크아웃 목록이 여기에 동적으로 생성됩니다 -->
    </div>

    <div class="btn-row mt-20">
      <button class="btn btn-secondary" onclick="showScreen('profileScreen')">← 이전</button>
      <button class="btn" onclick="showWorkoutBuilder()">✏️ 커스텀 워크아웃</button>
    </div>
  </div>

  <!-- 4) 워크아웃 빌더 (모달 형태) -->
  <div id="workoutBuilder" class="screen">
    <div class="header">
      <h1>✏️ 워크아웃 빌더</h1>
      <p class="subtitle">나만의 훈련을 만들어보세요</p>
    </div>

    <div class="card">
      <h3>워크아웃 정보</h3>
      <div class="form-group">
        <label for="workoutName">워크아웃 이름</label>
        <input type="text" id="workoutName" placeholder="나만의 훈련">
      </div>
      <div class="form-group">
        <label for="workoutDescription">설명</label>
        <input type="text" id="workoutDescription" placeholder="훈련 설명을 입력하세요">
      </div>
    </div>

    <div class="card">
      <h3>세그먼트 추가</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="segmentType">타입</label>
          <select id="segmentType" class="form-control">
            <option value="warmup">웜업</option>
            <option value="interval">인터벌</option>
            <option value="rest">휴식</option>
            <option value="cooldown">쿨다운</option>
            <option value="sweetspot">스위트스팟</option>
            <option value="tempo">템포</option>
          </select>
        </div>
        <div class="form-group">
          <label for="segmentDuration">시간 (분)</label>
          <input type="number" id="segmentDuration" placeholder="5" min="1" max="120">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="segmentPower">FTP % 또는 와트</label>
          <input type="number" id="segmentPower" placeholder="75" min="30" max="300">
        </div>
        <div class="form-group">
          <label for="segmentLabel">라벨</label>
          <input type="text" id="segmentLabel" placeholder="메인셋">
        </div>
      </div>
      <button class="btn" onclick="addSegment()">➕ 세그먼트 추가</button>
    </div>

    <div class="card">
      <h3>세그먼트 목록</h3>
      <div id="segmentsList"></div>
    </div>

    <div class="builder-actions">
      <div class="btn-row">
        <button class="btn btn-success" onclick="saveCustomWorkout()">💾 워크아웃 저장</button>
        <button class="btn btn-secondary" onclick="showScreen('workoutScreen')">← 돌아가기</button>
      </div>
    </div>
  </div>

  <!-- 5) 훈련 준비 화면 -->
  <div id="trainingReadyScreen" class="screen">
    <div class="header">
      <h1>🎯 훈련 준비</h1>
      <p class="subtitle">선택한 워크아웃을 확인하고 시작하세요</p>
    </div>

    <div class="workout-preview">
      <h2 id="previewWorkoutName">워크아웃</h2>
      <div class="preview-stats">
        <div><strong id="previewDuration">0분</strong><br /><span class="muted">총 시간</span></div>
        <div><strong id="previewIntensity">0%</strong><br /><span class="muted">평균 강도</span></div>
        <div><strong id="previewTSS">0</strong><br /><span class="muted">예상 TSS</span></div>
      </div>
      <div class="segment-preview" id="segmentPreview"></div>
    </div>

    <div class="training-ready">
      <div class="mb-30">
        <h3 class="mb-15">훈련 준비 완료</h3>
        <p class="muted">시작 버튼을 누르면 5초 카운트다운 후 훈련이 시작됩니다.</p>
      </div>
      <div class="btn-row center">
        <button class="btn btn-success" id="btnStartTraining">🚀 훈련 시작</button>
        <button class="btn btn-secondary" id="btnBackToWorkouts">← 워크아웃 변경</button>
      </div>
    </div>
  </div>

  <!-- 6) 훈련 화면 - 개선된 디자인 -->
  <div id="trainingScreen" class="screen">
    <!-- 1. 최상단: 사용자 정보 -->
    <div class="enhanced-training-user-info" id="userPanel">
      <div id="userInfo"></div>
    </div>

    <!-- 2. 두번째: 경과 시간 및 다음 세그먼트 정보 -->
    <div class="enhanced-training-time-info">
      <div class="enhanced-time-elapsed">
        <span class="enhanced-time-label">경과시간</span>
        <span class="enhanced-time-value" id="elapsedTime">00:00</span>
        <span class="enhanced-time-percent">(<span id="elapsedPercent">0</span>%)</span>
      </div>
      <div class="enhanced-next-segment-info">
        <span class="enhanced-next-label">다음 세그먼트</span>
        <span class="enhanced-next-value" id="nextSegment">인터벌 FTP 140%</span>
      </div>
    </div>

    <!-- 3. 메인 메트릭 영역 (3열 그리드) -->
    <div class="enhanced-metrics-grid">
      <!-- 왼쪽: TSS & 칼로리 -->
      <div class="enhanced-metric-panel enhanced-left-panel">
        <div class="enhanced-panel-header">훈련 데이터</div>
        <div class="enhanced-metric-item">
          <div class="enhanced-metric-label">TSS</div>
          <div class="enhanced-metric-value" id="tssValue">0.0</div>
        </div>
        <div class="enhanced-metric-item">
          <div class="enhanced-metric-label">칼로리</div>
          <div class="enhanced-metric-value" id="kcalValue">0</div>
          <div class="enhanced-metric-unit">kcal</div>
        </div>
      </div>

      <!-- 중앙: 메인 파워 디스플레이 -->
      <div class="enhanced-metric-panel enhanced-center-panel enhanced-main-power-display">
        <!-- 카운트다운 시간 (더 크게) -->
        <div class="enhanced-segment-countdown">
          <span class="enhanced-countdown-label">세그먼트 남은시간</span>
          <span class="enhanced-countdown-value" id="segmentTime">05:00</span>
        </div>

        <!-- 목표 파워와 세그먼트 평균 파워 같은 라인 -->
        <div class="enhanced-power-targets-row">
          <div class="enhanced-target-power-section">
            <div class="enhanced-target-label">목표 파워</div>
            <div class="enhanced-target-value" id="targetPowerValue">250</div>
            <div class="enhanced-target-unit">W</div>
          </div>
          <div class="enhanced-segment-avg-power">
            <span class="enhanced-avg-label">세그먼트 평균</span>
            <span class="enhanced-avg-value" id="avgSegmentPowerValue">242</span>
            <span class="enhanced-avg-unit">W</span>
          </div>
        </div>

        <!-- 현재 파워 (가장 크게) -->
        <div class="enhanced-current-power-section">
          <div class="enhanced-current-power-value" id="currentPowerValue">245</div>
          <div class="enhanced-current-power-unit">WATTS</div>
        </div>

        <!-- 달성도 프로그레스 바 -->
        <div class="enhanced-power-progress">
          <div class="enhanced-power-progress-bar" id="powerProgressBar"></div>
          <div class="enhanced-progress-labels">
            <span>달성도: <span id="achievementValueBar">98</span>%</span>
            <span>진행: <span id="segmentProgress">60</span>%</span>
          </div>
        </div>

        <!-- 현재 세그먼트 이름 -->
        <div class="enhanced-current-segment-name" id="currentSegmentName">메인셋 - FTP 105%</div>
      </div>

      <!-- 오른쪽: 심박수 & 케이던스 -->
      <div class="enhanced-metric-panel enhanced-right-panel">
        <div class="enhanced-panel-header">생체 데이터</div>
        <div class="enhanced-metric-item">
          <div class="enhanced-metric-label">심박수</div>
          <div class="enhanced-metric-value enhanced-heart-rate" id="heartRateValue">145</div>
          <div class="enhanced-metric-unit">BPM</div>
        </div>
        <div class="enhanced-metric-item">
          <div class="enhanced-metric-label">케이던스</div>
          <div class="enhanced-metric-value enhanced-cadence" id="cadenceValue">-</div>
          <div class="enhanced-metric-unit">RPM</div>
        </div>
      </div>
    </div>

    <!-- 4. 세그먼트 타임라인 + 마스코트 레이어 -->
    <div class="timeline-wrap">
      <div class="timeline-progress timeline--xl" id="timelineProgress">
        <!-- ✅ 마스코트 레이어 - 진행바 위에 오버레이 -->
        <div id="timelineMascotLayer" aria-hidden="true">
          <img id="progressMascot" src="assets/img/cyclist.gif" alt="cyclist mascot" />
          <img id="goalFlag" src="assets/img/goal-flag.jpg" alt="goal flag" />
        </div>
        
        <!-- 세그먼트 컨테이너 -->
        <div class="timeline-segments" id="timelineSegments"></div>
      </div>

      <div class="timeline-legend">
        <span>전체 진행율: <span id="segmentProgressLegend">0</span>%</span>
      </div>
    </div>

    <!-- 5. 컨트롤 버튼 -->
    <div class="training-controls">
      <button id="btnSkipSegment" class="enhanced-control-btn skip" aria-label="구간 건너뛰기"></button>
      <button id="btnTogglePause" class="enhanced-control-btn pause" aria-label="일시정지/재생"></button>
      <button id="btnStopTraining" class="enhanced-control-btn stop" aria-label="훈련 종료"></button>
    </div>
  </div>

  <!-- 7) 결과 화면 -->
  <div id="resultScreen" class="screen">
    <div class="header">
      <h1>🎉 훈련 완료!</h1>
      <p class="subtitle">수고하셨습니다</p>
    </div>

    <div class="text-center mb-30">
      <div class="achievement-circle">
        <div class="achievement-text" id="finalAchievement">0%</div>
      </div>
      <h2 id="workoutCompletedName">훈련 완주</h2>
    </div>

    <!-- 기본 결과 통계 -->
    <div class="result-stats">
      <div class="result-stat">
        <div class="result-stat-value" id="resultAvgPower">-</div>
        <div class="result-stat-label">평균 파워 (W)</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-value" id="resultMaxPower">-</div>
        <div class="result-stat-label">최대 파워 (W)</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-value" id="resultAvgHR">-</div>
        <div class="result-stat-label">평균 심박 (BPM)</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-value" id="resultCalories">-</div>
        <div class="result-stat-label">칼로리 (kcal)</div>
      </div>
    </div>

    <!-- AI 분석 -->
    <div class="card">
      <h3 class="mb-15">🤖 AI 성과 분석</h3>
      <div id="aiAnalysis" class="muted lh-16">분석 중...</div>
    </div>

    <!-- 파워 커브 분석 -->
    <div class="result-analysis">
      <div class="analysis-section">
        <div class="analysis-title">📊 파워 커브 (개인 기록)</div>
        <div class="power-curve" id="powerCurveDisplay">
          <div class="power-curve-item">
            <div class="power-curve-value" id="power5s">-</div>
            <div class="power-curve-label">5초</div>
          </div>
          <div class="power-curve-item">
            <div class="power-curve-value" id="power30s">-</div>
            <div class="power-curve-label">30초</div>
          </div>
          <div class="power-curve-item">
            <div class="power-curve-value" id="power1m">-</div>
            <div class="power-curve-label">1분</div>
          </div>
          <div class="power-curve-item">
            <div class="power-curve-value" id="power5m">-</div>
            <div class="power-curve-label">5분</div>
          </div>
          <div class="power-curve-item">
            <div class="power-curve-value" id="power20m">-</div>
            <div class="power-curve-label">20분</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 훈련 기록 관리 -->
    <div class="card">
      <h3 class="mb-15">📈 훈련 기록 관리</h3>
      
      <div class="form-group mb-10">
        <label for="resultUserSelect">사용자 선택</label>
        <select id="resultUserSelect" class="form-control" onchange="handleUserSelect(this.value)">
          <option value="">-- 사용자 선택 --</option>
        </select>
      </div>
      
      <div class="form-row mb-15">
        <div class="form-group">
          <label>시작일</label>
          <input type="date" id="startDate" />
        </div>
        <div class="form-group">
          <label>종료일</label>
          <input type="date" id="endDate" />
        </div>
        <div class="form-group">
          <button class="btn" onclick="applyDateFilter()">필터 적용</button>
        </div>
      </div>

      <div class="training-history" id="trainingHistory">
        <!-- 훈련 기록 테이블이 여기에 표시됩니다 -->
      </div>
    </div>

    <!-- 액션 버튼들 -->
    <div class="btn-row mt-20">
      <button class="btn btn-success" id="btnSaveResult" onclick="saveTrainingResult()">💾 결과 저장</button>
      <button class="btn btn-secondary" id="btnShareResult">📤 공유하기</button>
    </div>

    <div class="btn-row mt-10">
      <button class="btn" onclick="exportResults()">📤 결과 내보내기 (CSV)</button>
      <button class="btn" id="btnGoHome" onclick="showScreen('profileScreen')">🏠 홈으로</button>
    </div>
  </div>

  <!-- 카운트다운 오버레이 -->
  <div id="countdownOverlay" class="countdown-overlay hidden">
    <div class="countdown-number" id="countdownNumber">5</div>
  </div>

  <!-- 토스트 메시지 -->
  <div id="toast" class="toast hidden"></div>

  <!-- JavaScript 파일들 -->
  <script src="assets/js/data.js" defer></script>
  <script src="assets/js/bluetooth.js" defer></script>
  <script src="assets/js/userManager.js" defer></script>
  <script src="assets/js/resultManager.js" defer></script>
  <script src="assets/js/workoutManager.js" defer></script>
  <script src="app_fixed.js" defer></script>

  <!-- Google Charts for data visualization -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <script>
    console.log('HTML v1.4 loaded - 마스코트 레이어 구조 최적화 완료');
  </script>
</body>
</html>
