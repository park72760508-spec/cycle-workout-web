<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>사이클 아카데미 - 워크아웃 앱</title>
    <style>
        :root {
            --primary-color: #2E74E8;
            --secondary-color: #1A5AB8;
            --accent-color: #FF6B35;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --dark-color: #343A40;
            --light-color: #F8F9FA;
            --gray-color: #6C757D;
            --border-radius: 12px;
            --shadow: 0 4px 16px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-color);
            overflow-x: hidden;
        }

        .screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
            background: var(--light-color);
        }

        .screen.active {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: var(--gray-color);
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            text-align: center;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-secondary { background: var(--gray-color); }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 연결 화면 */
        .device-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .device-card.connected {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid var(--success-color);
        }

        .device-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .device-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            color: white;
        }

        .device-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .device-details p {
            font-size: 14px;
            color: var(--gray-color);
        }

        /* 프로필 화면 */
        .profile-card {
            position: relative;
        }

        .profile-info {
            display: flex;
            align-items: center;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .profile-details h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-color);
        }

        /* 워크아웃 화면 */
        .workout-card {
            position: relative;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .workout-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .workout-duration {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* 훈련 준비 화면 */
        .training-ready {
            text-align: center;
            padding: 40px 20px;
        }

        .workout-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .workout-preview h2 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 15px;
        }

        .segment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .segment-item {
            background: var(--light-color);
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }

        .segment-item.warmup { border-left: 4px solid #28A745; }
        .segment-item.interval { border-left: 4px solid #DC3545; }
        .segment-item.rest { border-left: 4px solid #FFC107; }
        .segment-item.cooldown { border-left: 4px solid #6C757D; }

        .segment-item h4 {
            font-size: 12px;
            margin-bottom: 5px;
            color: var(--gray-color);
        }

        .segment-item .ftp-percent {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .segment-item .duration {
            font-size: 12px;
            color: var(--gray-color);
        }

        /* 훈련 화면 */
        #trainingScreen {
            background: #000;
            color: white;
            padding: 10px;
        }

        #userInfo {
            color: #00E6A8;
            font-weight: 500;
            font-size: 15px;
        }
        
        .training-header {
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .current-segment {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .segment-details {
            display: flex;
            justify-content: space-around;
            font-size: 16px;
            opacity: 0.8;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .metric-card {
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
        }

            /* 세그먼트 평균 파워 중앙 정렬용 */
            .metric-card.avg-segment-power {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100%; /* ✅ power-display와 동일 높이로 자동 조정 */
                box-sizing: border-box;
            }

            /* 랩파워  */
            .metric-card.avg-segment-power .metric-value {
                font-size: 65px;
                font-weight: 700;
                color: #FFD700;  /* 골드톤 강조 */
                margin-bottom: 8px;
            }
            
            .metric-card.avg-segment-power .metric-label {
                font-size: 14px;
                opacity: 0.8;
                color: #fff;
            }

        

        /* 심박 + 케이던스 수직 정렬용 */
        .metric-card.dual-metric {
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;  /* 세 값이 위아래로 균등 배치 */
            align-items: center;
            height: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
        }
        
        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 좌우 표기(랩파워, TTS, BPM, RPM, kcal)*/
        .metric-item .metric-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 4px;
            color: white;
        }
        
        .metric-item .metric-label {
            font-size: 12px;
            opacity: 0.7;
            /*text-transform: uppercase;*/
        }

        
        .metric-card.dual-metric .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 좌우 표기(랩파워, TTS, BPM, RPM, kcal)*/
        .metric-card.dual-metric .metric-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .metric-card.dual-metric .metric-label {
            font-size: 12px;
            opacity: 0.8;
        }

        
        .metric-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.7;
            /*text-transform: uppercase;*/
        }

        /* 목표 파워 라인: 칼로리 숫자(metric-value) 톤과 동일화 */
        #powerComparison{
          font-size:48px; 
          font-weight:700;
          color:#fff;                 /* '목표:'와 'W' */
          font-variant-numeric: tabular-nums;
          font-feature-settings: 'tnum' 1, 'lnum' 1;
        }
        #powerComparison #targetPowerValue{
          color:#00E6A8;              /* 숫자만 민트 */
        }

        
        .power-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            padding: 20px;
        }

        .current-power {
            font-size: 96px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .power-progress {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }


        .power-progress-bar {
          height: 100%;
          background: linear-gradient(
            90deg,
            #FFFFFF66 0%,
            #FFFFFF66 70%,   /* 앞 70%는 흰색(알파 0.4) */
            #00E6A8 100%     /* 뒤 30% 구간에서 흰→민트로 자연스런 전환 */
          );
          opacity: 0.8;
          border-radius: 10px;
          transition: width 0.3s ease;
          position: relative;
          z-index: 0;            
        }


        /* 랩파워 달성도 표기 */
        .power-progress { position: relative; }
        

        .timeline-progress {
            width: 100%;
            height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .timeline-segments {
            display: flex;
            height: 100%;
        }
        
        .timeline-segment {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            position: relative;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .timeline-segment .segment-label {
            z-index: 2;
            text-align: center;
            line-height: 1.1;
        }        

        .timeline-segment .segment-time {
            font-size: 13px;
            opacity: 0.8;
        }
        
        .timeline-segment .progress-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
            z-index: 1;
            border-radius: 0;
        }
        
        .timeline-segment:first-child .progress-fill {
            border-radius: 15px 0 0 15px;
        }
        
        .timeline-segment:last-child .progress-fill {
            border-radius: 0 15px 15px 0;
        }
        
        .timeline-segment span {
            position: relative;
            z-index: 2;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .training-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.pause {
            background: var(--warning-color);
        }

        .control-btn.stop {
            background: var(--danger-color);
        }

        /* 랩파워 상태 색 */
        .lap-power--mint   { color: #00E6A8 !important; } /* ≥95% */
        .lap-power--yellow { color: #FFD700 !important; } /* <90%  */
        .lap-power--white  { color: #FFFFFF !important; } /* 90~95% */

        
        

        /* ===== SEGMENT DETAILS (Consolidated) 경과 시간 ===== */
        .training-header .segment-details {
          display: flex;
          align-items: center;
          justify-content: space-between;   /* 3칸 균등 배치 */
          gap: 20px;
        
          width: 100%;
          max-width: 720px;                 /* 줄 전체를 가운데 고정 */
          margin: 0 auto;
        }
        
        /* 각 칸 동일폭 + 레이아웃 안정화 */
        .training-header .segment-details > span {
          flex: 1 1 0;
          min-width: 0;
          text-align: center;               /* 기본 중앙 */
        }
        
        /* 좌/중/우 정렬 */
        .training-header .segment-details > span:nth-child(1) { text-align: left; }
        .training-header .segment-details > span:nth-child(2) { text-align: center; }
        .training-header .segment-details > span:nth-child(3) { text-align: right; }
        
        /* 왼쪽 ‘경과 시간’ 2줄 스택 */
        .segment-details .elapsed-block {
          display: flex;
          flex-direction: column;
          align-items: flex-start;          /* 내부 텍스트는 좌측 정렬 */
          line-height: 1.05;
        }
        
        /* 1줄째: 경과 시간 값(민트, 크게) */
        .segment-details .elapsed-block #elapsedTime {
          font-size: 40px;
          font-weight: 700;
          color: #00E6A8;
          line-height: 1;
        }
        
        /* 2줄째: 라벨( metric-label 톤 ) */
        .segment-details .elapsed-block .metric-label {
          font-size: 12px;
          opacity: 0.7;
          text-transform: uppercase;        /* 한글 영향 없음, 영문만 대문자 */
          margin-top: 2px;
        }
        /* ===== /SEGMENT DETAILS ===== */



        
        /* 결과 화면 */
        .achievement-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0deg, var(--success-color) 312deg, var(--light-color) 312deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }

        .achievement-circle::before {
            content: '';
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .achievement-text {
            font-size: 36px;
            font-weight: 700;
            color: var(--success-color);
            z-index: 1;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .result-stat {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
        }

        .result-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .result-stat-label {
            font-size: 14px;
            color: var(--gray-color);
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* 카운트다운 */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .countdown-number {
            font-size: 240px;
            font-weight: 700;
            color: white;
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in forwards;
        }
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .power-display {
                order: 1;
            }

            .timeline-progress {
                order: 3;
            }

            .current-power {
                font-size: 96px;
                line-height: 0.9;   /* 0.85~1 사이에서 취향대로 조절 */
                margin-bottom: 0;
            }
        }

            /* 바로 다음 줄의 "WATTS"를 위로 살짝 끌어올림 */
            #currentPowerValue + div {
              margin-top: -6px;   /* -4 ~ -10px 범위에서 화면 보면서 조절 */
              line-height: 1;
              /* 필요하면 더 미세 조정:
              position: relative;
              top: -2px;
              */
            }



        
        /* 🔹 세그먼트 남은 시간 스타일 */
        #segmentTime {
            font-size: 70px;             /* ✅ 글자 크기 업 */
            font-weight: 700;
            color: #fff;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        
        /* 🔸 10초 이하 시 깜빡임 + 확대 효과 */
        @keyframes blinkRed {
            0%, 100% { color: #FF3333; transform: scale(1); }
            50% { color: #FF9999; transform: scale(1.15); }
        }
        
        .countdown-alert {
            animation: blinkRed 0.8s ease-in-out infinite;
        }


        /* 🔹 경과 시간 표기 */        
        #elapsedTime {
            font-weight: 700;
            font-size: 40px;
            color: #00E6A8; /* 민트색 */
        }
        
        #elapsedPercent {
            font-weight: 600;
            font-size: 30px;
            color: #FFD700; /* 노란색으로 진행률 강조 */
        }
        

        #tssValue {
            color: #fff;
            font-weight: 700;
            transition: color 0.3s ease;
        }

        /* 3개 영역을 동일 너비로 */
        .segment-details > span {
          flex: 1 1 0;
        }        
        
        /* 왼쪽/가운데/오른쪽 정렬 */
        .segment-details > span:nth-child(1) { text-align: left; }
        .segment-details > span:nth-child(2) { text-align: center; }
        .segment-details > span:nth-child(3) { text-align: right; }
        
        /* 길어질 수 있는 '다음 세그먼트'는 말줄임 처리(선택) */
        #nextSegment {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          font-size: 18px; 
        }

        /* 세 칸 레이아웃은 유지(가운데/오른쪽은 중앙 정렬) */
        .segment-details { align-items: center; }
        
        /* 왼쪽 ‘경과 시간’ 블록만 위쪽으로 */
        .segment-details > span:nth-child(1) {
          align-self: flex-start;     /* ⬅️ 위 정렬 */
        }
        
        /* (선택) 큰 숫자 줄간 살짝 조이기 */
        #elapsedTime { line-height: 1; }


        
        /* 세그먼트 진행률: 칼로리 표시와 동일 컬러(화이트), 굵게/크게 */
        .segment-progress {
          font-size: 20px;     /* 필요하면 20~24px로 키워도 OK */
          font-weight: 800;
          color: #fff;         /* calorieValue와 동일 톤(화이트) */
        }


        /* powerComparison 안의 라벨(‘목표 :’, ‘W’)만 라벨 스타일 */
        #powerComparison .metric-label {
          font-size: 12px;
          opacity: 0.7;
          text-transform: uppercase;
        }
        
        /* 숫자는 기존 스타일 유지(예: 민트 색 등) – 필요시 명시 */
        #powerComparison #targetPowerValue {
          /* 예시: 민트 유지 */
          color: #00E6A8;
          /* 폰트 크기/굵기는 현재 값 유지 or 원하는 값으로 */
          /* font-size: 48px; font-weight: 700; */
        }


        
        
        /* (선택) 막대 높이를 기본 20px로 맞추고 줄간격도 정렬 */
        .power-progress { height: 30px; }     /* 기본값으로 돌리려면 유지/추가 */
        .power-progress-label { line-height: 30px; }

        #powerComparison { color: #fff; }
        #powerComparison #targetPowerValue { color: #00E6A8; }        
        #powerComparison {
          font-family: 'Inter', 'Pretendard', 'Noto Sans KR',
                       system-ui, -apple-system, 'Segoe UI', Roboto,
                       'Helvetica Neue', Arial, 'Apple SD Gothic Neo',
                       'Noto Sans', 'Malgun Gothic', sans-serif !important;
        } 
        /* 달성도 오버레이를 중앙에 띄우기 */
        .power-progress-label {
          position: absolute;      /* 오버레이 */
          inset: 0;                /* top/left/right/bottom = 0 */
          display: flex;
          align-items: center;
          justify-content: center; /* 정확히 중앙 정렬 */
          z-index: 1;              /* 바 위로 */
          pointer-events: none;
        
          /* 기존 가독성 스타일 유지 */
          font-size: 14px;
          font-weight: 400;
          color: rgba(255, 255, 255, 0.7);
          line-height: 30px;       /* 막대 높이와 맞춤(선택) */

            /* 세그먼트 정보 3개(경과/남은/다음)를 한 줄 중앙에 배치 */
            .segment-details {
              display: flex;
              justify-content: center;  /* ⬅️ 가로 중앙 정렬 */
              align-items: center;
              gap: 20px;                /* 항목 간 간격(원하면 조절) */
              margin: 0 auto;           /* 부모 폭이 넓을 때 중앙 배치 보조 */
            }
            
            /* 각 항목이 넓게 퍼지지 않도록(예전에 flex:1 준 게 있으면 덮어쓰기) */
            .segment-details > span {
              flex: 0 0 auto;
              text-align: center;       /* 텍스트도 중앙 정렬 */
            }
            
            /* (선택) 가운데 큰 시간은 중앙 정렬 유지 */
            #segmentTime { text-align: center; }




            
    </style>
</head>



    
<body>
    <!-- 연결 화면 -->
    <div id="connectionScreen" class="screen active">
        <div class="header">
            <h1>🚴‍♂️ 사이클 아카데미</h1>
            <p class="subtitle">와 심박계를 연결하세요</p>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px;">📡 블루투스 기기 연결</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <button class="btn" onclick="connectTrainer()">스마트 트레이너</button>
                <button class="btn btn-secondary" onclick="connectHeartRate()">심박계 연결</button>
                <button class="btn" onclick="connectPowerMeter()">파워미터 연결</button>
            </div>
        </div>

        <div id="deviceList">
            <!-- 연결된 기기들이 여기에 표시됩니다 -->
        </div>

        <div id="connectionStatus" class="hidden">
            <div class="card text-center">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>기기에 연결 중...</p>
                </div>
            </div>
        </div>

        <div id="connectedDevicesSummary" class="card hidden">
            <h3 style="margin-bottom: 15px;">✅ 연결된 기기</h3>
            <div id="connectedDevicesList"></div>
            <button class="btn btn-success" onclick="proceedToProfile()" style="margin-top: 15px;">다음 단계로</button>
        </div>
    </div>

    <!-- 프로필 선택 화면 -->
    <div id="profileScreen" class="screen">
        <div class="header">
            <h1>👤 프로필 선택</h1>
            <p class="subtitle">훈련할 사용자를 선택하세요</p>
        </div>

        <div id="profileList">
            <!-- 사용자 프로필들이 여기에 표시됩니다 -->
        </div>

        <div class="card" onclick="showAddUserForm()">
            <div class="text-center">
                <div style="font-size: 48px; margin-bottom: 10px;">➕</div>
                <h3>새 사용자 추가</h3>
                <p style="color: var(--gray-color); margin-top: 5px;">FTP와 몸무게를 입력하여 새 프로필을 만드세요</p>
            </div>
        </div>

        <div id="addUserForm" class="card hidden">
            <h3 style="margin-bottom: 20px;">새 사용자 등록</h3>
            <div class="form-group">
                <label>이름</label>
                <input type="text" id="userName" placeholder="이름을 입력하세요">
            </div>
            <div class="form-group">
                <label>연락처</label>
                <input type="tel" id="userContact" placeholder="010-1234-5678">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>FTP (W)</label>
                    <input type="number" id="userFTP" placeholder="250" min="100" max="500">
                </div>
                <div class="form-group">
                    <label>몸무게 (kg)</label>
                    <input type="number" id="userWeight" placeholder="70" min="40" max="150">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-success" onclick="saveNewUser()">저장</button>
                <button class="btn btn-secondary" onclick="cancelAddUser()">취소</button>
            </div>
        </div>
    </div>

    <!-- 워크아웃 선택 화면 -->
    <div id="workoutScreen" class="screen">
        <div class="header">
            <h1>📋 워크아웃 선택</h1>
            <p class="subtitle">오늘의 훈련 프로그램을 선택하세요</p>
        </div>

        <div id="workoutList">
            <!-- 워크아웃 목록이 여기에 표시됩니다 -->
        </div>
    </div>

    <!-- 훈련 준비 화면 -->
    <div id="trainingReadyScreen" class="screen">
        <div class="header">
            <h1>🎯 훈련 준비</h1>
            <p class="subtitle">선택한 워크아웃을 확인하고 시작하세요</p>
        </div>

        <div class="workout-preview">
            <h2 id="previewWorkoutName">SST_MCT(14)</h2>
            <div style="display: flex; justify-content: space-around; margin: 20px 0; font-size: 18px;">
                <div><strong id="previewDuration">92분</strong><br><span style="color: var(--gray-color);">총 시간</span></div>
                <div><strong id="previewIntensity">78%</strong><br><span style="color: var(--gray-color);">평균 강도</span></div>
                <div><strong id="previewTSS">82</strong><br><span style="color: var(--gray-color);">예상 TSS</span></div>
            </div>

            <div class="segment-preview" id="segmentPreview">
                <!-- 세그먼트 미리보기가 여기에 표시됩니다 -->
            </div>
        </div>

        <div class="training-ready">
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;">훈련 준비 완료</h3>
                <p style="color: var(--gray-color);">시작 버튼을 누르면 5초 카운트다운 후 훈련이 시작됩니다.</p>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-success" onclick="startWorkoutTraining()" style="min-width: 150px;">
                    🚀 훈련 시작
                </button>
                <button class="btn btn-secondary" onclick="backToWorkoutSelection()" style="min-width: 150px;">
                    ← 워크아웃 변경
                </button>
            </div>
        </div>
    </div>

    <!-- 훈련 화면 -->
    <div id="trainingScreen" class="screen">
        <div class="training-header">
            <div id="userInfo" style="font-size: 14px; color: #ccc; margin-top: 4px;">
                <!-- 사용자 정보가 여기 표시됩니다 -->
            </div>
            <div class="segment-details">
                <span class="elapsed-block">
                  <span id="elapsedTime">00:00</span>
                  <span class="metric-label">경과 시간</span>
                </span>
                <span id="segmentTime">00:00</span>
                <span id="nextSegment">다음: 인터벌 FTP 140%</span>
            </div>
        </div>

        <div class="metrics-grid">

            <div class="metric-card avg-segment-power">
                <div style="display:flex; flex-direction:column; align-items:center;">
                    <div class="metric-value" id="avgSegmentPowerValue">178</div>
                    <div class="metric-label">랩 파워 (W)</div>
                    <div class="metric-value" id="tssValue" style="margin-top:6px; font-size:48px;">0</div>
                    <div class="metric-label">TSS</div>
                </div>
            </div>

            

            <div class="power-display">
                <div class="current-power" id="currentPowerValue">185</div>
                <div style="opacity: 0.7;">WATTS</div>
                <div class="power-progress">
                    <div class="power-progress-bar" id="powerProgressBar"></div>
                    <!-- 달성도 오버레이(중앙) -->
                    <div class="power-progress-label">
                      달성도: <span id="achievementValueBar">0</span>%
                    </div>                    
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <div id="powerComparison" class="metric-value">
                      <span class="metric-label">목표 :</span>
                      <span id="targetPowerValue">194</span>
                      <span class="metric-label">W</span>
                    </div>
                     <!-- 진행률 표시 (FTP% → 세그먼트 진행률) -->
                    <div id="segmentProgressText" class="segment-progress">
                      진행률 <span id="segmentProgress">0</span>%
                    </div>                   
            
                    <!-- ✅ 세그먼트명 표시 위치 -->
                    <div id="currentSegmentName" 
                         style="margin-top: 8px; font-size: 20px; font-weight: 600; color: #FFD700;">
                         웜업 - 80RPM FTP 60%
                    </div>
                </div>
            </div>

            <div class="metric-card dual-metric">
                <div class="metric-item">
                    <div class="metric-value" id="heartRateValue">145</div>
                    <div class="metric-label">BPM</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="cadenceValue">89</div>
                    <div class="metric-label">RPM</div>
                </div>
                <!-- 🔹 칼로리 소모 표시 -->
                <div class="metric-item">
                    <div class="metric-value" id="calorieValue">-</div>
                    <div class="metric-label">kcal</div>
                </div>
            </div>

        </div>

        <div style="background: rgba(255,255,255,0.1); border-radius: var(--border-radius); padding: 15px;">
            <div class="timeline-progress">
                <div class="timeline-segments" id="timelineSegments">
                    <!-- 타임라인 세그먼트들이 여기에 표시됩니다 -->
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; opacity: 0.7;">
                <span>진행률: <span id="elapsedPercent">0</span>%</span> 
                <!-- <span>달성도: <span id="achievementValue">87</span>%</span>-->
                <span>평균 파워: <span id="avgPowerValue">178</span>W</span>
            </div>
        </div>

        <div class="training-controls">
            <button class="control-btn pause" onclick="togglePause()" title="일시정지">
                <span id="pauseIcon">⏸️</span>
            </button>
            <button class="control-btn" onclick="skipSegment()" title="구간 건너뛰기">⏭️</button>
            <button class="control-btn stop" onclick="stopTraining()" title="훈련 종료">⏹️</button>
        </div>
    </div>

    <!-- 결과 화면 -->
    <div id="resultScreen" class="screen">
        <div class="header">
            <h1>🎉 훈련 완료!</h1>
            <p class="subtitle">수고하셨습니다</p>
        </div>

        <div class="text-center" style="margin-bottom: 30px;">
            <div class="achievement-circle">
                <div class="achievement-text" id="finalAchievement">89%</div>
            </div>
            <h2 id="workoutCompletedName">SST_MCT(14) - 92분 완주</h2>
        </div>

        <div class="result-stats">
            <div class="result-stat">
                <div class="result-stat-value" id="resultAvgPower">184</div>
                <div class="result-stat-label">평균 파워 (W)</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="resultMaxPower">285</div>
                <div class="result-stat-label">최대 파워 (W)</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="resultAvgHR">152</div>
                <div class="result-stat-label">평균 심박 (BPM)</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="resultCalories">892</div>
                <div class="result-stat-label">칼로리 (kcal)</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px;">🤖 AI 성과 분석</h3>
            <div id="aiAnalysis" style="line-height: 1.6; color: var(--gray-color);">
                분석 중...
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-success" onclick="saveResult()">저장하기</button>
            <button class="btn btn-secondary" onclick="shareResult()">공유하기</button>
        </div>

        <button class="btn" onclick="goHome()" style="margin-top: 10px;">새 훈련 시작</button>
    </div>

    <!-- 카운트다운 오버레이 -->
    <div id="countdownOverlay" class="countdown-overlay hidden">
        <div class="countdown-number" id="countdownNumber">5</div>
    </div>

    <script>
        // Google Apps Script 웹 앱 URL (실제 배포된 URL로 교체 필요)
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwp6v4zwoRi0qQekKQZr4bCs8s2wUolHtLNKgq_uX8pIHck1XllibKgzCZ64w6Z7Wrw/exec';
        
        // 전역 변수 및 상태 관리
        let isSegmentChanging = false; // 세그먼트 교체 중(카운트다운 포함)
        let audioCtx = null; // 오디오 컨텍스트 (비프음 정책 대응)
        let countdownActive = false;  // 카운트다운 중복 방지
        let segmentCountdownStarted = false; // 세그먼트별 카운트다운 시작 플래그
        let currentScreen = 'connectionScreen';

        let connectedDevices = { trainer: null, heartRate: null, powerMeter: null }; // 이미 있으면 유지
        let usePowerMeterPreferred = true; // 외부 파워/캐이던스 우선 사용
        //let powerMeterState = { lastCrankRevs: null, lastCrankEventTime: null };
        //let powerMeterCadenceLastTs = 0; // 파워미터 캐이던스 최신 타임스탬프(ms)
        //const POWER_METER_CADENCE_TTL = 3000; // 3초 내 갱신일 때만 PM 캐이던스 우선

        
        let currentUser = null;
        let currentWorkout = null;
        let trainingSession = {
            sessionId: null,
            isRunning: false,
            isPaused: false,
            startTime: null,
            currentSegment: 0,
            segments: [],
            segmentStartTime: null,
            data: {
                power: [],
                cadence: [],
                heartRate: [],
                time: []
            }
        };
        let liveData = {
            power: 0,
            cadence: 0,
            heartRate: 0,
            targetPower: 0
        };

        // 상단(전역) 어딘가에 한 번만 선언
        const CPS_FLAG = {
          PEDAL_POWER_BALANCE_PRESENT: 1 << 0,   // +1 byte
          PEDAL_POWER_BALANCE_REF:     1 << 1,   // (길이 없음)
          ACC_TORQUE_PRESENT:          1 << 2,   // +2 bytes
          ACC_TORQUE_SOURCE:           1 << 3,   // (길이 없음)
          WHEEL_REV_DATA_PRESENT:      1 << 4,   // +6 bytes (u32 revs + u16 time1/1024s)
          CRANK_REV_DATA_PRESENT:      1 << 5,   // +4 bytes (u16 revs + u16 time1/1024s)
          // 이후 Extreme/Angle/Energy 등은 필요 시 확장
        };
        
        let powerMeterState = { lastCrankRevs: null, lastCrankEventTime: null };
        let powerMeterCadenceLastTs = 0;
        const POWER_METER_CADENCE_TTL = 3000; // ms
        
        function handlePowerMeterData(event) {
          const dv = event.target.value;
          let off = 0;
        
          const flags = dv.getUint16(off, true); off += 2;
          const instPower = dv.getInt16(off, true); off += 2;
        
          // 파워: 외부 우선이면 파워미터 값 사용
          if (usePowerMeterPreferred) {
            liveData.power = instPower;
          }
        
          // Pedal Power Balance (있으면 1B)
          if (flags & CPS_FLAG.PEDAL_POWER_BALANCE_PRESENT) off += 1;
          // Accumulated Torque (있으면 2B)
          if (flags & CPS_FLAG.ACC_TORQUE_PRESENT) off += 2;
          // Wheel Revolution Data (있으면 6B)
          if (flags & CPS_FLAG.WHEEL_REV_DATA_PRESENT) off += 6;
        
          // ✅ Crank Revolution Data (비트 5) — 케이던스 계산
          if (flags & CPS_FLAG.CRANK_REV_DATA_PRESENT) {
            const crankRevs = dv.getUint16(off, true); off += 2;
            const lastCrankTime = dv.getUint16(off, true); off += 2; // 1/1024s
        
            if (powerMeterState.lastCrankRevs !== null) {
              // 타이머 롤오버 보정
              let dtTicks = lastCrankTime - powerMeterState.lastCrankEventTime;
              if (dtTicks < 0) dtTicks += 0x10000; // 16bit wrap
              const dRev = crankRevs - powerMeterState.lastCrankRevs;
              if (dRev > 0 && dtTicks > 0) {
                const dtSec = dtTicks / 1024;
                const rpm = (dRev / dtSec) * 60;
                // 비정상치 필터
                if (rpm > 0 && rpm < 220) {
                  liveData.cadence = Math.round(rpm);
                  powerMeterCadenceLastTs = Date.now();
                }
              }
            }
            powerMeterState.lastCrankRevs = crankRevs;
            powerMeterState.lastCrankEventTime = lastCrankTime;
          }
        
          if (trainingSession.isRunning && !trainingSession.isPaused) {
            updateTrainingDisplay();
            recordDataPoint();
          }
        }




        
        // 화면 전환 함수들
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;

            if (screenId === 'profileScreen') {
                loadUsers();
            } else if (screenId === 'workoutScreen') {
                loadWorkouts();
            } else if (screenId === 'trainingReadyScreen') {
                showWorkoutPreview();
            }
        }

        // BLE 연결 함수들
        async function connectTrainer() {
          try {
            showConnectionStatus(true);
        
            const device = await navigator.bluetooth.requestDevice({
              // 기존 필터 유지(트레이너 탐색용). 파워미터는 별도 버튼/함수로도 연결 가능
              filters: [
                { services: ['fitness_machine'] },
                { services: ['cycling_power'] },
                { namePrefix: 'KICKR' },
                { namePrefix: 'Wahoo' }
              ],
              optionalServices: ['device_information', 'fitness_machine', 'cycling_power']
            });
        
            const server = await device.gatt.connect();
        
            // ★ FTMS 우선, 실패하면 CPS로 폴백
            let service, characteristic, isFTMS = false;
            try {
              service = await server.getPrimaryService('fitness_machine');
              characteristic = await service.getCharacteristic('indoor_bike_data');
              isFTMS = true;
            } catch (e) {
              // ★ FTMS 실패 → CPS 시도
              service = await server.getPrimaryService('cycling_power');
              characteristic = await service.getCharacteristic('cycling_power_measurement');
              isFTMS = false;
            }
        
            await characteristic.startNotifications();
        
            if (isFTMS) {
              // ✅ 트레이너 경로: FTMS 파서 + trainer 슬롯
              characteristic.addEventListener('characteristicvaluechanged', handleTrainerData);
              connectedDevices.trainer = {
                name: device.name || 'Smart Trainer',
                device, server, characteristic
              };
            } else {
              // ✅ 파워미터 경로: CPS 파서 + powerMeter 슬롯
              characteristic.addEventListener('characteristicvaluechanged', handlePowerMeterData);
              connectedDevices.powerMeter = {
                name: device.name || 'Power Meter',
                device, server, characteristic
              };
              usePowerMeterPreferred = true; // 외부 파워/케이던스 우선
            }
        
            // (선택 권장) 연결 해제 시 슬롯 정리
            device.addEventListener('gattserverdisconnected', () => {
              try {
                if (isFTMS && connectedDevices.trainer?.device === device) {
                  connectedDevices.trainer = null;
                }
                if (!isFTMS && connectedDevices.powerMeter?.device === device) {
                  connectedDevices.powerMeter = null;
                }
                updateDevicesList();
              } catch (e) { console.warn(e); }
            });
        
            updateDevicesList();
            showConnectionStatus(false);
            alert(`✅ ${device.name || (isFTMS ? 'Smart Trainer' : 'Power Meter')} 연결 성공!`);
          } catch (error) {
            showConnectionStatus(false);
            console.error('트레이너/파워미터 연결 오류:', error);
            alert("❌ 연결 실패: " + error.message);
          }
        }


        // 심박계 연결함수
        async function connectHeartRate() {
            try {
                showConnectionStatus(true);
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate'] }]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('heart_rate');
                const characteristic = await service.getCharacteristic('heart_rate_measurement');

                characteristic.addEventListener('characteristicvaluechanged', handleHeartRateData);
                await characteristic.startNotifications();

                connectedDevices.heartRate = {
                    name: device.name || 'Heart Rate Monitor',
                    device: device,
                    server: server,
                    characteristic: characteristic
                };

                updateDevicesList();
                showConnectionStatus(false);
                alert(`✅ ${device.name} 연결 성공!`);
            } catch (error) {
                showConnectionStatus(false);
                console.error('심박계 연결 오류:', error);
                alert("❌ 심박계 연결 실패: " + error.message);
            }
        }

        // 파워메터 연결 함수들
        async function connectPowerMeter() {
          try {
            showConnectionStatus(true);
        
            let device;
            // 1차: 파워미터로 의심되는 것만 노출
            try {
              //device = await navigator.bluetooth.requestDevice({
                //filters: [
                  //{ services: [0x1818] }, // cycling_power
                  //{ namePrefix: '4iiii' },
                  //{ namePrefix: 'Stages' },
                  //{ namePrefix: 'Favero' },
                  //{ namePrefix: 'Garmin' },
                  //{ namePrefix: 'SRM' },
                  //{ namePrefix: 'Shimano' }
                //],
                //optionalServices: [0x1818, 'device_information']
              //});

                device = await navigator.bluetooth.requestDevice({
                  filters: [{ services: ['cycling_power'] }],
                  optionalServices: ['device_information']   // 필요하면 'cycling_power'도 추가 가능
                });
                
            } catch {
              // 2차: 일부 기기는 광고에 서비스를 안 실음 → 폴백
              device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [0x1818, 'cycling_power', 'device_information']
              });
            }

              
            const server = await device.gatt.connect();
            let service;
            try { service = await server.getPrimaryService(0x1818); }
            catch { service = await server.getPrimaryService('cycling_power'); }
        
            const ch = await service.getCharacteristic(0x2A63 /* cycling_power_measurement */);
            await ch.startNotifications();
            ch.addEventListener('characteristicvaluechanged', handlePowerMeterData);
        
            connectedDevices.powerMeter = { name: device.name || 'Power Meter', device, server, characteristic: ch };
            usePowerMeterPreferred = true;
        
            updateDevicesList();
            showConnectionStatus(false);
            alert(`✅ ${device.name} 파워미터 연결 성공!`);
          } catch (err) {
            showConnectionStatus(false);
            console.error('파워미터 연결 오류:', err);
            alert('❌ 파워미터 연결 실패: ' + err.message);
          }
        }


        function handleTrainerData(event) {
          const dv = event.target.value;
          const flags = dv.getUint16(0, true);
          let off = 2;
        
          // FTMS cadence (bit2) 있을 때
          if (flags & 0x0004) {
            const ftmsCad = dv.getUint16(off, true) * 0.5; off += 2;
            const pmFresh = (Date.now() - powerMeterCadenceLastTs) < POWER_METER_CADENCE_TTL;
            if (!(usePowerMeterPreferred && connectedDevices.powerMeter && pmFresh)) {
              liveData.cadence = ftmsCad; // 파워미터 신호 신선하면 덮어쓰지 않음
            }
          }
        
          // FTMS power(bit6)도 기존 가드 유지
          if (flags & 0x0040) {
            const ftmsPower = dv.getInt16(off, true);
            if (!(usePowerMeterPreferred && connectedDevices.powerMeter)) {
              liveData.power = ftmsPower;
            }
          }
        
          if (trainingSession.isRunning && !trainingSession.isPaused) {
            updateTrainingDisplay();
            recordDataPoint();
          }
        }

        
        function handleHeartRateData(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            const rate16Bits = flags & 0x1;
            const bpm = rate16Bits ? value.getUint16(1, true) : value.getUint8(1);

            liveData.heartRate = bpm;

            if (trainingSession.isRunning && !trainingSession.isPaused) {
                updateTrainingDisplay();
            }
        }


        
        function showConnectionStatus(show) {
            const status = document.getElementById('connectionStatus');
            if (show) {
                status.classList.remove('hidden');
            } else {
                status.classList.add('hidden');
            }
        }

        function updateDevicesList() {
            const deviceList = document.getElementById('deviceList');
            const summary = document.getElementById('connectedDevicesSummary');
            const summaryList = document.getElementById('connectedDevicesList');

            let connectedCount = 0;
            let html = '';

            if (connectedDevices.trainer) {
                connectedCount++;
                html += `
                    <div class="card device-card connected">
                        <div class="device-info">
                            <div class="device-icon">🚴‍♂️</div>
                            <div class="device-details">
                                <h3>${connectedDevices.trainer.name}</h3>
                                <p>Smart Trainer</p>
                            </div>
                        </div>
                        <div style="color: var(--success-color); font-weight: 600;">연결됨</div>
                    </div>
                `;
            }

            if (connectedDevices.powerMeter) {
              connectedCount++;
              html += `
                <div class="card device-card connected">
                  <div class="device-info">
                    <div class="device-icon">⚡</div>
                    <div class="device-details">
                      <h3>${connectedDevices.powerMeter.name}</h3>
                      <p>Crank Power Meter (BLE)</p>
                    </div>
                  </div>
                  <div style="color: var(--success-color); font-weight: 600;">연결됨</div>
                </div>
              `;
            }

            
            if (connectedDevices.heartRate) {
                connectedCount++;
                html += `
                    <div class="card device-card connected">
                        <div class="device-info">
                            <div class="device-icon" style="background: var(--danger-color);">❤️</div>
                            <div class="device-details">
                                <h3>${connectedDevices.heartRate.name}</h3>
                                <p>Heart Rate Monitor</p>
                            </div>
                        </div>
                        <div style="color: var(--success-color); font-weight: 600;">연결됨</div>
                    </div>
                `;
            }

            deviceList.innerHTML = html;

            if (connectedCount > 0) {
                summaryList.innerHTML = html;
                summary.classList.remove('hidden');
            } else {
                summary.classList.add('hidden');
            }
        }

        function proceedToProfile() {
            //if (!connectedDevices.trainer) {
            if (!connectedDevices.trainer && !connectedDevices.powerMeter) {
                alert('훈련을 위해서는 스마트 트레이너 또는 파워메터가 필요합니다.');
                //return;  // 수정예정====> 실전배포 시 삭제 필요!!!!
            }
            showScreen('profileScreen');
        }

        // 사용자 관리 함수들
        async function loadUsers() {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getUsers' })
                });
                const users = await response.json();
                displayUsers(users);
            } catch (error) {
                console.error('사용자 로드 실패:', error);
                // 더미 데이터로 대체
                const dummyUsers = [
                    { user_id: 'U1', name: '박지성', contact: '010-1234-5678', ftp: 242, weight: 56 },
                    { user_id: 'U2', name: '박선호', contact: '010-9876-5432', ftp: 200, weight: 70 }
                ];
                displayUsers(dummyUsers);
            }
        }




            // 실시간 칼로리 계산 예시 (단순 HR 기반 공식)
            function updateCalories() {
                const heartRate = trainingSession.data.heartRate.slice(-1)[0] || 0;
                const weight = currentUser ? currentUser.weight : 70;
                const durationMin = (Date.now() - trainingSession.startTime) / 60000;
            
                // 🔸 간단한 남녀 공통 추정식 (심박수 기반)
                const kcal = 0.6309 * heartRate + 0.1988 * weight + 0.2017 * 30 - 55.0969;
                const totalKcal = Math.max(0, (kcal / 4.184) * durationMin * 0.5);
            
                document.getElementById("calorieValue").textContent = totalKcal.toFixed(0);
            }

        
        function displayUsers(users) {
            const profileList = document.getElementById('profileList');
            profileList.innerHTML = '';

            users.forEach(user => {
                const profileCard = document.createElement('div');
                profileCard.className = 'card profile-card';
                profileCard.onclick = () => selectUser(user);

                const initials = user.name.substring(0, 2);
                const powerToWeight = (user.ftp / user.weight).toFixed(1);

                profileCard.innerHTML = `
                    <div class="profile-info">
                        <div class="profile-avatar">${initials}</div>
                        <div class="profile-details">
                            <h3>${user.name}</h3>
                            <div class="profile-stats">
                                <div>
                                    <div class="stat-value">${user.ftp}W</div>
                                    <div class="stat-label">FTP</div>
                                </div>
                                <div>
                                    <div class="stat-value">${user.weight}kg</div>
                                    <div class="stat-label">몸무게</div>
                                </div>
                                <div>
                                    <div class="stat-value">${powerToWeight}</div>
                                    <div class="stat-label">W/kg</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                profileList.appendChild(profileCard);
            });
        }

        // 사용자 W/kg 색상 등급 표시
            function showUserInfo() {
                if (!currentUser) return;
            
                const wkg = (currentUser.ftp / currentUser.weight).toFixed(1);
                const userInfoEl = document.getElementById("userInfo");
            
                // 색상 분기
                let bgColor;
                if (wkg >= 4) bgColor = "#ff3333";         // 빨강
                else if (wkg >= 3.5) bgColor = "#ff6600";  // 오렌지
                else if (wkg >= 3) bgColor = "#1a5ab8";    // 남색
                else if (wkg >= 2.2) bgColor = "#7ED321";  // 연두
                else bgColor = "#FFD700";                  // 노랑
            
                // HTML 표시
                userInfoEl.innerHTML = `
                    <strong>${currentUser.name}</strong> |
                    FTP: ${currentUser.ftp}W |
                    ${wkg} W/kg
                `;
                userInfoEl.style.background = bgColor;
                userInfoEl.style.padding = "6px 10px";
                userInfoEl.style.borderRadius = "8px";
                userInfoEl.style.color = "#fff";
            }


        // 랩파워 달성율별 색 등급 표시        
        function colorizeLapPower() {
          // 1) 목표 파워(숫자) 가져오기
          let target = 0;
        
          // 우선순위: 실시간 타겟 → 화면의 targetPowerValue
          if (typeof liveData !== 'undefined' && Number(liveData.targetPower) > 0) {
            target = Number(liveData.targetPower);
          } else {
            const tEl = document.getElementById('targetPowerValue');
            if (tEl) target = Number(tEl.textContent.replace(/[^\d.-]/g, '')) || 0;
          }
          if (!target) return; // 목표가 없으면 색상 판단 불가
        
          // 2) 랩파워로 간주할 요소들(필요한 것만 남겨도 됨)
          const lapIds = [
            'avgSegmentPowerValue', // 세그먼트 평균 파워 카드(있다면)
            'avgPowerValue'         // 하단 요약의 평균 파워(있다면)
            // 'currentPowerValue',  // 원한다면 현재 파워도 포함 가능
          ];
        
          lapIds.forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
        
            const val = Number(String(el.textContent).replace(/[^\d.-]/g, '')) || 0;
            if (val <= 0) return;
        
            const pct = (val / target) * 100;
        
            // 기존 상태 클래스 제거
            el.classList.remove('lap-power--mint', 'lap-power--yellow', 'lap-power--white');
        
            // 기준 적용: ≥95 민트, <90 황색, 나머지 흰색
            if (pct >= 95) el.classList.add('lap-power--mint');
            else if (pct < 90) el.classList.add('lap-power--yellow');
            else el.classList.add('lap-power--white');
          });
        }


        
        
        function selectUser(user) {
            currentUser = user;
            alert(`${user.name}님, 환영합니다!`);
            showScreen('workoutScreen');
 
        }

        function showAddUserForm() {
            document.getElementById('addUserForm').classList.remove('hidden');
        }

        function cancelAddUser() {
            document.getElementById('addUserForm').classList.add('hidden');
            document.getElementById('userName').value = '';
            document.getElementById('userContact').value = '';
            document.getElementById('userFTP').value = '';
            document.getElementById('userWeight').value = '';
        }

        async function saveNewUser() {
            const name = document.getElementById('userName').value.trim();
            const contact = document.getElementById('userContact').value.trim();
            const ftp = parseInt(document.getElementById('userFTP').value);
            const weight = parseInt(document.getElementById('userWeight').value);

            if (!name || !contact || !ftp || !weight) {
                alert('모든 필드를 입력해주세요.');
                return;
            }

            if (ftp < 100 || ftp > 500) {
                alert('FTP는 100W에서 500W 사이의 값을 입력해주세요.');
                return;
            }

            if (weight < 40 || weight > 150) {
                alert('몸무게는 40kg에서 150kg 사이의 값을 입력해주세요.');
                return;
            }

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'addUser',
                        userData: { name, contact, ftp, weight }
                    })
                });
                const result = await response.json();

                if (result.success) {
                    alert('새 사용자가 추가되었습니다!');
                    cancelAddUser();
                    loadUsers();
                } else {
                    alert('사용자 추가 실패: ' + result.error);
                }
            } catch (error) {
                console.error('사용자 추가 오류:', error);
                alert('사용자 추가 중 오류가 발생했습니다.');
            }
        }

        // 워크아웃 관리 함수들
        async function loadWorkouts() {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getWorkouts' })
                });
                const workouts = await response.json();
                displayWorkouts(workouts);
            } catch (error) {
                console.error('워크아웃 로드 실패:', error);
                // 더미 데이터로 대체
                const dummyWorkouts = [
                    {
                        workout_id: 'SST_MCT14',
                        workout_name: 'SST_MCT(14)',
                        total_duration: 5520, // 92분 → 초 단위로 수정
                        avg_intensity: 78,
                        segments: [
                            { segment_order: 1, segment_type: '웜업', description: '80RPM FTP 60%', ftp_percent: 60, duration_sec: 20, target_rpm: 80 },
                            { segment_order: 2, segment_type: '인터벌', description: 'FTP 88%', ftp_percent: 88, duration_sec: 30, target_rpm: 90 },
                            { segment_order: 3, segment_type: '휴식', description: 'FTP 50%', ftp_percent: 50, duration_sec: 10, target_rpm: 75 },
                            { segment_order: 4, segment_type: '인터벌', description: 'FTP 92%', ftp_percent: 92, duration_sec: 60, target_rpm: 90 },
                            { segment_order: 5, segment_type: '쿨다운', description: 'FTP 45%', ftp_percent: 45, duration_sec: 10, target_rpm: 70 }
                        ]
                    }
                ];
                displayWorkouts(dummyWorkouts);
            }
        }

        function displayWorkouts(workouts) {
            const workoutList = document.getElementById('workoutList');
            workoutList.innerHTML = '';

            workouts.forEach(workout => {
                const workoutCard = document.createElement('div');
                workoutCard.className = 'card workout-card';
                workoutCard.onclick = () => selectWorkout(workout);

                const duration = Math.floor(workout.total_duration / 60);
                const tss = calculateWorkoutTSS(workout);

                workoutCard.innerHTML = `
                    <div class="workout-header">
                        <div class="workout-title">${workout.workout_name}</div>
                        <div class="workout-duration">${duration}분</div>
                    </div>
                    <div style="margin: 15px 0;">
                        <div style="font-size: 14px; color: var(--gray-color);">
                            평균: ${workout.avg_intensity}% FTP | TSS: ${tss}
                        </div>
                    </div>
                `;

                workoutList.appendChild(workoutCard);
            });
        }

        function calculateWorkoutTSS(workout) {
            let totalTSS = 0;
            workout.segments.forEach(segment => {
                const intensityFactor = segment.ftp_percent / 100;
                const durationHours = segment.duration_sec / 3600;
                totalTSS += durationHours * intensityFactor * intensityFactor * 100;
            });
            return Math.round(totalTSS);
        }

        function selectWorkout(workout) {
            currentWorkout = workout;
            showScreen('trainingReadyScreen');
        }

        // 워크아웃 미리보기 화면
        function showWorkoutPreview() {
            if (!currentWorkout || !currentUser) return;

            document.getElementById('previewWorkoutName').textContent = currentWorkout.workout_name;
            document.getElementById('previewDuration').textContent = Math.floor(currentWorkout.total_duration / 60) + '분';
            document.getElementById('previewIntensity').textContent = currentWorkout.avg_intensity + '%';
            document.getElementById('previewTSS').textContent = calculateWorkoutTSS(currentWorkout);

            const segmentPreview = document.getElementById('segmentPreview');
            segmentPreview.innerHTML = '';

            currentWorkout.segments.forEach((segment, index) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = `segment-item ${segment.segment_type.toLowerCase()}`;
                
                const duration = Math.floor(segment.duration_sec / 60);
                
                segmentDiv.innerHTML = `
                    <h4>${segment.segment_type}</h4>
                    <div class="ftp-percent">${segment.ftp_percent}%</div>
                    <div class="duration">${duration}분</div>
                `;

                segmentPreview.appendChild(segmentDiv);
            });
        }

        function startWorkoutTraining() {
            showScreen('trainingScreen');
            initializeTraining();
        }

        function backToWorkoutSelection() {
            showScreen('workoutScreen');
        }

        // 훈련 실행 함수들 - 수정된 부분
        function initializeTraining() {

            if (!currentWorkout || !currentUser) return;
            showUserInfo(); // ✅ 사용자 정보 표시/ 등급표시
            
            if (!currentWorkout || !currentUser) return;

            // 상태 초기화
            countdownActive = false;
            segmentCountdownStarted = false;

            trainingSession = {
                sessionId: 'S' + Date.now(),
                isRunning: false,
                isPaused: false,
                startTime: null,
                currentSegment: 0,
                segments: currentWorkout.segments,
                segmentStartTime: null,
                data: {
                    power: [],
                    cadence: [],
                    heartRate: [],
                    time: []
                }
            };

            updateTrainingDisplay();
            createTimeline();
            updateSegmentDisplay();

            // 5초 카운트다운 후 시작
            showCountdown(5, () => {
                startTraining();
            });
        }

        /////////////////////////////// 
        function showCountdown(seconds, callback, message = "훈련 시작 준비!", isInitialCall = true) {
            if (isInitialCall && countdownActive) return; // 중복 방지
            if (isInitialCall) countdownActive = true;
        
            // ✅ 브라우저 오디오 정책 대응
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioCtx.resume();
            }
        
            const overlay = document.getElementById('countdownOverlay');
            const number = document.getElementById('countdownNumber');
        
            let messageEl = document.getElementById("countdownMessage");
            if (!messageEl) {
                messageEl = document.createElement("div");
                messageEl.id = "countdownMessage";
                messageEl.style.position = "absolute";
                messageEl.style.top = "20%";
                messageEl.style.width = "100%";
                messageEl.style.textAlign = "center";
                messageEl.style.color = "white";
                messageEl.style.fontSize = "36px";
                messageEl.style.opacity = "0";
                messageEl.style.transition = "opacity 0.5s ease-in-out";
                overlay.appendChild(messageEl);
            }
        
            messageEl.textContent = message;
            messageEl.style.opacity = "1";
            overlay.classList.remove('hidden');
            number.textContent = seconds;
        
            playBeep(); // 시작 시 1회
        
            if (seconds > 0) {
                setTimeout(() => {
                    number.textContent = seconds - 1;
                    if (seconds > 1) playBeep();
                    showCountdown(seconds - 1, callback, message, false);
                }, 1000);
            } else {
                messageEl.style.opacity = "0";
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    countdownActive = false;
                    callback();
                }, 300);
            }
        }

       // 랩파워 색깔 표시를 위한 화면 로딩시 보정
        window.addEventListener('load', () => {
          colorizeLapPower();
        });
        
        //function playBeep() {
            //try {
                //const ctx = new (window.AudioContext || window.webkitAudioContext)();
                //const osc = ctx.createOscillator();
                //const gain = ctx.createGain();

                //osc.connect(gain);
                //gain.connect(ctx.destination);

                //osc.type = "sine";
                //osc.frequency.value = 800;
                //gain.gain.setValueAtTime(0.2, ctx.currentTime);

                //osc.start();
                //osc.stop(ctx.currentTime + 0.15);
            //} catch (err) {
                //console.error("Beep sound error:", err);
            //}
        //}

        let beepActive = false;
        
        function playBeep() {
            if (beepActive) return;
            beepActive = true;
        
            try {
                const ctx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
        
                osc.connect(gain);
                gain.connect(ctx.destination);
        
                osc.type = "square";
                osc.frequency.value = 950;
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
        
                osc.start();
                osc.stop(ctx.currentTime + 0.15);
        
                osc.onended = () => {
                    beepActive = false;
                };
            } catch (err) {
                beepActive = false;
                console.error("Beep sound error:", err);
            }
        }
       
/////////////////////////////////////////////////////////////////////////////////




        
        function startTraining() {
            trainingSession.isRunning = true;
            trainingSession.startTime = Date.now();
            trainingSession.segmentStartTime = Date.now();
            segmentCountdownStarted = false; // 초기화

            updateTrainingTimer();
            updateTargetPower();

            // 서버에 세션 시작 알림
            try {
                fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'startTrainingSessionAPI',
                        sessionData: {
                            user_id: currentUser.user_id,
                            workout_id: currentWorkout.workout_id
                        }
                    })
                });
            } catch (error) {
                console.error('세션 시작 실패:', error);
            }

            // 시뮬레이션 데이터 생성 (실제 기기가 연결되지 않은 경우)
            if (!connectedDevices.trainer && !connectedDevices.powerMeter) {
                startDataSimulation();
            }
        }

        function startDataSimulation() {
            setInterval(() => {
                if (!trainingSession.isRunning || trainingSession.isPaused) return;

                const currentSeg = trainingSession.segments[trainingSession.currentSegment];
                if (!currentSeg) return;

                const targetPower = Math.round(currentUser.ftp * (currentSeg.ftp_percent / 100));
                const variation = (Math.random() - 0.5) * 30;
                liveData.power = Math.max(0, targetPower + variation);
                liveData.cadence = currentSeg.target_rpm + (Math.random() - 0.5) * 10;
                liveData.targetPower = targetPower;

                updateTrainingDisplay();
                recordDataPoint();
            }, 1000);
        }

        function updateTargetPower() {
            if (!trainingSession.isRunning || trainingSession.isPaused) return;

            const currentSeg = trainingSession.segments[trainingSession.currentSegment];
            if (currentSeg && currentUser) {
                const targetPower = Math.round(currentUser.ftp * (currentSeg.ftp_percent / 100));
                liveData.targetPower = targetPower;
            }
            
            const targetEl = document.getElementById('targetPowerValue');
            if (targetEl) targetEl.textContent = Math.round(liveData.targetPower);
            colorizeLapPower();  // ✅ 새 목표 기준으로 재색칠
            
        }

        function updateTrainingDisplay() {
            // 실시간 표시값
            document.getElementById('currentPowerValue').textContent = Math.round(liveData.power);
            document.getElementById('cadenceValue').textContent = Math.round(liveData.cadence);
            document.getElementById('heartRateValue').textContent = Math.round(liveData.heartRate);
            document.getElementById('targetPowerValue').textContent = liveData.targetPower;

            // 달성률 먼저 계산/표시
            const achievement = liveData.targetPower > 0
              ? Math.min(100, Math.round((liveData.power / liveData.targetPower) * 100))
              : 0;
            const achBar = document.getElementById('achievementValueBar');
            if (achBar) achBar.textContent = achievement;

            // (교체 후) 세그먼트 진행률 % 표시
            (function updateSegmentProgressInline() {
              const seg = trainingSession.segments[trainingSession.currentSegment];
              let segPct = 0;
              if (seg && trainingSession.segmentStartTime) {
                const segElapsed = Date.now() - trainingSession.segmentStartTime;
                segPct = Math.min(100, Math.floor((segElapsed / (seg.duration_sec * 1000)) * 100));
              }
              const el = document.getElementById('segmentProgress');
              if (el) el.textContent = segPct;
            })();
            
            

            // 진행바 갱신
            const progressPercent = Math.min(100, (liveData.power / liveData.targetPower) * 100);
            document.getElementById('powerProgressBar').style.width = progressPercent + '%';

            // 전체 평균 파워
            let avgPower = 0;
            if (trainingSession.data.power.length > 0) {
                avgPower = trainingSession.data.power.reduce((a, b) => a + b, 0) / trainingSession.data.power.length;
                document.getElementById('avgPowerValue').textContent = Math.round(avgPower);
            }

          
            // 현재 세그먼트별 평균 파워 계산
            const segStart = trainingSession.segmentStartTime;
            const segEnd = Date.now();
            const segmentPowerData = trainingSession.data.power.filter((_, i) => {
                const t = trainingSession.data.time[i];
                return t >= segStart && t <= segEnd;
            });

            let avgSegPower = 0;
            if (segmentPowerData.length > 0) {
                avgSegPower = segmentPowerData.reduce((a, b) => a + b, 0) / segmentPowerData.length;
            }

            const avgSegPowerEl = document.getElementById('avgSegmentPowerValue');
            if (avgSegPowerEl) {
                avgSegPowerEl.textContent = Math.round(avgSegPower);
                if (avgSegPower < liveData.targetPower * 0.9) {
                    avgSegPowerEl.style.color = "#F56500"; // 주황색 (낮음)
                } else if (avgSegPower > liveData.targetPower * 1.1) {
                    avgSegPowerEl.style.color = "#7ED321"; // 연두색 (높음)
                } else {
                    avgSegPowerEl.style.color = "white"; // 정상 범위
                }
            }

            colorizeLapPower(); // ✅ 바로 호출

            
        }

            // 칼로리, TSS 계산            
            function updateCaloriesAndTSS() {
                if (!trainingSession.startTime) return;
                if (!trainingSession.isRunning || !currentUser) return;
                if (trainingSession.data.power.length < 5) return; // 최소 5초 이상 후부터 계산
                
                const heartRate = trainingSession.data.heartRate.slice(-1)[0] || 0;
                const power = trainingSession.data.power.slice(-1)[0] || 0;
                const weight = currentUser.weight || 70;
            
                // ✅ 경과 시간(초)
                const elapsedSec = (Date.now() - trainingSession.startTime) / 1000;
                const elapsedHr = elapsedSec / 3600;
            
                // 🔹 1. 실시간 칼로리 계산 (간단화된 HR 기반 추정식)
                const kcalPerMin = (0.6309 * heartRate + 0.1988 * weight + 0.2017 * 30 - 55.0969) / 4.184;
                const totalKcal = Math.max(0, kcalPerMin * (elapsedSec / 60) * 0.5);
                document.getElementById("calorieValue").textContent = totalKcal.toFixed(0);
            
                // 🔹 2. TSS 계산 (Normalized Power 기반 근사)
                // TSS = ( (sec × NP × IF) / (FTP × 3600) ) × 100
                const ftp = currentUser.ftp || 200;
                const avgPower = trainingSession.data.power.length
                    ? trainingSession.data.power.reduce((a, b) => a + b, 0) / trainingSession.data.power.length
                    : 0;
                const intensityFactor = avgPower / ftp;
                const tss = (elapsedSec * avgPower * intensityFactor) / (ftp * 3600) * 100;
                document.getElementById("tssValue").textContent = tss.toFixed(1);
            }


        // 총 계획시간(ms) 계산: 세그먼트 합계를 우선, 메타(total_duration)와 차이가 크면 합계 사용
        function getPlanTotalDurationMs() {
          if (!currentWorkout) return 0;
          const sumSec = (currentWorkout.segments || [])
            .reduce((acc, s) => acc + (Number(s.duration_sec) || 0), 0);
          const metaSec = Number(currentWorkout.total_duration) || 0;
          if (sumSec > 0 && (metaSec === 0 || Math.abs(sumSec - metaSec) > 1)) {
            return sumSec * 1000;           // 세그먼트 합 우선
          }
          return (metaSec || sumSec) * 1000;
        }



        
        function updateTrainingTimer() {
            const timerInterval = setInterval(() => {
                if (!trainingSession.isRunning) {
                    clearInterval(timerInterval);
                    return;
                }

                if (trainingSession.isPaused) return;

                const elapsed = Date.now() - trainingSession.startTime;
                const segmentElapsed = Date.now() - trainingSession.segmentStartTime;

                const elapsedMinutes = Math.floor(elapsed / 60000);
                const elapsedSeconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('elapsedTime').textContent =
                    `${elapsedMinutes.toString().padStart(2, '0')}:${elapsedSeconds.toString().padStart(2, '0')}`;
                    // ✅ 전체 진행률 계산 (훈련 총 시간 대비)
                    const totalMs = getPlanTotalDurationMs();
                    if (totalMs > 0) {
                      const percent = Math.min(100, Math.floor((elapsed / totalMs) * 100));
                      const ep = document.getElementById('elapsedPercent');
                      if (ep) ep.textContent = percent;
                    }
                    
                    // 총 시간 표기도 합계 기준으로 맞추고 싶다면
                    const totalSec = Math.round(totalMs / 1000);
                    const totalMinutes = Math.floor(totalSec / 60);
                    const totalSecondsRemaining = totalSec % 60;

                checkSegmentProgress(segmentElapsed);
                updateSegmentTimer(segmentElapsed);
                // ✅ 추가
                updateCaloriesAndTSS(); // 칼로리/TSS 실시간 갱신
                
            }, 1000); 
        }



        // 세그먼트 시간 카운다운        
        function updateSegmentTimer(/* segmentElapsed */) {
          const seg = trainingSession.segments[trainingSession.currentSegment];
          if (!seg) return;
        
          // 세그먼트 종료 시각(절대시각) 기준으로 남은 시간을 계산
          const endAt = trainingSession.segmentStartTime + seg.duration_sec * 1000;
          const segmentRemaining = Math.max(0, endAt - Date.now());
        
          const remainingMinutes = Math.floor(segmentRemaining / 60000);
          const remainingSeconds = Math.floor((segmentRemaining % 60000) / 1000);
        
          const segmentTimeEl = document.getElementById('segmentTime');
          segmentTimeEl.textContent =
            `${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        
          // 10초 이하 시 깜빡임 유지
          if (segmentRemaining > 0 && segmentRemaining <= 10000) {
            segmentTimeEl.classList.add('countdown-alert');
          } else {
            segmentTimeEl.classList.remove('countdown-alert');
          }
        }

        // ① 유틸
        function getSegmentDurationMs(seg){
          if(!seg) return 0;
          const parentMs = (Number(seg.duration_sec)||0)*1000;
          const childMs = (seg.steps||seg.segments||seg.intervals||seg.children||[])
            .reduce((a,s)=>a+((Number(s.duration_sec)||0)*1000),0);
          return childMs>0 ? childMs : parentMs;
        }
        
        // ② 진행률 계산 교체
        const segDurationMs = getSegmentDurationMs(currentSeg);
        const progressPercent = segDurationMs>0
          ? Math.min(100, (segmentElapsed/segDurationMs)*100)
          : 0;
        

        

        // 수정된 세그먼트 진행 체크 함수
        function checkSegmentProgress(segmentElapsed) {
            const segIndex = trainingSession.currentSegment;
            const currentSeg = trainingSession.segments[segIndex];
            if (!currentSeg) return;
        
            // ✅ 카운트다운 중에는 세그먼트 진행 중지
            if (isSegmentChanging) return;
        
            const progressPercent = Math.min(100, (segmentElapsed / (currentSeg.duration_sec * 1000)) * 100);
            const segments = document.querySelectorAll(".timeline-segment");
        
            segments.forEach((seg, idx) => {
                const fill = seg.querySelector(".progress-fill");
                if (!fill) return;
                if (idx < segIndex) fill.style.width = "100%";
                else if (idx === segIndex) fill.style.width = `${progressPercent}%`;
                else fill.style.width = "0%";
            });
        
            const remainingTime = currentSeg.duration_sec * 1000 - segmentElapsed;
        
            // ✅ 종료 5초 전 카운트다운 (한 번만 실행)
            if (!segmentCountdownStarted && remainingTime <= 5000 && remainingTime > 4000) {
                segmentCountdownStarted = true;
                isSegmentChanging = true; // 카운트다운 중 루프 일시 정지
        
                if (segIndex < trainingSession.segments.length - 1) {
                    showCountdown(5, () => {
                        completeCurrentSegment();
                        nextSegment();
                        isSegmentChanging = false;
                    }, "다음 세그먼트 준비!");
                } else {
                    showCountdown(5, () => {
                        completeCurrentSegment();
                        completeTraining();
                        isSegmentChanging = false;
                    }, "훈련 완료!");
                }
                return;
            }
        
            // ✅ 카운트다운이 끝난 뒤, 남은 시간이 완전히 0이 되면 정상 종료
            if (remainingTime <= 0 && !isSegmentChanging) {
                completeCurrentSegment();
                if (segIndex < trainingSession.segments.length - 1) {
                    nextSegment();
                } else {
                    completeTraining();
                }
            }

            // ✅ progressPercent 계산 직후에 추가 세그멘트 진행율
            const segProgEl = document.getElementById('segmentProgress');
            if (segProgEl) segProgEl.textContent = Math.floor(progressPercent);            
        }


        function completeCurrentSegment() {
            const segIndex = trainingSession.currentSegment;
            const currentSeg = trainingSession.segments[segIndex];
            if (!currentSeg) return;

            const segmentStartTime = trainingSession.segmentStartTime;
            const segmentEndTime = Date.now();

            const powerData = trainingSession.data.power;
            const timeData = trainingSession.data.time;

            const segmentPowerData = powerData.filter((_, i) => {
                const t = timeData[i];
                return t >= segmentStartTime && t <= segmentEndTime;
            });

            const avgPower = segmentPowerData.length > 0
                ? segmentPowerData.reduce((a, b) => a + b, 0) / segmentPowerData.length
                : 0;

            const targetPower = currentUser.ftp * (currentSeg.ftp_percent / 100);
            const achievement = targetPower > 0 ? (avgPower / targetPower) * 100 : 0;
            const color = achievement >= 100 ? "#7ED321" : "#F56500";

            const segment = document.getElementById(`timeline-segment-${segIndex}`);
            const fill = segment ? segment.querySelector(".progress-fill") : null;
            if (fill) {
                fill.style.width = "100%";
                fill.style.background = color;
            }

            console.log(`세그먼트 ${segIndex + 1} 완료: 평균 파워 ${Math.round(avgPower)}W, 달성률 ${Math.round(achievement)}%`);
        }


////////////////////////////////////////////////////////////////////////////////
        function nextSegment() {
            trainingSession.currentSegment++;
            segmentCountdownStarted = false;
            isSegmentChanging = false;
        
            if (trainingSession.currentSegment >= trainingSession.segments.length) {
                completeTraining();
                return;
            }
        
            trainingSession.segmentStartTime = Date.now();
            const sp = document.getElementById('segmentProgress');
            if (sp) sp.textContent = 0;  
            
            updateSegmentDisplay();
            updateTargetPower();
            updateTimelineSegment(trainingSession.currentSegment, 'current');
        }


        
        function updateSegmentDisplay() {
            const currentSeg = trainingSession.segments[trainingSession.currentSegment];
            if (!currentSeg) return;

            document.getElementById('currentSegmentName').textContent =
                `${currentSeg.description} (${currentSeg.segment_type})`;

            const nextSeg = trainingSession.segments[trainingSession.currentSegment + 1];
            if (nextSeg) {
                document.getElementById('nextSegment').textContent = `다음: ${nextSeg.description}`;
            } else {
                document.getElementById('nextSegment').textContent = '다음: 훈련 완료';
            }
        }

        function createTimeline() {
            const timeline = document.getElementById('timelineSegments');
            timeline.innerHTML = '';
        
            // ✅ 전체 세그먼트 시간 합계 구하기
            const totalDuration = trainingSession.segments.reduce(
                (sum, seg) => sum + seg.duration_sec,
                0
            );
        
            trainingSession.segments.forEach((seg, index) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'timeline-segment';
                segmentDiv.id = `timeline-segment-${index}`;
        
                // ✅ 시간 비율에 따른 폭 계산
                const widthPercent = (seg.duration_sec / totalDuration) * 100;
                segmentDiv.style.flex = 'unset';
                segmentDiv.style.width = `${widthPercent}%`;
        
                // 시간 표시 (분:초)
                const minutes = Math.floor(seg.duration_sec / 60);
                const seconds = seg.duration_sec % 60;
                const timeLabel =
                    seg.duration_sec >= 60
                        ? `${minutes}:${seconds.toString().padStart(2, "0")}`
                        : `${seconds}s`;
        
                segmentDiv.innerHTML = `
                    <div class="progress-fill"></div>
                    <div class="segment-label">
                        ${index + 1}<br><span class="segment-time">${timeLabel}</span>
                    </div>
                `;
        
                timeline.appendChild(segmentDiv);
            });
        }


        function updateTimelineSegment(segmentIndex, status) {
            const segment = document.getElementById(`timeline-segment-${segmentIndex}`);
            if (!segment) return;
            segment.className = `timeline-segment ${status}`;
        }

        function recordDataPoint() {
            trainingSession.data.power.push(liveData.power);
            trainingSession.data.cadence.push(liveData.cadence);
            trainingSession.data.heartRate.push(liveData.heartRate);
            trainingSession.data.time.push(Date.now());
        }

        function togglePause() {
            trainingSession.isPaused = !trainingSession.isPaused;
            const pauseIcon = document.getElementById('pauseIcon');
            pauseIcon.textContent = trainingSession.isPaused ? '▶️' : '⏸️';
        }

        function skipSegment() {
            if (confirm('현재 구간을 건너뛰시겠습니까?')) {
                completeCurrentSegment();
                nextSegment();
            }
        }

        function stopTraining() {
            if (confirm('정말 훈련을 중단하시겠습니까?')) {
                trainingSession.isRunning = false;
                completeTraining();
            }
        }

        function completeTraining() {
            trainingSession.isRunning = false;

            const avgPower = calculateAverage(trainingSession.data.power);
            const maxPower = Math.max(...trainingSession.data.power);
            const avgHR = calculateAverage(trainingSession.data.heartRate);
            const achievement = calculateOverallAchievement();

            const durationHours = (Date.now() - trainingSession.startTime) / 3600000;
            const calories = Math.round(avgPower * durationHours * 3.6);

            document.getElementById('finalAchievement').textContent = achievement + '%';
            document.getElementById('workoutCompletedName').textContent =
                `${currentWorkout.workout_name} - ${Math.floor(durationHours * 60)}분 완주`;

            document.getElementById('resultAvgPower').textContent = Math.round(avgPower);
            document.getElementById('resultMaxPower').textContent = Math.round(maxPower);
            document.getElementById('resultAvgHR').textContent = Math.round(avgHR);
            document.getElementById('resultCalories').textContent = calories;

            // AI 분석 요청
            requestAIAnalysis();

            showScreen('resultScreen');
        }

        function calculateAverage(array) {
            return array.length > 0 ? array.reduce((a, b) => a + b, 0) / array.length : 0;
        }

        function calculateOverallAchievement() {
            const totalTargetPowerTime = trainingSession.segments.reduce((sum, seg) => {
                const targetPower = currentUser.ftp * (seg.ftp_percent / 100);
                return sum + (targetPower * seg.duration_sec);
            }, 0);

            const totalActualPowerTime = trainingSession.data.power.reduce((sum, power) => sum + power, 0);

            if (totalTargetPowerTime === 0) return 100;
            return Math.min(100, Math.round((totalActualPowerTime / totalTargetPowerTime) * 100));
        }

        function requestAIAnalysis() {
            document.getElementById('aiAnalysis').textContent = '분석 중...';

            try {
                fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'analyzeTrainingPerformance',
                        sessionId: trainingSession.sessionId
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById('aiAnalysis').textContent = result.analysis;
                    } else {
                        document.getElementById('aiAnalysis').textContent = 'AI 분석을 수행할 수 없습니다.';
                    }
                })
                .catch(error => {
                    console.error('AI 분석 실패:', error);
                    document.getElementById('aiAnalysis').textContent = 'AI 분석 중 오류가 발생했습니다.';
                });
            } catch (error) {
                console.error('AI 분석 요청 실패:', error);
                document.getElementById('aiAnalysis').textContent = 'AI 분석을 수행할 수 없습니다.';
            }
        }

        function saveResult() {
            alert('훈련 결과가 저장되었습니다!');
        }

        function shareResult() {
            const achievement = document.getElementById('finalAchievement').textContent;
            const workoutName = document.getElementById('workoutCompletedName').textContent;
            const avgPower = document.getElementById('resultAvgPower').textContent;
            const avgHR = document.getElementById('resultAvgHR').textContent;

            const shareText = `🚴‍♂️ 사이클 아카데미 훈련 완료!
${workoutName}
달성률: ${achievement}
평균 파워: ${avgPower}W
평균 심박: ${avgHR}bpm

🎯 당신도 도전해보세요!
${window.location.href}`;

            if (navigator.share) {
                navigator.share({
                    title: '사이클 아카데미 - 훈련 완료!',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('결과가 클립보드에 복사되었습니다!');
                });
            }
        }

        function goHome() {
            currentUser = null;
            currentWorkout = null;
            countdownActive = false;
            segmentCountdownStarted = false;
            trainingSession = {
                sessionId: null,
                isRunning: false,
                isPaused: false,
                startTime: null,
                currentSegment: 0,
                segments: [],
                data: { power: [], cadence: [], heartRate: [], time: [] }
            };
            liveData = { power: 0, cadence: 0, heartRate: 0, targetPower: 0 };
            showScreen('connectionScreen');
        }

        // 페이지 로드 시 브라우저 지원 확인
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.bluetooth) {
                alert('이 브라우저는 Web Bluetooth를 지원하지 않습니다.\nChrome, Edge, Opera 브라우저를 사용해주세요.');
            }

            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                alert('블루투스 연결을 위해서는 HTTPS 환경이 필요합니다.');
            }

            console.log('사이클 아카데미 훈련 앱 로드 완료');
        });
    </script>
</body>
</html>
