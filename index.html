<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>사이클 아카데미 - iOS 버전</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root {
            --primary-color: #007AFF;
            --secondary-color: #5856D6;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --danger-color: #FF3B30;
            --background: #F2F2F7;
            --card-background: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .ios-notice {
            background: linear-gradient(135deg, #FF9500, #FF6B35);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ios-notice h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .btn:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        .btn-secondary {
            background: var(--text-secondary);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .training-mode {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .mode-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .mode-card.active {
            border-color: var(--primary-color);
            background: rgba(0, 122, 255, 0.1);
        }

        .mode-card h4 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .mode-card p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .manual-input {
            display: none;
        }

        .manual-input.active {
            display: block;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #D1D1D6;
            border-radius: 10px;
            font-size: 17px;
            background: var(--card-background);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .metrics-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .metric {
            background: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timer-display {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-value {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .timer-label {
            font-size: 16px;
            opacity: 0.8;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .control-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .start-btn {
            background: var(--success-color);
            color: white;
        }

        .pause-btn {
            background: var(--warning-color);
            color: white;
        }

        .stop-btn {
            background: var(--danger-color);
            color: white;
        }

        .workout-selector {
            margin-bottom: 20px;
        }

        .workout-selector select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #D1D1D6;
            border-radius: 10px;
            font-size: 17px;
            background: var(--card-background);
        }

        .pwa-install {
            background: linear-gradient(135deg, #34C759, #30D158);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .pwa-install h3 {
            margin-bottom: 10px;
        }

        .pwa-install p {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .install-steps {
            text-align: left;
            margin-top: 15px;
        }

        .install-steps ol {
            margin-left: 20px;
        }

        .install-steps li {
            margin-bottom: 8px;
        }

        @media (max-width: 390px) {
            .training-mode {
                grid-template-columns: 1fr;
            }
            
            .metrics-display {
                grid-template-columns: 1fr;
            }
            
            .timer-value {
                font-size: 36px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* iOS Safari 특화 스타일 */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-user-select: none;
                -webkit-touch-callout: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            input {
                -webkit-appearance: none;
            }
            
            .btn {
                -webkit-tap-highlight-color: transparent;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>🚴‍♂️ 사이클 아카데미</h1>
            <p class="subtitle">iOS 특화 버전</p>
        </div>

        <!-- iOS 안내 -->
        <div class="ios-notice">
            <h3>📱 iOS 사용자를 위한 특별 버전</h3>
            <p>블루투스 연결 대신 수동 입력으로 완전한 훈련 경험을 제공합니다</p>
        </div>

        <!-- PWA 설치 안내 -->
        <div class="pwa-install">
            <h3>📲 홈 화면에 앱으로 추가하기</h3>
            <p>더 나은 경험을 위해 홈 화면에 추가하세요</p>
            <div class="install-steps">
                <ol>
                    <li>Safari 하단의 공유 버튼 (📤) 탭</li>
                    <li>"홈 화면에 추가" 선택</li>
                    <li>앱 이름 확인 후 "추가" 탭</li>
                    <li>홈 화면에서 앱처럼 사용!</li>
                </ol>
            </div>
        </div>

        <!-- 사용자 정보 입력 -->
        <div class="card" id="userSetup">
            <h3 style="margin-bottom: 16px;">👤 사용자 정보</h3>
            <div class="input-group">
                <label>이름</label>
                <input type="text" id="userName" placeholder="이름을 입력하세요">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="input-group">
                    <label>FTP (W)</label>
                    <input type="number" id="userFTP" placeholder="250" min="100" max="500">
                </div>
                <div class="input-group">
                    <label>몸무게 (kg)</label>
                    <input type="number" id="userWeight" placeholder="70" min="40" max="150">
                </div>
            </div>
            <button class="btn btn-success" onclick="saveUserInfo()">저장하고 시작</button>
        </div>

        <!-- 훈련 모드 선택 -->
        <div class="card hidden" id="modeSelector">
            <h3 style="margin-bottom: 16px;">🎯 훈련 모드 선택</h3>
            <div class="training-mode">
                <div class="mode-card" onclick="selectMode('manual')">
                    <h4>✋ 수동 입력</h4>
                    <p>직접 데이터 입력</p>
                </div>
                <div class="mode-card" onclick="selectMode('simulator')">
                    <h4>🎮 시뮬레이터</h4>
                    <p>자동 데이터 생성</p>
                </div>
            </div>
        </div>

        <!-- 워크아웃 선택 -->
        <div class="card hidden" id="workoutSelector">
            <h3 style="margin-bottom: 16px;">📋 워크아웃 선택</h3>
            <div class="workout-selector">
                <select id="workoutSelect">
                    <option value="sst">SST (Sweet Spot Training) - 60분</option>
                    <option value="vo2max">VO2Max 인터벌 - 45분</option>
                    <option value="recovery">회복 라이딩 - 30분</option>
                    <option value="ftp_test">FTP 테스트 - 75분</option>
                </select>
            </div>
            <button class="btn" onclick="startWorkout()">훈련 시작</button>
        </div>

        <!-- 훈련 화면 -->
        <div class="hidden" id="trainingScreen">
            <!-- 타이머 -->
            <div class="timer-display">
                <div class="timer-value" id="timerDisplay">00:00</div>
                <div class="timer-label">경과 시간</div>
            </div>

            <!-- 메트릭스 표시 -->
            <div class="metrics-display">
                <div class="metric">
                    <div class="metric-value" id="powerDisplay">0</div>
                    <div class="metric-label">파워 (W)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="cadenceDisplay">0</div>
                    <div class="metric-label">케이던스</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="heartRateDisplay">0</div>
                    <div class="metric-label">심박수</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="targetPowerDisplay">0</div>
                    <div class="metric-label">목표 파워</div>
                </div>
            </div>

            <!-- 수동 입력 모드 -->
            <div class="card manual-input" id="manualInputs">
                <h4 style="margin-bottom: 16px;">📊 실시간 데이터 입력</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div class="input-group">
                        <label>파워</label>
                        <input type="number" id="manualPower" placeholder="0" onchange="updateManualData()">
                    </div>
                    <div class="input-group">
                        <label>케이던스</label>
                        <input type="number" id="manualCadence" placeholder="0" onchange="updateManualData()">
                    </div>
                    <div class="input-group">
                        <label>심박수</label>
                        <input type="number" id="manualHeartRate" placeholder="0" onchange="updateManualData()">
                    </div>
                </div>
            </div>

            <!-- 현재 구간 정보 -->
            <div class="card">
                <h4 style="margin-bottom: 8px;" id="currentSegment">웜업 구간</h4>
                <p style="color: var(--text-secondary);" id="segmentDescription">FTP 60% - 5분간 몸풀기</p>
                <div style="margin-top: 12px;">
                    <div style="background: #E5E5EA; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: var(--primary-color); height: 100%; width: 0%; transition: width 0.3s ease;" id="segmentProgress"></div>
                    </div>
                </div>
            </div>

            <!-- 컨트롤 -->
            <div class="controls">
                <button class="control-btn start-btn" id="startBtn" onclick="toggleTraining()">시작</button>
                <button class="control-btn pause-btn hidden" id="pauseBtn" onclick="toggleTraining()">일시정지</button>
                <button class="control-btn stop-btn" onclick="stopTraining()">종료</button>
            </div>
        </div>

        <!-- 결과 화면 -->
        <div class="hidden" id="resultScreen">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 20px;">🎉 훈련 완료!</h2>
                <div class="metrics-display">
                    <div class="metric">
                        <div class="metric-value" id="avgPowerResult">0</div>
                        <div class="metric-label">평균 파워</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="maxPowerResult">0</div>
                        <div class="metric-label">최대 파워</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="avgHRResult">0</div>
                        <div class="metric-label">평균 심박</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="caloriesResult">0</div>
                        <div class="metric-label">칼로리</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveWorkout()">결과 저장</button>
                <button class="btn btn-secondary" onclick="shareWorkout()">공유하기</button>
                <button class="btn" onclick="restartApp()">새 훈련</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentMode = null;
        let isTraining = false;
        let isPaused = false;
        let startTime = null;
        let timerInterval = null;
        let currentSegmentIndex = 0;
        let workoutData = [];

        const workouts = {
            sst: {
                name: "SST (Sweet Spot Training)",
                duration: 3600, // 60분
                segments: [
                    { name: "웜업", description: "FTP 60% - 가볍게 몸풀기", targetPercent: 60, duration: 600 },
                    { name: "메인 세트", description: "FTP 88% - 스위트스팟", targetPercent: 88, duration: 2400 },
                    { name: "쿨다운", description: "FTP 50% - 마무리", targetPercent: 50, duration: 600 }
                ]
            },
            vo2max: {
                name: "VO2Max 인터벌",
                duration: 2700, // 45분
                segments: [
                    { name: "웜업", description: "FTP 65% - 준비운동", targetPercent: 65, duration: 900 },
                    { name: "인터벌", description: "FTP 120% - 고강도", targetPercent: 120, duration: 900 },
                    { name: "쿨다운", description: "FTP 55% - 마무리", targetPercent: 55, duration: 900 }
                ]
            },
            recovery: {
                name: "회복 라이딩",
                duration: 1800, // 30분
                segments: [
                    { name: "전체", description: "FTP 50% - 가벼운 페달링", targetPercent: 50, duration: 1800 }
                ]
            }
        };

        function saveUserInfo() {
            const name = document.getElementById('userName').value.trim();
            const ftp = parseInt(document.getElementById('userFTP').value);
            const weight = parseInt(document.getElementById('userWeight').value);

            if (!name || !ftp || !weight) {
                alert('모든 정보를 입력해주세요.');
                return;
            }

            if (ftp < 100 || ftp > 500) {
                alert('FTP는 100-500W 사이로 입력해주세요.');
                return;
            }

            currentUser = { name, ftp, weight };
            
            document.getElementById('userSetup').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
        }

        function selectMode(mode) {
            currentMode = mode;
            
            // 모든 모드 카드에서 active 클래스 제거
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // 선택된 모드 카드에 active 클래스 추가
            event.target.classList.add('active');
            
            setTimeout(() => {
                document.getElementById('modeSelector').classList.add('hidden');
                document.getElementById('workoutSelector').classList.remove('hidden');
            }, 500);
        }

        function startWorkout() {
            const selectedWorkout = document.getElementById('workoutSelect').value;
            currentWorkout = workouts[selectedWorkout];
            
            document.getElementById('workoutSelector').classList.add('hidden');
            document.getElementById('trainingScreen').classList.remove('hidden');
            
            updateSegmentDisplay();
            
            if (currentMode === 'manual') {
                document.getElementById('manualInputs').classList.add('active');
            }
        }

        function updateSegmentDisplay() {
            const segment = currentWorkout.segments[currentSegmentIndex];
            if (!segment) return;

            document.getElementById('currentSegment').textContent = segment.name;
            document.getElementById('segmentDescription').textContent = segment.description;
            
            const targetPower = Math.round(currentUser.ftp * (segment.targetPercent / 100));
            document.getElementById('targetPowerDisplay').textContent = targetPower;
        }

        function toggleTraining() {
            if (!isTraining) {
                startTraining();
            } else {
                pauseTraining();
            }
        }

        function startTraining() {
            isTraining = true;
            isPaused = false;
            startTime = Date.now();
            
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            
            timerInterval = setInterval(updateTimer, 1000);
            
            if (currentMode === 'simulator') {
                startSimulation();
            }
        }

        function pauseTraining() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                pauseBtn.textContent = '재시작';
                clearInterval(timerInterval);
            } else {
                pauseBtn.textContent = '일시정지';
                timerInterval = setInterval(updateTimer, 1000);
            }
        }

        function stopTraining() {
            if (confirm('정말 훈련을 종료하시겠습니까?')) {
                isTraining = false;
                clearInterval(timerInterval);
                showResults();
            }
        }

        function updateTimer() {
            if (isPaused) return;
            
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 구간 진행률 업데이트
            const segment = currentWorkout.segments[currentSegmentIndex];
            if (segment) {
                const segmentProgress = Math.min(100, (elapsed / 1000) / segment.duration * 100);
                document.getElementById('segmentProgress').style.width = segmentProgress + '%';
                
                // 다음 구간으로 전환
                if (elapsed / 1000 >= segment.duration && currentSegmentIndex < currentWorkout.segments.length - 1) {
                    currentSegmentIndex++;
                    updateSegmentDisplay();
                }
            }
        }

        function updateManualData() {
            const power = parseInt(document.getElementById('manualPower').value) || 0;
            const cadence = parseInt(document.getElementById('manualCadence').value) || 0;
            const heartRate = parseInt(document.getElementById('manualHeartRate').value) || 0;
            
            document.getElementById('powerDisplay').textContent = power;
            document.getElementById('cadenceDisplay').textContent = cadence;
            document.getElementById('heartRateDisplay').textContent = heartRate;
            
            // 데이터 기록
            if (isTraining && !isPaused) {
                workoutData.push({
                    timestamp: Date.now(),
                    power: power,
                    cadence: cadence,
                    heartRate: heartRate
                });
            }
        }

        function startSimulation() {
            const simulationInterval = setInterval(() => {
                if (!isTraining || isPaused) {
                    clearInterval(simulationInterval);
                    return;
                }
                
                const segment = currentWorkout.segments[currentSegmentIndex];
                if (!segment) return;
                
                const targetPower = Math.round(currentUser.ftp * (segment.targetPercent / 100));
                const variation = (Math.random() - 0.5) * 20;
                
                const power = Math.max(0, targetPower + variation);
                const cadence = 85 + (Math.random() - 0.5) * 10;
                const heartRate = 140 + (Math.random() - 0.5) * 20;
                
                document.getElementById('powerDisplay').textContent = Math.round(power);
                document.getElementById('cadenceDisplay').textContent = Math.round(cadence);
                document.getElementById('heartRateDisplay').textContent = Math.round(heartRate);
                
                workoutData.push({
                    timestamp: Date.now(),
                    power: power,
                    cadence: cadence,
                    heartRate: heartRate
                });
            }, 1000);
        }

        function showResults() {
            document.getElementById('trainingScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            
            if (workoutData.length > 0) {
                const avgPower = workoutData.reduce((sum, d) => sum + d.power, 0) / workoutData.length;
                const maxPower = Math.max(...workoutData.map(d => d.power));
                const avgHR = workoutData.reduce((sum, d) => sum + d.heartRate, 0) / workoutData.length;
                const calories = Math.round(avgPower * (workoutData.length / 3600) * 3.6);
                
                document.getElementById('avgPowerResult').textContent = Math.round(avgPower);
                document.getElementById('maxPowerResult').textContent = Math.round(maxPower);
                document.getElementById('avgHRResult').textContent = Math.round(avgHR);
                document.getElementById('caloriesResult').textContent = calories;
            }
        }

        function saveWorkout() {
            alert('운동 결과가 저장되었습니다!');
        }

        function shareWorkout() {
            const avgPower = document.getElementById('avgPowerResult').textContent;
            const avgHR = document.getElementById('avgHRResult').textContent;
            const calories = document.getElementById('caloriesResult').textContent;
            
            const shareText = `🚴‍♂️ 사이클 아카데미 훈련 완료!

${currentWorkout.name}
평균 파워: ${avgPower}W
평균 심박: ${avgHR}bpm
칼로리: ${calories}kcal

📱 iOS에서도 완벽한 훈련!`;

            if (navigator.share) {
                navigator.share({
                    title: '사이클 아카데미 - 훈련 완료!',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('결과가 클립보드에 복사되었습니다!');
                });
            }
        }

        function restartApp() {
            location.reload();
        }

        // PWA 감지 및 설치 프롬프트
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            deferredPrompt = e;
            // iOS에서는 이 이벤트가 발생하지 않지만, 다른 플랫폼에서는 설치 버튼 표시 가능
        });

        // iOS에서 홈 화면 추가 감지
        if (window.navigator.standalone) {
            // 이미 홈 화면에 추가된 상태
            document.querySelector('.pwa-install').style.display = 'none';
        }
    </script>
</body>
</html>
