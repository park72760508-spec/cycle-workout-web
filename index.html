<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸ - ì›Œí¬ì•„ì›ƒ ì•±</title>
    <style>
        :root {
            --primary-color: #2E74E8;
            --secondary-color: #1A5AB8;
            --accent-color: #FF6B35;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --dark-color: #343A40;
            --light-color: #F8F9FA;
            --gray-color: #6C757D;
            --border-radius: 12px;
            --shadow: 0 4px 16px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-color);
            overflow-x: hidden;
        }

        .screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
            background: var(--light-color);
        }

        .screen.active {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: var(--gray-color);
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            text-align: center;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-secondary { background: var(--gray-color); }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì—°ê²° í™”ë©´ */
        .device-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .device-card.connected {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid var(--success-color);
        }

        .device-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .device-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            color: white;
        }

        .device-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .device-details p {
            font-size: 14px;
            color: var(--gray-color);
        }

        /* í”„ë¡œí•„ í™”ë©´ */
        .profile-card {
            position: relative;
        }

        .profile-info {
            display: flex;
            align-items: center;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .profile-details h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-color);
        }

        /* ì›Œí¬ì•„ì›ƒ í™”ë©´ */
        .workout-card {
            position: relative;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .workout-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .workout-duration {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* í›ˆë ¨ ì¤€ë¹„ í™”ë©´ */
        .training-ready {
            text-align: center;
            padding: 40px 20px;
        }

        .workout-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .workout-preview h2 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 15px;
        }

        .segment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .segment-item {
            background: var(--light-color);
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }

        .segment-item.warmup { border-left: 4px solid #28A745; }
        .segment-item.interval { border-left: 4px solid #DC3545; }
        .segment-item.rest { border-left: 4px solid #FFC107; }
        .segment-item.cooldown { border-left: 4px solid #6C757D; }

        .segment-item h4 {
            font-size: 12px;
            margin-bottom: 5px;
            color: var(--gray-color);
        }

        .segment-item .ftp-percent {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .segment-item .duration {
            font-size: 12px;
            color: var(--gray-color);
        }

        /* í›ˆë ¨ í™”ë©´ */
        #trainingScreen {
            background: #000;
            color: white;
            padding: 10px;
        }

        .training-header {
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .current-segment {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .segment-details {
            display: flex;
            justify-content: space-around;
            font-size: 24px;
            opacity: 0.8;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .metric-card {
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .power-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            padding: 20px;
        }

        .current-power {
            font-size: 80px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .power-progress {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .power-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #F56500, #7ED321);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .timeline-progress {
            width: 100%;
            height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .timeline-segments {
            display: flex;
            height: 100%;
        }

        
        // ì„¸ê·¸ë©˜íŠ¸ë°” í˜•ì‹        
        .timeline-segment {
            border-right: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 600;
            flex-direction: column; /* âœ… ì„¸ë¡œ ë°°ì¹˜ (ë²ˆí˜¸ ìœ„, ì‹œê°„ ì•„ë˜) */
            color: #fff;
            position: relative;
        }
        
        .timeline-segment .segment-label {
            z-index: 2;
            text-align: center;
            line-height: 1.1;
        }
        
        .timeline-segment .segment-time {
            font-size: 12px;
            font-weight: 400;
            color: rgba(255,255,255,0.8);
        }
        
        .timeline-segment .progress-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
            z-index: 1;
            border-radius: 0;
        }
        
        .timeline-segment:first-child .progress-fill {
            border-radius: 15px 0 0 15px;
        }
        
        .timeline-segment:last-child .progress-fill {
            border-radius: 0 15px 15px 0;
        }
        
        .timeline-segment span {
            position: relative;
            z-index: 2;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .training-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.pause {
            background: var(--warning-color);
        }

        .control-btn.stop {
            background: var(--danger-color);
        }

        /* ê²°ê³¼ í™”ë©´ */
        .achievement-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0deg, var(--success-color) 312deg, var(--light-color) 312deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }

        .achievement-circle::before {
            content: '';
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .achievement-text {
            font-size: 36px;
            font-weight: 700;
            color: var(--success-color);
            z-index: 1;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .result-stat {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
        }

        .result-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .result-stat-label {
            font-size: 14px;
            color: var(--gray-color);
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* ì¹´ìš´íŠ¸ë‹¤ìš´ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .countdown-number {
            font-size: 120px;
            font-weight: 700;
            color: white;
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in forwards;
        }
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .power-display {
                order: 1;
            }

            .timeline-progress {
                order: 3;
            }

            .current-power {
                font-size: 48px;
            }
        }
    </style>
</head>
<body>
    <!-- ì—°ê²° í™”ë©´ -->
    <div id="connectionScreen" class="screen active">
        <div class="header">
            <h1>ğŸš´â€â™‚ï¸ ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸</h1>
            <p class="subtitle">ìŠ¤ë§ˆíŠ¸ íŠ¸ë ˆì´ë„ˆì™€ ì‹¬ë°•ê³„ë¥¼ ì—°ê²°í•˜ì„¸ìš”</p>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px;">ğŸ“¶ ë¸”ë£¨íˆ¬ìŠ¤ ê¸°ê¸° ì—°ê²°</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <button class="btn" onclick="connectTrainer()">ìŠ¤ë§ˆíŠ¸ íŠ¸ë ˆì´ë„ˆ</button>
                <button class="btn btn-secondary" onclick="connectHeartRate()">â¤ï¸ì‹¬ë°•ê³„</button>
            </div>
        </div>

        <div id="deviceList">
            <!-- ì—°ê²°ëœ ê¸°ê¸°ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div id="connectionStatus" class="hidden">
            <div class="card text-center">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ê¸°ê¸°ì— ì—°ê²° ì¤‘...</p>
                </div>
            </div>
        </div>

        <div id="connectedDevicesSummary" class="card hidden">
            <h3 style="margin-bottom: 15px;">âœ… ì—°ê²°ëœ ê¸°ê¸°</h3>
            <div id="connectedDevicesList"></div>
            <button class="btn btn-success" onclick="proceedToProfile()" style="margin-top: 15px;">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
        </div>
    </div>

    <!-- í”„ë¡œí•„ ì„ íƒ í™”ë©´ -->
    <div id="profileScreen" class="screen">
        <div class="header">
            <h1>ğŸ‘¤ í”„ë¡œí•„ ì„ íƒ</h1>
            <p class="subtitle">í›ˆë ¨í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        </div>

        <div id="profileList">
            <!-- ì‚¬ìš©ì í”„ë¡œí•„ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div class="card" onclick="showAddUserForm()">
            <div class="text-center">
                <div style="font-size: 48px; margin-bottom: 10px;">â•</div>
                <h3>ìƒˆ ì‚¬ìš©ì ì¶”ê°€</h3>
                <p style="color: var(--gray-color); margin-top: 5px;">FTPì™€ ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì—¬ ìƒˆ í”„ë¡œí•„ì„ ë§Œë“œì„¸ìš”</p>
            </div>
        </div>

        <div id="addUserForm" class="card hidden">
            <h3 style="margin-bottom: 20px;">ìƒˆ ì‚¬ìš©ì ë“±ë¡</h3>
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="userName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label>ì—°ë½ì²˜</label>
                <input type="tel" id="userContact" placeholder="010-1234-5678">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>FTP (W)</label>
                    <input type="number" id="userFTP" placeholder="250" min="100" max="500">
                </div>
                <div class="form-group">
                    <label>ëª¸ë¬´ê²Œ (kg)</label>
                    <input type="number" id="userWeight" placeholder="70" min="40" max="150">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-success" onclick="saveNewUser()">ì €ì¥</button>
                <button class="btn btn-secondary" onclick="cancelAddUser()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ì›Œí¬ì•„ì›ƒ ì„ íƒ í™”ë©´ -->
    <div id="workoutScreen" class="screen">
        <div class="header">
            <h1>ğŸ“‹ ì›Œí¬ì•„ì›ƒ ì„ íƒ</h1>
            <p class="subtitle">ì˜¤ëŠ˜ì˜ í›ˆë ¨ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•˜ì„¸ìš”</p>
        </div>

        <div id="workoutList">
            <!-- ì›Œí¬ì•„ì›ƒ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- í›ˆë ¨ ì¤€ë¹„ í™”ë©´ -->
    <div id="trainingReadyScreen" class="screen">
        <div class="header">
            <h1>ğŸ¯ í›ˆë ¨ ì¤€ë¹„</h1>
            <p class="subtitle">ì„ íƒí•œ ì›Œí¬ì•„ì›ƒì„ í™•ì¸í•˜ê³  ì‹œì‘í•˜ì„¸ìš”</p>
        </div>

        <div class="workout-preview">
            <h2 id="previewWorkoutName">SST_MCT(14)</h2>
            <div style="display: flex; justify-content: space-around; margin: 20px 0; font-size: 18px;">
                <div><strong id="previewDuration">92ë¶„</strong><br><span style="color: var(--gray-color);">ì´ ì‹œê°„</span></div>
                <div><strong id="previewIntensity">78%</strong><br><span style="color: var(--gray-color);">í‰ê·  ê°•ë„</span></div>
                <div><strong id="previewTSS">82</strong><br><span style="color: var(--gray-color);">ì˜ˆìƒ TSS</span></div>
            </div>

            <div class="segment-preview" id="segmentPreview">
                <!-- ì„¸ê·¸ë¨¼íŠ¸ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <div class="training-ready">
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;">í›ˆë ¨ ì¤€ë¹„ ì™„ë£Œ</h3>
                <p style="color: var(--gray-color);">ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ í›ˆë ¨ì´ ì‹œì‘ë©ë‹ˆë‹¤.</p>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-success" onclick="startWorkoutTraining()" style="min-width: 150px;">
                    ğŸš€ í›ˆë ¨ ì‹œì‘
                </button>
                <button class="btn btn-secondary" onclick="backToWorkoutSelection()" style="min-width: 150px;">
                    â† ì›Œí¬ì•„ì›ƒ ë³€ê²½
                </button>
            </div>
        </div>
    </div>

    <!-- í›ˆë ¨ í™”ë©´ -->
    <div id="trainingScreen" class="screen">
        <div class="training-header">
            <div class="current-segment" id="currentSegmentName">ì›œì—… - 80RPM FTP 60%</div>
            <div class="segment-details">
                <span id="elapsedTime">02:30</span>
                <span id="segmentProgress">ë‹¨ê³„ 2/17</span>
                <span id="nextSegment">ë‹¤ìŒ: ì¸í„°ë²Œ FTP 140%</span>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="segmentTime">02:30</div>
                <div class="metric-label">ë©íƒ€ì„</div>
                <div class="metric-value" id="avgSegmentPowerValue">0</div>
                <div class="metric-label">ë©íŒŒì›Œ(W)</div>
            </div>

            <div class="power-display">
                <div class="current-power" id="currentPowerValue">185</div>
                <div style="opacity: 0.7;">WATTS</div>
                <div class="power-progress">
                    <div class="power-progress-bar" id="powerProgressBar"></div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <div id="powerComparison" style="font-size: 30px; font-weight: 700; margin-bottom: 5px;">
                        ëª©í‘œ :  <span id="targetPowerValue">194</span>W
                    </div>
                    <!-- âœ… ì„¸ê·¸ë¨¼íŠ¸ëª… í‘œì‹œ ìœ„ì¹˜ -->
                    <div id="currentSegmentName" style="margin-top: 14px; font-size: 18px; font-weight: 600; color: #FFD700;"> ì›œì—… - 80RPM FTP 60%</div>

                </div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="heartRateValue">145</div>
                <div class="metric-label">BPM</div>
                <div class="metric-value" id="cadenceValue">89</div>
                <div class="metric-label">RPM</div>                
            </div>
        </div>

        <div style="background: rgba(255,255,255,0.1); border-radius: var(--border-radius); padding: 15px;">
            <div class="timeline-progress">
                <div class="timeline-segments" id="timelineSegments">
                    <!-- íƒ€ì„ë¼ì¸ ì„¸ê·¸ë¨¼íŠ¸ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 18px; opacity: 0.7;">
                <span>ë‹¬ì„±ë„: <span id="achievementValue">87</span>%</span>
                <span>ê²½ê³¼: <span id="elapsedTime">12:34</span> / <span id="totalTime">65:20</span></span>
                <span>í‰ê·  íŒŒì›Œ: <span id="avgPowerValue">178</span>W</span>
            </div>
        </div>

        <div class="training-controls">
            <button class="control-btn pause" onclick="togglePause()" title="ì¼ì‹œì •ì§€">
                <span id="pauseIcon">â¸</span>
            </button>
            <button class="control-btn" onclick="skipSegment()" title="êµ¬ê°„ ê±´ë„ˆë›°ê¸°">â­</button>
            <button class="control-btn stop" onclick="stopTraining()" title="í›ˆë ¨ ì¢…ë£Œ">â¹</button>
        </div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ -->
    <div id="resultScreen" class="screen">
        <div class="header">
            <h1>ğŸ‰ í›ˆë ¨ ì™„ë£Œ!</h1>
            <p class="subtitle">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤</p>
        </div>

        <div class="text-center" style="margin-bottom: 30px;">
            <div class="achievement-circle">
                <div class="achievement-text" id="finalAchievement">89%</div>
            </div>
            <h2 id="workoutCompletedName">SST_MCT(14) - 92ë¶„ ì™„ì£¼</h2>
        </div>

        <div class="result-stats">
            <div class="result-stat">
                <div class="result-stat-value" id="resultAvgPower">184</div>
                <div class="result-stat-label">í‰ê·  íŒŒì›Œ (W)</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="resultMaxPower">285</div>
                <div class="result-stat-label">ìµœëŒ€ íŒŒì›Œ (W)</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="resultAvgHR">152</div>
                <div class="result-stat-label">í‰ê·  ì‹¬ë°• (BPM)</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="resultCalories">892</div>
                <div class="result-stat-label">ì¹¼ë¡œë¦¬ (kcal)</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px;">ğŸ¤– AI ì„±ê³¼ ë¶„ì„</h3>
            <div id="aiAnalysis" style="line-height: 1.6; color: var(--gray-color);">
                ë¶„ì„ ì¤‘...
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-success" onclick="saveResult()">ì €ì¥í•˜ê¸°</button>
            <button class="btn btn-secondary" onclick="shareResult()">ê³µìœ í•˜ê¸°</button>
        </div>

        <button class="btn" onclick="goHome()" style="margin-top: 10px;">ìƒˆ í›ˆë ¨ ì‹œì‘</button>
    </div>

    <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ -->
    <div id="countdownOverlay" class="countdown-overlay hidden">
        <div class="countdown-number" id="countdownNumber">5</div>
    </div>

    <script>
        // Google Apps Script ì›¹ ì•± URL (ì‹¤ì œ ë°°í¬ëœ URLë¡œ êµì²´ í•„ìš”)
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwp6v4zwoRi0qQekKQZr4bCs8s2wUolHtLNKgq_uX8pIHck1XllibKgzCZ64w6Z7Wrw/exec';
        
        // ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬
        let wakeLock = null;  // í™”ë©´ ì ˆì „ ë°©ì§€ í•¸ë“¤ëŸ¬
        let isSegmentChanging = false; // ì„¸ê·¸ë¨¼íŠ¸ êµì²´ ì¤‘(ì¹´ìš´íŠ¸ë‹¤ìš´ í¬í•¨)
        let audioCtx = null; // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ (ë¹„í”„ìŒ ì •ì±… ëŒ€ì‘)
        let countdownActive = false;  // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ë³µ ë°©ì§€
        let segmentCountdownStarted = false; // ì„¸ê·¸ë¨¼íŠ¸ë³„ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘ í”Œë˜ê·¸
        let currentScreen = 'connectionScreen';
        let connectedDevices = {
            trainer: null,
            heartRate: null
        };
        let currentUser = null;
        let currentWorkout = null;
        let trainingSession = {
            sessionId: null,
            isRunning: false,
            isPaused: false,
            startTime: null,
            currentSegment: 0,
            segments: [],
            segmentStartTime: null,
            data: {
                power: [],
                cadence: [],
                heartRate: [],
                time: []
            }
        };
        let liveData = {
            power: 0,
            cadence: 0,
            heartRate: 0,
            targetPower: 0
        };



        
        // í™”ë©´ ì „í™˜ í•¨ìˆ˜ë“¤
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;

            if (screenId === 'profileScreen') {
                loadUsers();
            } else if (screenId === 'workoutScreen') {
                loadWorkouts();
            } else if (screenId === 'trainingReadyScreen') {
                showWorkoutPreview();
            }
        }

        // BLE ì—°ê²° í•¨ìˆ˜ë“¤
        async function connectTrainer() {
            try {
                showConnectionStatus(true);
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['fitness_machine'] },
                        { services: ['cycling_power'] },
                        { namePrefix: 'KICKR' },
                        { namePrefix: 'Wahoo' }
                    ],
                    optionalServices: ['device_information', 'fitness_machine', 'cycling_power']
                });

                const server = await device.gatt.connect();
                
                // Fitness Machine Service ì‹œë„
                let service, characteristic;
                try {
                    service = await server.getPrimaryService('fitness_machine');
                    characteristic = await service.getCharacteristic('indoor_bike_data');
                } catch (e) {
                    // Cycling Power Service ëŒ€ì•ˆ
                    try {
                        service = await server.getPrimaryService('cycling_power');
                        characteristic = await service.getCharacteristic('cycling_power_measurement');
                    } catch (e2) {
                        throw new Error('ì§€ì›ë˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }

                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleTrainerData);

                connectedDevices.trainer = {
                    name: device.name || 'Smart Trainer',
                    device: device,
                    server: server,
                    characteristic: characteristic
                };

                updateDevicesList();
                showConnectionStatus(false);
                alert(`âœ… ${device.name} ì—°ê²° ì„±ê³µ!`);
            } catch (error) {
                showConnectionStatus(false);
                console.error('íŠ¸ë ˆì´ë„ˆ ì—°ê²° ì˜¤ë¥˜:', error);
                alert("âŒ íŠ¸ë ˆì´ë„ˆ ì—°ê²° ì‹¤íŒ¨: " + error.message);
            }
        }

        async function connectHeartRate() {
            try {
                showConnectionStatus(true);
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate'] }]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('heart_rate');
                const characteristic = await service.getCharacteristic('heart_rate_measurement');

                characteristic.addEventListener('characteristicvaluechanged', handleHeartRateData);
                await characteristic.startNotifications();

                connectedDevices.heartRate = {
                    name: device.name || 'Heart Rate Monitor',
                    device: device,
                    server: server,
                    characteristic: characteristic
                };

                updateDevicesList();
                showConnectionStatus(false);
                alert(`âœ… ${device.name} ì—°ê²° ì„±ê³µ!`);
            } catch (error) {
                showConnectionStatus(false);
                console.error('ì‹¬ë°•ê³„ ì—°ê²° ì˜¤ë¥˜:', error);
                alert("âŒ ì‹¬ë°•ê³„ ì—°ê²° ì‹¤íŒ¨: " + error.message);
            }
        }

        function handleTrainerData(event) {
            const data = event.target.value;
            
            // Fitness Machine Service - Indoor Bike Data
            if (data.byteLength >= 4) {
                const flags = data.getUint16(0, true);
                let offset = 2;

                // ì¼€ì´ë˜ìŠ¤ (Bit 2)
                if (flags & 0x04) {
                    const cadence = data.getUint16(offset, true) * 0.5;
                    liveData.cadence = cadence;
                    offset += 2;
                }

                // íŒŒì›Œ (Bit 6)
                if (flags & 0x40) {
                    const power = data.getInt16(offset, true);
                    liveData.power = power;
                }
            }

            if (trainingSession.isRunning && !trainingSession.isPaused) {
                updateTrainingDisplay();
                recordDataPoint();
            }
        }

        function handleHeartRateData(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            const rate16Bits = flags & 0x1;
            const bpm = rate16Bits ? value.getUint16(1, true) : value.getUint8(1);

            liveData.heartRate = bpm;

            if (trainingSession.isRunning && !trainingSession.isPaused) {
                updateTrainingDisplay();
            }
        }

        function showConnectionStatus(show) {
            const status = document.getElementById('connectionStatus');
            if (show) {
                status.classList.remove('hidden');
            } else {
                status.classList.add('hidden');
            }
        }

        function updateDevicesList() {
            const deviceList = document.getElementById('deviceList');
            const summary = document.getElementById('connectedDevicesSummary');
            const summaryList = document.getElementById('connectedDevicesList');

            let connectedCount = 0;
            let html = '';

            if (connectedDevices.trainer) {
                connectedCount++;
                html += `
                    <div class="card device-card connected">
                        <div class="device-info">
                            <div class="device-icon">ğŸš´â€â™‚ï¸</div>
                            <div class="device-details">
                                <h3>${connectedDevices.trainer.name}</h3>
                                <p>Smart Trainer</p>
                            </div>
                        </div>
                        <div style="color: var(--success-color); font-weight: 600;">ì—°ê²°ë¨</div>
                    </div>
                `;
            }

            if (connectedDevices.heartRate) {
                connectedCount++;
                html += `
                    <div class="card device-card connected">
                        <div class="device-info">
                            <div class="device-icon" style="background: var(--danger-color);">â¤ï¸</div>
                            <div class="device-details">
                                <h3>${connectedDevices.heartRate.name}</h3>
                                <p>Heart Rate Monitor</p>
                            </div>
                        </div>
                        <div style="color: var(--success-color); font-weight: 600;">ì—°ê²°ë¨</div>
                    </div>
                `;
            }

            deviceList.innerHTML = html;

            if (connectedCount > 0) {
                summaryList.innerHTML = html;
                summary.classList.remove('hidden');
            } else {
                summary.classList.add('hidden');
            }
        }

        function proceedToProfile() {
            if (!connectedDevices.trainer) {
                alert('í›ˆë ¨ì„ ìœ„í•´ì„œëŠ” ìŠ¤ë§ˆíŠ¸ íŠ¸ë ˆì´ë„ˆê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                //return;  // ìˆ˜ì •ì˜ˆì •
            }
            showScreen('profileScreen');
        }

        // ì‚¬ìš©ì ê´€ë¦¬ í•¨ìˆ˜ë“¤
        async function loadUsers() {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getUsers' })
                });
                const users = await response.json();
                displayUsers(users);
            } catch (error) {
                console.error('ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', error);
                // ë”ë¯¸ ë°ì´í„°ë¡œ ëŒ€ì²´
                const dummyUsers = [
                    { user_id: 'U1', name: 'ë°•ì§€ì„±', contact: '010-1234-5678', ftp: 242, weight: 56 },
                    { user_id: 'U2', name: 'ë°•ì„ í˜¸', contact: '010-9876-5432', ftp: 280, weight: 70 }
                ];
                displayUsers(dummyUsers);
            }
        }

        function displayUsers(users) {
            const profileList = document.getElementById('profileList');
            profileList.innerHTML = '';

            users.forEach(user => {
                const profileCard = document.createElement('div');
                profileCard.className = 'card profile-card';
                profileCard.onclick = () => selectUser(user);

                const initials = user.name.substring(0, 2);
                const powerToWeight = (user.ftp / user.weight).toFixed(1);

                profileCard.innerHTML = `
                    <div class="profile-info">
                        <div class="profile-avatar">${initials}</div>
                        <div class="profile-details">
                            <h3>${user.name}</h3>
                            <div class="profile-stats">
                                <div>
                                    <div class="stat-value">${user.ftp}W</div>
                                    <div class="stat-label">FTP</div>
                                </div>
                                <div>
                                    <div class="stat-value">${user.weight}kg</div>
                                    <div class="stat-label">ëª¸ë¬´ê²Œ</div>
                                </div>
                                <div>
                                    <div class="stat-value">${powerToWeight}</div>
                                    <div class="stat-label">W/kg</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                profileList.appendChild(profileCard);
            });
        }

        function selectUser(user) {
            currentUser = user;
            alert(`${user.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
            showScreen('workoutScreen');
        }

        function showAddUserForm() {
            document.getElementById('addUserForm').classList.remove('hidden');
        }

        function cancelAddUser() {
            document.getElementById('addUserForm').classList.add('hidden');
            document.getElementById('userName').value = '';
            document.getElementById('userContact').value = '';
            document.getElementById('userFTP').value = '';
            document.getElementById('userWeight').value = '';
        }

        async function saveNewUser() {
            const name = document.getElementById('userName').value.trim();
            const contact = document.getElementById('userContact').value.trim();
            const ftp = parseInt(document.getElementById('userFTP').value);
            const weight = parseInt(document.getElementById('userWeight').value);

            if (!name || !contact || !ftp || !weight) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (ftp < 100 || ftp > 500) {
                alert('FTPëŠ” 100Wì—ì„œ 500W ì‚¬ì´ì˜ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (weight < 40 || weight > 150) {
                alert('ëª¸ë¬´ê²ŒëŠ” 40kgì—ì„œ 150kg ì‚¬ì´ì˜ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'addUser',
                        userData: { name, contact, ftp, weight }
                    })
                });
                const result = await response.json();

                if (result.success) {
                    alert('ìƒˆ ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    cancelAddUser();
                    loadUsers();
                } else {
                    alert('ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ì‚¬ìš©ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì›Œí¬ì•„ì›ƒ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        async function loadWorkouts() {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getWorkouts' })
                });
                const workouts = await response.json();
                displayWorkouts(workouts);
            } catch (error) {
                console.error('ì›Œí¬ì•„ì›ƒ ë¡œë“œ ì‹¤íŒ¨:', error);
                // ë”ë¯¸ ë°ì´í„°ë¡œ ëŒ€ì²´
                const dummyWorkouts = [
                    {
                        workout_id: 'SST_MCT14',
                        workout_name: 'SST_MCT(14)',
                        total_duration: 5520, // 92ë¶„ â†’ ì´ˆ ë‹¨ìœ„ë¡œ ìˆ˜ì •
                        avg_intensity: 78,
                        segments: [
                            { segment_order: 1, segment_type: 'ì›œì—…', description: '80RPM FTP 60%', ftp_percent: 60, duration_sec: 20, target_rpm: 80 },
                            { segment_order: 2, segment_type: 'ì¸í„°ë²Œ', description: 'FTP 88%', ftp_percent: 88, duration_sec: 30, target_rpm: 90 },
                            { segment_order: 3, segment_type: 'íœ´ì‹', description: 'FTP 50%', ftp_percent: 50, duration_sec: 10, target_rpm: 75 },
                            { segment_order: 4, segment_type: 'ì¸í„°ë²Œ', description: 'FTP 92%', ftp_percent: 92, duration_sec: 60, target_rpm: 90 },
                            { segment_order: 5, segment_type: 'ì¿¨ë‹¤ìš´', description: 'FTP 45%', ftp_percent: 45, duration_sec: 10, target_rpm: 70 }
                        ]
                    }
                ];
                displayWorkouts(dummyWorkouts);
            }
        }

        function displayWorkouts(workouts) {
            const workoutList = document.getElementById('workoutList');
            workoutList.innerHTML = '';

            workouts.forEach(workout => {
                const workoutCard = document.createElement('div');
                workoutCard.className = 'card workout-card';
                workoutCard.onclick = () => selectWorkout(workout);

                const duration = Math.floor(workout.total_duration / 60);
                const tss = calculateWorkoutTSS(workout);

                workoutCard.innerHTML = `
                    <div class="workout-header">
                        <div class="workout-title">${workout.workout_name}</div>
                        <div class="workout-duration">${duration}ë¶„</div>
                    </div>
                    <div style="margin: 15px 0;">
                        <div style="font-size: 14px; color: var(--gray-color);">
                            í‰ê· : ${workout.avg_intensity}% FTP | TSS: ${tss}
                        </div>
                    </div>
                `;

                workoutList.appendChild(workoutCard);
            });
        }

        function calculateWorkoutTSS(workout) {
            let totalTSS = 0;
            workout.segments.forEach(segment => {
                const intensityFactor = segment.ftp_percent / 100;
                const durationHours = segment.duration_sec / 3600;
                totalTSS += durationHours * intensityFactor * intensityFactor * 100;
            });
            return Math.round(totalTSS);
        }

        function selectWorkout(workout) {
            currentWorkout = workout;
            showScreen('trainingReadyScreen');
        }

        // ì›Œí¬ì•„ì›ƒ ë¯¸ë¦¬ë³´ê¸° í™”ë©´
        function showWorkoutPreview() {
            if (!currentWorkout || !currentUser) return;

            document.getElementById('previewWorkoutName').textContent = currentWorkout.workout_name;
            document.getElementById('previewDuration').textContent = Math.floor(currentWorkout.total_duration / 60) + 'ë¶„';
            document.getElementById('previewIntensity').textContent = currentWorkout.avg_intensity + '%';
            document.getElementById('previewTSS').textContent = calculateWorkoutTSS(currentWorkout);

            const segmentPreview = document.getElementById('segmentPreview');
            segmentPreview.innerHTML = '';

            currentWorkout.segments.forEach((segment, index) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = `segment-item ${segment.segment_type.toLowerCase()}`;
                
                const duration = Math.floor(segment.duration_sec / 60);
                
                segmentDiv.innerHTML = `
                    <h4>${segment.segment_type}</h4>
                    <div class="ftp-percent">${segment.ftp_percent}%</div>
                    <div class="duration">${duration}ë¶„</div>
                `;

                segmentPreview.appendChild(segmentDiv);
            });
        }

        function startWorkoutTraining() {
            showScreen('trainingScreen');
            initializeTraining();
        }




        
        function backToWorkoutSelection() {
            showScreen('workoutScreen');
        }

        // í›ˆë ¨ ì‹¤í–‰ í•¨ìˆ˜ë“¤ - ìˆ˜ì •ëœ ë¶€ë¶„
        function initializeTraining() {
            if (!currentWorkout || !currentUser) return;

            // ìƒíƒœ ì´ˆê¸°í™”
            countdownActive = false;
            segmentCountdownStarted = false;

            trainingSession = {
                sessionId: 'S' + Date.now(),
                isRunning: false,
                isPaused: false,
                startTime: null,
                currentSegment: 0,
                segments: currentWorkout.segments,
                segmentStartTime: null,
                data: {
                    power: [],
                    cadence: [],
                    heartRate: [],
                    time: []
                }
            };

            updateTrainingDisplay();
            createTimeline();
            updateSegmentDisplay();

            // 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ ì‹œì‘
            showCountdown(5, () => {
                startTraining();
            });
        }

        /////////////////////////////// 
        function showCountdown(seconds, callback, message = " ì¤€ë¹„!", isInitialCall = true) {
            if (isInitialCall && countdownActive) return; // ì¤‘ë³µ ë°©ì§€
            if (isInitialCall) countdownActive = true;
        
            // âœ… ë¸Œë¼ìš°ì € ì˜¤ë””ì˜¤ ì •ì±… ëŒ€ì‘
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioCtx.resume();
            }
        
            const overlay = document.getElementById('countdownOverlay');
            const number = document.getElementById('countdownNumber');
        
            let messageEl = document.getElementById("countdownMessage");
            if (!messageEl) {
                messageEl = document.createElement("div");
                messageEl.id = "countdownMessage";
                messageEl.style.position = "absolute";
                messageEl.style.top = "20%";
                messageEl.style.width = "100%";
                messageEl.style.textAlign = "center";
                messageEl.style.color = "white";
                messageEl.style.fontSize = "36px";
                messageEl.style.opacity = "0";
                messageEl.style.transition = "opacity 0.5s ease-in-out";
                overlay.appendChild(messageEl);
            }
        
            messageEl.textContent = message;
            messageEl.style.opacity = "1";
            overlay.classList.remove('hidden');
            number.textContent = seconds;
        
            playBeep(); // ì‹œì‘ ì‹œ 1íšŒ
        
            if (seconds > 0) {
                setTimeout(() => {
                    number.textContent = seconds - 1;
                    if (seconds > 1) playBeep();
                    showCountdown(seconds - 1, callback, message, false);
                }, 1000);
            } else {
                messageEl.style.opacity = "0";
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    countdownActive = false;
                    callback();
                }, 300);
            }
        }


        //function playBeep() {
            //try {
                //const ctx = new (window.AudioContext || window.webkitAudioContext)();
                //const osc = ctx.createOscillator();
                //const gain = ctx.createGain();

                //osc.connect(gain);
                //gain.connect(ctx.destination);

                //osc.type = "sine";
                //osc.frequency.value = 800;
                //gain.gain.setValueAtTime(0.2, ctx.currentTime);

                //osc.start();
                //osc.stop(ctx.currentTime + 0.15);
            //} catch (err) {
                //console.error("Beep sound error:", err);
            //}
        //}

        let beepActive = false;
        
        function playBeep() {
            if (beepActive) return;
            beepActive = true;
        
            try {
                const ctx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
        
                osc.connect(gain);
                gain.connect(ctx.destination);
        
                osc.type = "square";
                osc.frequency.value = 950;
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
        
                osc.start();
                osc.stop(ctx.currentTime + 0.15);
        
                osc.onended = () => {
                    beepActive = false;
                };
            } catch (err) {
                beepActive = false;
                console.error("Beep sound error:", err);
            }
        }
       
/////////////////////////////////////////////////////////////////////////////////




        
        function startTraining() {
            trainingSession.isRunning = true;
            trainingSession.startTime = Date.now();
            trainingSession.segmentStartTime = Date.now();
            segmentCountdownStarted = false; // ì´ˆê¸°í™”

            updateTrainingTimer();
            updateTargetPower();

            async function startTraining() {
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log("âœ… í™”ë©´ ì ˆì „ ëª¨ë“œ ë°©ì§€ í™œì„±í™”ë¨");
                    }
                } catch (err) {
                    console.error("í™”ë©´ ê¹¨ì›€ ìš”ì²­ ì‹¤íŒ¨:", err);
                }
            
                // ê¸°ì¡´ startTraining ë‚´ìš© ì•„ë˜ ì´ì–´ì„œ...

            
            // ì„œë²„ì— ì„¸ì…˜ ì‹œì‘ ì•Œë¦¼
            try {
                fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'startTrainingSessionAPI',
                        sessionData: {
                            user_id: currentUser.user_id,
                            workout_id: currentWorkout.workout_id
                        }
                    })
                });
            } catch (error) {
                console.error('ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨:', error);
            }

            // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„± (ì‹¤ì œ ê¸°ê¸°ê°€ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš°)
            if (!connectedDevices.trainer) {
                startDataSimulation();
            }
        }

        function startDataSimulation() {
            setInterval(() => {
                if (!trainingSession.isRunning || trainingSession.isPaused) return;

                const currentSeg = trainingSession.segments[trainingSession.currentSegment];
                if (!currentSeg) return;

                const targetPower = Math.round(currentUser.ftp * (currentSeg.ftp_percent / 100));
                const variation = (Math.random() - 0.5) * 30;
                liveData.power = Math.max(0, targetPower + variation);
                liveData.cadence = currentSeg.target_rpm + (Math.random() - 0.5) * 10;
                liveData.targetPower = targetPower;

                updateTrainingDisplay();
                recordDataPoint();
            }, 1000);
        }

        function updateTargetPower() {
            if (!trainingSession.isRunning || trainingSession.isPaused) return;

            const currentSeg = trainingSession.segments[trainingSession.currentSegment];
            if (currentSeg && currentUser) {
                const targetPower = Math.round(currentUser.ftp * (currentSeg.ftp_percent / 100));
                liveData.targetPower = targetPower;
            }
        }

        function updateTrainingDisplay() {
            // ì‹¤ì‹œê°„ í‘œì‹œê°’
            document.getElementById('currentPowerValue').textContent = Math.round(liveData.power);
            document.getElementById('cadenceValue').textContent = Math.round(liveData.cadence);
            document.getElementById('heartRateValue').textContent = Math.round(liveData.heartRate);
            document.getElementById('targetPowerValue').textContent = liveData.targetPower;

            const ftpPercent = currentUser ? Math.round((liveData.targetPower / currentUser.ftp) * 100) : 0;
            document.getElementById('targetFtpPercent').textContent = ftpPercent;

            // ë‹¬ì„±ë¥  í‘œì‹œ
            const achievement = liveData.targetPower > 0 ?
                Math.min(100, Math.round((liveData.power / liveData.targetPower) * 100)) : 0;
            document.getElementById('achievementValue').textContent = achievement;

            // ì§„í–‰ë°” ê°±ì‹ 
            const progressPercent = Math.min(100, (liveData.power / liveData.targetPower) * 100);
            document.getElementById('powerProgressBar').style.width = progressPercent + '%';

            // ì „ì²´ í‰ê·  íŒŒì›Œ
            let avgPower = 0;
            if (trainingSession.data.power.length > 0) {
                avgPower = trainingSession.data.power.reduce((a, b) => a + b, 0) / trainingSession.data.power.length;
                document.getElementById('avgPowerValue').textContent = Math.round(avgPower);
            }

            // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ë³„ í‰ê·  íŒŒì›Œ ê³„ì‚°
            const segStart = trainingSession.segmentStartTime;
            const segEnd = Date.now();
            const segmentPowerData = trainingSession.data.power.filter((_, i) => {
                const t = trainingSession.data.time[i];
                return t >= segStart && t <= segEnd;
            });

            let avgSegPower = 0;
            if (segmentPowerData.length > 0) {
                avgSegPower = segmentPowerData.reduce((a, b) => a + b, 0) / segmentPowerData.length;
            }

            const avgSegPowerEl = document.getElementById('avgSegmentPowerValue');
            if (avgSegPowerEl) {
                avgSegPowerEl.textContent = Math.round(avgSegPower);
                if (avgSegPower < liveData.targetPower * 0.9) {
                    avgSegPowerEl.style.color = "#F56500"; // ì£¼í™©ìƒ‰ (ë‚®ìŒ)
                } else if (avgSegPower > liveData.targetPower * 1.1) {
                    avgSegPowerEl.style.color = "#7ED321"; // ì—°ë‘ìƒ‰ (ë†’ìŒ)
                } else {
                    avgSegPowerEl.style.color = "white"; // ì •ìƒ ë²”ìœ„
                }
            }
        }

        function updateTrainingTimer() {
            const timerInterval = setInterval(() => {
                if (!trainingSession.isRunning) {
                    clearInterval(timerInterval);
                    return;
                }

                if (trainingSession.isPaused) return;

                const elapsed = Date.now() - trainingSession.startTime;
                const segmentElapsed = Date.now() - trainingSession.segmentStartTime;

                const elapsedMinutes = Math.floor(elapsed / 60000);
                const elapsedSeconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('elapsedTime').textContent =
                    `${elapsedMinutes.toString().padStart(2, '0')}:${elapsedSeconds.toString().padStart(2, '0')}`;

                const totalMinutes = Math.floor(currentWorkout.total_duration / 60);
                const totalSecondsRemaining = currentWorkout.total_duration % 60;
                document.getElementById('totalTime').textContent =
                    `${totalMinutes.toString().padStart(2, '0')}:${totalSecondsRemaining.toString().padStart(2, '0')}`;

                checkSegmentProgress(segmentElapsed);
                updateSegmentTimer(segmentElapsed);
            }, 1000);
        }

        function updateSegmentTimer(segmentElapsed) {
            const currentSeg = trainingSession.segments[trainingSession.currentSegment];
            if (!currentSeg) return;

            const segmentRemaining = Math.max(0, currentSeg.duration_sec * 1000 - segmentElapsed);
            const remainingMinutes = Math.floor(segmentRemaining / 60000);
            const remainingSeconds = Math.floor((segmentRemaining % 60000) / 1000);

            const segmentTotalMinutes = Math.floor(currentSeg.duration_sec / 60);
            const segmentTotalSeconds = currentSeg.duration_sec % 60;

            document.getElementById('segmentTime').textContent =
                `${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')} / ${segmentTotalMinutes.toString().padStart(2, '0')}:${segmentTotalSeconds.toString().padStart(2, '0')}`;
        }

        // ìˆ˜ì •ëœ ì„¸ê·¸ë¨¼íŠ¸ ì§„í–‰ ì²´í¬ í•¨ìˆ˜
        function checkSegmentProgress(segmentElapsed) {
            const segIndex = trainingSession.currentSegment;
            const currentSeg = trainingSession.segments[segIndex];
            if (!currentSeg) return;
        
            // âœ… ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì—ëŠ” ì„¸ê·¸ë¨¼íŠ¸ ì§„í–‰ ì¤‘ì§€
            if (isSegmentChanging) return;
        
            const progressPercent = Math.min(100, (segmentElapsed / (currentSeg.duration_sec * 1000)) * 100);
            const segments = document.querySelectorAll(".timeline-segment");
        
            segments.forEach((seg, idx) => {
                const fill = seg.querySelector(".progress-fill");
                if (!fill) return;
                if (idx < segIndex) fill.style.width = "100%";
                else if (idx === segIndex) fill.style.width = `${progressPercent}%`;
                else fill.style.width = "0%";
            });
        
            const remainingTime = currentSeg.duration_sec * 1000 - segmentElapsed;
        
            // âœ… ì¢…ë£Œ 5ì´ˆ ì „ ì¹´ìš´íŠ¸ë‹¤ìš´ (í•œ ë²ˆë§Œ ì‹¤í–‰)
            if (!segmentCountdownStarted && remainingTime <= 5000 && remainingTime > 4000) {
                segmentCountdownStarted = true;
                isSegmentChanging = true; // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ ë£¨í”„ ì¼ì‹œ ì •ì§€
        
                if (segIndex < trainingSession.segments.length - 1) {
                    showCountdown(5, () => {
                        completeCurrentSegment();
                        nextSegment();
                        isSegmentChanging = false;
                    }, "ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ì¤€ë¹„!");
                } else {
                    showCountdown(5, () => {
                        completeCurrentSegment();
                        completeTraining();
                        isSegmentChanging = false;
                    }, "í›ˆë ¨ ì™„ë£Œ!");
                }
                return;
            }
        
            // âœ… ì¹´ìš´íŠ¸ë‹¤ìš´ì´ ëë‚œ ë’¤, ë‚¨ì€ ì‹œê°„ì´ ì™„ì „íˆ 0ì´ ë˜ë©´ ì •ìƒ ì¢…ë£Œ
            if (remainingTime <= 0 && !isSegmentChanging) {
                completeCurrentSegment();
                if (segIndex < trainingSession.segments.length - 1) {
                    nextSegment();
                } else {
                    completeTraining();
                }
            }
        }


        function completeCurrentSegment() {
            const segIndex = trainingSession.currentSegment;
            const currentSeg = trainingSession.segments[segIndex];
            if (!currentSeg) return;

            const segmentStartTime = trainingSession.segmentStartTime;
            const segmentEndTime = Date.now();

            const powerData = trainingSession.data.power;
            const timeData = trainingSession.data.time;

            const segmentPowerData = powerData.filter((_, i) => {
                const t = timeData[i];
                return t >= segmentStartTime && t <= segmentEndTime;
            });

            const avgPower = segmentPowerData.length > 0
                ? segmentPowerData.reduce((a, b) => a + b, 0) / segmentPowerData.length
                : 0;

            const targetPower = currentUser.ftp * (currentSeg.ftp_percent / 100);
            const achievement = targetPower > 0 ? (avgPower / targetPower) * 100 : 0;
            const color = achievement >= 100 ? "#7ED321" : "#F56500";

            const segment = document.getElementById(`timeline-segment-${segIndex}`);
            const fill = segment ? segment.querySelector(".progress-fill") : null;
            if (fill) {
                fill.style.width = "100%";
                fill.style.background = color;
            }

            console.log(`ì„¸ê·¸ë¨¼íŠ¸ ${segIndex + 1} ì™„ë£Œ: í‰ê·  íŒŒì›Œ ${Math.round(avgPower)}W, ë‹¬ì„±ë¥  ${Math.round(achievement)}%`);
        }


////////////////////////////////////////////////////////////////////////////////
        function nextSegment() {
            trainingSession.currentSegment++;
            segmentCountdownStarted = false;
            isSegmentChanging = false;
        
            if (trainingSession.currentSegment >= trainingSession.segments.length) {
                completeTraining();
                return;
            }
        
            trainingSession.segmentStartTime = Date.now();
            updateSegmentDisplay();
            updateTargetPower();
            updateTimelineSegment(trainingSession.currentSegment, 'current');
        }


        
        function updateSegmentDisplay() {
            const currentSeg = trainingSession.segments[trainingSession.currentSegment];
            if (!currentSeg) return;

            document.getElementById('currentSegmentName').textContent =
                `${currentSeg.description} (${currentSeg.segment_type})`;

            document.getElementById('segmentProgress').textContent =
                `ë‹¨ê³„ ${trainingSession.currentSegment + 1}/${trainingSession.segments.length}`;

            const nextSeg = trainingSession.segments[trainingSession.currentSegment + 1];
            if (nextSeg) {
                document.getElementById('nextSegment').textContent = `ë‹¤ìŒ: ${nextSeg.description}`;
            } else {
                document.getElementById('nextSegment').textContent = 'ë‹¤ìŒ: í›ˆë ¨ ì™„ë£Œ';
            }
        }

        function createTimeline() {
            const timeline = document.getElementById('timelineSegments');
            timeline.innerHTML = '';
        
            // âœ… ì „ì²´ ì„¸ê·¸ë¨¼íŠ¸ ì‹œê°„ í•©ê³„ êµ¬í•˜ê¸°
            const totalDuration = trainingSession.segments.reduce(
                (sum, seg) => sum + seg.duration_sec,
                0
            );
        
            trainingSession.segments.forEach((seg, index) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'timeline-segment';
                segmentDiv.id = `timeline-segment-${index}`;
        
                // âœ… ì‹œê°„ ë¹„ìœ¨ì— ë”°ë¥¸ í­ ê³„ì‚°
                const widthPercent = (seg.duration_sec / totalDuration) * 100;
                segmentDiv.style.flex = 'unset';
                segmentDiv.style.width = `${widthPercent}%`;
        
                // ì‹œê°„ í‘œì‹œ (ë¶„:ì´ˆ)
                const minutes = Math.floor(seg.duration_sec / 60);
                const seconds = seg.duration_sec % 60;
                const timeLabel =
                    seg.duration_sec >= 60
                        ? `${minutes}:${seconds.toString().padStart(2, "0")}`
                        : `${seconds}s`;
        
                segmentDiv.innerHTML = `
                    <div class="progress-fill"></div>
                    <div class="segment-label">
                        ${index + 1}<br><span class="segment-time">${timeLabel}</span>
                    </div>
                `;
        
                timeline.appendChild(segmentDiv);
            });
        }



        function updateTimelineSegment(segmentIndex, status) {
            const segment = document.getElementById(`timeline-segment-${segmentIndex}`);
            if (!segment) return;
            segment.className = `timeline-segment ${status}`;
        }

        function recordDataPoint() {
            trainingSession.data.power.push(liveData.power);
            trainingSession.data.cadence.push(liveData.cadence);
            trainingSession.data.heartRate.push(liveData.heartRate);
            trainingSession.data.time.push(Date.now());
        }

        function togglePause() {
            trainingSession.isPaused = !trainingSession.isPaused;
            const pauseIcon = document.getElementById('pauseIcon');
            pauseIcon.textContent = trainingSession.isPaused ? 'â–¶ï¸' : 'â¸ï¸';
        }

        function skipSegment() {
            if (confirm('í˜„ì¬ êµ¬ê°„ì„ ê±´ë„ˆë›°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                completeCurrentSegment();
                nextSegment();
            }
        }

        function stopTraining() {
            if (confirm('ì •ë§ í›ˆë ¨ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                trainingSession.isRunning = false;
                completeTraining();
            }
        }

        function completeTraining() {
            trainingSession.isRunning = false;

            const avgPower = calculateAverage(trainingSession.data.power);
            const maxPower = Math.max(...trainingSession.data.power);
            const avgHR = calculateAverage(trainingSession.data.heartRate);
            const achievement = calculateOverallAchievement();

            const durationHours = (Date.now() - trainingSession.startTime) / 3600000;
            const calories = Math.round(avgPower * durationHours * 3.6);

            document.getElementById('finalAchievement').textContent = achievement + '%';
            document.getElementById('workoutCompletedName').textContent =
                `${currentWorkout.workout_name} - ${Math.floor(durationHours * 60)}ë¶„ ì™„ì£¼`;

            document.getElementById('resultAvgPower').textContent = Math.round(avgPower);
            document.getElementById('resultMaxPower').textContent = Math.round(maxPower);
            document.getElementById('resultAvgHR').textContent = Math.round(avgHR);
            document.getElementById('resultCalories').textContent = calories;

            // AI ë¶„ì„ ìš”ì²­
            requestAIAnalysis();

            showScreen('resultScreen');

            if (wakeLock) {
                try {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log("ğŸ”’ í™”ë©´ ì ˆì „ ëª¨ë“œ í•´ì œë¨");
                } catch (err) {
                    console.error("wakeLock í•´ì œ ì‹¤íŒ¨:", err);
                }
            }
            
        }

        function calculateAverage(array) {
            return array.length > 0 ? array.reduce((a, b) => a + b, 0) / array.length : 0;
        }

        function calculateOverallAchievement() {
            const totalTargetPowerTime = trainingSession.segments.reduce((sum, seg) => {
                const targetPower = currentUser.ftp * (seg.ftp_percent / 100);
                return sum + (targetPower * seg.duration_sec);
            }, 0);

            const totalActualPowerTime = trainingSession.data.power.reduce((sum, power) => sum + power, 0);

            if (totalTargetPowerTime === 0) return 100;
            return Math.min(100, Math.round((totalActualPowerTime / totalTargetPowerTime) * 100));
        }

        function requestAIAnalysis() {
            document.getElementById('aiAnalysis').textContent = 'ë¶„ì„ ì¤‘...';

            try {
                fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'analyzeTrainingPerformance',
                        sessionId: trainingSession.sessionId
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById('aiAnalysis').textContent = result.analysis;
                    } else {
                        document.getElementById('aiAnalysis').textContent = 'AI ë¶„ì„ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                })
                .catch(error => {
                    console.error('AI ë¶„ì„ ì‹¤íŒ¨:', error);
                    document.getElementById('aiAnalysis').textContent = 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                });
            } catch (error) {
                console.error('AI ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨:', error);
                document.getElementById('aiAnalysis').textContent = 'AI ë¶„ì„ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        function saveResult() {
            alert('í›ˆë ¨ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function shareResult() {
            const achievement = document.getElementById('finalAchievement').textContent;
            const workoutName = document.getElementById('workoutCompletedName').textContent;
            const avgPower = document.getElementById('resultAvgPower').textContent;
            const avgHR = document.getElementById('resultAvgHR').textContent;

            const shareText = `ğŸš´â€â™‚ï¸ ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸ í›ˆë ¨ ì™„ë£Œ!
${workoutName}
ë‹¬ì„±ë¥ : ${achievement}
í‰ê·  íŒŒì›Œ: ${avgPower}W
í‰ê·  ì‹¬ë°•: ${avgHR}bpm

ğŸ¯ ë‹¹ì‹ ë„ ë„ì „í•´ë³´ì„¸ìš”!
${window.location.href}`;

            if (navigator.share) {
                navigator.share({
                    title: 'ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸ - í›ˆë ¨ ì™„ë£Œ!',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                });
            }
        }

        function goHome() {
            currentUser = null;
            currentWorkout = null;
            countdownActive = false;
            segmentCountdownStarted = false;
            trainingSession = {
                sessionId: null,
                isRunning: false,
                isPaused: false,
                startTime: null,
                currentSegment: 0,
                segments: [],
                data: { power: [], cadence: [], heartRate: [], time: [] }
            };
            liveData = { power: 0, cadence: 0, heartRate: 0, targetPower: 0 };
            showScreen('connectionScreen');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.bluetooth) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nChrome, Edge, Opera ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
            }

            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                alert('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°ì„ ìœ„í•´ì„œëŠ” HTTPS í™˜ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }

            console.log('ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸ í›ˆë ¨ ì•± ë¡œë“œ ì™„ë£Œ');


        // í™”ë©´ ì ê¸ˆ í•´ì œ ê²€ì¶œ            
        document.addEventListener("visibilitychange", async () => {
            if (wakeLock !== null && document.visibilityState === "visible") {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log("ğŸ” í™”ë©´ ì ˆì „ ë°©ì§€ ì¬ìš”ì²­ë¨");
                } catch (err) {
                    console.error("í™”ë©´ ê¹¨ì›€ ì¬ìš”ì²­ ì‹¤íŒ¨:", err);
                }
            }
        });


            
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸ - ì›Œí¬ì•„ì›ƒ ì•±</title>
    <style>
        :root {
            --primary-color: #2E74E8;
            --secondary-color: #1A5AB8;
            --accent-color: #FF6B35;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --dark-color: #343A40;
            --light-color: #F8F9FA;
            --gray-color: #6C757D;
            --border-radius: 12px;
            --shadow: 0 4px 16px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-color);
            overflow-x: hidden;
        }

        .screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
            background: var(--light-color);
        }

        .screen.active {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: var(--gray-color);
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            text-align: center;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-secondary { background: var(--gray-color); }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì—°ê²° í™”ë©´ */
        .device-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .device-card.connected {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid var(--success-color);
        }

        .device-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .device-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            color: white;
        }

        .device-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .device-details p {
            font-size: 14px;
            color: var(--gray-color);
        }

        /* í”„ë¡œí•„ í™”ë©´ */
        .profile-card {
            position: relative;
        }

        .profile-info {
            display: flex;
            align-items: center;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .profile-details h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-color);
        }

        /* ì›Œí¬ì•„ì›ƒ í™”ë©´ */
        .workout-card {
            position: relative;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .workout-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .workout-duration {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* í›ˆë ¨ ì¤€ë¹„ í™”ë©´ */
        .training-ready {
            text-align: center;
            padding: 40px 20px;
        }

        .workout-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .workout-preview h2 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 15px;
        }

        .segment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .segment-item {
            background: var(--light-color);
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }

        .segment-item.warmup { border-left: 4px solid #28A745; }
        .segment-item.interval { border-left: 4px solid #DC3545; }
        .segment-item.rest { border-left: 4px solid #FFC107; }
        .segment-item.cooldown { border-left: 4px solid #6C757D; }

        .segment-item h4 {
            font-size: 12px;
            margin-bottom: 5px;
            color: var(--gray-color);
        }

        .segment-item .ftp-percent {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .segment-item .duration {
            font-size: 12px;
            color: var(--gray-color);
        }

        /* í›ˆë ¨ í™”ë©´ */
        #trainingScreen {
            background: #000;
            color: white;
            padding: 10px;
        }

        .training-header {
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .current-segment {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .segment-details {
            display: flex;
            justify-content: space-around;
            font-size: 24px;
            opacity: 0.8;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .metric-card {
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            place-items: center;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .power-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            padding: 20px;
        }

        .current-power {
            font-size: 80px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .power-progress {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .power-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #F56500, #7ED321);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .timeline-progress {
            width: 100%;
            height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .timeline-segments {
            display: flex;
            height: 100%;
        }
        
        .timeline-segment {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            position: relative;
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        .timeline-segment .segment-time {
            font-size: 15px;
            opacity: 0.8;
        }

        
        .timeline-segment .progress-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
            z-index: 1;
            border-radius: 0;
        }
        
        .timeline-segment:first-child .progress-fill {
            border-radius: 15px 0 0 15px;
        }
        
        .timeline-segment:last-child .progress-fill {
            border-radius: 0 15px 15px 0;
        }
        
        .timeline-segment span {
            position: relative;
            z-index: 2;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .training-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.pause {
            background: var(--warning-color);
        }

        .control-btn.stop {
            background: var(--danger-color);
        }

        /* ê²°ê³¼ í™”ë©´ */
        .achievement-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0deg, var(--success-color) 312deg, var(--light-color) 312deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }

        .achievement-circle::before {
            content: '';
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .achievement-text {
            font-size: 36px;
            font-weight: 700;
            color: var(--success-color);
            z-index: 1;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .result-stat {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
        }

        .result-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .result-stat-label {
            font-size: 14px;
            color: var(--gray-color);
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* ì¹´ìš´íŠ¸ë‹¤ìš´ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .countdown-number {
            font-size: 120px;
            font-weight: 700;
            color: white;
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in forwards;
        }
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .power-display {
                order: 1;
            }

            .timeline-progress {
                order: 3;
            }

            .current-power {
                font-size: 48px;
            }
        }
    </style>
</head>
<body>
    <!-- ì—°ê²° í™”ë©´ -->
    <div id="connectionScreen" class="screen active">
        <div class="header">
            <h1>ğŸš´â€â™‚ï¸ ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸</h1>
            <p class="subtitle">ìŠ¤ë§ˆíŠ¸ íŠ¸ë ˆì´ë„ˆì™€ ì‹¬ë°•ê³„ë¥¼ ì—°ê²°í•˜ì„¸ìš”</p>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px;">ğŸ“¡ ë¸”ë£¨íˆ¬ìŠ¤ ê¸°ê¸° ì—°ê²°</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <button class="btn" onclick="connectTrainer()">ìŠ¤ë§ˆíŠ¸ íŠ¸ë ˆì´ë„ˆ</button>
                <button class="btn btn-secondary" onclick="connectHeartRate()">ì‹¬ë°•ê³„ ì—°ê²°</button>
            </div>
        </div>

        <div id="deviceList">
            <!-- ì—°ê²°ëœ ê¸°ê¸°ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div id="connectionStatus" class="hidden">
            <div class="card text-center">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ê¸°ê¸°ì— ì—°ê²° ì¤‘...</p>
                </div>
            </div>
        </div>

        <div id="connectedDevicesSummary" class="card hidden">
            <h3 style="margin-bottom: 15px;">âœ… ì—°ê²°ëœ ê¸°ê¸°</h3>
            <div id="connectedDevicesList"></div>
            <button class="btn btn-success" onclick="proceedToProfile()" style="margin-top: 15px;">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
        </div>
    </div>

    <!-- í”„ë¡œí•„ ì„ íƒ í™”ë©´ -->
    <div id="profileScreen" class="screen">
        <div class="header">
            <h1>ğŸ‘¤ í”„ë¡œí•„ ì„ íƒ</h1>
            <p class="subtitle">í›ˆë ¨í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        </div>

        <div id="profileList">
            <!-- ì‚¬ìš©ì í”„ë¡œí•„ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div class="card" onclick="showAddUserForm()">
            <div class="text-center">
                <div style="font-size: 48px; margin-bottom: 10px;">â•</div>
                <h3>ìƒˆ ì‚¬ìš©ì ì¶”ê°€</h3>
                <p style="color: var(--gray-color); margin-top: 5px;">FTPì™€ ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì—¬ ìƒˆ í”„ë¡œí•„ì„ ë§Œë“œì„¸ìš”</p>
            </div>
        </div>

        <div id="addUserForm" class="card hidden">
            <h3 style="margin-bottom: 20px;">ìƒˆ ì‚¬ìš©ì ë“±ë¡</h3>
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="userName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label>ì—°ë½ì²˜</label>
                <input type="tel" id="userContact" placeholder="010-1234-5678">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>FTP (W)</label>
                    <input type="number" id="userFTP" placeholder="250" min="100" max="500">
                </div>
                <div class="form-group">
                    <label>ëª¸ë¬´ê²Œ (kg)</label>
                    <input type="number" id="userWeight" placeholder="70" min="40" max="150">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-success" onclick="saveNewUser()">ì €ì¥</button>
                <button class="btn btn-secondary" onclick="cancelAddUser()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ì›Œí¬ì•„ì›ƒ ì„ íƒ í™”ë©´ -->
    <div id="workoutScreen" class="screen">
        <div class="header">
            <h1>ğŸ“‹ ì›Œí¬ì•„ì›ƒ ì„ íƒ</h1>
            <p class="subtitle">ì˜¤ëŠ˜ì˜ í›ˆë ¨ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•˜ì„¸ìš”</p>
        </div>

        <div id="workoutList">
            <!-- ì›Œí¬ì•„ì›ƒ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- í›ˆë ¨ ì¤€ë¹„ í™”ë©´ -->
    <div id="trainingReadyScreen" class="screen">
        <div class="header">
            <h1>ğŸ¯ í›ˆë ¨ ì¤€ë¹„</h1>
            <p class="subtitle">ì„ íƒí•œ ì›Œí¬ì•„ì›ƒì„ í™•ì¸í•˜ê³  ì‹œì‘í•˜ì„¸ìš”</p>
        </div>

        <div class="workout-preview">
            <h2 id="previewWorkoutName">SST_MCT(14)</h2>
            <div style="display: flex; justify-content: space-around; margin: 20px 0; font-size: 18px;">
                <div><strong id="previewDuration">92ë¶„</strong><br><span style="color: var(--gray-color);">ì´ ì‹œê°„</span></div>
                <div><strong id="previewIntensity">78%</strong><br><span style="color: var(--gray-color);">í‰ê·  ê°•ë„</span></div>
                <div><strong id="previewTSS">82</strong><br><span style="color: var(--gray-color);">ì˜ˆìƒ TSS</span></div>
            </div>

            <div class="segment-preview" id="segmentPreview">
                <!-- ì„¸ê·¸ë¨¼íŠ¸ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <div class="training-ready">
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;">í›ˆë ¨ ì¤€ë¹„ ì™„ë£Œ</h3>
                <p style="color: var(--gray-color);">ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ í›ˆë ¨ì´ ì‹œì‘ë©ë‹ˆë‹¤.</p>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-success" onclick="startWorkoutTraining()" style="min-width: 150px;">
                    ğŸš€ í›ˆë ¨ ì‹œì‘
                </button>
                <button class="btn btn-secondary" onclick="backToWorkoutSelection()" style="min-width: 150px;">
                    â† ì›Œí¬ì•„ì›ƒ ë³€ê²½
                </button>
            </div>
        </div>
    </div>

    <!-- í›ˆë ¨ í™”ë©´ -->
    <!-- í›ˆë ¨ í™”ë©´ -->
    <div id="trainingScreen" class="screen">
        <div class="training-header">
            <div class="current-segment" id="currentSegmentName">ì›œì—… - 80RPM FTP 60%</div>
            <div class="segment-details">
                <span id="segmentTime">02:30 / 03:00</span>
                <span id="segmentProgress">ë‹¨ê³„ 2/17</span>
                <span id="nextSegment">ë‹¤ìŒ: ì¸í„°ë²Œ FTP 140%</span>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="segmentTime">02:30</div>
                <div class="metric-label">ë©íƒ€ì„</div>
                <div class="metric-value" id="avgSegmentPowerValue">0</div>
                <div class="metric-label">ë©íŒŒì›Œ(W)</div>
            </div>

            <div class="power-display">
                <div class="current-power" id="currentPowerValue">185</div>
                <div style="opacity: 0.7;">WATTS</div>
                <div class="power-progress">
                    <div class="power-progress-bar" id="powerProgressBar"></div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <div id="powerComparison" style="font-size: 30px; font-weight: 700; margin-bottom: 5px;">
                        ëª©í‘œ :  <span id="targetPowerValue">194</span>W
                    </div>
                    <!-- âœ… ì„¸ê·¸ë¨¼íŠ¸ëª… í‘œì‹œ ìœ„ì¹˜ -->
                    <div id="currentSegmentName" style="margin-top: 14px; font-size: 18px; font-weight: 600; color: #FFD700;"> ì›œì—… - 80RPM FTP 60%</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="heartRateValue">145</div>
                <div class="metric-label">BPM</div>
                <div class="metric-value" id="cadenceValue">89</div>
                <div class="metric-label">RPM</div>  
            </div>
        </div>

        <div style="background: rgba(255,255,255,0.1); border-radius: var(--border-radius); padding: 15px;">
            <div class="timeline-progress">
                <div class="timeline-segments" id="timelineSegments">
                    <!-- íƒ€ì„ë¼ì¸ ì„¸ê·¸ë¨¼íŠ¸ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 18px; opacity: 0.7;">
                <span>ë‹¬ì„±ë„: <span id="achievementValue">87</span>%</span>
                <span>ê²½ê³¼: <span id="elapsedTime">12:34</span> / <span id="totalTime">65:20</span></span>
                <span>í‰ê·  íŒŒì›Œ: <span id="avgPowerValue">178</span>W</span>
            </div>
        </div>

        <div class="training-controls">
            <button class="control-btn pause" onclick="togglePause()" title="ì¼ì‹œì •ì§€">
                <span id="pauseIcon">â¸</span>
            </button>
            <button class="control-btn" onclick="skipSegment()" title="êµ¬ê°„ ê±´ë„ˆë›°ê¸°">â­</button>
            <button class="control-btn stop" onclick="stopTraining()" title="í›ˆë ¨ ì¢…ë£Œ">â¹</button>
        </div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ -->
    <div id="resultScreen" class="screen">
        <div class="header">
            <h1>ğŸ‰ í›ˆë ¨ ì™„ë£Œ!</h1>
            <p class="subtitle">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤</p>
        </div>

        <div class="text-center" style="margin-bottom: 30px;">
            <div class="achievement-circle">
                <div class="achievement-text" id="finalAchievement">89%</div>
            </div>
            <h2 id="workoutCompletedName">SST_MCT(14) - 92ë¶„ ì™„ì£¼</h2>
        </div>

        <div class="result-stats">
            <div class="result-stat">
                <div class="result-stat-value" id="resultAvgPower">184</div>
                <div class="result-stat-label">í‰ê·  íŒŒì›Œ (W)</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="resultMaxPower">285</div>
                <div class="result-stat-label">ìµœëŒ€ íŒŒì›Œ (W)</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="resultAvgHR">152</div>
                <div class="result-stat-label">í‰ê·  ì‹¬ë°• (BPM)</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="resultCalories">892</div>
                <div class="result-stat-label">ì¹¼ë¡œë¦¬ (kcal)</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px;">ğŸ¤– AI ì„±ê³¼ ë¶„ì„</h3>
            <div id="aiAnalysis" style="line-height: 1.6; color: var(--gray-color);">
                ë¶„ì„ ì¤‘...
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-success" onclick="saveResult()">ì €ì¥í•˜ê¸°</button>
            <button class="btn btn-secondary" onclick="shareResult()">ê³µìœ í•˜ê¸°</button>
        </div>

        <button class="btn" onclick="goHome()" style="margin-top: 10px;">ìƒˆ í›ˆë ¨ ì‹œì‘</button>
    </div>

    <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ -->
    <div id="countdownOverlay" class="countdown-overlay hidden">
        <div class="countdown-number" id="countdownNumber">5</div>
    </div>

    <script>
        // Google Apps Script ì›¹ ì•± URL (ì‹¤ì œ ë°°í¬ëœ URLë¡œ êµì²´ í•„ìš”)
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwp6v4zwoRi0qQekKQZr4bCs8s2wUolHtLNKgq_uX8pIHck1XllibKgzCZ64w6Z7Wrw/exec';
        
        // ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬
        let isSegmentChanging = false; // ì„¸ê·¸ë¨¼íŠ¸ êµì²´ ì¤‘(ì¹´ìš´íŠ¸ë‹¤ìš´ í¬í•¨)
        let audioCtx = null; // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ (ë¹„í”„ìŒ ì •ì±… ëŒ€ì‘)
        let countdownActive = false;  // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ë³µ ë°©ì§€
        let segmentCountdownStarted = false; // ì„¸ê·¸ë¨¼íŠ¸ë³„ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘ í”Œë˜ê·¸
        let currentScreen = 'connectionScreen';
        let connectedDevices = {
            trainer: null,
            heartRate: null
        };
        let currentUser = null;
        let currentWorkout = null;
        let trainingSession = {
            sessionId: null,
            isRunning: false,
            isPaused: false,
            startTime: null,
            currentSegment: 0,
            segments: [],
            segmentStartTime: null,
            data: {
                power: [],
                cadence: [],
                heartRate: [],
                time: []
            }
        };
        let liveData = {
            power: 0,
            cadence: 0,
            heartRate: 0,
            targetPower: 0
        };

        // í™”ë©´ ì „í™˜ í•¨ìˆ˜ë“¤
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;

            if (screenId === 'profileScreen') {
                loadUsers();
            } else if (screenId === 'workoutScreen') {
                loadWorkouts();
            } else if (screenId === 'trainingReadyScreen') {
                showWorkoutPreview();
            }
        }

        // BLE ì—°ê²° í•¨ìˆ˜ë“¤
        async function connectTrainer() {
            try {
                showConnectionStatus(true);
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['fitness_machine'] },
                        { services: ['cycling_power'] },
                        { namePrefix: 'KICKR' },
                        { namePrefix: 'Wahoo' }
                    ],
                    optionalServices: ['device_information', 'fitness_machine', 'cycling_power']
                });

                const server = await device.gatt.connect();
                
                // Fitness Machine Service ì‹œë„
                let service, characteristic;
                try {
                    service = await server.getPrimaryService('fitness_machine');
                    characteristic = await service.getCharacteristic('indoor_bike_data');
                } catch (e) {
                    // Cycling Power Service ëŒ€ì•ˆ
                    try {
                        service = await server.getPrimaryService('cycling_power');
                        characteristic = await service.getCharacteristic('cycling_power_measurement');
                    } catch (e2) {
                        throw new Error('ì§€ì›ë˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }

                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleTrainerData);

                connectedDevices.trainer = {
                    name: device.name || 'Smart Trainer',
                    device: device,
                    server: server,
                    characteristic: characteristic
                };

                updateDevicesList();
                showConnectionStatus(false);
                alert(`âœ… ${device.name} ì—°ê²° ì„±ê³µ!`);
            } catch (error) {
                showConnectionStatus(false);
                console.error('íŠ¸ë ˆì´ë„ˆ ì—°ê²° ì˜¤ë¥˜:', error);
                alert("âŒ íŠ¸ë ˆì´ë„ˆ ì—°ê²° ì‹¤íŒ¨: " + error.message);
            }
        }

        async function connectHeartRate() {
            try {
                showConnectionStatus(true);
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate'] }]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('heart_rate');
                const characteristic = await service.getCharacteristic('heart_rate_measurement');

                characteristic.addEventListener('characteristicvaluechanged', handleHeartRateData);
                await characteristic.startNotifications();

                connectedDevices.heartRate = {
                    name: device.name || 'Heart Rate Monitor',
                    device: device,
                    server: server,
                    characteristic: characteristic
                };

                updateDevicesList();
                showConnectionStatus(false);
                alert(`âœ… ${device.name} ì—°ê²° ì„±ê³µ!`);
            } catch (error) {
                showConnectionStatus(false);
                console.error('ì‹¬ë°•ê³„ ì—°ê²° ì˜¤ë¥˜:', error);
                alert("âŒ ì‹¬ë°•ê³„ ì—°ê²° ì‹¤íŒ¨: " + error.message);
            }
        }

        function handleTrainerData(event) {
            const data = event.target.value;
            
            // Fitness Machine Service - Indoor Bike Data
            if (data.byteLength >= 4) {
                const flags = data.getUint16(0, true);
                let offset = 2;

                // ì¼€ì´ë˜ìŠ¤ (Bit 2)
                if (flags & 0x04) {
                    const cadence = data.getUint16(offset, true) * 0.5;
                    liveData.cadence = cadence;
                    offset += 2;
                }

                // íŒŒì›Œ (Bit 6)
                if (flags & 0x40) {
                    const power = data.getInt16(offset, true);
                    liveData.power = power;
                }
            }

            if (trainingSession.isRunning && !trainingSession.isPaused) {
                updateTrainingDisplay();
                recordDataPoint();
            }
        }

        function handleHeartRateData(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            const rate16Bits = flags & 0x1;
            const bpm = rate16Bits ? value.getUint16(1, true) : value.getUint8(1);

            liveData.heartRate = bpm;

            if (trainingSession.isRunning && !trainingSession.isPaused) {
                updateTrainingDisplay();
            }
        }

        function showConnectionStatus(show) {
            const status = document.getElementById('connectionStatus');
            if (show) {
                status.classList.remove('hidden');
            } else {
                status.classList.add('hidden');
            }
        }

        function updateDevicesList() {
            const deviceList = document.getElementById('deviceList');
            const summary = document.getElementById('connectedDevicesSummary');
            const summaryList = document.getElementById('connectedDevicesList');

            let connectedCount = 0;
            let html = '';

            if (connectedDevices.trainer) {
                connectedCount++;
                html += `
                    <div class="card device-card connected">
                        <div class="device-info">
                            <div class="device-icon">ğŸš´â€â™‚ï¸</div>
                            <div class="device-details">
                                <h3>${connectedDevices.trainer.name}</h3>
                                <p>Smart Trainer</p>
                            </div>
                        </div>
                        <div style="color: var(--success-color); font-weight: 600;">ì—°ê²°ë¨</div>
                    </div>
                `;
            }

            if (connectedDevices.heartRate) {
                connectedCount++;
                html += `
                    <div class="card device-card connected">
                        <div class="device-info">
                            <div class="device-icon" style="background: var(--danger-color);">â¤ï¸</div>
                            <div class="device-details">
                                <h3>${connectedDevices.heartRate.name}</h3>
                                <p>Heart Rate Monitor</p>
                            </div>
                        </div>
                        <div style="color: var(--success-color); font-weight: 600;">ì—°ê²°ë¨</div>
                    </div>
                `;
            }

            deviceList.innerHTML = html;

            if (connectedCount > 0) {
                summaryList.innerHTML = html;
                summary.classList.remove('hidden');
            } else {
                summary.classList.add('hidden');
            }
        }

        function proceedToProfile() {
            if (!connectedDevices.trainer) {
                alert('í›ˆë ¨ì„ ìœ„í•´ì„œëŠ” ìŠ¤ë§ˆíŠ¸ íŠ¸ë ˆì´ë„ˆê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                //return;  // ìˆ˜ì •ì˜ˆì •
            }
            showScreen('profileScreen');
        }

        // ì‚¬ìš©ì ê´€ë¦¬ í•¨ìˆ˜ë“¤
        async function loadUsers() {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getUsers' })
                });
                const users = await response.json();
                displayUsers(users);
            } catch (error) {
                console.error('ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', error);
                // ë”ë¯¸ ë°ì´í„°ë¡œ ëŒ€ì²´
                const dummyUsers = [
                    { user_id: 'U1', name: 'ë°•ì§€ì„±', contact: '010-1234-5678', ftp: 242, weight: 56 },
                    { user_id: 'U2', name: 'ë°•ì„ í˜¸', contact: '010-9876-5432', ftp: 280, weight: 70 }
                ];
                displayUsers(dummyUsers);
            }
        }

        function displayUsers(users) {
            const profileList = document.getElementById('profileList');
            profileList.innerHTML = '';

            users.forEach(user => {
                const profileCard = document.createElement('div');
                profileCard.className = 'card profile-card';
                profileCard.onclick = () => selectUser(user);

                const initials = user.name.substring(0, 2);
                const powerToWeight = (user.ftp / user.weight).toFixed(1);

                profileCard.innerHTML = `
                    <div class="profile-info">
                        <div class="profile-avatar">${initials}</div>
                        <div class="profile-details">
                            <h3>${user.name}</h3>
                            <div class="profile-stats">
                                <div>
                                    <div class="stat-value">${user.ftp}W</div>
                                    <div class="stat-label">FTP</div>
                                </div>
                                <div>
                                    <div class="stat-value">${user.weight}kg</div>
                                    <div class="stat-label">ëª¸ë¬´ê²Œ</div>
                                </div>
                                <div>
                                    <div class="stat-value">${powerToWeight}</div>
                                    <div class="stat-label">W/kg</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                profileList.appendChild(profileCard);
            });
        }

        function selectUser(user) {
            currentUser = user;
            alert(`${user.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
            showScreen('workoutScreen');
        }

        function showAddUserForm() {
            document.getElementById('addUserForm').classList.remove('hidden');
        }

        function cancelAddUser() {
            document.getElementById('addUserForm').classList.add('hidden');
            document.getElementById('userName').value = '';
            document.getElementById('userContact').value = '';
            document.getElementById('userFTP').value = '';
            document.getElementById('userWeight').value = '';
        }

        async function saveNewUser() {
            const name = document.getElementById('userName').value.trim();
            const contact = document.getElementById('userContact').value.trim();
            const ftp = parseInt(document.getElementById('userFTP').value);
            const weight = parseInt(document.getElementById('userWeight').value);

            if (!name || !contact || !ftp || !weight) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (ftp < 100 || ftp > 500) {
                alert('FTPëŠ” 100Wì—ì„œ 500W ì‚¬ì´ì˜ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (weight < 40 || weight > 150) {
                alert('ëª¸ë¬´ê²ŒëŠ” 40kgì—ì„œ 150kg ì‚¬ì´ì˜ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'addUser',
                        userData: { name, contact, ftp, weight }
                    })
                });
                const result = await response.json();

                if (result.success) {
                    alert('ìƒˆ ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    cancelAddUser();
                    loadUsers();
                } else {
                    alert('ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ì‚¬ìš©ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì›Œí¬ì•„ì›ƒ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        async function loadWorkouts() {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getWorkouts' })
                });
                const workouts = await response.json();
                displayWorkouts(workouts);
            } catch (error) {
                console.error('ì›Œí¬ì•„ì›ƒ ë¡œë“œ ì‹¤íŒ¨:', error);
                // ë”ë¯¸ ë°ì´í„°ë¡œ ëŒ€ì²´
                const dummyWorkouts = [
                    {
                        workout_id: 'SST_MCT14',
                        workout_name: 'SST_MCT(14)',
                        total_duration: 5520, // 92ë¶„ â†’ ì´ˆ ë‹¨ìœ„ë¡œ ìˆ˜ì •
                        avg_intensity: 78,
                        segments: [
                            { segment_order: 1, segment_type: 'ì›œì—…', description: '80RPM FTP 60%', ftp_percent: 60, duration_sec: 20, target_rpm: 80 },
                            { segment_order: 2, segment_type: 'ì¸í„°ë²Œ', description: 'FTP 88%', ftp_percent: 88, duration_sec: 30, target_rpm: 90 },
                            { segment_order: 3, segment_type: 'íœ´ì‹', description: 'FTP 50%', ftp_percent: 50, duration_sec: 10, target_rpm: 75 },
                            { segment_order: 4, segment_type: 'ì¸í„°ë²Œ', description: 'FTP 92%', ftp_percent: 92, duration_sec: 60, target_rpm: 90 },
                            { segment_order: 5, segment_type: 'ì¿¨ë‹¤ìš´', description: 'FTP 45%', ftp_percent: 45, duration_sec: 10, target_rpm: 70 }
                        ]
                    }
                ];
                displayWorkouts(dummyWorkouts);
            }
        }

        function displayWorkouts(workouts) {
            const workoutList = document.getElementById('workoutList');
            workoutList.innerHTML = '';

            workouts.forEach(workout => {
                const workoutCard = document.createElement('div');
                workoutCard.className = 'card workout-card';
                workoutCard.onclick = () => selectWorkout(workout);

                const duration = Math.floor(workout.total_duration / 60);
                const tss = calculateWorkoutTSS(workout);

                workoutCard.innerHTML = `
                    <div class="workout-header">
                        <div class="workout-title">${workout.workout_name}</div>
                        <div class="workout-duration">${duration}ë¶„</div>
                    </div>
                    <div style="margin: 15px 0;">
                        <div style="font-size: 14px; color: var(--gray-color);">
                            í‰ê· : ${workout.avg_intensity}% FTP | TSS: ${tss}
                        </div>
                    </div>
                `;

                workoutList.appendChild(workoutCard);
            });
        }

        function calculateWorkoutTSS(workout) {
            let totalTSS = 0;
            workout.segments.forEach(segment => {
                const intensityFactor = segment.ftp_percent / 100;
                const durationHours = segment.duration_sec / 3600;
                totalTSS += durationHours * intensityFactor * intensityFactor * 100;
            });
            return Math.round(totalTSS);
        }

        function selectWorkout(workout) {
            currentWorkout = workout;
            showScreen('trainingReadyScreen');
        }

        // ì›Œí¬ì•„ì›ƒ ë¯¸ë¦¬ë³´ê¸° í™”ë©´
        function showWorkoutPreview() {
            if (!currentWorkout || !currentUser) return;

            document.getElementById('previewWorkoutName').textContent = currentWorkout.workout_name;
            document.getElementById('previewDuration').textContent = Math.floor(currentWorkout.total_duration / 60) + 'ë¶„';
            document.getElementById('previewIntensity').textContent = currentWorkout.avg_intensity + '%';
            document.getElementById('previewTSS').textContent = calculateWorkoutTSS(currentWorkout);

            const segmentPreview = document.getElementById('segmentPreview');
            segmentPreview.innerHTML = '';

            currentWorkout.segments.forEach((segment, index) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = `segment-item ${segment.segment_type.toLowerCase()}`;
                
                const duration = Math.floor(segment.duration_sec / 60);
                
                segmentDiv.innerHTML = `
                    <h4>${segment.segment_type}</h4>
                    <div class="ftp-percent">${segment.ftp_percent}%</div>
                    <div class="duration">${duration}ë¶„</div>
                `;

                segmentPreview.appendChild(segmentDiv);
            });
        }

        function startWorkoutTraining() {
            showScreen('trainingScreen');
            initializeTraining();
        }

        function backToWorkoutSelection() {
            showScreen('workoutScreen');
        }

        // í›ˆë ¨ ì‹¤í–‰ í•¨ìˆ˜ë“¤ - ìˆ˜ì •ëœ ë¶€ë¶„
        function initializeTraining() {
            if (!currentWorkout || !currentUser) return;

            // ìƒíƒœ ì´ˆê¸°í™”
            countdownActive = false;
            segmentCountdownStarted = false;

            trainingSession = {
                sessionId: 'S' + Date.now(),
                isRunning: false,
                isPaused: false,
                startTime: null,
                currentSegment: 0,
                segments: currentWorkout.segments,
                segmentStartTime: null,
                data: {
                    power: [],
                    cadence: [],
                    heartRate: [],
                    time: []
                }
            };

            updateTrainingDisplay();
            createTimeline();
            updateSegmentDisplay();

            // 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ ì‹œì‘
            showCountdown(5, () => {
                startTraining();
            });
        }

        /////////////////////////////// 
        function showCountdown(seconds, callback, message = "í›ˆë ¨ ì‹œì‘ ì¤€ë¹„!", isInitialCall = true) {
            if (isInitialCall && countdownActive) return; // ì¤‘ë³µ ë°©ì§€
            if (isInitialCall) countdownActive = true;
        
            // âœ… ë¸Œë¼ìš°ì € ì˜¤ë””ì˜¤ ì •ì±… ëŒ€ì‘
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioCtx.resume();
            }
        
            const overlay = document.getElementById('countdownOverlay');
            const number = document.getElementById('countdownNumber');
        
            let messageEl = document.getElementById("countdownMessage");
            if (!messageEl) {
                messageEl = document.createElement("div");
                messageEl.id = "countdownMessage";
                messageEl.style.position = "absolute";
                messageEl.style.top = "20%";
                messageEl.style.width = "100%";
                messageEl.style.textAlign = "center";
                messageEl.style.color = "white";
                messageEl.style.fontSize = "36px";
                messageEl.style.opacity = "0";
                messageEl.style.transition = "opacity 0.5s ease-in-out";
                overlay.appendChild(messageEl);
            }
        
            messageEl.textContent = message;
            messageEl.style.opacity = "1";
            overlay.classList.remove('hidden');
            number.textContent = seconds;
        
            playBeep(); // ì‹œì‘ ì‹œ 1íšŒ
        
            if (seconds > 0) {
                setTimeout(() => {
                    number.textContent = seconds - 1;
                    if (seconds > 1) playBeep();
                    showCountdown(seconds - 1, callback, message, false);
                }, 1000);
            } else {
                messageEl.style.opacity = "0";
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    countdownActive = false;
                    callback();
                }, 300);
            }
        }



        let beepActive = false;
        
        function playBeep() {
            if (beepActive) return;
            beepActive = true;
        
            try {
                const ctx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
        
                osc.connect(gain);
                gain.connect(ctx.destination);
        
                osc.type = "square";
                osc.frequency.value = 950;
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
        
                osc.start();
                osc.stop(ctx.currentTime + 0.15);
        
                osc.onended = () => {
                    beepActive = false;
                };
            } catch (err) {
                beepActive = false;
                console.error("Beep sound error:", err);
            }
        }
       
/////////////////////////////////////////////////////////////////////////////////




        
        function startTraining() {
            trainingSession.isRunning = true;
            trainingSession.startTime = Date.now();
            trainingSession.segmentStartTime = Date.now();
            segmentCountdownStarted = false; // ì´ˆê¸°í™”

            updateTrainingTimer();
            updateTargetPower();

            // ì„œë²„ì— ì„¸ì…˜ ì‹œì‘ ì•Œë¦¼
            try {
                fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'startTrainingSessionAPI',
                        sessionData: {
                            user_id: currentUser.user_id,
                            workout_id: currentWorkout.workout_id
                        }
                    })
                });
            } catch (error) {
                console.error('ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨:', error);
            }

            // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„± (ì‹¤ì œ ê¸°ê¸°ê°€ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš°)
            if (!connectedDevices.trainer) {
                startDataSimulation();
            }
        }

        function startDataSimulation() {
            setInterval(() => {
                if (!trainingSession.isRunning || trainingSession.isPaused) return;

                const currentSeg = trainingSession.segments[trainingSession.currentSegment];
                if (!currentSeg) return;

                const targetPower = Math.round(currentUser.ftp * (currentSeg.ftp_percent / 100));
                const variation = (Math.random() - 0.5) * 30;
                liveData.power = Math.max(0, targetPower + variation);
                liveData.cadence = currentSeg.target_rpm + (Math.random() - 0.5) * 10;
                liveData.targetPower = targetPower;

                updateTrainingDisplay();
                recordDataPoint();
            }, 1000);
        }

        function updateTargetPower() {
            if (!trainingSession.isRunning || trainingSession.isPaused) return;

            const currentSeg = trainingSession.segments[trainingSession.currentSegment];
            if (currentSeg && currentUser) {
                const targetPower = Math.round(currentUser.ftp * (currentSeg.ftp_percent / 100));
                liveData.targetPower = targetPower;
            }
        }

        function updateTrainingDisplay() {
            // ì‹¤ì‹œê°„ í‘œì‹œê°’
            document.getElementById('currentPowerValue').textContent = Math.round(liveData.power);
            document.getElementById('cadenceValue').textContent = Math.round(liveData.cadence);
            document.getElementById('heartRateValue').textContent = Math.round(liveData.heartRate);
            document.getElementById('targetPowerValue').textContent = liveData.targetPower;

            const ftpPercent = currentUser ? Math.round((liveData.targetPower / currentUser.ftp) * 100) : 0;
            document.getElementById('targetFtpPercent').textContent = ftpPercent;

            // ë‹¬ì„±ë¥  í‘œì‹œ
            const achievement = liveData.targetPower > 0 ?
                Math.min(100, Math.round((liveData.power / liveData.targetPower) * 100)) : 0;
            document.getElementById('achievementValue').textContent = achievement;

            // ì§„í–‰ë°” ê°±ì‹ 
            const progressPercent = Math.min(100, (liveData.power / liveData.targetPower) * 100);
            document.getElementById('powerProgressBar').style.width = progressPercent + '%';

            // ì „ì²´ í‰ê·  íŒŒì›Œ
            let avgPower = 0;
            if (trainingSession.data.power.length > 0) {
                avgPower = trainingSession.data.power.reduce((a, b) => a + b, 0) / trainingSession.data.power.length;
                document.getElementById('avgPowerValue').textContent = Math.round(avgPower);
            }

            // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ë³„ í‰ê·  íŒŒì›Œ ê³„ì‚°
            const segStart = trainingSession.segmentStartTime;
            const segEnd = Date.now();
            const segmentPowerData = trainingSession.data.power.filter((_, i) => {
                const t = trainingSession.data.time[i];
                return t >= segStart && t <= segEnd;
            });

            let avgSegPower = 0;
            if (segmentPowerData.length > 0) {
                avgSegPower = segmentPowerData.reduce((a, b) => a + b, 0) / segmentPowerData.length;
            }

            const avgSegPowerEl = document.getElementById('avgSegmentPowerValue');
            if (avgSegPowerEl) {
                avgSegPowerEl.textContent = Math.round(avgSegPower);
                if (avgSegPower < liveData.targetPower * 0.9) {
                    avgSegPowerEl.style.color = "#F56500"; // ì£¼í™©ìƒ‰ (ë‚®ìŒ)
                } else if (avgSegPower > liveData.targetPower * 1.1) {
                    avgSegPowerEl.style.color = "#7ED321"; // ì—°ë‘ìƒ‰ (ë†’ìŒ)
                } else {
                    avgSegPowerEl.style.color = "white"; // ì •ìƒ ë²”ìœ„
                }
            }
        }

        function updateTrainingTimer() {
            const timerInterval = setInterval(() => {
                if (!trainingSession.isRunning) {
                    clearInterval(timerInterval);
                    return;
                }

                if (trainingSession.isPaused) return;

                const elapsed = Date.now() - trainingSession.startTime;
                const segmentElapsed = Date.now() - trainingSession.segmentStartTime;

                const elapsedMinutes = Math.floor(elapsed / 60000);
                const elapsedSeconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('elapsedTime').textContent =
                    `${elapsedMinutes.toString().padStart(2, '0')}:${elapsedSeconds.toString().padStart(2, '0')}`;

                const totalMinutes = Math.floor(currentWorkout.total_duration / 60);
                const totalSecondsRemaining = currentWorkout.total_duration % 60;
                document.getElementById('totalTime').textContent =
                    `${totalMinutes.toString().padStart(2, '0')}:${totalSecondsRemaining.toString().padStart(2, '0')}`;

                checkSegmentProgress(segmentElapsed);
                updateSegmentTimer(segmentElapsed);
            }, 1000);
        }

        function updateSegmentTimer(segmentElapsed) {
            const currentSeg = trainingSession.segments[trainingSession.currentSegment];
            if (!currentSeg) return;

            const segmentRemaining = Math.max(0, currentSeg.duration_sec * 1000 - segmentElapsed);
            const remainingMinutes = Math.floor(segmentRemaining / 60000);
            const remainingSeconds = Math.floor((segmentRemaining % 60000) / 1000);

            const segmentTotalMinutes = Math.floor(currentSeg.duration_sec / 60);
            const segmentTotalSeconds = currentSeg.duration_sec % 60;

            document.getElementById('segmentTime').textContent =
                `${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')} `;
            
            //document.getElementById('segmentTime').textContent =
                //`${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')} / ${segmentTotalMinutes.toString().padStart(2, '0')}:${segmentTotalSeconds.toString().padStart(2, '0')}`;
        }

        // ìˆ˜ì •ëœ ì„¸ê·¸ë¨¼íŠ¸ ì§„í–‰ ì²´í¬ í•¨ìˆ˜
        function checkSegmentProgress(segmentElapsed) {
            const segIndex = trainingSession.currentSegment;
            const currentSeg = trainingSession.segments[segIndex];
            if (!currentSeg) return;
        
            // âœ… ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì—ëŠ” ì„¸ê·¸ë¨¼íŠ¸ ì§„í–‰ ì¤‘ì§€
            if (isSegmentChanging) return;
        
            const progressPercent = Math.min(100, (segmentElapsed / (currentSeg.duration_sec * 1000)) * 100);
            const segments = document.querySelectorAll(".timeline-segment");
        
            segments.forEach((seg, idx) => {
                const fill = seg.querySelector(".progress-fill");
                if (!fill) return;
                if (idx < segIndex) fill.style.width = "100%";
                else if (idx === segIndex) fill.style.width = `${progressPercent}%`;
                else fill.style.width = "0%";
            });
        
            const remainingTime = currentSeg.duration_sec * 1000 - segmentElapsed;
        
            // âœ… ì¢…ë£Œ 5ì´ˆ ì „ ì¹´ìš´íŠ¸ë‹¤ìš´ (í•œ ë²ˆë§Œ ì‹¤í–‰)
            if (!segmentCountdownStarted && remainingTime <= 5000 && remainingTime > 4000) {
                segmentCountdownStarted = true;
                isSegmentChanging = true; // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ ë£¨í”„ ì¼ì‹œ ì •ì§€
        
                if (segIndex < trainingSession.segments.length - 1) {
                    showCountdown(5, () => {
                        completeCurrentSegment();
                        nextSegment();
                        isSegmentChanging = false;
                    }, "ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ì¤€ë¹„!");
                } else {
                    showCountdown(5, () => {
                        completeCurrentSegment();
                        completeTraining();
                        isSegmentChanging = false;
                    }, "í›ˆë ¨ ì™„ë£Œ!");
                }
                return;
            }
        
            // âœ… ì¹´ìš´íŠ¸ë‹¤ìš´ì´ ëë‚œ ë’¤, ë‚¨ì€ ì‹œê°„ì´ ì™„ì „íˆ 0ì´ ë˜ë©´ ì •ìƒ ì¢…ë£Œ
            if (remainingTime <= 0 && !isSegmentChanging) {
                completeCurrentSegment();
                if (segIndex < trainingSession.segments.length - 1) {
                    nextSegment();
                } else {
                    completeTraining();
                }
            }
        }


        function completeCurrentSegment() {
            const segIndex = trainingSession.currentSegment;
            const currentSeg = trainingSession.segments[segIndex];
            if (!currentSeg) return;

            const segmentStartTime = trainingSession.segmentStartTime;
            const segmentEndTime = Date.now();

            const powerData = trainingSession.data.power;
            const timeData = trainingSession.data.time;

            const segmentPowerData = powerData.filter((_, i) => {
                const t = timeData[i];
                return t >= segmentStartTime && t <= segmentEndTime;
            });

            const avgPower = segmentPowerData.length > 0
                ? segmentPowerData.reduce((a, b) => a + b, 0) / segmentPowerData.length
                : 0;

            const targetPower = currentUser.ftp * (currentSeg.ftp_percent / 100);
            const achievement = targetPower > 0 ? (avgPower / targetPower) * 100 : 0;
            const color = achievement >= 100 ? "#7ED321" : "#F56500";

            const segment = document.getElementById(`timeline-segment-${segIndex}`);
            const fill = segment ? segment.querySelector(".progress-fill") : null;
            if (fill) {
                fill.style.width = "100%";
                fill.style.background = color;
            }

            console.log(`ì„¸ê·¸ë¨¼íŠ¸ ${segIndex + 1} ì™„ë£Œ: í‰ê·  íŒŒì›Œ ${Math.round(avgPower)}W, ë‹¬ì„±ë¥  ${Math.round(achievement)}%`);
        }


////////////////////////////////////////////////////////////////////////////////
        function nextSegment() {
            trainingSession.currentSegment++;
            segmentCountdownStarted = false;
            isSegmentChanging = false;
        
            if (trainingSession.currentSegment >= trainingSession.segments.length) {
                completeTraining();
                return;
            }
        
            trainingSession.segmentStartTime = Date.now();
            updateSegmentDisplay();
            updateTargetPower();
            updateTimelineSegment(trainingSession.currentSegment, 'current');
        }


        
        function updateSegmentDisplay() {
            const currentSeg = trainingSession.segments[trainingSession.currentSegment];
            if (!currentSeg) return;

            document.getElementById('currentSegmentName').textContent =
                `${currentSeg.description} (${currentSeg.segment_type})`;

            document.getElementById('segmentProgress').textContent =
                `ë‹¨ê³„ ${trainingSession.currentSegment + 1}/${trainingSession.segments.length}`;

            const nextSeg = trainingSession.segments[trainingSession.currentSegment + 1];
            if (nextSeg) {
                document.getElementById('nextSegment').textContent = `ë‹¤ìŒ: ${nextSeg.description}`;
            } else {
                document.getElementById('nextSegment').textContent = 'ë‹¤ìŒ: í›ˆë ¨ ì™„ë£Œ';
            }
        }

        function createTimeline() {
            const timeline = document.getElementById('timelineSegments');
            timeline.innerHTML = '';

            trainingSession.segments.forEach((segment, index) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'timeline-segment';
                segmentDiv.style.flex = segment.duration_sec;
                segmentDiv.id = `timeline-segment-${index}`;

                const fillDiv = document.createElement('div');
                fillDiv.className = 'progress-fill';
                segmentDiv.appendChild(fillDiv);

                const label = document.createElement('span');
                label.textContent = index + 1;
                segmentDiv.appendChild(label);

                timeline.appendChild(segmentDiv);
            });
        }

        function updateTimelineSegment(segmentIndex, status) {
            const segment = document.getElementById(`timeline-segment-${segmentIndex}`);
            if (!segment) return;
            segment.className = `timeline-segment ${status}`;
        }

        function recordDataPoint() {
            trainingSession.data.power.push(liveData.power);
            trainingSession.data.cadence.push(liveData.cadence);
            trainingSession.data.heartRate.push(liveData.heartRate);
            trainingSession.data.time.push(Date.now());
        }

        function togglePause() {
            trainingSession.isPaused = !trainingSession.isPaused;
            const pauseIcon = document.getElementById('pauseIcon');
            pauseIcon.textContent = trainingSession.isPaused ? 'â–¶ï¸' : 'â¸ï¸';
        }

        function skipSegment() {
            if (confirm('í˜„ì¬ êµ¬ê°„ì„ ê±´ë„ˆë›°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                completeCurrentSegment();
                nextSegment();
            }
        }

        function stopTraining() {
            if (confirm('ì •ë§ í›ˆë ¨ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                trainingSession.isRunning = false;
                completeTraining();
            }
        }

        function completeTraining() {
            trainingSession.isRunning = false;

            const avgPower = calculateAverage(trainingSession.data.power);
            const maxPower = Math.max(...trainingSession.data.power);
            const avgHR = calculateAverage(trainingSession.data.heartRate);
            const achievement = calculateOverallAchievement();

            const durationHours = (Date.now() - trainingSession.startTime) / 3600000;
            const calories = Math.round(avgPower * durationHours * 3.6);

            document.getElementById('finalAchievement').textContent = achievement + '%';
            document.getElementById('workoutCompletedName').textContent =
                `${currentWorkout.workout_name} - ${Math.floor(durationHours * 60)}ë¶„ ì™„ì£¼`;

            document.getElementById('resultAvgPower').textContent = Math.round(avgPower);
            document.getElementById('resultMaxPower').textContent = Math.round(maxPower);
            document.getElementById('resultAvgHR').textContent = Math.round(avgHR);
            document.getElementById('resultCalories').textContent = calories;

            // AI ë¶„ì„ ìš”ì²­
            requestAIAnalysis();

            showScreen('resultScreen');
        }

        function calculateAverage(array) {
            return array.length > 0 ? array.reduce((a, b) => a + b, 0) / array.length : 0;
        }

        function calculateOverallAchievement() {
            const totalTargetPowerTime = trainingSession.segments.reduce((sum, seg) => {
                const targetPower = currentUser.ftp * (seg.ftp_percent / 100);
                return sum + (targetPower * seg.duration_sec);
            }, 0);

            const totalActualPowerTime = trainingSession.data.power.reduce((sum, power) => sum + power, 0);

            if (totalTargetPowerTime === 0) return 100;
            return Math.min(100, Math.round((totalActualPowerTime / totalTargetPowerTime) * 100));
        }

        function requestAIAnalysis() {
            document.getElementById('aiAnalysis').textContent = 'ë¶„ì„ ì¤‘...';

            try {
                fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'analyzeTrainingPerformance',
                        sessionId: trainingSession.sessionId
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById('aiAnalysis').textContent = result.analysis;
                    } else {
                        document.getElementById('aiAnalysis').textContent = 'AI ë¶„ì„ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                })
                .catch(error => {
                    console.error('AI ë¶„ì„ ì‹¤íŒ¨:', error);
                    document.getElementById('aiAnalysis').textContent = 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                });
            } catch (error) {
                console.error('AI ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨:', error);
                document.getElementById('aiAnalysis').textContent = 'AI ë¶„ì„ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        function saveResult() {
            alert('í›ˆë ¨ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function shareResult() {
            const achievement = document.getElementById('finalAchievement').textContent;
            const workoutName = document.getElementById('workoutCompletedName').textContent;
            const avgPower = document.getElementById('resultAvgPower').textContent;
            const avgHR = document.getElementById('resultAvgHR').textContent;

            const shareText = `ğŸš´â€â™‚ï¸ ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸ í›ˆë ¨ ì™„ë£Œ!
${workoutName}
ë‹¬ì„±ë¥ : ${achievement}
í‰ê·  íŒŒì›Œ: ${avgPower}W
í‰ê·  ì‹¬ë°•: ${avgHR}bpm

ğŸ¯ ë‹¹ì‹ ë„ ë„ì „í•´ë³´ì„¸ìš”!
${window.location.href}`;

            if (navigator.share) {
                navigator.share({
                    title: 'ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸ - í›ˆë ¨ ì™„ë£Œ!',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                });
            }
        }

        function goHome() {
            currentUser = null;
            currentWorkout = null;
            countdownActive = false;
            segmentCountdownStarted = false;
            trainingSession = {
                sessionId: null,
                isRunning: false,
                isPaused: false,
                startTime: null,
                currentSegment: 0,
                segments: [],
                data: { power: [], cadence: [], heartRate: [], time: [] }
            };
            liveData = { power: 0, cadence: 0, heartRate: 0, targetPower: 0 };
            showScreen('connectionScreen');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.bluetooth) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nChrome, Edge, Opera ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
            }

            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                alert('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°ì„ ìœ„í•´ì„œëŠ” HTTPS í™˜ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }

            console.log('ì‚¬ì´í´ ì•„ì¹´ë°ë¯¸ í›ˆë ¨ ì•± ë¡œë“œ ì™„ë£Œ');
        });
    </script>
</body>
</html>
