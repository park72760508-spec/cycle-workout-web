<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no"
  />
  <title>사이클 앱코치</title>

  <!-- GitHub Pages / HTTPS / BLE 권장 헤더 -->
  <meta http-equiv="origin-trial" content="">
  <meta name="theme-color" content="#2E74E8" />

  <style>
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
      background:#333;color:#fff;padding:10px 16px;border-radius:8px;
      opacity:0;transition:opacity .35s;z-index:9999}
    .toast.show{opacity:.92}
    .hidden{display:none}
  </style>

  
  <!-- 외부 스타일 (Step 2에서 제공할 파일) -->
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- 앱 전역설정: GAS URL 등 (Step 5에서 교체) -->
  <script>
    window.CONFIG = {
      GAS_WEB_APP_URL:
        "https://script.google.com/macros/s/AKfycbwp6v4zwoRi0qQekKQZr4bCs8s2wUolHtLNKgq_uX8pIHck1XllibKgzCZ64w6Z7Wrw/exec"
    };
  </script>
</head>

<body>
  <!-- =========================
       1) 연결 화면
  ========================== -->
  <div id="connectionScreen" class="screen active">
    <div class="header">
      <h1>🚴‍♂️ 사이클 앱코치</h1>
      <p class="subtitle">와 심박계를 연결하세요(0242)</p>
    </div>

    <div class="card">
      <h3 class="mb-15">📡 블루투스 기기 연결</h3>
      <div class="grid-2 gap-10 mb-15">
        <button class="btn" id="btnConnectTrainer">스마트 트레이너</button>
        <button class="btn btn-secondary" id="btnConnectHR">심박계 연결</button>
        <button class="btn" id="btnConnectPM">파워미터 연결</button>
      </div>
    </div>

    <div id="connectedDevicesList"><!-- 연결된 기기 카드들 --></div>

    <div id="connectionStatus" class="hidden">
      <div class="card text-center">
        <div class="loading">
          <div class="spinner"></div>
          <p>기기에 연결 중...</p>
        </div>
      </div>
    </div>

    <div id="connectedDevicesSummary" class="card hidden">
      <h3 class="mb-15">✅ 연결된 기기</h3>
      <button class="btn btn-success" id="btnToProfile" style="margin-top:15px">
        다음 단계로
      </button>
    </div>
  </div>

  <!-- =========================
       2) 프로필 선택 화면
  ========================== -->
  <div id="profileScreen" class="screen">
    <div class="header">
      <h1>👤 프로필 선택</h1>
      <p class="subtitle">훈련할 사용자를 선택하세요</p>
    </div>

    <div id="userList"><!-- 사용자 프로필 카드들 --></div>
    <div class="card" id="cardAddUser">
      <div class="text-center">
        <div class="big-plus mb-10">➕</div>
        <h3>새 사용자 추가</h3>
        <p class="muted mt-5">FTP와 몸무게를 입력하여 새 프로필을 만드세요</p>
      </div>
    </div>

    <div id="addUserForm" class="card hidden">
      <h3 class="mb-20">새 사용자 등록</h3>
      <div class="form-group">
        <label>이름</label>
        <input type="text" id="userName" placeholder="이름을 입력하세요" />
      </div>
      <div class="form-group">
        <label>연락처</label>
        <input type="tel" id="userContact" placeholder="010-1234-5678" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>FTP (W)</label>
          <input type="number" id="userFTP" placeholder="250" min="100" max="500" />
        </div>
        <div class="form-group">
          <label>몸무게 (kg)</label>
          <input type="number" id="userWeight" placeholder="70" min="40" max="150" />
        </div>
      </div>
      <div class="btn-row mt-10">
        <button class="btn btn-success" id="btnSaveUser">저장</button>
        <button class="btn btn-secondary" id="btnCancelAddUser">취소</button>
      </div>
    </div>
  </div>

  <!-- =========================
       3) 워크아웃 선택 화면
  ========================== -->
  <div id="workoutScreen" class="screen">
    <div class="header">
      <h1>📋 워크아웃 선택</h1>
      <p class="subtitle">오늘의 훈련 프로그램을 선택하세요</p>
    </div>
    <div id="workoutList" class="workout-list"></div>
  </div>

  <!-- =========================
       4) 훈련 준비 화면
  ========================== -->
  <div id="trainingReadyScreen" class="screen">
    <div class="header">
      <h1>🎯 훈련 준비</h1>
      <p class="subtitle">선택한 워크아웃을 확인하고 시작하세요</p>
    </div>

    <div class="workout-preview">
      <h2 id="previewWorkoutName">SST_MCT(14)</h2>
      <div class="preview-stats">
        <div><strong id="previewDuration">92분</strong><br /><span class="muted">총 시간</span></div>
        <div><strong id="previewIntensity">78%</strong><br /><span class="muted">평균 강도</span></div>
        <div><strong id="previewTSS">82</strong><br /><span class="muted">예상 TSS</span></div>
      </div>
      <div class="segment-preview" id="segmentPreview"><!-- 세그먼트 미리보기 --></div>
    </div>

    <div class="training-ready">
      <div class="mb-30">
        <h3 class="mb-15">훈련 준비 완료</h3>
        <p class="muted">시작 버튼을 누르면 5초 카운트다운 후 훈련이 시작됩니다.</p>
      </div>

      <div class="btn-row center">
        <button class="btn btn-success" id="btnStartTraining">🚀 훈련 시작</button>
        <button class="btn btn-secondary" id="btnBackToWorkouts">← 워크아웃 변경</button>
      </div>
    </div>
  </div>

  <!-- =========================
       5) 훈련 화면
  ========================== -->
<div id="trainingScreen" class="screen">
  <div class="training-header">
    <div id="userInfo"><!-- 사용자 정보 --></div>
  </div>

  <!-- ✅ 새로 추가: 시간/세그먼트 전용 3분할 블럭 (.segment-details1) -->
  <div class="segment-details1">
    <div class="seg-left1">
      <span class="elapsed-wrap1">
        경과: <span id="elapsedTime">00:00</span>
        (<span id="elapsedPercent">0</span>%)
      </span>
    </div>
    <div class="seg-center1">
      <span id="segmentTime">00:00</span>
    </div>
    <div class="seg-right1">
      <span id="nextSegment">다음: 인터벌 FTP 140%</span>
    </div>
  </div>

  <!-- ... 이하 기존 훈련 화면 구성 계속 ... -->

    <div class="metrics-grid">
      <!-- 좌측: 세그먼트 평균 파워 + TSS -->
      <div class="metric-card avg-segment-power">
        <div class="col-center">
          <div class="metric-value" id="avgSegmentPowerValue">178</div>
          <div class="metric-label">랩 파워 (W)</div>
          <div class="metric-value" id="tssValue">0</div>
          <div class="metric-label">TSS</div>
        </div>
      </div>

      <!-- 중앙: 현재 파워 + 목표/달성도 + 세그먼트 진행률 -->
      <div class="power-display">
        <div class="current-power" id="currentPowerValue">185</div>
        <div class="unit-dim">WATTS</div>
        <div class="power-progress">
          <div class="power-progress-bar" id="powerProgressBar"></div>
          <div class="power-progress-label">달성도: <span id="achievementValueBar">0</span>%</div>
        </div>
        <div class="center mt-10">
          <div id="powerComparison" class="target-line">목표 : <span id="targetPowerValue">194</span>W</div>
          <div id="segmentProgressText" class="segment-progress">진행률 <span id="segmentProgress">0</span>%</div>
          <div id="currentSegmentName" class="segment-name">웜업 - 80RPM FTP 60%</div>
        </div>
      </div>

      <!-- 우측: 심박/케이던스/칼로리 -->
      <div class="metric-card dual-metric">
        <div class="metric-item">
          <div class="metric-value" id="heartRateValue">145</div>
          <div class="metric-label">BPM</div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="cadenceValue">89</div>
          <div class="metric-label">RPM</div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="kcalValue">-</div> 
          <div class="metric-label">kcal</div>
        </div>
      </div>
    </div>

    <div class="timeline-wrap">
      <div class="timeline-progress">
        <div class="timeline-segments" id="timelineSegments"><!-- 세그먼트 바 --></div>
      </div>
      <div class="timeline-legend">
        <span>평균 파워: <span id="avgPowerValue">178</span>W</span>
      </div>
    </div>

    <div class="training-controls">
      <button class="control-btn pause" id="btnTogglePause" title="일시정지"><span id="pauseIcon">⏸️</span></button>
      <button class="control-btn" id="btnSkipSegment" title="구간 건너뛰기">⏭️</button>
      <button class="control-btn stop" id="btnStopTraining" title="훈련 종료">⏹️</button>
    </div>
  </div>


  
  <!-- =========================
       6) 결과 화면
  ========================== -->
  <div id="resultScreen" class="screen">
    <div class="header">
      <h1>🎉 훈련 완료!</h1>
      <p class="subtitle">수고하셨습니다</p>
    </div>

    <div class="text-center mb-30">
      <div class="achievement-circle"><div class="achievement-text" id="finalAchievement">89%</div></div>
      <h2 id="workoutCompletedName">SST_MCT(14) - 92분 완주</h2>
    </div>

   <!-- =========================
       추가) 결과 화면
  ========================== -->  
    <!-- ✅ 여기로 이동 -->
    <div class="form-group text-center mb-10">
      <label for="resultUserSelect">사용자 선택</label>
      <select id="resultUserSelect" class="form-control" onchange="handleUserSelect(this.value)">
        <option value="">-- 사용자 선택 --</option>
      </select>
    </div>
    
    <div class="result-stats">
      <div class="result-stat">
        <div class="result-stat-value" id="resultAvgPower">184</div>
        <div class="result-stat-label">평균 파워 (W)</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-value" id="resultMaxPower">285</div>
        <div class="result-stat-label">최대 파워 (W)</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-value" id="resultAvgHR">152</div>
        <div class="result-stat-label">평균 심박 (BPM)</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-value" id="resultCalories">892</div>
        <div class="result-stat-label">칼로리 (kcal)</div>
      </div>
    </div>

      <div class="form-row text-center mt-10 mb-15">
        <div class="form-group">
          <label>시작일</label>
          <input type="date" id="startDate" />
        </div>
        <div class="form-group">
          <label>종료일</label>
          <input type="date" id="endDate" />
        </div>
        <div class="form-group mt-15">
          <button class="btn btn-success" onclick="applyDateFilter()">적용</button>
        </div>
      </div>
    
    <div class="card">
      <h3 class="mb-15">🤖 AI 성과 분석</h3>
      <div id="aiAnalysis" class="muted lh-16">분석 중...</div>
    </div>

    <div class="btn-row mt-20">
      <button class="btn btn-success" id="btnSaveResult">저장하기</button>
      <button class="btn btn-secondary" id="btnShareResult">공유하기</button>
    </div>

    <button class="btn mt-10" id="btnGoHome">새 훈련 시작</button>

  <div class="btn-row mt-10">
    <button class="btn btn-success" onclick="exportResults()">📤 결과 내보내기 (CSV)</button>
  </div>    
  </div>

  <!-- =========================
       카운트다운 오버레이
  ========================== -->
  <div id="countdownOverlay" class="countdown-overlay hidden">
    <div class="countdown-number" id="countdownNumber">5</div>
  </div>

  <!-- 비차단 메시지용 토스트 -->
  <div id="toast" class="toast hidden"></div>

<!-- 예: assets/js/ 폴더에 있다면 -->
<script src="assets/js/data.js" defer></script>
<script src="assets/js/bluetooth.js" defer></script>
<script src="assets/js/app.js" defer></script>


  <script src="https://www.gstatic.com/charts/loader.js"></script>

  
</body>
</html>
