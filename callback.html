<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strava 연동 중 – STELVIO AI</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Pretendard", "Noto Sans KR", sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f6f8fa;
      color: #222;
      padding: 24px;
    }
    .box {
      max-width: 400px;
      width: 100%;
      text-align: center;
      padding: 32px 24px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 20px;
      border: 3px solid #eee;
      border-top-color: #fc4c02;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .msg { font-size: 1.05em; line-height: 1.5; color: #555; margin-bottom: 8px; }
    .err { color: #c00; }
    .link {
      display: inline-block;
      margin-top: 20px;
      padding: 12px 24px;
      background: #fc4c02;
      color: #fff;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 600;
      transition: opacity .2s;
    }
    .link:hover { opacity: .9; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="box">
    <div id="loading">
      <div class="spinner"></div>
      <p class="msg">Strava 연동을 처리하는 중입니다.</p>
    </div>
    <div id="success" class="hidden">
      <p class="msg">✅ Strava 연동이 완료되었습니다.</p>
      <a id="backLink" class="link" href="./index.html">앱으로 돌아가기</a>
    </div>
    <div id="error" class="hidden">
      <p class="msg err" id="errorText"></p>
      <a id="retryLink" class="link" href="./index.html">앱으로 돌아가기</a>
    </div>
  </div>

  <!-- GAS URL / Strava 콜백 URL (배포 시 동일하게 맞출 것) -->
  <script>
    window.CONFIG = {
      GAS_WEB_APP_URL: "https://script.google.com/macros/s/AKfycbzF8br63uD3ziNxCFkp0UUSpP49zURthDsEVZ6o3uRu47pdS5uXE5S1oJ3d7AKHFouJ/exec",
      STRAVA_REDIRECT_URI: "https://stelvio.ai.kr/callback.html"
    };
    window.GAS_URL = window.CONFIG.GAS_WEB_APP_URL;
    window.STRAVA_REDIRECT_URI = window.CONFIG.STRAVA_REDIRECT_URI;
  </script>
  <!-- Firebase 초기화 (stravaManager.js가 필요로 함) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
    // Firebase 설정 (index.html과 동일)
    const firebaseConfig = {
      apiKey: "AIzaSyDVQJZV6NIbqhPdz1CKfbA8yHHYClSC35Q",
      authDomain: "stelvio-ai.firebaseapp.com",
      projectId: "stelvio-ai",
      storageBucket: "stelvio-ai.firebasestorage.app",
      messagingSenderId: "752285835508",
      appId: "1:752285835508:web:0662a2a874209ebb483ea1"
    };
    
    // Firebase 초기화
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    window.firestore = firebase.firestore();
    window.auth = firebase.auth();
    console.log('[callback.html] ✅ Firebase 초기화 완료 (Firestore + Auth)');
    
    // phoneToEmail 함수 정의 (index.html과 동일)
    function phoneToEmail(phoneNumber) {
      if (!phoneNumber) return null;
      const cleaned = phoneNumber.replace(/-/g, '');
      return cleaned + '@stelvio.ai';
    }
    window.phoneToEmail = phoneToEmail;
    
    // Firebase Auth 상태 복원 (localStorage에서)
    var authRestored = false;
    firebase.auth().onAuthStateChanged(async function(user) {
      if (user) {
        console.log('[callback.html] ✅ Firebase Auth 로그인 상태 복원됨:', user.uid);
        window.currentUser = { id: user.uid };
        authRestored = true;
        // 인증 복원 완료 후 Strava 콜백 처리
        if (typeof window.handleStravaCallbackAfterAuth === 'function') {
          window.handleStravaCallbackAfterAuth();
        }
      } else {
        console.log('[callback.html] ⚠️ Firebase Auth 로그인 상태 없음 - localStorage에서 복원 시도');
        try {
          const currentUserStr = localStorage.getItem('currentUser');
          if (currentUserStr) {
            const currentUser = JSON.parse(currentUserStr);
            const userId = currentUser.id || currentUser.userId;
            
            if (userId) {
              const phoneToEmailStr = localStorage.getItem('phoneToEmail');
              if (phoneToEmailStr) {
                try {
                  const emailMap = JSON.parse(phoneToEmailStr);
                  const phone = Object.keys(emailMap).find(key => {
                    const email = emailMap[key];
                    return email && email.includes(userId);
                  });
                  
                  if (phone) {
                    const email = emailMap[phone] || phoneToEmail(phone);
                    const password = localStorage.getItem('userPassword_' + phone) || localStorage.getItem('lastPassword');
                    
                    if (email && password) {
                      try {
                        await firebase.auth().signInWithEmailAndPassword(email, password);
                        console.log('[callback.html] ✅ Firebase Auth 로그인 복원 성공');
                        window.currentUser = { id: userId };
                        authRestored = true;
                        // 인증 복원 완료 후 Strava 콜백 처리
                        if (typeof window.handleStravaCallbackAfterAuth === 'function') {
                          window.handleStravaCallbackAfterAuth();
                        }
                        return;
                      } catch (signInError) {
                        console.warn('[callback.html] ⚠️ Firebase Auth 로그인 복원 실패:', signInError);
                      }
                    }
                  } else {
                    // Fallback: try direct conversion from currentUser.contact
                    const contact = currentUser.contact || '';
                    if (contact) {
                      const email = phoneToEmail(contact);
                      const password = localStorage.getItem('userPassword_' + contact) || localStorage.getItem('lastPassword');
                      if (email && password) {
                        try {
                          await firebase.auth().signInWithEmailAndPassword(email, password);
                          console.log('[callback.html] ✅ Firebase Auth 로그인 복원 성공 (전화번호 직접 변환)');
                          window.currentUser = { id: userId };
                          authRestored = true;
                          // 인증 복원 완료 후 Strava 콜백 처리
                          if (typeof window.handleStravaCallbackAfterAuth === 'function') {
                            window.handleStravaCallbackAfterAuth();
                          }
                          return;
                        } catch (signInError) {
                          console.warn('[callback.html] ⚠️ Firebase Auth 로그인 복원 실패 (전화번호 직접 변환):', signInError);
                        }
                      }
                    }
                  }
                } catch (parseError) {
                  console.warn('[callback.html] ⚠️ phoneToEmail 파싱 실패:', parseError);
                }
              } else {
                // Fallback: phoneToEmail localStorage item not found, try direct conversion
                const contact = currentUser.contact || '';
                if (contact) {
                  const email = phoneToEmail(contact);
                  const password = localStorage.getItem('userPassword_' + contact) || localStorage.getItem('lastPassword');
                  if (email && password) {
                    try {
                      await firebase.auth().signInWithEmailAndPassword(email, password);
                      console.log('[callback.html] ✅ Firebase Auth 로그인 복원 성공 (전화번호 직접 변환)');
                      window.currentUser = { id: userId };
                      authRestored = true;
                      // 인증 복원 완료 후 Strava 콜백 처리
                      if (typeof window.handleStravaCallbackAfterAuth === 'function') {
                        window.handleStravaCallbackAfterAuth();
                      }
                      return;
                    } catch (signInError) {
                      console.warn('[callback.html] ⚠️ Firebase Auth 로그인 복원 실패 (전화번호 직접 변환):', signInError);
                    }
                  }
                }
              }
            }
          }
        } catch (e) {
          console.warn('[callback.html] ⚠️ localStorage에서 인증 정보 복원 실패:', e);
        }
        
        // 인증 복원 실패 시에도 일정 시간 후 콜백 처리 시도
        if (!authRestored) {
          setTimeout(function() {
            if (typeof window.handleStravaCallbackAfterAuth === 'function') {
              window.handleStravaCallbackAfterAuth();
            }
          }, 2000);
        }
      }
    });
  </script>
  <script src="assets/js/stravaManager.js"></script>
  <script src="assets/js/strava_auth.js"></script>
  <script>
    (function () {
      var loading = document.getElementById('loading');
      var success = document.getElementById('success');
      var error = document.getElementById('error');
      var errorText = document.getElementById('errorText');
      var backLink = document.getElementById('backLink');
      var retryLink = document.getElementById('retryLink');

      function showLoading() {
        loading.classList.remove('hidden');
        success.classList.add('hidden');
        error.classList.add('hidden');
      }
      function showSuccess() {
        loading.classList.add('hidden');
        success.classList.remove('hidden');
        error.classList.add('hidden');
      }
      function showError(msg) {
        loading.classList.add('hidden');
        success.classList.add('hidden');
        error.classList.remove('hidden');
        errorText.textContent = msg || '연동 처리 중 오류가 발생했습니다.';
      }

      // return_to 등으로 돌아갈 메인 앱 URL (필요 시 쿼리 등으로 전달 가능)
      var returnUrl = new URLSearchParams(window.location.search).get('return_to') || './index.html';
      if (backLink) backLink.href = returnUrl;
      if (retryLink) retryLink.href = returnUrl;

      if (typeof handleStravaCallback !== 'function') {
        showError('Strava 연동 스크립트를 불러올 수 없습니다.');
        return;
      }

      // Firebase Auth 상태 복원 후 Strava 콜백 처리
      window.handleStravaCallbackAfterAuth = function() {
        handleStravaCallback(
          function () { showSuccess(); },
          function (err) { showError(err); }
        );
      };
      
      // 이미 인증 상태가 복원되어 있으면 즉시 처리
      if (firebase.auth().currentUser) {
        window.handleStravaCallbackAfterAuth();
      }
      // 그렇지 않으면 onAuthStateChanged에서 호출됨
    })();
  </script>
</body>
</html>
