<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°œì¸ í›ˆë ¨ ëŒ€ì‹œë³´ë“œ</title>
    
    <!-- Favicon ì„¤ì • -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš´</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš´</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="assets/js/firebaseConfig.js"></script>

    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Pretendard', sans-serif;
            margin: 0;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ê³ ë ¤ (Dynamic Viewport Height) */
            min-height: -webkit-fill-available; /* iOS Safari ëŒ€ì‘ */
        }

        /* ìƒë‹¨ í—¤ë” */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
            position: relative; /* ì„¸ê·¸ë¨¼íŠ¸ ì •ë³´ ì ˆëŒ€ ìœ„ì¹˜ ê¸°ì¤€ */
        }
        
        /* ì„¸ê·¸ë¨¼íŠ¸ ì •ë³´ ì¤‘ì•™ ì •ë ¬ */
        #segment-info {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        .bike-badge {
            background-color: #00d4aa;
            color: #000;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1.1em;
            display: inline-block; /* ê¸€ì í­ì— ë§ì¶¤ */
            width: auto; /* ë‚´ìš©ë¬¼ì— ë§ê²Œ ìë™ ì¡°ì • */
        }
        .timer {
            font-size: 1.5em;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            color: #fff;
        }

        /* ë©”ì¸ ì½˜í…ì¸  (ê²Œì´ì§€ ì˜ì—­) */
        .main-content {
            flex: 1 1 0; /* flex-grow: 1, flex-shrink: 1, flex-basis: 0 (ê°€ìš© ê³µê°„ì„ ê· ë“±í•˜ê²Œ ë¶„ë°°) */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 0; /* flex ì•„ì´í…œì´ ì¶•ì†Œ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
            overflow: hidden; /* ë„˜ì¹˜ëŠ” ë‚´ìš© ìˆ¨ê¹€ */
        }

        /* ì†ë„ê³„ ì»¨í…Œì´ë„ˆ */
        .gauge-container {
            width: 90vw;
            max-width: 500px;
            aspect-ratio: 1/1;
            position: relative;
        }

        /* í†µê³„ ì •ë³´ (í•˜ë‹¨) */
        .stats-footer {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            background-color: #1e1e1e;
            padding: 15px 0;
            border-top: 1px solid #333;
        }
        .stat-box {
            text-align: center;
            border-right: 1px solid #333;
        }
        .stat-box:last-child { border-right: none; }
        .stat-label { font-size: 0.8em; color: #888; margin-bottom: 5px; }
        .stat-value { font-size: 1.8em; font-weight: bold; }
        .unit { font-size: 0.5em; color: #aaa; }

        /* ìƒ‰ìƒ í´ë˜ìŠ¤ */
        .c-power { color: #fff; }
        .c-cadence { color: #00d4aa; }
        .c-hr { color: #ff4444; }
        .c-target { color: #ff8c00; }

        /* ì„¸ê·¸ë¨¼íŠ¸ ê·¸ë˜í”„ ì»¨í…Œì´ë„ˆ */
        .segment-graph-section {
            padding: 0 20px; /* ìƒí•˜ íŒ¨ë”© ì œê±°, ì¢Œìš° íŒ¨ë”©ë§Œ ìœ ì§€ */
            background-color: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: center;
            align-items: stretch; /* ìì‹ ìš”ì†Œë¥¼ ì„¹ì…˜ ë†’ì´ì— ë§ì¶¤ */
            flex: 0.4 0.4 0; /* flex-grow: 0.4, flex-shrink: 0.4 (20% ì¶•ì†Œ: 0.5 * 0.8 = 0.4) */
            min-height: 80px; /* ìµœì†Œ ë†’ì´ ë³´ì¥ (20% ì¶•ì†Œ: 100px * 0.8 = 80px) */
            position: relative;
            overflow: hidden; /* ë„˜ì¹˜ëŠ” ë‚´ìš© ìˆ¨ê¹€ */
        }
        
        /* ëª¨ë°”ì¼ í™˜ê²½ ìµœì í™” */
        @media (max-height: 800px) {
            .segment-graph-section {
                min-height: 72px; /* ì‘ì€ í™”ë©´ì—ì„œë„ ì ì ˆí•œ ë†’ì´ (20% ì¶•ì†Œ: 90px * 0.8 = 72px) */
            }
        }
        
        @media (max-height: 600px) {
            .segment-graph-section {
                min-height: 60px; /* ë§¤ìš° ì‘ì€ í™”ë©´ ëŒ€ì‘ (20% ì¶•ì†Œ: 75px * 0.8 = 60px) */
            }
        }
        
        .segment-graph-container {
            width: 98%; /* ê·¸ë˜í”„ ë¸”ëŸ­ì˜ 98% ë„ˆë¹„ */
            max-width: 600px;
            height: 98% !important; /* ê·¸ë˜í”„ ë¸”ëŸ­ì˜ 98% ë†’ì´ */
            position: relative;
            display: flex;
            align-items: center; /* Canvasë¥¼ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ì— ë°°ì¹˜ */
            justify-content: center;
        }
        .segment-graph-container canvas {
            width: 100% !important;
            height: 100% !important; /* ì»¨í…Œì´ë„ˆ ë†’ì´ì— ë§ì¶¤ */
            display: block;
            /* object-fit ì œê±°: Canvasì˜ ì‹¤ì œ í”½ì…€ í¬ê¸°ë¥¼ ì¡°ì •í•˜ë¯€ë¡œ ë¶ˆí•„ìš” */
        }

        /* 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        .countdown-overlay.hidden {
            display: none;
        }
        .countdown-number {
            font-size: 200px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5), 0 0 60px rgba(255, 255, 255, 0.3);
            animation: countdownPulse 0.8s ease-out;
            user-select: none;
        }
        @keyframes countdownPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <div id="bike-id-display" class="bike-badge">Bike ?</div>
        <div id="segment-info" style="font-size:0.9em; color:#ccc;">ì¤€ë¹„ ì¤‘</div>
        <div id="main-timer" class="timer">00:00:00</div>
    </div>

    <div class="segment-graph-section">
        <div class="segment-graph-container">
            <canvas id="individualSegmentGraph"></canvas>
        </div>
    </div>

    <div class="main-content">
        <div class="gauge-container">
            <svg viewBox="0 0 200 220" style="width:100%; height:100%;">
                <!-- ì›í˜¸ ë°°ê²½ -->
                <path d="M 20 140 A 80 80 0 0 1 180 140" fill="none" stroke="#333" stroke-width="12" stroke-linecap="round"/>
                
                <!-- ëˆˆê¸ˆ ê·¸ë£¹ (JavaScriptë¡œ ë™ì  ìƒì„±) -->
                <g id="gauge-ticks"></g>
                
                <!-- ë ˆì´ë¸” ê·¸ë£¹ (JavaScriptë¡œ ë™ì  ìƒì„±) -->
                <g id="gauge-labels"></g>
                
                <!-- ë©ì¹´ìš´íŠ¸ë‹¤ìš´ (ì†ë„ê³„ ìƒë‹¨) -->
                <text x="100" y="0" text-anchor="middle" fill="#888" font-size="8">LAP COUNTDOWN</text>
                <text id="ui-lap-time" x="100" y="22" text-anchor="middle" fill="#00d4aa" font-size="20" font-weight="bold">00:00</text>
                
                <text x="100" y="90" text-anchor="middle" fill="#888" font-size="6">TARGET</text>
                <text id="ui-target-power" x="100" y="120" text-anchor="middle" fill="#ff8c00" font-size="28" font-weight="bold">0</text>
                
                <text x="100" y="160" text-anchor="middle" fill="#aaa" font-size="8.4">WATTS</text>
                <text id="ui-current-power" x="100" y="200" text-anchor="middle" fill="#fff" font-size="48" font-weight="bold">0</text>

                <g id="gauge-needle" transform="translate(100, 140) rotate(-90)">
                    <line x1="0" y1="0" x2="0" y2="-75" stroke="#ff0000" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="0" cy="0" r="6" fill="#fff"/>
                </g>
            </svg>
        </div>
    </div>

    <div class="stats-footer">
        <div class="stat-box">
            <div class="stat-label">CADENCE</div>
            <div class="stat-value c-cadence"><span id="ui-cadence">0</span><span class="unit">rpm</span></div>
        </div>
        <div class="stat-box">
            <div class="stat-label">HEART RATE</div>
            <div class="stat-value c-hr"><span id="ui-hr">0</span><span class="unit">bpm</span></div>
        </div>
        <div class="stat-box">
            <div class="stat-label">LAP AVG</div>
            <div class="stat-value c-target"><span id="ui-lap-power">0</span><span class="unit">w</span></div>
        </div>
    </div>

    <!-- 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ -->
    <div id="countdownOverlay" class="countdown-overlay hidden">
        <div class="countdown-number" id="countdownNumber">5</div>
    </div>

    <script src="assets/js/workoutManager.js"></script>
    
    <!-- í™”ë©´ ì ê¸ˆ ë°©ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // í™”ë©´ ì ê¸ˆ ë°©ì§€ (Screen Wake Lock API)
        let wakeLock = null;
        let wakeLockVideo = null;
        const wakeLockSupported = 'wakeLock' in navigator;
        
        // Wake Lock API ì‚¬ìš©
        async function requestWakeLock() {
            if (wakeLockSupported) {
                try {
                    // ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¬ìš”ì²­í•˜ì§€ ì•ŠìŒ
                    if (wakeLock) return;
                    
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('[Screen Wake Lock] í™”ë©´ ì ê¸ˆ ë°©ì§€ í™œì„±í™”');
                    
                    // ì‹œìŠ¤í…œì´ í•´ì œí–ˆì„ ë•Œ í”Œë˜ê·¸ ì •ë¦¬
                    wakeLock.addEventListener('release', () => {
                        console.log('[Screen Wake Lock] ì‹œìŠ¤í…œì— ì˜í•´ í•´ì œë¨');
                        wakeLock = null;
                        // ë‹¤ì‹œ ìš”ì²­ ì‹œë„
                        if (document.visibilityState === 'visible') {
                            requestWakeLock();
                        }
                    });
                } catch (err) {
                    console.warn('[Screen Wake Lock] í™œì„±í™” ì‹¤íŒ¨:', err);
                    // Wake Lockì´ ì‹¤íŒ¨í•˜ë©´ ë¹„ë””ì˜¤ íŠ¸ë¦­ ì‚¬ìš©
                    if (!wakeLockVideo) {
                        startVideoWakeLock();
                    }
                }
            } else {
                // Wake Lock API ë¯¸ì§€ì› ì‹œ ë¹„ë””ì˜¤ íŠ¸ë¦­ ì‚¬ìš©
                if (!wakeLockVideo) {
                    startVideoWakeLock();
                }
            }
        }
        
        // ë¹„ë””ì˜¤ íŠ¸ë¦­ ì‚¬ìš© (iOS Safari ë° êµ¬í˜• ë¸Œë¼ìš°ì € ëŒ€ì‘)
        function startVideoWakeLock() {
            try {
                // ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆìœ¼ë©´ ì¬ìƒì„±í•˜ì§€ ì•ŠìŒ
                if (wakeLockVideo) return;
                
                // Canvasë¡œ ìµœì†Œ í¬ê¸°ì˜ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìƒì„±
                const canvas = document.createElement('canvas');
                canvas.width = 2;
                canvas.height = 2;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 2, 2);
                
                // Canvasë¥¼ MediaStreamìœ¼ë¡œ ë³€í™˜
                const stream = canvas.captureStream(1); // 1 FPSë¡œ ì¶©ë¶„
                
                // íˆ¬ëª…í•œ ë¹„ë””ì˜¤ ìš”ì†Œ ìƒì„±
                wakeLockVideo = document.createElement('video');
                wakeLockVideo.setAttribute('playsinline', '');
                wakeLockVideo.setAttribute('muted', '');
                wakeLockVideo.setAttribute('loop', '');
                wakeLockVideo.setAttribute('webkit-playsinline', '');
                wakeLockVideo.style.position = 'fixed';
                wakeLockVideo.style.top = '0';
                wakeLockVideo.style.left = '0';
                wakeLockVideo.style.width = '1px';
                wakeLockVideo.style.height = '1px';
                wakeLockVideo.style.opacity = '0';
                wakeLockVideo.style.pointerEvents = 'none';
                wakeLockVideo.style.zIndex = '-9999';
                
                // ìŠ¤íŠ¸ë¦¼ì„ ë¹„ë””ì˜¤ì— ì—°ê²°
                wakeLockVideo.srcObject = stream;
                document.body.appendChild(wakeLockVideo);
                
                // ë¹„ë””ì˜¤ ì¬ìƒ
                const playPromise = wakeLockVideo.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('[Video Wake Lock] í™”ë©´ ì ê¸ˆ ë°©ì§€ í™œì„±í™” (ë¹„ë””ì˜¤ íŠ¸ë¦­)');
                    }).catch(err => {
                        console.warn('[Video Wake Lock] ì¬ìƒ ì‹¤íŒ¨:', err);
                    });
                }
            } catch (err) {
                console.warn('[Video Wake Lock] ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
            }
        }
        
        // í™”ë©´ ì ê¸ˆ í•´ì œ
        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                    console.log('[Screen Wake Lock] í™”ë©´ ì ê¸ˆ ë°©ì§€ í•´ì œ');
                }).catch(err => {
                    console.warn('[Screen Wake Lock] í•´ì œ ì‹¤íŒ¨:', err);
                    wakeLock = null;
                });
            }
            
            if (wakeLockVideo !== null) {
                try {
                    if (wakeLockVideo.srcObject) {
                        wakeLockVideo.srcObject.getTracks().forEach(track => track.stop());
                        wakeLockVideo.srcObject = null;
                    }
                    wakeLockVideo.pause();
                    if (wakeLockVideo.parentNode) {
                        wakeLockVideo.parentNode.removeChild(wakeLockVideo);
                    }
                    wakeLockVideo = null;
                    console.log('[Video Wake Lock] í™”ë©´ ì ê¸ˆ ë°©ì§€ í•´ì œ (ë¹„ë””ì˜¤ íŠ¸ë¦­)');
                } catch (err) {
                    console.warn('[Video Wake Lock] í•´ì œ ì‹¤íŒ¨:', err);
                }
            }
        }
        
        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ì¬ìš”ì²­
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ë©´ Wake Lock ì¬ìš”ì²­
                if (wakeLockSupported && !wakeLock) {
                    await requestWakeLock();
                }
                // ë¹„ë””ì˜¤ íŠ¸ë¦­ë„ ì¬ì‹œì‘
                if (wakeLockVideo && wakeLockVideo.paused) {
                    wakeLockVideo.play().catch(err => {
                        console.warn('[Video Wake Lock] ì¬ì‹œì‘ ì‹¤íŒ¨:', err);
                    });
                }
            }
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í™”ë©´ ì ê¸ˆ ë°©ì§€ ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì—ë§Œ í™œì„±í™” (ë¸Œë¼ìš°ì € ì •ì±…)
            const activateWakeLock = () => {
                requestWakeLock();
            };
            
            // ì²« í„°ì¹˜/í´ë¦­ ì‹œ í™œì„±í™”
            document.addEventListener('touchstart', activateWakeLock, { once: true, passive: true });
            document.addEventListener('click', activateWakeLock, { once: true });
            document.addEventListener('pointerdown', activateWakeLock, { once: true, passive: true });
        });
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ í•´ì œ
        window.addEventListener('beforeunload', releaseWakeLock);
        window.addEventListener('pagehide', releaseWakeLock);
        
        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (í•„ìš”ì‹œ ìˆ˜ë™ ì œì–´ ê°€ëŠ¥)
        window.wakeLockControl = {
            request: requestWakeLock,
            release: releaseWakeLock
        };
    </script>
    
    <script src="assets/js/individual.js"></script>
</body>
</html>